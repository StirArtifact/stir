static	O
inline	O
ssize_t	long
http_method	function
(	O
int	O
fd	int
,	O
Http_destination	struct
*	O
dest	pointer
,	O
Http_method	enum
method	enum
,	O
ssize_t	long
length	long
)	O
{	O
char	O
str	pointer
[	O
1024	int
]	O
;	O
Http_request	struct
*	O
request	pointer
;	O
ssize_t	long
n	long
;	O
if	O
(	O
fd	int
==	O
-	O
1	int
)	O
{	O
log_error	function
(	O
"http_method: fd == -1"	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
n	long
=	O
0	int
;	O
if	O
(	O
dest	pointer
->	O
proxy_name	pointer
!=	O
NULL	O
)	O
n	long
=	O
sprintf	function
(	O
str	pointer
,	O
"http://%s:%d"	pointer
,	O
dest	pointer
->	O
host_name	pointer
,	O
dest	pointer
->	O
host_port	int
)	O
;	O
sprintf	function
(	O
str	pointer
+	O
n	long
,	O
"/index.html?crap=%ld"	pointer
,	O
time	function
(	O
NULL	O
)	O
)	O
;	O
request	pointer
=	O
http_create_request	function
(	O
method	enum
,	O
str	pointer
,	O
1	int
,	O
1	int
)	O
;	O
if	O
(	O
request	pointer
==	O
NULL	O
)	O
return	O
-	O
1	int
;	O
sprintf	function
(	O
str	pointer
,	O
"%s:%d"	pointer
,	O
dest	pointer
->	O
host_name	pointer
,	O
dest	pointer
->	O
host_port	int
)	O
;	O
http_add_header	function
(	O
&	O
request	pointer
->	O
header	pointer
,	O
"Host"	pointer
,	O
str	pointer
)	O
;	O
if	O
(	O
length	long
>=	O
0	int
)	O
{	O
sprintf	function
(	O
str	pointer
,	O
"%d"	pointer
,	O
length	long
)	O
;	O
http_add_header	function
(	O
&	O
request	pointer
->	O
header	pointer
,	O
"Content-Length"	pointer
,	O
str	pointer
)	O
;	O
}	O
http_add_header	function
(	O
&	O
request	pointer
->	O
header	pointer
,	O
"Connection"	pointer
,	O
"close"	pointer
)	O
;	O
if	O
(	O
dest	pointer
->	O
proxy_authorization	pointer
)	O
{	O
http_add_header	function
(	O
&	O
request	pointer
->	O
header	pointer
,	O
"Proxy-Authorization"	pointer
,	O
dest	pointer
->	O
proxy_authorization	pointer
)	O
;	O
}	O
if	O
(	O
dest	pointer
->	O
user_agent	pointer
)	O
{	O
http_add_header	function
(	O
&	O
request	pointer
->	O
header	pointer
,	O
"User-Agent"	pointer
,	O
dest	pointer
->	O
user_agent	pointer
)	O
;	O
}	O
n	long
=	O
http_write_request	function
(	O
fd	int
,	O
request	pointer
)	O
;	O
http_destroy_request	function
(	O
request	pointer
)	O
;	O
return	O
n	long
;	O
}	O
ssize_t	long
http_get	function
(	O
int	O
fd	int
,	O
Http_destination	struct
*	O
dest	pointer
)	O
{	O
return	O
http_method	function
(	O
fd	int
,	O
dest	pointer
,	O
HTTP_GET	int
,	O
-	O
1	int
)	O
;	O
}	O
ssize_t	long
http_put	function
(	O
int	O
fd	int
,	O
Http_destination	struct
*	O
dest	pointer
,	O
size_t	long
length	long
)	O
{	O
return	O
http_method	function
(	O
fd	int
,	O
dest	pointer
,	O
HTTP_PUT	int
,	O
(	O
ssize_t	long
)	O
length	long
)	O
;	O
}	O
ssize_t	long
http_post	function
(	O
int	O
fd	int
,	O
Http_destination	struct
*	O
dest	pointer
,	O
size_t	long
length	long
)	O
{	O
return	O
http_method	function
(	O
fd	int
,	O
dest	pointer
,	O
HTTP_POST	int
,	O
(	O
ssize_t	long
)	O
length	long
)	O
;	O
}	O
int	O
http_error_to_errno	function
(	O
int	O
err	int
)	O
{	O
switch	O
(	O
err	int
)	O
{	O
case	O
-	O
1	int
:	O
return	O
errno	O
;	O
case	O
-	O
200	int
:	O
case	O
-	O
201	int
:	O
case	O
-	O
202	int
:	O
case	O
-	O
203	int
:	O
case	O
-	O
204	int
:	O
case	O
-	O
205	int
:	O
case	O
-	O
206	int
:	O
return	O
0	int
;	O
case	O
-	O
400	int
:	O
log_error	function
(	O
"http_error_to_errno: 400 bad request"	pointer
)	O
;	O
return	O
EIO	int
;	O
case	O
-	O
401	int
:	O
log_error	function
(	O
"http_error_to_errno: 401 unauthorized"	pointer
)	O
;	O
return	O
EACCES	int
;	O
case	O
-	O
403	int
:	O
log_error	function
(	O
"http_error_to_errno: 403 forbidden"	pointer
)	O
;	O
return	O
EACCES	int
;	O
case	O
-	O
404	int
:	O
log_error	function
(	O
"http_error_to_errno: 404 not found"	pointer
)	O
;	O
return	O
ENOENT	int
;	O
case	O
-	O
411	int
:	O
log_error	function
(	O
"http_error_to_errno: 411 length required"	pointer
)	O
;	O
return	O
EIO	int
;	O
case	O
-	O
413	int
:	O
log_error	function
(	O
"http_error_to_errno: 413 request entity too large"	pointer
)	O
;	O
return	O
EIO	int
;	O
case	O
-	O
505	int
:	O
log_error	function
(	O
"http_error_to_errno: 413 HTTP version not supported"	pointer
)	O
;	O
return	O
EIO	int
;	O
case	O
-	O
100	int
:	O
case	O
-	O
101	int
:	O
case	O
-	O
300	int
:	O
case	O
-	O
301	int
:	O
case	O
-	O
302	int
:	O
case	O
-	O
303	int
:	O
case	O
-	O
304	int
:	O
case	O
-	O
305	int
:	O
case	O
-	O
402	int
:	O
case	O
-	O
405	int
:	O
case	O
-	O
406	int
:	O
case	O
-	O
407	int
:	O
case	O
-	O
408	int
:	O
case	O
-	O
409	int
:	O
case	O
-	O
410	int
:	O
case	O
-	O
412	int
:	O
case	O
-	O
414	int
:	O
case	O
-	O
415	int
:	O
case	O
-	O
500	int
:	O
case	O
-	O
501	int
:	O
case	O
-	O
502	int
:	O
case	O
-	O
503	int
:	O
case	O
-	O
504	int
:	O
log_error	function
(	O
"http_error_to_errno: HTTP error %d"	pointer
,	O
err	int
)	O
;	O
return	O
EIO	int
;	O
default	O
:	O
log_error	function
(	O
"http_error_to_errno: unknown error %d"	pointer
,	O
err	int
)	O
;	O
return	O
EIO	int
;	O
}	O
}	O
static	O
Http_method	enum
http_string_to_method	function
(	O
const	O
char	O
*	O
method	enum
,	O
size_t	long
n	long
)	O
{	O
if	O
(	O
strncmp	function
(	O
method	enum
,	O
"GET"	pointer
,	O
n	long
)	O
==	O
0	int
)	O
return	O
HTTP_GET	int
;	O
if	O
(	O
strncmp	function
(	O
method	enum
,	O
"PUT"	pointer
,	O
n	long
)	O
==	O
0	int
)	O
return	O
HTTP_PUT	int
;	O
if	O
(	O
strncmp	function
(	O
method	enum
,	O
"POST"	pointer
,	O
n	long
)	O
==	O
0	int
)	O
return	O
HTTP_POST	int
;	O
if	O
(	O
strncmp	function
(	O
method	enum
,	O
"OPTIONS"	pointer
,	O
n	long
)	O
==	O
0	int
)	O
return	O
HTTP_OPTIONS	int
;	O
if	O
(	O
strncmp	function
(	O
method	enum
,	O
"HEAD"	pointer
,	O
n	long
)	O
==	O
0	int
)	O
return	O
HTTP_HEAD	int
;	O
if	O
(	O
strncmp	function
(	O
method	enum
,	O
"DELETE"	pointer
,	O
n	long
)	O
==	O
0	int
)	O
return	O
HTTP_DELETE	int
;	O
if	O
(	O
strncmp	function
(	O
method	enum
,	O
"TRACE"	pointer
,	O
n	long
)	O
==	O
0	int
)	O
return	O
HTTP_TRACE	int
;	O
return	O
-	O
1	int
;	O
}	O
static	O
const	O
char	O
*	O
http_method_to_string	function
(	O
Http_method	enum
method	enum
)	O
{	O
switch	O
(	O
method	enum
)	O
{	O
case	O
HTTP_GET	int
:	O
return	O
"GET"	pointer
;	O
case	O
HTTP_PUT	int
:	O
return	O
"PUT"	pointer
;	O
case	O
HTTP_POST	int
:	O
return	O
"POST"	pointer
;	O
case	O
HTTP_OPTIONS	int
:	O
return	O
"OPTIONS"	pointer
;	O
case	O
HTTP_HEAD	int
:	O
return	O
"HEAD"	pointer
;	O
case	O
HTTP_DELETE	int
:	O
return	O
"DELETE"	pointer
;	O
case	O
HTTP_TRACE	int
:	O
return	O
"TRACE"	pointer
;	O
}	O
return	O
"(uknown)"	pointer
;	O
}	O
static	O
ssize_t	long
read_until	function
(	O
int	O
fd	int
,	O
int	O
ch	int
,	O
unsigned	O
char	O
*	O
*	O
data	pointer
)	O
{	O
unsigned	O
char	O
*	O
buf	pointer
,	O
*	O
buf2	pointer
;	O
ssize_t	long
n	long
,	O
len	long
,	O
buf_size	long
;	O
*	O
data	pointer
=	O
NULL	O
;	O
buf_size	long
=	O
100	int
;	O
buf	pointer
=	O
malloc	function
(	O
buf_size	long
)	O
;	O
if	O
(	O
buf	pointer
==	O
NULL	O
)	O
{	O
log_error	function
(	O
"read_until: out of memory"	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
len	long
=	O
0	int
;	O
while	O
(	O
(	O
n	long
=	O
read_all	function
(	O
fd	int
,	O
buf	pointer
+	O
len	long
,	O
1	int
)	O
)	O
==	O
1	int
)	O
{	O
if	O
(	O
buf	pointer
[	O
len	long
++	O
]	O
==	O
ch	int
)	O
break	O
;	O
if	O
(	O
len	long
+	O
1	int
==	O
buf_size	long
)	O
{	O
buf_size	long
*=	O
2	int
;	O
buf2	pointer
=	O
realloc	function
(	O
buf	pointer
,	O
buf_size	long
)	O
;	O
if	O
(	O
buf2	pointer
==	O
NULL	O
)	O
{	O
log_error	function
(	O
"read_until: realloc failed"	pointer
)	O
;	O
free	function
(	O
buf	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
buf	pointer
=	O
buf2	pointer
;	O
}	O
}	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
free	function
(	O
buf	pointer
)	O
;	O
if	O
(	O
n	long
==	O
0	int
)	O
log_error	function
(	O
"read_until: closed"	pointer
)	O
;	O
else	O
log_error	function
(	O
"read_until: read error: %s"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
return	O
n	long
;	O
}	O
buf2	pointer
=	O
realloc	function
(	O
buf	pointer
,	O
len	long
+	O
1	int
)	O
;	O
if	O
(	O
buf2	pointer
==	O
NULL	O
)	O
log_error	function
(	O
"read_until: realloc: shrink failed"	pointer
)	O
;	O
else	O
buf	pointer
=	O
buf2	pointer
;	O
*	O
data	pointer
=	O
buf	pointer
;	O
return	O
len	long
;	O
}	O
static	O
inline	O
Http_header	struct
*	O
http_alloc_header	function
(	O
const	O
char	O
*	O
name	pointer
,	O
const	O
char	O
*	O
value	pointer
)	O
{	O
Http_header	struct
*	O
header	pointer
;	O
header	pointer
=	O
malloc	function
(	O
sizeof	O
(	O
Http_header	struct
)	O
)	O
;	O
if	O
(	O
header	pointer
==	O
NULL	O
)	O
return	O
NULL	O
;	O
header	pointer
->	O
name	pointer
=	O
header	pointer
->	O
value	pointer
=	O
NULL	O
;	O
header	pointer
->	O
name	pointer
=	O
strdup	function
(	O
name	pointer
)	O
;	O
header	pointer
->	O
value	pointer
=	O
strdup	function
(	O
value	pointer
)	O
;	O
if	O
(	O
name	pointer
==	O
NULL	O
||	O
value	pointer
==	O
NULL	O
)	O
{	O
if	O
(	O
name	pointer
==	O
NULL	O
)	O
free	function
(	O
(	O
char	O
*	O
)	O
name	pointer
)	O
;	O
if	O
(	O
value	pointer
==	O
NULL	O
)	O
free	function
(	O
(	O
char	O
*	O
)	O
value	pointer
)	O
;	O
free	function
(	O
header	pointer
)	O
;	O
return	O
NULL	O
;	O
}	O
return	O
header	pointer
;	O
}	O
Http_header	struct
*	O
http_add_header	function
(	O
Http_header	struct
*	O
*	O
header	pointer
,	O
const	O
char	O
*	O
name	pointer
,	O
const	O
char	O
*	O
value	pointer
)	O
{	O
Http_header	struct
*	O
new_header	pointer
;	O
new_header	pointer
=	O
http_alloc_header	function
(	O
name	pointer
,	O
value	pointer
)	O
;	O
if	O
(	O
new_header	pointer
==	O
NULL	O
)	O
return	O
NULL	O
;	O
new_header	pointer
->	O
next	pointer
=	O
NULL	O
;	O
while	O
(	O
*	O
header	pointer
)	O
header	pointer
=	O
&	O
(	O
*	O
header	pointer
)	O
->	O
next	pointer
;	O
*	O
header	pointer
=	O
new_header	pointer
;	O
return	O
new_header	pointer
;	O
}	O
static	O
ssize_t	long
parse_header	function
(	O
int	O
fd	int
,	O
Http_header	struct
*	O
*	O
header	pointer
)	O
{	O
unsigned	O
char	O
buf	pointer
[	O
2	int
]	O
;	O
unsigned	O
char	O
*	O
data	pointer
;	O
Http_header	struct
*	O
h	pointer
;	O
size_t	long
len	long
;	O
ssize_t	long
n	long
;	O
*	O
header	pointer
=	O
NULL	O
;	O
n	long
=	O
read_all	function
(	O
fd	int
,	O
buf	pointer
,	O
2	int
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
return	O
n	long
;	O
if	O
(	O
buf	pointer
[	O
0	int
]	O
==	O
'\r'	O
&&	O
buf	pointer
[	O
1	int
]	O
==	O
'\n'	O
)	O
return	O
n	long
;	O
h	pointer
=	O
malloc	function
(	O
sizeof	O
(	O
Http_header	struct
)	O
)	O
;	O
if	O
(	O
h	pointer
==	O
NULL	O
)	O
{	O
log_error	function
(	O
"parse_header: malloc failed"	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
*	O
header	pointer
=	O
h	pointer
;	O
h	pointer
->	O
name	pointer
=	O
NULL	O
;	O
h	pointer
->	O
value	pointer
=	O
NULL	O
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
':'	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
return	O
n	long
;	O
data	pointer
=	O
realloc	function
(	O
data	pointer
,	O
n	long
+	O
2	int
)	O
;	O
if	O
(	O
data	pointer
==	O
NULL	O
)	O
{	O
log_error	function
(	O
"parse_header: realloc failed"	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
memmove	function
(	O
data	pointer
+	O
2	int
,	O
data	pointer
,	O
n	long
)	O
;	O
memcpy	function
(	O
data	pointer
,	O
buf	pointer
,	O
2	int
)	O
;	O
n	long
+=	O
2	int
;	O
data	pointer
[	O
n	long
-	O
1	int
]	O
=	O
0	int
;	O
h	pointer
->	O
name	pointer
=	O
data	pointer
;	O
len	long
=	O
n	long
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
'\r'	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
return	O
n	long
;	O
data	pointer
[	O
n	long
-	O
1	int
]	O
=	O
0	int
;	O
h	pointer
->	O
value	pointer
=	O
data	pointer
;	O
len	long
+=	O
n	long
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
'\n'	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
return	O
n	long
;	O
free	function
(	O
data	pointer
)	O
;	O
if	O
(	O
n	long
!=	O
1	int
)	O
{	O
log_error	function
(	O
"parse_header: invalid line ending"	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
len	long
+=	O
n	long
;	O
log_verbose	function
(	O
"parse_header: %s:%s"	pointer
,	O
h	pointer
->	O
name	pointer
,	O
h	pointer
->	O
value	pointer
)	O
;	O
n	long
=	O
parse_header	function
(	O
fd	int
,	O
&	O
h	pointer
->	O
next	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
return	O
n	long
;	O
len	long
+=	O
n	long
;	O
return	O
len	long
;	O
}	O
static	O
ssize_t	long
http_write_header	function
(	O
int	O
fd	int
,	O
Http_header	struct
*	O
header	pointer
)	O
{	O
ssize_t	long
n	long
=	O
0	int
,	O
m	long
;	O
if	O
(	O
header	pointer
==	O
NULL	O
)	O
return	O
write_all	function
(	O
fd	int
,	O
"\r\n"	pointer
,	O
2	int
)	O
;	O
m	long
=	O
write_all	function
(	O
fd	int
,	O
(	O
void	O
*	O
)	O
header	pointer
->	O
name	pointer
,	O
strlen	function
(	O
header	pointer
->	O
name	pointer
)	O
)	O
;	O
if	O
(	O
m	long
==	O
-	O
1	int
)	O
{	O
return	O
-	O
1	int
;	O
}	O
n	long
+=	O
m	long
;	O
m	long
=	O
write_all	function
(	O
fd	int
,	O
": "	pointer
,	O
2	int
)	O
;	O
if	O
(	O
m	long
==	O
-	O
1	int
)	O
{	O
return	O
-	O
1	int
;	O
}	O
n	long
+=	O
m	long
;	O
m	long
=	O
write_all	function
(	O
fd	int
,	O
(	O
void	O
*	O
)	O
header	pointer
->	O
value	pointer
,	O
strlen	function
(	O
header	pointer
->	O
value	pointer
)	O
)	O
;	O
if	O
(	O
m	long
==	O
-	O
1	int
)	O
{	O
return	O
-	O
1	int
;	O
}	O
n	long
+=	O
m	long
;	O
m	long
=	O
write_all	function
(	O
fd	int
,	O
"\r\n"	pointer
,	O
2	int
)	O
;	O
if	O
(	O
m	long
==	O
-	O
1	int
)	O
{	O
return	O
-	O
1	int
;	O
}	O
n	long
+=	O
m	long
;	O
m	long
=	O
http_write_header	function
(	O
fd	int
,	O
header	pointer
->	O
next	pointer
)	O
;	O
if	O
(	O
m	long
==	O
-	O
1	int
)	O
{	O
return	O
-	O
1	int
;	O
}	O
n	long
+=	O
m	long
;	O
return	O
n	long
;	O
}	O
static	O
void	O
http_destroy_header	function
(	O
Http_header	struct
*	O
header	pointer
)	O
{	O
if	O
(	O
header	pointer
==	O
NULL	O
)	O
return	O
;	O
http_destroy_header	function
(	O
header	pointer
->	O
next	pointer
)	O
;	O
if	O
(	O
header	pointer
->	O
name	pointer
)	O
free	function
(	O
(	O
char	O
*	O
)	O
header	pointer
->	O
name	pointer
)	O
;	O
if	O
(	O
header	pointer
->	O
value	pointer
)	O
free	function
(	O
(	O
char	O
*	O
)	O
header	pointer
->	O
value	pointer
)	O
;	O
free	function
(	O
header	pointer
)	O
;	O
}	O
static	O
inline	O
Http_response	struct
*	O
http_allocate_response	function
(	O
const	O
char	O
*	O
status_message	pointer
)	O
{	O
Http_response	struct
*	O
response	pointer
;	O
response	pointer
=	O
malloc	function
(	O
sizeof	O
(	O
Http_response	struct
)	O
)	O
;	O
if	O
(	O
response	pointer
==	O
NULL	O
)	O
return	O
NULL	O
;	O
response	pointer
->	O
status_message	pointer
=	O
strdup	function
(	O
status_message	pointer
)	O
;	O
if	O
(	O
response	pointer
->	O
status_message	pointer
==	O
NULL	O
)	O
{	O
free	function
(	O
response	pointer
)	O
;	O
return	O
NULL	O
;	O
}	O
return	O
response	pointer
;	O
}	O
Http_response	struct
*	O
http_create_response	function
(	O
int	O
major_version	int
,	O
int	O
minor_version	int
,	O
int	O
status_code	int
,	O
const	O
char	O
*	O
status_message	pointer
)	O
{	O
Http_response	struct
*	O
response	pointer
;	O
response	pointer
=	O
http_allocate_response	function
(	O
status_message	pointer
)	O
;	O
if	O
(	O
response	pointer
==	O
NULL	O
)	O
return	O
NULL	O
;	O
response	pointer
->	O
major_version	int
=	O
major_version	int
;	O
response	pointer
->	O
minor_version	int
=	O
minor_version	int
;	O
response	pointer
->	O
status_code	int
=	O
status_code	int
;	O
response	pointer
->	O
header	pointer
=	O
NULL	O
;	O
return	O
response	pointer
;	O
}	O
ssize_t	long
http_parse_response	function
(	O
int	O
fd	int
,	O
Http_response	struct
*	O
*	O
response_	pointer
)	O
{	O
Http_response	struct
*	O
response	pointer
;	O
unsigned	O
char	O
*	O
data	pointer
;	O
size_t	long
len	long
;	O
ssize_t	long
n	long
;	O
*	O
response_	pointer
=	O
NULL	O
;	O
response	pointer
=	O
malloc	function
(	O
sizeof	O
(	O
Http_response	struct
)	O
)	O
;	O
if	O
(	O
response	pointer
==	O
NULL	O
)	O
{	O
log_error	function
(	O
"http_parse_response: out of memory"	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
response	pointer
->	O
major_version	int
=	O
-	O
1	int
;	O
response	pointer
->	O
minor_version	int
=	O
-	O
1	int
;	O
response	pointer
->	O
status_code	int
=	O
-	O
1	int
;	O
response	pointer
->	O
status_message	pointer
=	O
NULL	O
;	O
response	pointer
->	O
header	pointer
=	O
NULL	O
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
'/'	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
free	function
(	O
response	pointer
)	O
;	O
return	O
n	long
;	O
}	O
else	O
if	O
(	O
n	long
!=	O
5	int
||	O
memcmp	function
(	O
data	pointer
,	O
"HTTP"	pointer
,	O
4	int
)	O
!=	O
0	int
)	O
{	O
log_error	function
(	O
"http_parse_response: expected \"HTTP\""	pointer
)	O
;	O
free	function
(	O
data	pointer
)	O
;	O
free	function
(	O
response	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
free	function
(	O
data	pointer
)	O
;	O
len	long
=	O
n	long
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
'.'	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
free	function
(	O
response	pointer
)	O
;	O
return	O
n	long
;	O
}	O
data	pointer
[	O
n	long
-	O
1	int
]	O
=	O
0	int
;	O
response	pointer
->	O
major_version	int
=	O
atoi	function
(	O
data	pointer
)	O
;	O
log_verbose	function
(	O
"http_parse_response: major version = %d"	pointer
,	O
response	pointer
->	O
major_version	int
)	O
;	O
free	function
(	O
data	pointer
)	O
;	O
len	long
+=	O
n	long
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
' '	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
free	function
(	O
response	pointer
)	O
;	O
return	O
n	long
;	O
}	O
data	pointer
[	O
n	long
-	O
1	int
]	O
=	O
0	int
;	O
response	pointer
->	O
minor_version	int
=	O
atoi	function
(	O
data	pointer
)	O
;	O
log_verbose	function
(	O
"http_parse_response: minor version = %d"	pointer
,	O
response	pointer
->	O
minor_version	int
)	O
;	O
free	function
(	O
data	pointer
)	O
;	O
len	long
+=	O
n	long
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
' '	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
free	function
(	O
response	pointer
)	O
;	O
return	O
n	long
;	O
}	O
data	pointer
[	O
n	long
-	O
1	int
]	O
=	O
0	int
;	O
response	pointer
->	O
status_code	int
=	O
atoi	function
(	O
data	pointer
)	O
;	O
log_verbose	function
(	O
"http_parse_response: status code = %d"	pointer
,	O
response	pointer
->	O
status_code	int
)	O
;	O
free	function
(	O
data	pointer
)	O
;	O
len	long
+=	O
n	long
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
'\r'	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
free	function
(	O
response	pointer
)	O
;	O
return	O
n	long
;	O
}	O
data	pointer
[	O
n	long
-	O
1	int
]	O
=	O
0	int
;	O
response	pointer
->	O
status_message	pointer
=	O
data	pointer
;	O
log_verbose	function
(	O
"http_parse_response: status message = \"%s\""	pointer
,	O
response	pointer
->	O
status_message	pointer
)	O
;	O
len	long
+=	O
n	long
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
'\n'	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
http_destroy_response	function
(	O
response	pointer
)	O
;	O
return	O
n	long
;	O
}	O
free	function
(	O
data	pointer
)	O
;	O
if	O
(	O
n	long
!=	O
1	int
)	O
{	O
log_error	function
(	O
"http_parse_request: invalid line ending"	pointer
)	O
;	O
http_destroy_response	function
(	O
response	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
len	long
+=	O
n	long
;	O
n	long
=	O
parse_header	function
(	O
fd	int
,	O
&	O
response	pointer
->	O
header	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
http_destroy_response	function
(	O
response	pointer
)	O
;	O
return	O
n	long
;	O
}	O
len	long
+=	O
n	long
;	O
*	O
response_	pointer
=	O
response	pointer
;	O
return	O
len	long
;	O
}	O
void	O
http_destroy_response	function
(	O
Http_response	struct
*	O
response	pointer
)	O
{	O
if	O
(	O
response	pointer
->	O
status_message	pointer
)	O
free	function
(	O
(	O
char	O
*	O
)	O
response	pointer
->	O
status_message	pointer
)	O
;	O
http_destroy_header	function
(	O
response	pointer
->	O
header	pointer
)	O
;	O
free	function
(	O
response	pointer
)	O
;	O
}	O
static	O
inline	O
Http_request	struct
*	O
http_allocate_request	function
(	O
const	O
char	O
*	O
uri	pointer
)	O
{	O
Http_request	struct
*	O
request	pointer
;	O
request	pointer
=	O
malloc	function
(	O
sizeof	O
(	O
Http_request	struct
)	O
)	O
;	O
if	O
(	O
request	pointer
==	O
NULL	O
)	O
return	O
NULL	O
;	O
request	pointer
->	O
uri	pointer
=	O
strdup	function
(	O
uri	pointer
)	O
;	O
if	O
(	O
request	pointer
->	O
uri	pointer
==	O
NULL	O
)	O
{	O
free	function
(	O
request	pointer
)	O
;	O
return	O
NULL	O
;	O
}	O
return	O
request	pointer
;	O
}	O
Http_request	struct
*	O
http_create_request	function
(	O
Http_method	enum
method	enum
,	O
const	O
char	O
*	O
uri	pointer
,	O
int	O
major_version	int
,	O
int	O
minor_version	int
)	O
{	O
Http_request	struct
*	O
request	pointer
;	O
request	pointer
=	O
http_allocate_request	function
(	O
uri	pointer
)	O
;	O
if	O
(	O
request	pointer
==	O
NULL	O
)	O
return	O
NULL	O
;	O
request	pointer
->	O
method	enum
=	O
method	enum
;	O
request	pointer
->	O
major_version	int
=	O
major_version	int
;	O
request	pointer
->	O
minor_version	int
=	O
minor_version	int
;	O
request	pointer
->	O
header	pointer
=	O
NULL	O
;	O
return	O
request	pointer
;	O
}	O
ssize_t	long
http_parse_request	function
(	O
int	O
fd	int
,	O
Http_request	struct
*	O
*	O
request_	pointer
)	O
{	O
Http_request	struct
*	O
request	pointer
;	O
unsigned	O
char	O
*	O
data	pointer
;	O
size_t	long
len	long
;	O
ssize_t	long
n	long
;	O
*	O
request_	pointer
=	O
NULL	O
;	O
request	pointer
=	O
malloc	function
(	O
sizeof	O
(	O
Http_request	struct
)	O
)	O
;	O
if	O
(	O
request	pointer
==	O
NULL	O
)	O
{	O
log_error	function
(	O
"http_parse_request: out of memory"	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
request	pointer
->	O
method	enum
=	O
-	O
1	int
;	O
request	pointer
->	O
uri	pointer
=	O
NULL	O
;	O
request	pointer
->	O
major_version	int
=	O
-	O
1	int
;	O
request	pointer
->	O
minor_version	int
=	O
-	O
1	int
;	O
request	pointer
->	O
header	pointer
=	O
NULL	O
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
' '	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
free	function
(	O
request	pointer
)	O
;	O
return	O
n	long
;	O
}	O
request	pointer
->	O
method	enum
=	O
http_string_to_method	function
(	O
data	pointer
,	O
n	long
-	O
1	int
)	O
;	O
if	O
(	O
request	pointer
->	O
method	enum
==	O
-	O
1	int
)	O
{	O
log_error	function
(	O
"http_parse_request: expected an HTTP method"	pointer
)	O
;	O
free	function
(	O
data	pointer
)	O
;	O
free	function
(	O
request	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
data	pointer
[	O
n	long
-	O
1	int
]	O
=	O
0	int
;	O
log_verbose	function
(	O
"http_parse_request: method = \"%s\""	pointer
,	O
data	pointer
)	O
;	O
free	function
(	O
data	pointer
)	O
;	O
len	long
=	O
n	long
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
' '	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
free	function
(	O
request	pointer
)	O
;	O
return	O
n	long
;	O
}	O
data	pointer
[	O
n	long
-	O
1	int
]	O
=	O
0	int
;	O
request	pointer
->	O
uri	pointer
=	O
data	pointer
;	O
len	long
+=	O
n	long
;	O
log_verbose	function
(	O
"http_parse_request: uri = \"%s\""	pointer
,	O
request	pointer
->	O
uri	pointer
)	O
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
'/'	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
http_destroy_request	function
(	O
request	pointer
)	O
;	O
return	O
n	long
;	O
}	O
else	O
if	O
(	O
n	long
!=	O
5	int
||	O
memcmp	function
(	O
data	pointer
,	O
"HTTP"	pointer
,	O
4	int
)	O
!=	O
0	int
)	O
{	O
log_error	function
(	O
"http_parse_request: expected \"HTTP\""	pointer
)	O
;	O
free	function
(	O
data	pointer
)	O
;	O
http_destroy_request	function
(	O
request	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
free	function
(	O
data	pointer
)	O
;	O
len	long
=	O
n	long
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
'.'	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
http_destroy_request	function
(	O
request	pointer
)	O
;	O
return	O
n	long
;	O
}	O
data	pointer
[	O
n	long
-	O
1	int
]	O
=	O
0	int
;	O
request	pointer
->	O
major_version	int
=	O
atoi	function
(	O
data	pointer
)	O
;	O
log_verbose	function
(	O
"http_parse_request: major version = %d"	pointer
,	O
request	pointer
->	O
major_version	int
)	O
;	O
free	function
(	O
data	pointer
)	O
;	O
len	long
+=	O
n	long
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
'\r'	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
http_destroy_request	function
(	O
request	pointer
)	O
;	O
return	O
n	long
;	O
}	O
data	pointer
[	O
n	long
-	O
1	int
]	O
=	O
0	int
;	O
request	pointer
->	O
minor_version	int
=	O
atoi	function
(	O
data	pointer
)	O
;	O
log_verbose	function
(	O
"http_parse_request: minor version = %d"	pointer
,	O
request	pointer
->	O
minor_version	int
)	O
;	O
free	function
(	O
data	pointer
)	O
;	O
len	long
+=	O
n	long
;	O
n	long
=	O
read_until	function
(	O
fd	int
,	O
'\n'	O
,	O
&	O
data	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
http_destroy_request	function
(	O
request	pointer
)	O
;	O
return	O
n	long
;	O
}	O
free	function
(	O
data	pointer
)	O
;	O
if	O
(	O
n	long
!=	O
1	int
)	O
{	O
log_error	function
(	O
"http_parse_request: invalid line ending"	pointer
)	O
;	O
http_destroy_request	function
(	O
request	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
len	long
+=	O
n	long
;	O
n	long
=	O
parse_header	function
(	O
fd	int
,	O
&	O
request	pointer
->	O
header	pointer
)	O
;	O
if	O
(	O
n	long
<=	O
0	int
)	O
{	O
http_destroy_request	function
(	O
request	pointer
)	O
;	O
return	O
n	long
;	O
}	O
len	long
+=	O
n	long
;	O
*	O
request_	pointer
=	O
request	pointer
;	O
return	O
len	long
;	O
}	O
ssize_t	long
http_write_request	function
(	O
int	O
fd	int
,	O
Http_request	struct
*	O
request	pointer
)	O
{	O
char	O
str	pointer
[	O
1024	int
]	O
;	O
ssize_t	long
n	long
=	O
0	int
;	O
size_t	long
m	long
;	O
m	long
=	O
sprintf	function
(	O
str	pointer
,	O
"%s %s HTTP/%d.%d\r\n"	pointer
,	O
http_method_to_string	function
(	O
request	pointer
->	O
method	enum
)	O
,	O
request	pointer
->	O
uri	pointer
,	O
request	pointer
->	O
major_version	int
,	O
request	pointer
->	O
minor_version	int
)	O
;	O
m	long
=	O
write_all	function
(	O
fd	int
,	O
str	pointer
,	O
m	long
)	O
;	O
log_verbose	function
(	O
"http_write_request: %s"	pointer
,	O
str	pointer
)	O
;	O
if	O
(	O
m	long
==	O
-	O
1	int
)	O
{	O
log_error	function
(	O
"http_write_request: write error: %s"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
return	O
-	O
1	int
;	O
}	O
n	long
+=	O
m	long
;	O
m	long
=	O
http_write_header	function
(	O
fd	int
,	O
request	pointer
->	O
header	pointer
)	O
;	O
if	O
(	O
m	long
==	O
-	O
1	int
)	O
{	O
return	O
-	O
1	int
;	O
}	O
n	long
+=	O
m	long
;	O
return	O
n	long
;	O
}	O
void	O
http_destroy_request	function
(	O
Http_request	struct
*	O
request	pointer
)	O
{	O
if	O
(	O
request	pointer
->	O
uri	pointer
)	O
free	function
(	O
(	O
char	O
*	O
)	O
request	pointer
->	O
uri	pointer
)	O
;	O
http_destroy_header	function
(	O
request	pointer
->	O
header	pointer
)	O
;	O
free	function
(	O
request	pointer
)	O
;	O
}	O
static	O
Http_header	struct
*	O
http_header_find	function
(	O
Http_header	struct
*	O
header	pointer
,	O
const	O
char	O
*	O
name	pointer
)	O
{	O
if	O
(	O
header	pointer
==	O
NULL	O
)	O
return	O
NULL	O
;	O
if	O
(	O
strcmp	function
(	O
header	pointer
->	O
name	pointer
,	O
name	pointer
)	O
==	O
0	int
)	O
return	O
header	pointer
;	O
return	O
http_header_find	function
(	O
header	pointer
->	O
next	pointer
,	O
name	pointer
)	O
;	O
}	O
const	O
char	O
*	O
http_header_get	function
(	O
Http_header	struct
*	O
header	pointer
,	O
const	O
char	O
*	O
name	pointer
)	O
{	O
Http_header	struct
*	O
h	pointer
;	O
h	pointer
=	O
http_header_find	function
(	O
header	pointer
,	O
name	pointer
)	O
;	O
if	O
(	O
h	pointer
==	O
NULL	O
)	O
return	O
NULL	O
;	O
return	O
h	pointer
->	O
value	pointer
;	O
}	O

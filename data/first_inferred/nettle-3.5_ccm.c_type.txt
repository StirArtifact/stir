static	O
void	O
ccm_pad	function
(	O
struct	O
ccm_ctx	struct
*	O
ctx	pointer
,	O
const	O
void	O
*	O
cipher	pointer
,	O
nettle_cipher_func	function
*	O
f	pointer
)	O
{	O
if	O
(	O
ctx	pointer
->	O
blength	int
)	O
f	pointer
(	O
cipher	pointer
,	O
CCM_BLOCK_SIZE	int
,	O
ctx	pointer
->	O
tag	union
.	O
b	array
,	O
ctx	pointer
->	O
tag	union
.	O
b	array
)	O
;	O
ctx	pointer
->	O
blength	int
=	O
0	int
;	O
}	O
static	O
void	O
ccm_build_iv	function
(	O
uint8_t	char
*	O
iv	pointer
,	O
size_t	long
noncelen	long
,	O
const	O
uint8_t	char
*	O
nonce	pointer
,	O
uint8_t	char
flags	char
,	O
size_t	long
count	long
)	O
{	O
unsigned	O
int	O
i	int
;	O
assert	O
(	O
noncelen	long
>=	O
CCM_MIN_NONCE_SIZE	int
)	O
;	O
assert	O
(	O
noncelen	long
<=	O
CCM_MAX_NONCE_SIZE	int
)	O
;	O
iv	pointer
[	O
CCM_OFFSET_FLAGS	int
]	O
=	O
flags	char
|	O
CCM_FLAG_SET_L	O
(	O
CCM_L_SIZE	O
(	O
noncelen	long
)	O
)	O
;	O
memcpy	function
(	O
&	O
iv	pointer
[	O
CCM_OFFSET_NONCE	int
]	O
,	O
nonce	pointer
,	O
noncelen	long
)	O
;	O
for	O
(	O
i	int
=	O
(	O
CCM_BLOCK_SIZE	int
-	O
1	int
)	O
;	O
i	int
>=	O
(	O
CCM_OFFSET_NONCE	int
+	O
noncelen	long
)	O
;	O
i	int
--	O
)	O
{	O
iv	pointer
[	O
i	int
]	O
=	O
count	long
&	O
0xff	int
;	O
count	long
>>=	O
8	int
;	O
}	O
assert	O
(	O
!	O
count	long
)	O
;	O
}	O
void	O
ccm_set_nonce	O
(	O
struct	O
ccm_ctx	struct
*	O
ctx	pointer
,	O
const	O
void	O
*	O
cipher	pointer
,	O
nettle_cipher_func	function
*	O
f	pointer
,	O
size_t	long
length	long
,	O
const	O
uint8_t	char
*	O
nonce	pointer
,	O
size_t	long
authlen	long
,	O
size_t	long
msglen	long
,	O
size_t	long
taglen	long
)	O
{	O
ctx	pointer
->	O
blength	int
=	O
0	int
;	O
ccm_build_iv	function
(	O
ctx	pointer
->	O
tag	union
.	O
b	array
,	O
length	long
,	O
nonce	pointer
,	O
CCM_FLAG_SET_M	O
(	O
taglen	long
)	O
,	O
msglen	long
)	O
;	O
ccm_build_iv	function
(	O
ctx	pointer
->	O
ctr	union
.	O
b	array
,	O
length	long
,	O
nonce	pointer
,	O
0	int
,	O
1	int
)	O
;	O
if	O
(	O
!	O
authlen	long
)	O
{	O
f	pointer
(	O
cipher	pointer
,	O
CCM_BLOCK_SIZE	int
,	O
ctx	pointer
->	O
tag	union
.	O
b	array
,	O
ctx	pointer
->	O
tag	union
.	O
b	array
)	O
;	O
return	O
;	O
}	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
CCM_OFFSET_FLAGS	int
]	O
|=	O
CCM_FLAG_ADATA	int
;	O
f	pointer
(	O
cipher	pointer
,	O
CCM_BLOCK_SIZE	int
,	O
ctx	pointer
->	O
tag	union
.	O
b	array
,	O
ctx	pointer
->	O
tag	union
.	O
b	array
)	O
;	O
if	O
(	O
authlen	long
>=	O
(	O
0x01ULL	int
<<	O
32	int
)	O
)	O
{	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
0xff	int
;	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
0xff	int
;	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
(	O
authlen	long
>>	O
56	int
)	O
&	O
0xff	int
;	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
(	O
authlen	long
>>	O
48	int
)	O
&	O
0xff	int
;	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
(	O
authlen	long
>>	O
40	int
)	O
&	O
0xff	int
;	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
(	O
authlen	long
>>	O
32	int
)	O
&	O
0xff	int
;	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
(	O
authlen	long
>>	O
24	int
)	O
&	O
0xff	int
;	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
(	O
authlen	long
>>	O
16	int
)	O
&	O
0xff	int
;	O
}	O
else	O
if	O
(	O
authlen	long
>=	O
(	O
(	O
0x1ULL	int
<<	O
16	int
)	O
-	O
(	O
0x1ULL	int
<<	O
8	int
)	O
)	O
)	O
{	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
0xff	int
;	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
0xfe	int
;	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
(	O
authlen	long
>>	O
24	int
)	O
&	O
0xff	int
;	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
(	O
authlen	long
>>	O
16	int
)	O
&	O
0xff	int
;	O
}	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
(	O
authlen	long
>>	O
8	int
)	O
&	O
0xff	int
;	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
++	O
]	O
^=	O
(	O
authlen	long
>>	O
0	int
)	O
&	O
0xff	int
;	O
}	O
void	O
ccm_update	O
(	O
struct	O
ccm_ctx	struct
*	O
ctx	pointer
,	O
const	O
void	O
*	O
cipher	pointer
,	O
nettle_cipher_func	function
*	O
f	pointer
,	O
size_t	long
length	long
,	O
const	O
uint8_t	char
*	O
data	pointer
)	O
{	O
const	O
uint8_t	char
*	O
end	pointer
=	O
data	pointer
+	O
length	long
;	O
if	O
(	O
(	O
ctx	pointer
->	O
blength	int
+	O
length	long
)	O
<	O
CCM_BLOCK_SIZE	int
)	O
{	O
memxor	O
(	O
&	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
]	O
,	O
data	pointer
,	O
length	long
)	O
;	O
ctx	pointer
->	O
blength	int
+=	O
length	long
;	O
return	O
;	O
}	O
if	O
(	O
ctx	pointer
->	O
blength	int
)	O
{	O
memxor	O
(	O
&	O
ctx	pointer
->	O
tag	union
.	O
b	array
[	O
ctx	pointer
->	O
blength	int
]	O
,	O
data	pointer
,	O
CCM_BLOCK_SIZE	int
-	O
ctx	pointer
->	O
blength	int
)	O
;	O
data	pointer
+=	O
(	O
CCM_BLOCK_SIZE	int
-	O
ctx	pointer
->	O
blength	int
)	O
;	O
f	pointer
(	O
cipher	pointer
,	O
CCM_BLOCK_SIZE	int
,	O
ctx	pointer
->	O
tag	union
.	O
b	array
,	O
ctx	pointer
->	O
tag	union
.	O
b	array
)	O
;	O
}	O
while	O
(	O
(	O
data	pointer
+	O
CCM_BLOCK_SIZE	int
)	O
<	O
end	pointer
)	O
{	O
memxor	O
(	O
ctx	pointer
->	O
tag	union
.	O
b	array
,	O
data	pointer
,	O
CCM_BLOCK_SIZE	int
)	O
;	O
f	pointer
(	O
cipher	pointer
,	O
CCM_BLOCK_SIZE	int
,	O
ctx	pointer
->	O
tag	union
.	O
b	array
,	O
ctx	pointer
->	O
tag	union
.	O
b	array
)	O
;	O
data	pointer
+=	O
CCM_BLOCK_SIZE	int
;	O
}	O
ctx	pointer
->	O
blength	int
=	O
(	O
end	pointer
-	O
data	pointer
)	O
;	O
if	O
(	O
ctx	pointer
->	O
blength	int
)	O
memxor	O
(	O
&	O
ctx	pointer
->	O
tag	union
.	O
b	array
,	O
data	pointer
,	O
ctx	pointer
->	O
blength	int
)	O
;	O
}	O
void	O
ccm_encrypt	O
(	O
struct	O
ccm_ctx	struct
*	O
ctx	pointer
,	O
const	O
void	O
*	O
cipher	pointer
,	O
nettle_cipher_func	function
*	O
f	pointer
,	O
size_t	long
length	long
,	O
uint8_t	char
*	O
dst	pointer
,	O
const	O
uint8_t	char
*	O
src	pointer
)	O
{	O
ccm_pad	function
(	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
)	O
;	O
ccm_update	O
(	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
,	O
length	long
,	O
src	pointer
)	O
;	O
ctr_crypt	O
(	O
cipher	pointer
,	O
f	pointer
,	O
CCM_BLOCK_SIZE	int
,	O
ctx	pointer
->	O
ctr	union
.	O
b	array
,	O
length	long
,	O
dst	pointer
,	O
src	pointer
)	O
;	O
}	O
void	O
ccm_decrypt	O
(	O
struct	O
ccm_ctx	struct
*	O
ctx	pointer
,	O
const	O
void	O
*	O
cipher	pointer
,	O
nettle_cipher_func	function
*	O
f	pointer
,	O
size_t	long
length	long
,	O
uint8_t	char
*	O
dst	pointer
,	O
const	O
uint8_t	char
*	O
src	pointer
)	O
{	O
ctr_crypt	O
(	O
cipher	pointer
,	O
f	pointer
,	O
CCM_BLOCK_SIZE	int
,	O
ctx	pointer
->	O
ctr	union
.	O
b	array
,	O
length	long
,	O
dst	pointer
,	O
src	pointer
)	O
;	O
ccm_pad	function
(	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
)	O
;	O
ccm_update	O
(	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
,	O
length	long
,	O
dst	pointer
)	O
;	O
}	O
void	O
ccm_digest	O
(	O
struct	O
ccm_ctx	struct
*	O
ctx	pointer
,	O
const	O
void	O
*	O
cipher	pointer
,	O
nettle_cipher_func	function
*	O
f	pointer
,	O
size_t	long
length	long
,	O
uint8_t	char
*	O
digest	pointer
)	O
{	O
int	O
i	int
=	O
CCM_BLOCK_SIZE	int
-	O
CCM_FLAG_GET_L	O
(	O
ctx	pointer
->	O
ctr	union
.	O
b	array
[	O
CCM_OFFSET_FLAGS	int
]	O
)	O
;	O
assert	O
(	O
length	long
<=	O
CCM_BLOCK_SIZE	int
)	O
;	O
while	O
(	O
i	int
<	O
CCM_BLOCK_SIZE	int
)	O
ctx	pointer
->	O
ctr	union
.	O
b	array
[	O
i	int
++	O
]	O
=	O
0	int
;	O
ccm_pad	function
(	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
)	O
;	O
ctr_crypt	O
(	O
cipher	pointer
,	O
f	pointer
,	O
CCM_BLOCK_SIZE	int
,	O
ctx	pointer
->	O
ctr	union
.	O
b	array
,	O
length	long
,	O
digest	pointer
,	O
ctx	pointer
->	O
tag	union
.	O
b	array
)	O
;	O
}	O
void	O
ccm_encrypt_message	O
(	O
const	O
void	O
*	O
cipher	pointer
,	O
nettle_cipher_func	function
*	O
f	pointer
,	O
size_t	long
nlength	long
,	O
const	O
uint8_t	char
*	O
nonce	pointer
,	O
size_t	long
alength	long
,	O
const	O
uint8_t	char
*	O
adata	pointer
,	O
size_t	long
tlength	long
,	O
size_t	long
clength	long
,	O
uint8_t	char
*	O
dst	pointer
,	O
const	O
uint8_t	char
*	O
src	pointer
)	O
{	O
struct	O
ccm_ctx	struct
ctx	pointer
;	O
uint8_t	char
*	O
tag	union
=	O
dst	pointer
+	O
(	O
clength	long
-	O
tlength	long
)	O
;	O
assert	O
(	O
clength	long
>=	O
tlength	long
)	O
;	O
ccm_set_nonce	O
(	O
&	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
,	O
nlength	long
,	O
nonce	pointer
,	O
alength	long
,	O
clength	long
-	O
tlength	long
,	O
tlength	long
)	O
;	O
ccm_update	O
(	O
&	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
,	O
alength	long
,	O
adata	pointer
)	O
;	O
ccm_encrypt	O
(	O
&	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
,	O
clength	long
-	O
tlength	long
,	O
dst	pointer
,	O
src	pointer
)	O
;	O
ccm_digest	O
(	O
&	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
,	O
tlength	long
,	O
tag	union
)	O
;	O
}	O
int	O
ccm_decrypt_message	O
(	O
const	O
void	O
*	O
cipher	pointer
,	O
nettle_cipher_func	function
*	O
f	pointer
,	O
size_t	long
nlength	long
,	O
const	O
uint8_t	char
*	O
nonce	pointer
,	O
size_t	long
alength	long
,	O
const	O
uint8_t	char
*	O
adata	pointer
,	O
size_t	long
tlength	long
,	O
size_t	long
mlength	long
,	O
uint8_t	char
*	O
dst	pointer
,	O
const	O
uint8_t	char
*	O
src	pointer
)	O
{	O
struct	O
ccm_ctx	struct
ctx	pointer
;	O
uint8_t	char
tag	union
[	O
CCM_BLOCK_SIZE	int
]	O
;	O
ccm_set_nonce	O
(	O
&	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
,	O
nlength	long
,	O
nonce	pointer
,	O
alength	long
,	O
mlength	long
,	O
tlength	long
)	O
;	O
ccm_update	O
(	O
&	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
,	O
alength	long
,	O
adata	pointer
)	O
;	O
ccm_decrypt	O
(	O
&	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
,	O
mlength	long
,	O
dst	pointer
,	O
src	pointer
)	O
;	O
ccm_digest	O
(	O
&	O
ctx	pointer
,	O
cipher	pointer
,	O
f	pointer
,	O
tlength	long
,	O
tag	union
)	O
;	O
return	O
memeql_sec	O
(	O
tag	union
,	O
src	pointer
+	O
mlength	long
,	O
tlength	long
)	O
;	O
}	O

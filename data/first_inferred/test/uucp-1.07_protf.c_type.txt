const	O
char	O
protf_rcsid	array
[	O
]	O
=	O
"$Id: protf.c,v 1.36 2002/03/05 19:10:41 ian Rel $"	pointer
;	O
struct	O
sfinfo	struct
{	O
boolean	int
(	O
*	O
psendfn	pointer
)	O
P	O
(	O
(	O
struct	O
stransfer	struct
*	O
qtrans	pointer
,	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
)	O
)	O
;	O
boolean	int
(	O
*	O
precfn	pointer
)	O
P	O
(	O
(	O
struct	O
stransfer	struct
*	O
qtrans	pointer
,	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
,	O
const	O
char	O
*	O
zdata	pointer
,	O
size_t	long
cdata	long
)	O
)	O
;	O
pointer	pointer
pinfo	pointer
;	O
char	O
bsend	char
;	O
}	O
;	O
static	O
boolean	int
ffprocess_data	function
P	O
(	O
(	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
,	O
boolean	int
*	O
pfexit	pointer
,	O
size_t	long
*	O
pcneed	pointer
)	O
)	O
;	O
static	O
boolean	int
ffawait_ack	function
P	O
(	O
(	O
struct	O
stransfer	struct
*	O
qtrans	pointer
,	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
,	O
const	O
char	O
*	O
zdata	pointer
,	O
size_t	long
cdata	long
)	O
)	O
;	O
static	O
boolean	int
ffawait_cksum	function
P	O
(	O
(	O
struct	O
stransfer	struct
*	O
qtrans	pointer
,	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
,	O
const	O
char	O
*	O
zdata	pointer
,	O
size_t	long
cdata	long
)	O
)	O
;	O
static	O
boolean	int
ffsend_ack	function
P	O
(	O
(	O
struct	O
stransfer	struct
*	O
qtrans	pointer
,	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
)	O
)	O
;	O
static	O
int	O
cFtimeout	int
=	O
120	int
;	O
static	O
int	O
cFmaxretries	int
=	O
2	int
;	O
static	O
char	O
*	O
zFbuf	pointer
;	O
static	O
boolean	int
fFfile	int
;	O
static	O
unsigned	O
int	O
iFcheck	int
;	O
static	O
char	O
bFspecial	char
;	O
static	O
int	O
cFretries	int
;	O
static	O
boolean	int
fFacked	int
;	O
struct	O
uuconf_cmdtab	struct
asFproto_params	array
[	O
]	O
=	O
{	O
{	O
"timeout"	pointer
,	O
UUCONF_CMDTABTYPE_INT	O
,	O
(	O
pointer	pointer
)	O
&	O
cFtimeout	int
,	O
NULL	O
}	O
,	O
{	O
"retries"	pointer
,	O
UUCONF_CMDTABTYPE_INT	O
,	O
(	O
pointer	pointer
)	O
&	O
cFmaxretries	int
,	O
NULL	O
}	O
,	O
{	O
NULL	O
,	O
0	int
,	O
NULL	O
,	O
NULL	O
}	O
}	O
;	O
static	O
long	O
cFsent_data	long
;	O
static	O
long	O
cFsent_bytes	long
;	O
static	O
long	O
cFrec_data	long
;	O
static	O
long	O
cFrec_bytes	long
;	O
static	O
long	O
cFsend_retries	long
;	O
static	O
long	O
cFrec_retries	long
;	O
boolean	int
ffstart	function
(	O
qdaemon	pointer
,	O
pzlog	pointer
)	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
char	O
*	O
*	O
pzlog	pointer
;	O
{	O
*	O
pzlog	pointer
=	O
NULL	O
;	O
cFsent_data	long
=	O
0	int
;	O
cFsent_bytes	long
=	O
0	int
;	O
cFrec_data	long
=	O
0	int
;	O
cFrec_bytes	long
=	O
0	int
;	O
cFsend_retries	long
=	O
0	int
;	O
cFrec_retries	long
=	O
0	int
;	O
if	O
(	O
!	O
fconn_set	function
(	O
qdaemon	pointer
->	O
qconn	pointer
,	O
PARITYSETTING_DEFAULT	int
,	O
STRIPSETTING_SEVENBITS	int
,	O
XONXOFF_ON	int
)	O
)	O
return	O
FALSE	O
;	O
usysdep_sleep	function
(	O
2	int
)	O
;	O
return	O
TRUE	O
;	O
}	O
boolean	int
ffshutdown	function
(	O
qdaemon	pointer
)	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
ATTRIBUTE_UNUSED	O
;	O
{	O
xfree	function
(	O
(	O
pointer	pointer
)	O
zFbuf	pointer
)	O
;	O
zFbuf	pointer
=	O
NULL	O
;	O
ulog	function
(	O
LOG_NORMAL	int
,	O
"Protocol 'f': sent %ld bytes for %ld, received %ld bytes for %ld"	pointer
,	O
cFsent_bytes	long
,	O
cFsent_data	long
,	O
cFrec_bytes	long
,	O
cFrec_data	long
)	O
;	O
if	O
(	O
cFsend_retries	long
!=	O
0	int
||	O
cFrec_retries	long
!=	O
0	int
)	O
ulog	function
(	O
LOG_NORMAL	int
,	O
"Protocol 'f' file retries: %ld sending, %ld receiving"	pointer
,	O
cFsend_retries	long
,	O
cFrec_retries	long
)	O
;	O
cFtimeout	int
=	O
120	int
;	O
cFmaxretries	int
=	O
2	int
;	O
return	O
TRUE	O
;	O
}	O
boolean	int
ffsendcmd	function
(	O
qdaemon	pointer
,	O
z	pointer
,	O
ilocal	int
,	O
iremote	int
)	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
const	O
char	O
*	O
z	pointer
;	O
int	O
ilocal	int
ATTRIBUTE_UNUSED	O
;	O
int	O
iremote	int
ATTRIBUTE_UNUSED	O
;	O
{	O
size_t	long
clen	long
;	O
char	O
*	O
zalc	pointer
;	O
boolean	int
fret	int
;	O
DEBUG_MESSAGE1	O
(	O
DEBUG_UUCP_PROTO	O
,	O
"ffsendcmd: Sending command \"%s\""	pointer
,	O
z	pointer
)	O
;	O
clen	long
=	O
strlen	function
(	O
z	pointer
)	O
;	O
zalc	pointer
=	O
zbufalc	function
(	O
clen	long
+	O
2	int
)	O
;	O
memcpy	function
(	O
zalc	pointer
,	O
z	pointer
,	O
clen	long
)	O
;	O
zalc	pointer
[	O
clen	long
]	O
=	O
'\r'	O
;	O
zalc	pointer
[	O
clen	long
+	O
1	int
]	O
=	O
'\0'	O
;	O
fret	int
=	O
fsend_data	function
(	O
qdaemon	pointer
->	O
qconn	pointer
,	O
zalc	pointer
,	O
clen	long
+	O
1	int
,	O
TRUE	O
)	O
;	O
ubuffree	function
(	O
zalc	pointer
)	O
;	O
return	O
fret	int
;	O
}	O
char	O
*	O
zfgetspace	function
(	O
qdaemon	pointer
,	O
pclen	pointer
)	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
ATTRIBUTE_UNUSED	O
;	O
size_t	long
*	O
pclen	pointer
;	O
{	O
*	O
pclen	pointer
=	O
CFBUFSIZE	O
;	O
if	O
(	O
zFbuf	pointer
==	O
NULL	O
)	O
zFbuf	pointer
=	O
(	O
char	O
*	O
)	O
xmalloc	function
(	O
CFBUFSIZE	O
)	O
;	O
return	O
zFbuf	pointer
;	O
}	O
boolean	int
ffsenddata	function
(	O
qdaemon	pointer
,	O
zdata	pointer
,	O
cdata	long
,	O
ilocal	int
,	O
iremote	int
,	O
ipos	long
)	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
char	O
*	O
zdata	pointer
;	O
size_t	long
cdata	long
;	O
int	O
ilocal	int
ATTRIBUTE_UNUSED	O
;	O
int	O
iremote	int
ATTRIBUTE_UNUSED	O
;	O
long	O
ipos	long
ATTRIBUTE_UNUSED	O
;	O
{	O
char	O
ab	array
[	O
CFBUFSIZE	O
*	O
2	int
]	O
;	O
char	O
*	O
ze	pointer
;	O
register	O
unsigned	O
int	O
itmpchk	int
;	O
cFsent_data	long
+=	O
cdata	long
;	O
ze	pointer
=	O
ab	array
;	O
itmpchk	int
=	O
iFcheck	int
;	O
while	O
(	O
cdata	long
--	O
>	O
0	int
)	O
{	O
register	O
int	O
b	int
;	O
if	O
(	O
(	O
itmpchk	int
&	O
0x8000	int
)	O
==	O
0	int
)	O
itmpchk	int
<<=	O
1	int
;	O
else	O
{	O
itmpchk	int
<<=	O
1	int
;	O
++	O
itmpchk	int
;	O
}	O
b	int
=	O
*	O
zdata	pointer
++	O
&	O
0xff	int
;	O
itmpchk	int
+=	O
b	int
;	O
if	O
(	O
b	int
<=	O
0177	int
)	O
{	O
if	O
(	O
b	int
<=	O
037	int
)	O
{	O
*	O
ze	pointer
++	O
=	O
'\172'	O
;	O
*	O
ze	pointer
++	O
=	O
(	O
char	O
)	O
(	O
b	int
+	O
0100	int
)	O
;	O
}	O
else	O
if	O
(	O
b	int
<=	O
0171	int
)	O
*	O
ze	pointer
++	O
=	O
(	O
char	O
)	O
b	int
;	O
else	O
{	O
*	O
ze	pointer
++	O
=	O
'\173'	O
;	O
*	O
ze	pointer
++	O
=	O
(	O
char	O
)	O
(	O
b	int
-	O
0100	int
)	O
;	O
}	O
}	O
else	O
{	O
if	O
(	O
b	int
<=	O
0237	int
)	O
{	O
*	O
ze	pointer
++	O
=	O
'\174'	O
;	O
*	O
ze	pointer
++	O
=	O
(	O
char	O
)	O
(	O
b	int
-	O
0100	int
)	O
;	O
}	O
else	O
if	O
(	O
b	int
<=	O
0371	int
)	O
{	O
*	O
ze	pointer
++	O
=	O
'\175'	O
;	O
*	O
ze	pointer
++	O
=	O
(	O
char	O
)	O
(	O
b	int
-	O
0200	int
)	O
;	O
}	O
else	O
{	O
*	O
ze	pointer
++	O
=	O
'\176'	O
;	O
*	O
ze	pointer
++	O
=	O
(	O
char	O
)	O
(	O
b	int
-	O
0300	int
)	O
;	O
}	O
}	O
}	O
iFcheck	int
=	O
itmpchk	int
;	O
cFsent_bytes	long
+=	O
ze	pointer
-	O
ab	array
;	O
return	O
fsend_data	function
(	O
qdaemon	pointer
->	O
qconn	pointer
,	O
ab	array
,	O
(	O
size_t	long
)	O
(	O
ze	pointer
-	O
ab	array
)	O
,	O
FALSE	O
)	O
;	O
}	O
static	O
boolean	int
ffprocess_data	function
(	O
qdaemon	pointer
,	O
pfexit	pointer
,	O
pcneed	pointer
)	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
boolean	int
*	O
pfexit	pointer
;	O
size_t	long
*	O
pcneed	pointer
;	O
{	O
int	O
i	int
;	O
register	O
unsigned	O
int	O
itmpchk	int
;	O
*	O
pfexit	pointer
=	O
FALSE	O
;	O
if	O
(	O
pcneed	pointer
!=	O
NULL	O
)	O
*	O
pcneed	pointer
=	O
1	int
;	O
if	O
(	O
!	O
fFfile	int
)	O
{	O
while	O
(	O
iPrecstart	int
!=	O
iPrecend	int
)	O
{	O
for	O
(	O
i	int
=	O
iPrecstart	int
;	O
i	int
<	O
CRECBUFLEN	O
&&	O
i	int
!=	O
iPrecend	int
;	O
i	int
++	O
)	O
{	O
abPrecbuf	array
[	O
i	int
]	O
&=	O
0x7f	int
;	O
if	O
(	O
abPrecbuf	array
[	O
i	int
]	O
==	O
'\r'	O
)	O
{	O
int	O
istart	int
;	O
DEBUG_MESSAGE1	O
(	O
DEBUG_PROTO	O
,	O
"ffprocess_data: Got %d command bytes"	pointer
,	O
i	int
-	O
iPrecstart	int
+	O
1	int
)	O
;	O
abPrecbuf	array
[	O
i	int
]	O
=	O
'\0'	O
;	O
istart	int
=	O
iPrecstart	int
;	O
iPrecstart	int
=	O
(	O
i	int
+	O
1	int
)	O
%	O
CRECBUFLEN	O
;	O
if	O
(	O
pcneed	pointer
!=	O
NULL	O
)	O
*	O
pcneed	pointer
=	O
0	int
;	O
return	O
fgot_data	function
(	O
qdaemon	pointer
,	O
abPrecbuf	array
+	O
istart	int
,	O
(	O
size_t	long
)	O
(	O
i	int
-	O
istart	int
+	O
1	int
)	O
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
(	O
size_t	long
)	O
0	int
,	O
-	O
1	int
,	O
-	O
1	int
,	O
(	O
long	O
)	O
-	O
1	int
,	O
TRUE	O
,	O
pfexit	pointer
)	O
;	O
}	O
}	O
DEBUG_MESSAGE1	O
(	O
DEBUG_PROTO	O
,	O
"ffprocess_data: Got %d command bytes"	pointer
,	O
i	int
-	O
iPrecstart	int
)	O
;	O
if	O
(	O
!	O
fgot_data	function
(	O
qdaemon	pointer
,	O
abPrecbuf	array
+	O
iPrecstart	int
,	O
(	O
size_t	long
)	O
(	O
i	int
-	O
iPrecstart	int
)	O
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
(	O
size_t	long
)	O
0	int
,	O
-	O
1	int
,	O
-	O
1	int
,	O
(	O
long	O
)	O
-	O
1	int
,	O
TRUE	O
,	O
pfexit	pointer
)	O
)	O
return	O
FALSE	O
;	O
iPrecstart	int
=	O
i	int
%	O
CRECBUFLEN	O
;	O
}	O
return	O
TRUE	O
;	O
}	O
itmpchk	int
=	O
iFcheck	int
;	O
while	O
(	O
iPrecstart	int
!=	O
iPrecend	int
)	O
{	O
char	O
*	O
zstart	pointer
,	O
*	O
zto	pointer
,	O
*	O
zfrom	pointer
;	O
int	O
c	long
;	O
zto	pointer
=	O
zfrom	pointer
=	O
zstart	pointer
=	O
abPrecbuf	array
+	O
iPrecstart	int
;	O
c	long
=	O
iPrecend	int
-	O
iPrecstart	int
;	O
if	O
(	O
c	long
<	O
0	int
)	O
c	long
=	O
CRECBUFLEN	O
-	O
iPrecstart	int
;	O
while	O
(	O
c	long
--	O
!=	O
0	int
)	O
{	O
int	O
b	int
;	O
b	int
=	O
*	O
zfrom	pointer
++	O
&	O
0x7f	int
;	O
if	O
(	O
b	int
<	O
040	int
||	O
b	int
>	O
0176	int
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"Illegal byte %d"	pointer
,	O
b	int
)	O
;	O
continue	O
;	O
}	O
if	O
(	O
b	int
>=	O
0172	int
)	O
{	O
if	O
(	O
bFspecial	char
!=	O
0	int
)	O
{	O
if	O
(	O
bFspecial	char
!=	O
0176	int
||	O
b	int
!=	O
0176	int
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"Illegal bytes %d %d"	pointer
,	O
bFspecial	char
,	O
b	int
)	O
;	O
bFspecial	char
=	O
0	int
;	O
continue	O
;	O
}	O
if	O
(	O
zto	pointer
!=	O
zstart	pointer
)	O
{	O
cFrec_bytes	long
+=	O
zfrom	pointer
-	O
zstart	pointer
-	O
2	int
;	O
cFrec_data	long
+=	O
zto	pointer
-	O
zstart	pointer
;	O
if	O
(	O
!	O
fgot_data	function
(	O
qdaemon	pointer
,	O
zstart	pointer
,	O
(	O
size_t	long
)	O
(	O
zto	pointer
-	O
zstart	pointer
)	O
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
(	O
size_t	long
)	O
0	int
,	O
-	O
1	int
,	O
-	O
1	int
,	O
(	O
long	O
)	O
-	O
1	int
,	O
TRUE	O
,	O
pfexit	pointer
)	O
)	O
return	O
FALSE	O
;	O
}	O
iPrecstart	int
=	O
(	O
iPrecstart	int
+	O
zfrom	pointer
-	O
zstart	pointer
)	O
%	O
CRECBUFLEN	O
;	O
iFcheck	int
=	O
itmpchk	int
;	O
if	O
(	O
pcneed	pointer
!=	O
NULL	O
)	O
*	O
pcneed	pointer
=	O
0	int
;	O
return	O
fgot_data	function
(	O
qdaemon	pointer
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
(	O
size_t	long
)	O
0	int
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
(	O
size_t	long
)	O
0	int
,	O
-	O
1	int
,	O
-	O
1	int
,	O
(	O
long	O
)	O
-	O
1	int
,	O
TRUE	O
,	O
pfexit	pointer
)	O
;	O
}	O
bFspecial	char
=	O
(	O
char	O
)	O
b	int
;	O
}	O
else	O
{	O
int	O
bnext	int
;	O
switch	O
(	O
bFspecial	char
)	O
{	O
default	O
:	O
bnext	int
=	O
b	int
;	O
break	O
;	O
case	O
0172	int
:	O
bnext	int
=	O
b	int
-	O
0100	int
;	O
break	O
;	O
case	O
0173	int
:	O
case	O
0174	int
:	O
bnext	int
=	O
b	int
+	O
0100	int
;	O
break	O
;	O
case	O
0175	int
:	O
bnext	int
=	O
b	int
+	O
0200	int
;	O
break	O
;	O
case	O
0176	int
:	O
bnext	int
=	O
b	int
+	O
0300	int
;	O
break	O
;	O
}	O
*	O
zto	pointer
++	O
=	O
(	O
char	O
)	O
bnext	int
;	O
bFspecial	char
=	O
0	int
;	O
if	O
(	O
(	O
itmpchk	int
&	O
0x8000	int
)	O
==	O
0	int
)	O
itmpchk	int
<<=	O
1	int
;	O
else	O
{	O
itmpchk	int
<<=	O
1	int
;	O
++	O
itmpchk	int
;	O
}	O
itmpchk	int
+=	O
bnext	int
;	O
}	O
}	O
if	O
(	O
zto	pointer
!=	O
zstart	pointer
)	O
{	O
DEBUG_MESSAGE1	O
(	O
DEBUG_PROTO	O
,	O
"ffprocess_data: Got %d bytes"	pointer
,	O
zto	pointer
-	O
zstart	pointer
)	O
;	O
cFrec_data	long
+=	O
zto	pointer
-	O
zstart	pointer
;	O
if	O
(	O
!	O
fgot_data	function
(	O
qdaemon	pointer
,	O
zstart	pointer
,	O
(	O
size_t	long
)	O
(	O
zto	pointer
-	O
zstart	pointer
)	O
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
(	O
size_t	long
)	O
0	int
,	O
-	O
1	int
,	O
-	O
1	int
,	O
(	O
long	O
)	O
-	O
1	int
,	O
TRUE	O
,	O
pfexit	pointer
)	O
)	O
return	O
FALSE	O
;	O
}	O
cFrec_bytes	long
+=	O
zfrom	pointer
-	O
zstart	pointer
;	O
iPrecstart	int
=	O
(	O
iPrecstart	int
+	O
zfrom	pointer
-	O
zstart	pointer
)	O
%	O
CRECBUFLEN	O
;	O
}	O
iFcheck	int
=	O
itmpchk	int
;	O
if	O
(	O
pcneed	pointer
!=	O
NULL	O
)	O
{	O
if	O
(	O
bFspecial	char
==	O
0176	int
)	O
*	O
pcneed	pointer
=	O
6	int
;	O
else	O
*	O
pcneed	pointer
=	O
7	int
;	O
}	O
return	O
TRUE	O
;	O
}	O
boolean	int
ffwait	function
(	O
qdaemon	pointer
)	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
{	O
while	O
(	O
TRUE	O
)	O
{	O
boolean	int
fexit	int
;	O
size_t	long
cneed	long
,	O
crec	long
;	O
if	O
(	O
!	O
ffprocess_data	function
(	O
qdaemon	pointer
,	O
&	O
fexit	int
,	O
&	O
cneed	long
)	O
)	O
return	O
FALSE	O
;	O
if	O
(	O
fexit	int
)	O
return	O
TRUE	O
;	O
if	O
(	O
cneed	long
>	O
0	int
)	O
{	O
if	O
(	O
!	O
freceive_data	function
(	O
qdaemon	pointer
->	O
qconn	pointer
,	O
cneed	long
,	O
&	O
crec	long
,	O
cFtimeout	int
,	O
TRUE	O
)	O
)	O
return	O
FALSE	O
;	O
if	O
(	O
crec	long
==	O
0	int
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"Timed out waiting for data"	pointer
)	O
;	O
return	O
FALSE	O
;	O
}	O
}	O
}	O
}	O
boolean	int
fffile	function
(	O
qdaemon	pointer
,	O
qtrans	pointer
,	O
fstart	int
,	O
fsend	int
,	O
cbytes	long
,	O
pfhandled	pointer
)	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
struct	O
stransfer	struct
*	O
qtrans	pointer
;	O
boolean	int
fstart	int
;	O
boolean	int
fsend	int
;	O
long	O
cbytes	long
ATTRIBUTE_UNUSED	O
;	O
boolean	int
*	O
pfhandled	pointer
;	O
{	O
DEBUG_MESSAGE3	O
(	O
DEBUG_PROTO	O
,	O
"fffile: fstart %s; fsend %s; fFacked %s"	pointer
,	O
fstart	int
?	O
"true"	pointer
:	O
"false"	pointer
,	O
fsend	int
?	O
"true"	pointer
:	O
"false"	pointer
,	O
fFacked	int
?	O
"true"	pointer
:	O
"false"	pointer
)	O
;	O
*	O
pfhandled	pointer
=	O
FALSE	O
;	O
if	O
(	O
fstart	int
)	O
{	O
iFcheck	int
=	O
0xffff	int
;	O
cFretries	int
=	O
0	int
;	O
fFacked	int
=	O
FALSE	O
;	O
if	O
(	O
!	O
fsend	int
)	O
{	O
bFspecial	char
=	O
0	int
;	O
fFfile	int
=	O
TRUE	O
;	O
}	O
return	O
TRUE	O
;	O
}	O
else	O
{	O
struct	O
sfinfo	struct
*	O
qinfo	pointer
;	O
if	O
(	O
fFacked	int
)	O
{	O
fFacked	int
=	O
FALSE	O
;	O
return	O
TRUE	O
;	O
}	O
if	O
(	O
fsend	int
)	O
{	O
char	O
ab	array
[	O
sizeof	O
"\176\176ABCD\r"	pointer
]	O
;	O
sprintf	function
(	O
ab	array
,	O
"\176\176%04x\r"	pointer
,	O
iFcheck	int
&	O
0xffff	int
)	O
;	O
if	O
(	O
!	O
fsend_data	function
(	O
qdaemon	pointer
->	O
qconn	pointer
,	O
ab	array
,	O
(	O
size_t	long
)	O
7	int
,	O
TRUE	O
)	O
)	O
return	O
FALSE	O
;	O
fFfile	int
=	O
FALSE	O
;	O
qinfo	pointer
=	O
(	O
struct	O
sfinfo	struct
*	O
)	O
xmalloc	function
(	O
sizeof	O
(	O
struct	O
sfinfo	struct
)	O
)	O
;	O
qinfo	pointer
->	O
psendfn	pointer
=	O
qtrans	pointer
->	O
psendfn	pointer
;	O
qinfo	pointer
->	O
precfn	pointer
=	O
qtrans	pointer
->	O
precfn	pointer
;	O
qinfo	pointer
->	O
pinfo	pointer
=	O
qtrans	pointer
->	O
pinfo	pointer
;	O
qtrans	pointer
->	O
psendfn	pointer
=	O
NULL	O
;	O
qtrans	pointer
->	O
precfn	pointer
=	O
ffawait_ack	function
;	O
qtrans	pointer
->	O
pinfo	pointer
=	O
(	O
pointer	pointer
)	O
qinfo	pointer
;	O
qtrans	pointer
->	O
fcmd	int
=	O
TRUE	O
;	O
*	O
pfhandled	pointer
=	O
TRUE	O
;	O
return	O
fqueue_receive	function
(	O
qdaemon	pointer
,	O
qtrans	pointer
)	O
;	O
}	O
else	O
{	O
fFfile	int
=	O
FALSE	O
;	O
qinfo	pointer
=	O
(	O
struct	O
sfinfo	struct
*	O
)	O
xmalloc	function
(	O
sizeof	O
(	O
struct	O
sfinfo	struct
)	O
)	O
;	O
qinfo	pointer
->	O
psendfn	pointer
=	O
qtrans	pointer
->	O
psendfn	pointer
;	O
qinfo	pointer
->	O
precfn	pointer
=	O
qtrans	pointer
->	O
precfn	pointer
;	O
qinfo	pointer
->	O
pinfo	pointer
=	O
qtrans	pointer
->	O
pinfo	pointer
;	O
qtrans	pointer
->	O
psendfn	pointer
=	O
NULL	O
;	O
qtrans	pointer
->	O
precfn	pointer
=	O
ffawait_cksum	function
;	O
qtrans	pointer
->	O
pinfo	pointer
=	O
(	O
pointer	pointer
)	O
qinfo	pointer
;	O
qtrans	pointer
->	O
fcmd	int
=	O
TRUE	O
;	O
*	O
pfhandled	pointer
=	O
TRUE	O
;	O
return	O
fqueue_receive	function
(	O
qdaemon	pointer
,	O
qtrans	pointer
)	O
;	O
}	O
}	O
}	O
static	O
boolean	int
ffawait_ack	function
(	O
qtrans	pointer
,	O
qdaemon	pointer
,	O
zdata	pointer
,	O
cdata	long
)	O
struct	O
stransfer	struct
*	O
qtrans	pointer
;	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
const	O
char	O
*	O
zdata	pointer
;	O
size_t	long
cdata	long
ATTRIBUTE_UNUSED	O
;	O
{	O
struct	O
sfinfo	struct
*	O
qinfo	pointer
=	O
(	O
struct	O
sfinfo	struct
*	O
)	O
qtrans	pointer
->	O
pinfo	pointer
;	O
qtrans	pointer
->	O
precfn	pointer
=	O
NULL	O
;	O
if	O
(	O
*	O
zdata	pointer
==	O
'R'	O
)	O
{	O
if	O
(	O
!	O
ffileisopen	O
(	O
qtrans	pointer
->	O
e	pointer
)	O
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"Request to resent non-file"	pointer
)	O
;	O
return	O
FALSE	O
;	O
}	O
++	O
cFretries	int
;	O
if	O
(	O
cFretries	int
>	O
cFmaxretries	int
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"Too many retries"	pointer
)	O
;	O
return	O
FALSE	O
;	O
}	O
ulog	function
(	O
LOG_NORMAL	int
,	O
"Resending file"	pointer
)	O
;	O
if	O
(	O
!	O
ffilerewind	O
(	O
qtrans	pointer
->	O
e	pointer
)	O
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"rewind: %s"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
return	O
FALSE	O
;	O
}	O
qtrans	pointer
->	O
ipos	long
=	O
(	O
long	O
)	O
0	int
;	O
iFcheck	int
=	O
0xffff	int
;	O
++	O
cFsend_retries	long
;	O
qtrans	pointer
->	O
psendfn	pointer
=	O
qinfo	pointer
->	O
psendfn	pointer
;	O
qtrans	pointer
->	O
precfn	pointer
=	O
qinfo	pointer
->	O
precfn	pointer
;	O
qtrans	pointer
->	O
pinfo	pointer
=	O
qinfo	pointer
->	O
pinfo	pointer
;	O
xfree	function
(	O
(	O
pointer	pointer
)	O
qinfo	pointer
)	O
;	O
qtrans	pointer
->	O
fsendfile	int
=	O
TRUE	O
;	O
return	O
fqueue_send	function
(	O
qdaemon	pointer
,	O
qtrans	pointer
)	O
;	O
}	O
if	O
(	O
*	O
zdata	pointer
!=	O
'G'	O
)	O
{	O
DEBUG_MESSAGE1	O
(	O
DEBUG_PROTO	O
,	O
"fffile: Got \"%s\""	pointer
,	O
zdata	pointer
)	O
;	O
ulog	function
(	O
LOG_ERROR	int
,	O
"File send failed"	pointer
)	O
;	O
return	O
FALSE	O
;	O
}	O
qtrans	pointer
->	O
psendfn	pointer
=	O
qinfo	pointer
->	O
psendfn	pointer
;	O
qtrans	pointer
->	O
precfn	pointer
=	O
qinfo	pointer
->	O
precfn	pointer
;	O
qtrans	pointer
->	O
pinfo	pointer
=	O
qinfo	pointer
->	O
pinfo	pointer
;	O
xfree	function
(	O
(	O
pointer	pointer
)	O
qinfo	pointer
)	O
;	O
fFacked	int
=	O
TRUE	O
;	O
return	O
(	O
*	O
qtrans	pointer
->	O
psendfn	pointer
)	O
(	O
qtrans	pointer
,	O
qdaemon	pointer
)	O
;	O
}	O
static	O
boolean	int
ffawait_cksum	function
(	O
qtrans	pointer
,	O
qdaemon	pointer
,	O
zdata	pointer
,	O
cdata	long
)	O
struct	O
stransfer	struct
*	O
qtrans	pointer
;	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
const	O
char	O
*	O
zdata	pointer
;	O
size_t	long
cdata	long
ATTRIBUTE_UNUSED	O
;	O
{	O
struct	O
sfinfo	struct
*	O
qinfo	pointer
=	O
(	O
struct	O
sfinfo	struct
*	O
)	O
qtrans	pointer
->	O
pinfo	pointer
;	O
unsigned	O
int	O
icheck	int
;	O
qtrans	pointer
->	O
precfn	pointer
=	O
NULL	O
;	O
if	O
(	O
!	O
isxdigit	function
(	O
zdata	pointer
[	O
0	int
]	O
)	O
||	O
!	O
isxdigit	function
(	O
zdata	pointer
[	O
1	int
]	O
)	O
||	O
!	O
isxdigit	function
(	O
zdata	pointer
[	O
2	int
]	O
)	O
||	O
!	O
isxdigit	function
(	O
zdata	pointer
[	O
3	int
]	O
)	O
||	O
zdata	pointer
[	O
4	int
]	O
!=	O
'\0'	O
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"Bad checksum format"	pointer
)	O
;	O
xfree	function
(	O
qtrans	pointer
->	O
pinfo	pointer
)	O
;	O
return	O
FALSE	O
;	O
}	O
icheck	int
=	O
(	O
unsigned	O
int	O
)	O
strtol	function
(	O
(	O
char	O
*	O
)	O
zdata	pointer
,	O
(	O
char	O
*	O
*	O
)	O
NULL	O
,	O
16	int
)	O
;	O
if	O
(	O
icheck	int
!=	O
(	O
iFcheck	int
&	O
0xffff	int
)	O
)	O
{	O
DEBUG_MESSAGE2	O
(	O
DEBUG_PROTO	O
|	O
DEBUG_ABNORMAL	O
,	O
"Checksum failed; calculated 0x%x, got 0x%x"	pointer
,	O
iFcheck	int
&	O
0xffff	int
,	O
icheck	int
)	O
;	O
if	O
(	O
!	O
ffileisopen	O
(	O
qtrans	pointer
->	O
e	pointer
)	O
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"Failed to get non-file"	pointer
)	O
;	O
return	O
FALSE	O
;	O
}	O
++	O
cFretries	int
;	O
if	O
(	O
cFretries	int
>	O
cFmaxretries	int
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"Too many retries"	pointer
)	O
;	O
qinfo	pointer
->	O
bsend	char
=	O
'Q'	O
;	O
}	O
else	O
{	O
ulog	function
(	O
LOG_NORMAL	int
,	O
"File being resent"	pointer
)	O
;	O
qtrans	pointer
->	O
e	pointer
=	O
esysdep_truncate	function
(	O
qtrans	pointer
->	O
e	pointer
,	O
qtrans	pointer
->	O
s	struct
.	O
ztemp	pointer
)	O
;	O
if	O
(	O
!	O
ffileisopen	O
(	O
qtrans	pointer
->	O
e	pointer
)	O
)	O
return	O
FALSE	O
;	O
qtrans	pointer
->	O
ipos	long
=	O
(	O
long	O
)	O
0	int
;	O
iFcheck	int
=	O
0xffff	int
;	O
bFspecial	char
=	O
0	int
;	O
fFfile	int
=	O
TRUE	O
;	O
++	O
cFrec_retries	long
;	O
qinfo	pointer
->	O
bsend	char
=	O
'R'	O
;	O
}	O
}	O
else	O
{	O
qinfo	pointer
->	O
bsend	char
=	O
'G'	O
;	O
}	O
qtrans	pointer
->	O
psendfn	pointer
=	O
ffsend_ack	function
;	O
return	O
fqueue_send	function
(	O
qdaemon	pointer
,	O
qtrans	pointer
)	O
;	O
}	O
static	O
boolean	int
ffsend_ack	function
(	O
qtrans	pointer
,	O
qdaemon	pointer
)	O
struct	O
stransfer	struct
*	O
qtrans	pointer
;	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
{	O
struct	O
sfinfo	struct
*	O
qinfo	pointer
=	O
(	O
struct	O
sfinfo	struct
*	O
)	O
qtrans	pointer
->	O
pinfo	pointer
;	O
char	O
ab	array
[	O
2	int
]	O
;	O
ab	array
[	O
0	int
]	O
=	O
qinfo	pointer
->	O
bsend	char
;	O
ab	array
[	O
1	int
]	O
=	O
'\0'	O
;	O
if	O
(	O
!	O
ffsendcmd	function
(	O
qdaemon	pointer
,	O
ab	array
,	O
0	int
,	O
0	int
)	O
)	O
return	O
FALSE	O
;	O
qtrans	pointer
->	O
psendfn	pointer
=	O
qinfo	pointer
->	O
psendfn	pointer
;	O
qtrans	pointer
->	O
precfn	pointer
=	O
qinfo	pointer
->	O
precfn	pointer
;	O
qtrans	pointer
->	O
pinfo	pointer
=	O
qinfo	pointer
->	O
pinfo	pointer
;	O
xfree	function
(	O
(	O
pointer	pointer
)	O
qinfo	pointer
)	O
;	O
if	O
(	O
ab	array
[	O
0	int
]	O
==	O
'Q'	O
)	O
return	O
FALSE	O
;	O
if	O
(	O
ab	array
[	O
0	int
]	O
==	O
'R'	O
)	O
{	O
qtrans	pointer
->	O
frecfile	int
=	O
TRUE	O
;	O
return	O
fqueue_receive	function
(	O
qdaemon	pointer
,	O
qtrans	pointer
)	O
;	O
}	O
fFacked	int
=	O
TRUE	O
;	O
return	O
(	O
*	O
qtrans	pointer
->	O
precfn	pointer
)	O
(	O
qtrans	pointer
,	O
qdaemon	pointer
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
(	O
size_t	long
)	O
0	int
)	O
;	O
}	O
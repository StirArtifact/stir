void	O
recfmt_parse_args	function
(	O
int	O
argc	int
,	O
char	O
*	O
*	O
argv	*
)	O
;	O
bool	bool
recfmt_process_data	function
(	O
rec_db_t	*
db	*
)	O
;	O
void	O
recfmt_process_db	function
(	O
rec_db_t	*
db	*
,	O
char	O
*	O
template	struct
)	O
;	O
char	O
*	O
recfmt_apply_template	function
(	O
rec_record_t	*
record	*
,	O
char	O
*	O
template	*
)	O
;	O
char	O
*	O
recfmt_get_subst	function
(	O
rec_record_t	*
record	*
,	O
char	O
*	O
str	*
)	O
;	O
char	O
*	O
recfmt_template	*
=	O
NULL	O
;	O
enum	O
{	O
COMMON_ARGS	O
,	O
FILE_ARG	int
}	O
;	O
static	O
const	O
struct	O
option	struct
GNU_longOptions	array
[	O
]	O
=	O
{	O
COMMON_LONG_ARGS	O
,	O
{	O
"file"	*
,	O
required_argument	int
,	O
NULL	O
,	O
FILE_ARG	int
}	O
,	O
{	O
NULL	O
,	O
0	int
,	O
NULL	O
,	O
0	int
}	O
}	O
;	O
void	O
recutl_print_help	function
(	O
void	O
)	O
{	O
printf	function
(	O
_	O
(	O
"Usage: recfmt [OPTION]... [TEMPLATE]\n"	*
)	O
)	O
;	O
fputs	function
(	O
_	O
(	O
"Apply a template to records read from standard input.\n"	*
)	O
,	O
stdout	*
)	O
;	O
puts	function
(	O
""	*
)	O
;	O
fputs	function
(	O
_	O
(	O
"  -f, --file=FILENAME                 read the template to apply from a file.\n"	*
)	O
,	O
stdout	*
)	O
;	O
recutl_print_help_common	function
(	O
)	O
;	O
puts	function
(	O
""	*
)	O
;	O
recutl_print_help_footer	function
(	O
)	O
;	O
}	O
void	O
recfmt_parse_args	function
(	O
int	O
argc	int
,	O
char	O
*	O
*	O
argv	*
)	O
{	O
char	O
c	int
;	O
int	O
ret	int
;	O
while	O
(	O
(	O
ret	int
=	O
getopt_long	function
(	O
argc	int
,	O
argv	*
,	O
"f:"	*
,	O
GNU_longOptions	array
,	O
NULL	O
)	O
)	O
!=	O
-	O
1	int
)	O
{	O
c	int
=	O
ret	int
;	O
switch	O
(	O
c	int
)	O
{	O
COMMON_ARGS_CASES	O
case	O
FILE_ARG	int
:	O
case	O
'f'	O
:	O
{	O
recfmt_template	*
=	O
recutl_read_file	function
(	O
optarg	*
)	O
;	O
if	O
(	O
!	O
recfmt_template	int
)	O
{	O
recutl_fatal	function
(	O
_	O
(	O
"can't open file %s for reading.\n"	*
)	O
,	O
optarg	*
)	O
;	O
}	O
break	O
;	O
}	O
default	O
:	O
{	O
exit	function
(	O
EXIT_FAILURE	int
)	O
;	O
}	O
}	O
}	O
if	O
(	O
optind	int
<	O
argc	int
)	O
{	O
if	O
(	O
recfmt_template	int
)	O
{	O
recutl_fatal	function
(	O
_	O
(	O
"don't specify a template in the command line and -f at the same time.\n"	*
)	O
)	O
;	O
}	O
if	O
(	O
(	O
argc	int
-	O
optind	int
)	O
!=	O
1	int
)	O
{	O
recutl_print_help	function
(	O
)	O
;	O
exit	function
(	O
EXIT_FAILURE	int
)	O
;	O
}	O
recfmt_template	*
=	O
xstrdup	function
(	O
argv	*
[	O
optind	int
++	O
]	O
)	O
;	O
}	O
}	O
char	O
*	O
recfmt_get_subst	function
(	O
rec_record_t	*
record	*
,	O
char	O
*	O
str	*
)	O
{	O
char	O
*	O
res	*
;	O
rec_sex_t	*
sex	*
;	O
sex	enum
=	O
rec_sex_new	function
(	O
false	int
)	O
;	O
if	O
(	O
!	O
rec_sex_compile	function
(	O
sex	*
,	O
str	*
)	O
)	O
{	O
recutl_fatal	function
(	O
_	O
(	O
"invalid expression in a template slot.\n"	*
)	O
)	O
;	O
}	O
res	int
=	O
rec_sex_eval_str	function
(	O
sex	*
,	O
record	*
)	O
;	O
if	O
(	O
!	O
res	*
)	O
{	O
recutl_fatal	function
(	O
_	O
(	O
"error evaluating expression in a template slot.\n"	*
)	O
)	O
;	O
}	O
rec_sex_destroy	function
(	O
sex	*
)	O
;	O
return	O
res	*
;	O
}	O
char	O
*	O
recfmt_apply_template	function
(	O
rec_record_t	*
record	*
,	O
char	O
*	O
template	*
)	O
{	O
rec_buf_t	struct
result_buf	struct
;	O
char	O
*	O
result	*
;	O
char	O
*	O
tmp	*
;	O
size_t	long
tmp_size	long
;	O
size_t	long
result_size	long
;	O
char	O
*	O
p	*
;	O
regex_t	struct
regexp	*
;	O
regmatch_t	struct
matches	*
;	O
char	O
*	O
subst_str	*
;	O
if	O
(	O
regcomp	function
(	O
&	O
regexp	struct
,	O
"\\{\\{"	*
"[^}]*"	*
"\\}\\}"	*
,	O
REG_EXTENDED	int
)	O
!=	O
0	int
)	O
{	O
recutl_fatal	function
(	O
_	O
(	O
"recfmt_apply_template: error compiling regexp. Please report this.\n"	*
)	O
)	O
;	O
}	O
result_buf	struct
=	O
rec_buf_new	function
(	O
&	O
result	*
,	O
&	O
result_size	struct
)	O
;	O
p	*
=	O
template	struct
;	O
while	O
(	O
*	O
p	*
&&	O
(	O
regexec	function
(	O
&	O
regexp	O
,	O
p	*
,	O
1	int
,	O
&	O
matches	*
,	O
0	int
)	O
==	O
0	int
)	O
&&	O
(	O
matches	struct
.	O
rm_so	int
!=	O
-	O
1	int
)	O
)	O
{	O
if	O
(	O
matches	struct
.	O
rm_so	int
>	O
0	int
)	O
{	O
tmp	*
=	O
xmalloc	function
(	O
matches	struct
.	O
rm_so	int
+	O
1	int
)	O
;	O
memcpy	function
(	O
tmp	*
,	O
p	*
,	O
matches	struct
.	O
rm_so	int
)	O
;	O
tmp	*
[	O
matches	struct
.	O
rm_so	int
]	O
=	O
'\0'	O
;	O
rec_buf_puts	function
(	O
tmp	*
,	O
result_buf	struct
)	O
;	O
free	function
(	O
tmp	*
)	O
;	O
}	O
tmp_size	int
=	O
matches	struct
.	O
rm_eo	int
-	O
matches	struct
.	O
rm_so	int
-	O
4	int
;	O
tmp	*
=	O
xmalloc	function
(	O
tmp_size	long
+	O
1	int
)	O
;	O
memcpy	function
(	O
tmp	*
,	O
p	*
+	O
matches	struct
.	O
rm_so	int
+	O
2	int
,	O
tmp_size	int
)	O
;	O
tmp	*
[	O
tmp_size	int
]	O
=	O
'\0'	O
;	O
p	*
=	O
p	*
+	O
matches	struct
.	O
rm_eo	int
;	O
subst_str	*
=	O
recfmt_get_subst	function
(	O
record	*
,	O
tmp	*
)	O
;	O
if	O
(	O
subst_str	*
)	O
{	O
rec_buf_puts	function
(	O
subst_str	*
,	O
result_buf	struct
)	O
;	O
free	function
(	O
subst_str	*
)	O
;	O
}	O
free	function
(	O
tmp	*
)	O
;	O
}	O
if	O
(	O
*	O
p	*
)	O
{	O
rec_buf_puts	function
(	O
p	*
,	O
result_buf	struct
)	O
;	O
}	O
rec_buf_close	function
(	O
result_buf	struct
)	O
;	O
return	O
result	*
;	O
}	O
void	O
recfmt_process_db	function
(	O
rec_db_t	*
db	*
,	O
char	O
*	O
template	struct
)	O
{	O
size_t	long
n_rset	long
;	O
rec_rset_t	*
rset	*
;	O
rec_record_t	*
record	*
;	O
char	O
*	O
result	*
;	O
rec_mset_iterator_t	struct
iter	struct
;	O
for	O
(	O
n_rset	long
=	O
0	int
;	O
n_rset	long
<	O
rec_db_size	O
(	O
db	*
)	O
;	O
n_rset	long
++	O
)	O
{	O
rset	*
=	O
rec_db_get_rset	function
(	O
db	*
,	O
n_rset	long
)	O
;	O
iter	struct
=	O
rec_mset_iterator	function
(	O
rec_rset_mset	function
(	O
rset	*
)	O
)	O
;	O
while	O
(	O
rec_mset_iterator_next	function
(	O
&	O
iter	struct
,	O
MSET_RECORD	int
,	O
(	O
const	O
void	O
*	O
*	O
)	O
&	O
record	*
,	O
NULL	O
)	O
)	O
{	O
result	*
=	O
recfmt_apply_template	function
(	O
record	*
,	O
template	struct
)	O
;	O
if	O
(	O
result	*
&&	O
(	O
*	O
result	*
!=	O
'\0'	O
)	O
)	O
{	O
printf	function
(	O
"%s"	*
,	O
result	*
)	O
;	O
free	function
(	O
result	*
)	O
;	O
}	O
}	O
rec_mset_iterator_free	function
(	O
&	O
iter	struct
)	O
;	O
}	O
}	O
int	O
main	function
(	O
int	O
argc	int
,	O
char	O
*	O
argv	*
[	O
]	O
)	O
{	O
rec_db_t	*
db	*
;	O
recutl_init	function
(	O
"recfmt"	*
)	O
;	O
recfmt_parse_args	function
(	O
argc	int
,	O
argv	*
)	O
;	O
db	*
=	O
recutl_read_db_from_file	function
(	O
NULL	O
)	O
;	O
if	O
(	O
db	*
&&	O
recfmt_template	*
)	O
{	O
recfmt_process_db	function
(	O
db	*
,	O
recfmt_template	*
)	O
;	O
}	O
return	O
EXIT_SUCCESS	int
;	O
}	O
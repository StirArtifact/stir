void	O
dologin	function
(	O
struct	O
passwd	struct
*	O
pw	*
,	O
struct	O
sockaddr_in	struct
*	O
sin	*
)	O
;	O
struct	O
sockaddr_in	struct
hisctladdr	struct
;	O
int	O
hisaddrlen	int
=	O
sizeof	O
hisctladdr	*
;	O
struct	O
sockaddr_in	struct
myctladdr	struct
;	O
int	O
mypid	int
;	O
char	O
Username	array
[	O
64	int
]	O
;	O
char	O
*	O
nenv	array
[	O
]	O
=	O
{	O
Username	*
,	O
NULL	O
,	O
}	O
;	O
extern	O
char	O
*	O
*	O
environ	*
;	O
static	O
struct	O
argp	struct
argp	struct
=	O
{	O
NULL	O
,	O
NULL	O
,	O
NULL	O
,	O
"TCP/IP server for uucico"	function
}	O
;	O
int	O
main	function
(	O
int	O
argc	int
,	O
char	O
*	O
*	O
argv	*
)	O
{	O
register	O
int	O
s	*
;	O
struct	O
servent	struct
*	O
sp	*
;	O
void	O
dologout	function
(	O
void	O
)	O
;	O
set_program_name	function
(	O
argv	*
[	O
0	int
]	O
)	O
;	O
iu_argp_init	O
(	O
"uucpd"	*
,	O
default_program_authors	array
)	O
;	O
argp_parse	function
(	O
&	O
argp	struct
,	O
argc	int
,	O
argv	*
,	O
0	int
,	O
NULL	O
,	O
NULL	O
)	O
;	O
environ	*
=	O
nenv	*
;	O
sp	*
=	O
getservbyname	function
(	O
"uucp"	*
,	O
"tcp"	*
)	O
;	O
if	O
(	O
sp	*
==	O
NULL	O
)	O
{	O
perror	function
(	O
"uucpd: getservbyname"	*
)	O
;	O
exit	function
(	O
EXIT_FAILURE	int
)	O
;	O
}	O
if	O
(	O
fork	function
(	O
)	O
)	O
exit	function
(	O
EXIT_SUCCESS	int
)	O
;	O
if	O
(	O
(	O
s	*
=	O
open	function
(	O
PATH_TTY	int
,	O
O_RDWR	int
)	O
)	O
>=	O
0	int
)	O
{	O
ioctl	function
(	O
s	int
,	O
TIOCNOTTY	int
,	O
(	O
char	O
*	O
)	O
0	int
)	O
;	O
close	function
(	O
s	int
)	O
;	O
}	O
memset	function
(	O
&	O
myctladdr	struct
,	O
0	int
,	O
sizeof	O
(	O
myctladdr	struct
)	O
)	O
;	O
myctladdr	struct
.	O
sin_family	short
=	O
AF_INET	O
;	O
myctladdr	struct
.	O
sin_port	short
=	O
sp	*
->	O
s_port	int
;	O
}	O
static	O
int	O
readline	function
(	O
register	O
char	O
*	O
p	*
,	O
register	O
int	O
n	int
)	O
{	O
char	O
c	int
;	O
while	O
(	O
n	int
--	O
>	O
0	int
)	O
{	O
if	O
(	O
read	*
(	O
0	int
,	O
&	O
c	int
,	O
1	int
)	O
<=	O
0	int
)	O
return	O
(	O
-	O
1	int
)	O
;	O
c	int
&=	O
0177	int
;	O
if	O
(	O
c	int
==	O
'\n'	O
||	O
c	int
==	O
'\r'	O
)	O
{	O
*	O
p	*
=	O
'\0'	O
;	O
return	O
(	O
0	int
)	O
;	O
}	O
*	O
p	*
++	O
=	O
c	int
;	O
}	O
return	O
(	O
-	O
1	int
)	O
;	O
}	O
void	O
doit	function
(	O
struct	O
sockaddr_in	struct
*	O
sinp	*
)	O
{	O
struct	O
passwd	struct
*	O
pw	*
,	O
*	O
getpwnam	function
(	O
const	O
char	O
*	O
)	O
;	O
char	O
user	*
[	O
64	int
]	O
,	O
passwd	*
[	O
64	int
]	O
;	O
char	O
*	O
xpasswd	*
;	O
alarm	function
(	O
60	int
)	O
;	O
printf	function
(	O
"login: "	*
)	O
;	O
fflush	function
(	O
stdout	*
)	O
;	O
if	O
(	O
readline	function
(	O
user	*
,	O
sizeof	O
user	*
)	O
<	O
0	int
)	O
{	O
fprintf	function
(	O
stderr	*
,	O
"user read\n"	*
)	O
;	O
return	O
;	O
}	O
user	*
[	O
8	int
]	O
=	O
'\0'	O
;	O
pw	*
=	O
getpwnam	function
(	O
user	*
)	O
;	O
if	O
(	O
pw	*
==	O
NULL	O
)	O
{	O
fprintf	function
(	O
stderr	*
,	O
"user unknown\n"	*
)	O
;	O
return	O
;	O
}	O
if	O
(	O
strcmp	function
(	O
pw	*
->	O
pw_shell	*
,	O
PATH_UUCICO	*
)	O
)	O
{	O
fprintf	function
(	O
stderr	*
,	O
"Login incorrect."	*
)	O
;	O
return	O
;	O
}	O
if	O
(	O
pw	*
->	O
pw_passwd	*
&&	O
*	O
pw	*
->	O
pw_passwd	*
!=	O
'\0'	O
)	O
{	O
printf	function
(	O
"Password: "	*
)	O
;	O
fflush	function
(	O
stdout	*
)	O
;	O
if	O
(	O
readline	function
(	O
passwd	struct
,	O
sizeof	O
passwd	*
)	O
<	O
0	int
)	O
{	O
fprintf	function
(	O
stderr	*
,	O
"passwd read\n"	*
)	O
;	O
return	O
;	O
}	O
xpasswd	*
=	O
crypt	function
(	O
passwd	struct
,	O
pw	*
->	O
pw_passwd	*
)	O
;	O
if	O
(	O
strcmp	function
(	O
xpasswd	*
,	O
pw	*
->	O
pw_passwd	*
)	O
)	O
{	O
fprintf	function
(	O
stderr	*
,	O
"Login incorrect."	*
)	O
;	O
return	O
;	O
}	O
}	O
alarm	function
(	O
0	int
)	O
;	O
sprintf	function
(	O
Username	*
,	O
"USER=%s"	*
,	O
user	*
)	O
;	O
dologin	function
(	O
pw	*
,	O
sinp	*
)	O
;	O
setgid	function
(	O
pw	*
->	O
pw_gid	int
)	O
;	O
chdir	function
(	O
pw	*
->	O
pw_dir	*
)	O
;	O
setuid	function
(	O
pw	*
->	O
pw_uid	int
)	O
;	O
perror	function
(	O
"uucico server: execl"	*
)	O
;	O
}	O
void	O
dologout	function
(	O
void	O
)	O
{	O
int	O
pid	int
;	O
while	O
(	O
(	O
pid	int
=	O
wait3	function
(	O
0	int
,	O
WNOHANG	int
,	O
0	int
)	O
)	O
>	O
0	int
)	O
{	O
char	O
line	array
[	O
100	int
]	O
;	O
sprintf	function
(	O
line	*
,	O
"uucp%.4d"	*
,	O
pid	int
)	O
;	O
logwtmp	function
(	O
line	array
,	O
""	*
,	O
""	*
)	O
;	O
}	O
}	O
void	O
dologin	function
(	O
struct	O
passwd	struct
*	O
pw	*
,	O
struct	O
sockaddr_in	struct
*	O
sin	*
)	O
{	O
char	O
line	array
[	O
32	int
]	O
;	O
char	O
remotehost	array
[	O
32	int
]	O
;	O
int	O
f	*
;	O
struct	O
hostent	struct
*	O
hp	*
=	O
gethostbyaddr	function
(	O
(	O
char	O
*	O
)	O
&	O
sin	struct
->	O
sin_addr	struct
,	O
sizeof	O
(	O
struct	O
in_addr	struct
)	O
,	O
AF_INET	O
)	O
;	O
if	O
(	O
hp	*
)	O
{	O
strncpy	function
(	O
remotehost	O
,	O
hp	*
->	O
h_name	*
,	O
sizeof	O
(	O
remotehost	*
)	O
)	O
;	O
endhostent	function
(	O
)	O
;	O
}	O
else	O
strncpy	function
(	O
remotehost	*
,	O
inet_ntoa	function
(	O
sin	*
->	O
sin_addr	struct
)	O
,	O
sizeof	O
(	O
remotehost	struct
)	O
)	O
;	O
sprintf	function
(	O
line	*
,	O
"uucp%.4d"	*
,	O
getpid	function
(	O
)	O
)	O
;	O
logwtmp	function
(	O
line	*
,	O
pw	*
->	O
pw_name	*
,	O
remotehost	int
)	O
;	O
f	*
=	O
open	function
(	O
PATH_LASTLOG	int
,	O
O_RDWR	int
)	O
;	O
if	O
(	O
f	int
>=	O
0	int
)	O
{	O
struct	O
lastlog	O
ll	int
;	O
time_t	long
t	long
;	O
time	function
(	O
&	O
t	long
)	O
;	O
ll	struct
.	O
ll_time	*
=	O
t	*
;	O
lseek	function
(	O
f	*
,	O
(	O
long	O
)	O
pw	*
->	O
pw_uid	int
*	O
sizeof	O
(	O
struct	O
lastlog	struct
)	O
,	O
0	int
)	O
;	O
strcpy	function
(	O
line	*
,	O
remotehost	*
)	O
;	O
SCPYN	function
(	O
ll	struct
.	O
ll_line	*
,	O
line	int
)	O
;	O
SCPYN	function
(	O
ll	struct
.	O
ll_host	int
,	O
remotehost	int
)	O
;	O
write	function
(	O
f	*
,	O
(	O
char	O
*	O
)	O
&	O
ll	int
,	O
sizeof	O
ll	*
)	O
;	O
close	*
(	O
f	int
)	O
;	O
}	O
}	O
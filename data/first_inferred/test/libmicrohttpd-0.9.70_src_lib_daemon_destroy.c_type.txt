static	O
void	O
stop_workers	function
(	O
struct	O
MHD_Daemon	O
*	O
daemon	function
)	O
{	O
MHD_socket	int
fd	int
;	O
unsigned	O
int	O
i	int
;	O
mhd_assert	O
(	O
1	int
<	O
daemon	function
->	O
worker_pool_size	*
)	O
;	O
mhd_assert	O
(	O
1	int
<	O
daemon	function
->	O
threading_mode	enum
)	O
;	O
if	O
(	O
daemon	function
->	O
was_quiesced	int
)	O
fd	int
=	O
MHD_INVALID_SOCKET	O
;	O
else	O
fd	int
=	O
daemon	function
->	O
listen_socket	int
;	O
for	O
(	O
i	long
=	O
0	int
;	O
i	int
<	O
daemon	function
->	O
worker_pool_size	int
;	O
i	long
++	O
)	O
{	O
daemon	function
->	O
worker_pool	*
[	O
i	long
]	O
.	O
shutdown	int
=	O
true	int
;	O
if	O
(	O
MHD_ITC_IS_VALID_	function
(	O
daemon	function
->	O
worker_pool	*
[	O
i	long
]	O
.	O
itc	int
)	O
)	O
{	O
if	O
(	O
!	O
MHD_itc_activate_	function
(	O
daemon	function
->	O
worker_pool	*
[	O
i	long
]	O
.	O
itc	int
,	O
"e"	int
)	O
)	O
MHD_PANIC	O
(	O
_	O
(	O
"Failed to signal shutdown via inter-thread communication channel."	*
)	O
)	O
;	O
}	O
else	O
{	O
mhd_assert	O
(	O
MHD_INVALID_SOCKET	O
!=	O
fd	int
)	O
;	O
}	O
}	O
if	O
(	O
MHD_INVALID_SOCKET	O
!=	O
fd	int
)	O
{	O
(	O
void	O
)	O
shutdown	function
(	O
fd	int
,	O
SHUT_RDWR	int
)	O
;	O
}	O
for	O
(	O
i	int
=	O
0	int
;	O
i	int
<	O
daemon	function
->	O
worker_pool_size	int
;	O
++	O
i	long
)	O
{	O
MHD_daemon_destroy	function
(	O
&	O
daemon	function
->	O
worker_pool	*
[	O
i	long
]	O
)	O
;	O
}	O
free	function
(	O
daemon	function
->	O
worker_pool	*
)	O
;	O
daemon	function
->	O
worker_pool	*
=	O
NULL	O
;	O
mhd_assert	O
(	O
MHD_ITC_IS_INVALID_	function
(	O
daemon	function
->	O
itc	*
)	O
)	O
;	O
mhd_assert	O
(	O
-	O
1	int
==	O
daemon	function
->	O
epoll_fd	int
)	O
;	O
}	O
void	O
MHD_daemon_destroy	function
(	O
struct	O
MHD_Daemon	O
*	O
daemon	function
)	O
{	O
MHD_socket	int
fd	int
;	O
daemon	function
->	O
shutdown	function
=	O
true	int
;	O
if	O
(	O
daemon	function
->	O
was_quiesced	int
)	O
fd	int
=	O
MHD_INVALID_SOCKET	O
;	O
else	O
fd	int
=	O
daemon	function
->	O
listen_socket	int
;	O
if	O
(	O
NULL	O
!=	O
daemon	function
->	O
worker_pool	*
)	O
{	O
stop_workers	function
(	O
daemon	function
)	O
;	O
}	O
else	O
{	O
mhd_assert	O
(	O
0	int
==	O
daemon	function
->	O
worker_pool_size	*
)	O
;	O
if	O
(	O
MHD_TM_EXTERNAL_EVENT_LOOP	int
!=	O
daemon	function
->	O
threading_mode	enum
)	O
{	O
if	O
(	O
MHD_ITC_IS_VALID_	function
(	O
daemon	function
->	O
itc	*
)	O
)	O
{	O
if	O
(	O
!	O
MHD_itc_activate_	function
(	O
daemon	function
->	O
itc	*
,	O
"e"	int
)	O
)	O
MHD_PANIC	O
(	O
_	O
(	O
"Failed to signal shutdown via inter-thread communication channel"	*
)	O
)	O
;	O
}	O
else	O
{	O
if	O
(	O
MHD_INVALID_SOCKET	O
!=	O
fd	int
)	O
{	O
if	O
(	O
NULL	O
==	O
daemon	function
->	O
master	*
)	O
(	O
void	O
)	O
shutdown	function
(	O
fd	int
,	O
SHUT_RDWR	int
)	O
;	O
}	O
else	O
mhd_assert	O
(	O
false	int
)	O
;	O
}	O
if	O
(	O
!	O
MHD_join_thread_	O
(	O
daemon	function
->	O
pid	int
.	O
handle	long
)	O
)	O
{	O
MHD_PANIC	O
(	O
_	O
(	O
"Failed to join a thread\n"	*
)	O
)	O
;	O
}	O
}	O
else	O
{	O
MHD_daemon_close_all_connections_	function
(	O
daemon	function
)	O
;	O
}	O
if	O
(	O
MHD_ITC_IS_VALID_	function
(	O
daemon	function
->	O
itc	*
)	O
)	O
MHD_itc_destroy_chk_	function
(	O
daemon	function
->	O
itc	*
)	O
;	O
if	O
(	O
(	O
MHD_ELS_EPOLL	int
==	O
daemon	function
->	O
event_loop_syscall	enum
)	O
&&	O
(	O
-	O
1	int
!=	O
daemon	function
->	O
epoll_fd	int
)	O
)	O
MHD_socket_close_chk_	O
(	O
daemon	function
->	O
epoll_fd	int
)	O
;	O
MHD_mutex_destroy_chk_	function
(	O
&	O
daemon	function
->	O
cleanup_connection_mutex	union
)	O
;	O
}	O
if	O
(	O
NULL	O
!=	O
daemon	function
->	O
master	*
)	O
return	O
;	O
if	O
(	O
MHD_INVALID_SOCKET	O
!=	O
fd	int
)	O
MHD_socket_close_chk_	O
(	O
fd	*
)	O
;	O
free	function
(	O
daemon	function
->	O
nnc	*
)	O
;	O
MHD_mutex_destroy_chk_	function
(	O
&	O
daemon	function
->	O
nnc_lock	union
)	O
;	O
MHD_mutex_destroy_chk_	function
(	O
&	O
daemon	function
->	O
per_ip_connection_mutex	union
)	O
;	O
free	function
(	O
daemon	function
)	O
;	O
}	O
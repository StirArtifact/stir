int	O
mu_create_temp_file	function
(	O
char	O
*	O
filename	*
,	O
size_t	long
suflen	long
,	O
int	O
*	O
pfd	*
,	O
int	O
isdir	int
)	O
{	O
int	O
rc	int
;	O
size_t	long
len	long
;	O
char	O
*	O
carrybuf	*
;	O
char	O
*	O
p	*
,	O
*	O
cp	*
,	O
*	O
start	*
,	O
*	O
end	*
;	O
struct	O
stat	struct
st	struct
;	O
static	O
int	O
first_call	int
;	O
static	O
char	O
randstate	array
[	O
256	int
]	O
;	O
static	O
const	O
unsigned	O
char	O
alphabet	array
[	O
]	O
=	O
"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"	*
;	O
if	O
(	O
!	O
first_call	*
)	O
{	O
struct	O
timeval	struct
tv	struct
;	O
gettimeofday	function
(	O
&	O
tv	struct
,	O
NULL	O
)	O
;	O
initstate	function
(	O
(	O
(	O
unsigned	O
long	O
)	O
tv	struct
.	O
tv_usec	long
<<	O
16	int
)	O
^	O
tv	struct
.	O
tv_sec	long
,	O
randstate	*
,	O
sizeof	O
(	O
randstate	struct
)	O
)	O
;	O
first_call	int
=	O
1	int
;	O
}	O
setstate	function
(	O
randstate	*
)	O
;	O
end	*
=	O
filename	*
+	O
strlen	function
(	O
filename	*
)	O
-	O
suflen	long
-	O
1	int
;	O
for	O
(	O
p	*
=	O
end	*
;	O
p	*
>=	O
filename	*
&&	O
*	O
p	*
==	O
'X'	O
;	O
p	*
--	O
)	O
*	O
p	*
=	O
alphabet	array
[	O
random	function
(	O
)	O
%	O
(	O
sizeof	O
(	O
alphabet	array
)	O
-	O
1	int
)	O
]	O
;	O
len	long
=	O
end	*
-	O
p	*
;	O
if	O
(	O
len	int
==	O
0	int
)	O
return	O
EINVAL	int
;	O
start	*
=	O
p	*
+	O
1	int
;	O
carrybuf	*
=	O
malloc	function
(	O
len	int
)	O
;	O
if	O
(	O
!	O
carrybuf	*
)	O
return	O
ENOMEM	int
;	O
memcpy	function
(	O
carrybuf	*
,	O
start	*
,	O
len	int
)	O
;	O
for	O
(	O
;	O
;	O
)	O
{	O
if	O
(	O
isdir	int
)	O
{	O
if	O
(	O
mkdir	function
(	O
filename	*
,	O
0700	int
)	O
==	O
0	int
)	O
{	O
rc	int
=	O
0	int
;	O
break	O
;	O
}	O
}	O
else	O
if	O
(	O
pfd	int
)	O
{	O
if	O
(	O
(	O
*	O
pfd	*
=	O
open	function
(	O
filename	*
,	O
O_CREAT	int
|	O
O_EXCL	int
|	O
O_RDWR	int
,	O
0600	int
)	O
)	O
>=	O
0	int
)	O
{	O
rc	int
=	O
0	int
;	O
break	O
;	O
}	O
}	O
else	O
if	O
(	O
lstat	function
(	O
filename	*
,	O
&	O
st	struct
)	O
&&	O
errno	O
==	O
ENOENT	int
)	O
{	O
rc	int
=	O
0	int
;	O
break	O
;	O
}	O
if	O
(	O
errno	O
!=	O
EEXIST	int
)	O
{	O
rc	int
=	O
errno	O
;	O
break	O
;	O
}	O
for	O
(	O
p	int
=	O
start	int
,	O
cp	int
=	O
carrybuf	int
;	O
;	O
p	*
++	O
,	O
cp	*
++	O
)	O
{	O
char	O
*	O
q	*
;	O
if	O
(	O
p	*
==	O
end	*
)	O
return	O
EEXIST	int
;	O
q	*
=	O
strchr	function
(	O
(	O
char	O
*	O
)	O
alphabet	*
,	O
*	O
p	*
)	O
;	O
if	O
(	O
!	O
q	*
)	O
abort	function
(	O
)	O
;	O
*	O
p	*
=	O
(	O
q	*
[	O
1	int
]	O
==	O
0	int
)	O
?	O
alphabet	array
[	O
0	int
]	O
:	O
q	*
[	O
1	int
]	O
;	O
if	O
(	O
*	O
p	*
!=	O
*	O
cp	*
)	O
break	O
;	O
}	O
}	O
free	function
(	O
carrybuf	*
)	O
;	O
return	O
rc	int
;	O
}	O
int	O
mu_tempfile	function
(	O
struct	O
mu_tempfile_hints	struct
*	O
hints	*
,	O
int	O
flags	int
,	O
int	O
*	O
pfd	*
,	O
char	O
*	O
*	O
namep	*
)	O
{	O
char	O
*	O
filename	*
;	O
const	O
char	O
*	O
tmpdir	*
=	O
getenv	function
(	O
"TMPDIR"	*
)	O
;	O
const	O
char	O
*	O
suf	*
=	O
NULL	O
;	O
int	O
create_dir	int
=	O
0	int
;	O
int	O
rc	int
;	O
struct	O
stat	struct
st	struct
;	O
if	O
(	O
pfd	*
==	O
NULL	O
&&	O
namep	*
==	O
NULL	O
)	O
return	O
EINVAL	int
;	O
if	O
(	O
hints	*
)	O
{	O
if	O
(	O
flags	int
&	O
MU_TEMPFILE_TMPDIR	int
)	O
tmpdir	*
=	O
hints	*
->	O
tmpdir	*
;	O
if	O
(	O
flags	int
&	O
MU_TEMPFILE_SUFFIX	int
)	O
suf	*
=	O
hints	*
->	O
suffix	*
;	O
create_dir	*
=	O
flags	int
&	O
MU_TEMPFILE_MKDIR	int
;	O
}	O
if	O
(	O
!	O
tmpdir	*
)	O
tmpdir	*
=	O
P_tmpdir	*
;	O
if	O
(	O
stat	struct
(	O
tmpdir	*
,	O
&	O
st	struct
)	O
)	O
return	O
errno	O
;	O
filename	*
=	O
mu_make_file_name_suf	function
(	O
tmpdir	*
,	O
"muXXXXXX"	*
,	O
suf	*
)	O
;	O
rc	int
=	O
mu_create_temp_file	function
(	O
filename	*
,	O
suf	*
?	O
strlen	function
(	O
suf	*
)	O
:	O
0	int
,	O
pfd	int
,	O
create_dir	*
)	O
;	O
if	O
(	O
rc	int
==	O
0	int
)	O
{	O
if	O
(	O
namep	*
)	O
*	O
namep	*
=	O
filename	*
;	O
else	O
{	O
unlink	function
(	O
filename	*
)	O
;	O
free	function
(	O
filename	*
)	O
;	O
}	O
}	O
return	O
rc	int
;	O
}	O
char	O
*	O
mu_tempname	function
(	O
const	O
char	O
*	O
tmpdir	*
)	O
{	O
struct	O
mu_tempfile_hints	struct
hints	*
;	O
char	O
*	O
filename	*
=	O
NULL	O
;	O
int	O
fd	int
;	O
hints	*
.	O
tmpdir	*
=	O
(	O
char	O
*	O
)	O
tmpdir	*
;	O
if	O
(	O
mu_tempfile	function
(	O
&	O
hints	*
,	O
MU_TEMPFILE_TMPDIR	int
,	O
&	O
fd	int
,	O
&	O
filename	*
)	O
)	O
return	O
NULL	O
;	O
close	*
(	O
fd	int
)	O
;	O
return	O
filename	*
;	O
}	O
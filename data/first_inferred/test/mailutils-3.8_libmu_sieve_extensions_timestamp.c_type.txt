static	O
int	O
timestamp_test	function
(	O
mu_sieve_machine_t	*
mach	*
)	O
{	O
char	O
const	O
*	O
hname	*
;	O
char	O
const	O
*	O
date	*
;	O
mu_header_t	*
hdr	*
;	O
char	O
*	O
val	*
;	O
time_t	long
now	long
=	O
time	struct
(	O
NULL	O
)	O
;	O
time_t	long
tlimit	long
,	O
tval	struct
;	O
int	O
rc	int
;	O
mu_sieve_get_arg	function
(	O
mach	*
,	O
0	int
,	O
SVT_STRING	int
,	O
&	O
hname	O
)	O
;	O
mu_sieve_get_arg	function
(	O
mach	*
,	O
1	int
,	O
SVT_STRING	int
,	O
&	O
date	*
)	O
;	O
if	O
(	O
mu_parse_date	function
(	O
date	*
,	O
&	O
tlimit	struct
,	O
&	O
now	long
)	O
)	O
{	O
mu_sieve_error	function
(	O
mach	*
,	O
_	O
(	O
"cannot parse date specification (%s)"	*
)	O
,	O
date	*
)	O
;	O
mu_sieve_abort	function
(	O
mach	*
)	O
;	O
}	O
rc	int
=	O
mu_message_get_header	function
(	O
mu_sieve_get_message	function
(	O
mach	*
)	O
,	O
&	O
hdr	*
)	O
;	O
if	O
(	O
rc	int
)	O
{	O
mu_sieve_error	function
(	O
mach	*
,	O
"mu_message_get_header: %s"	*
,	O
mu_strerror	function
(	O
rc	int
)	O
)	O
;	O
mu_sieve_abort	function
(	O
mach	*
)	O
;	O
}	O
if	O
(	O
mu_header_aget_value	O
(	O
hdr	*
,	O
hname	*
,	O
&	O
val	*
)	O
)	O
return	O
0	int
;	O
if	O
(	O
mu_parse_date	function
(	O
val	*
,	O
&	O
tval	struct
,	O
&	O
now	long
)	O
)	O
{	O
mu_sieve_error	function
(	O
mach	*
,	O
"cannot parse header date specification (%s)"	*
,	O
val	*
)	O
;	O
free	function
(	O
val	*
)	O
;	O
mu_sieve_abort	function
(	O
mach	*
)	O
;	O
}	O
free	function
(	O
val	*
)	O
;	O
rc	int
=	O
tval	int
>	O
tlimit	int
;	O
if	O
(	O
mu_sieve_get_tag	function
(	O
mach	*
,	O
"before"	*
,	O
SVT_VOID	int
,	O
NULL	O
)	O
)	O
rc	int
=	O
!	O
rc	int
;	O
return	O
rc	int
;	O
}	O
static	O
mu_sieve_data_type	enum
timestamp_req_args	array
[	O
]	O
=	O
{	O
SVT_STRING	int
,	O
SVT_STRING	int
,	O
SVT_VOID	int
}	O
;	O
static	O
mu_sieve_tag_def_t	struct
timestamp_tags	array
[	O
]	O
=	O
{	O
{	O
"after"	*
,	O
SVT_VOID	int
}	O
,	O
{	O
"before"	*
,	O
SVT_VOID	int
}	O
,	O
{	O
NULL	O
}	O
}	O
;	O
static	O
mu_sieve_tag_group_t	struct
timestamp_tag_groups	array
[	O
]	O
=	O
{	O
{	O
timestamp_tags	*
,	O
NULL	O
}	O
,	O
{	O
NULL	O
}	O
}	O
;	O
int	O
SIEVE_EXPORT	O
(	O
timestamp	O
,	O
init	O
)	O
(	O
mu_sieve_machine_t	*
mach	*
)	O
{	O
mu_sieve_register_test	function
(	O
mach	*
,	O
"timestamp"	*
,	O
timestamp_test	*
,	O
timestamp_req_args	*
,	O
timestamp_tag_groups	*
,	O
1	int
)	O
;	O
return	O
0	int
;	O
}	O
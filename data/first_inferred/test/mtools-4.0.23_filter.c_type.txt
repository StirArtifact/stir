typedef	O
struct	O
Filter_t	O
{	O
Class_t	struct
*	O
Class	*
;	O
int	O
refs	int
;	O
Stream_t	struct
*	O
Next	*
;	O
Stream_t	struct
*	O
Buffer	*
;	O
int	O
dospos	int
;	O
int	O
unixpos	int
;	O
int	O
mode	int
;	O
int	O
rw	int
;	O
int	O
lastchar	int
;	O
}	O
Filter_t	struct
;	O
static	O
int	O
read_filter	function
(	O
Stream_t	struct
*	O
Stream	*
,	O
char	O
*	O
buf	*
,	O
mt_off_t	long
iwhere	long
,	O
size_t	long
len	int
)	O
{	O
DeclareThis	O
(	O
Filter_t	*
)	O
;	O
int	O
i	int
,	O
j	int
,	O
ret	int
;	O
unsigned	O
char	O
newchar	int
;	O
off_t	long
where	long
=	O
truncBytes32	function
(	O
iwhere	*
)	O
;	O
if	O
(	O
where	long
!=	O
This	*
->	O
unixpos	*
)	O
{	O
fprintf	function
(	O
stderr	*
,	O
"Bad offset\n"	*
)	O
;	O
exit	function
(	O
1	int
)	O
;	O
}	O
if	O
(	O
This	*
->	O
rw	O
==	O
F_WRITE	int
)	O
{	O
fprintf	function
(	O
stderr	*
,	O
"Change of transfer direction!\n"	*
)	O
;	O
exit	function
(	O
1	int
)	O
;	O
}	O
This	*
->	O
rw	O
=	O
F_READ	int
;	O
ret	int
=	O
READS	O
(	O
This	*
->	O
Next	*
,	O
buf	*
,	O
(	O
mt_off_t	long
)	O
This	*
->	O
dospos	*
,	O
len	int
)	O
;	O
if	O
(	O
ret	int
<	O
0	int
)	O
return	O
ret	int
;	O
j	int
=	O
0	int
;	O
for	O
(	O
i	int
=	O
0	int
;	O
i	int
<	O
ret	int
;	O
i	int
++	O
)	O
{	O
if	O
(	O
buf	*
[	O
i	int
]	O
==	O
'\r'	O
)	O
continue	O
;	O
if	O
(	O
buf	*
[	O
i	int
]	O
==	O
0x1a	int
)	O
break	O
;	O
newchar	*
=	O
buf	*
[	O
i	int
]	O
;	O
This	*
->	O
lastchar	*
=	O
buf	*
[	O
j	int
++	O
]	O
=	O
newchar	int
;	O
}	O
This	*
->	O
dospos	int
+=	O
i	int
;	O
This	*
->	O
unixpos	int
+=	O
j	int
;	O
return	O
j	int
;	O
}	O
static	O
int	O
write_filter	function
(	O
Stream_t	struct
*	O
Stream	*
,	O
char	O
*	O
buf	*
,	O
mt_off_t	long
iwhere	long
,	O
size_t	long
len	long
)	O
{	O
DeclareThis	O
(	O
Filter_t	*
)	O
;	O
unsigned	O
int	O
i	int
,	O
j	int
;	O
int	O
ret	int
;	O
char	O
buffer	array
[	O
1025	int
]	O
;	O
unsigned	O
char	O
newchar	int
;	O
off_t	long
where	long
=	O
truncBytes32	function
(	O
iwhere	*
)	O
;	O
if	O
(	O
This	*
->	O
unixpos	int
==	O
-	O
1	int
)	O
return	O
-	O
1	int
;	O
if	O
(	O
where	long
!=	O
This	*
->	O
unixpos	*
)	O
{	O
fprintf	function
(	O
stderr	*
,	O
"Bad offset\n"	*
)	O
;	O
exit	function
(	O
1	int
)	O
;	O
}	O
if	O
(	O
This	*
->	O
rw	O
==	O
F_READ	int
)	O
{	O
fprintf	function
(	O
stderr	*
,	O
"Change of transfer direction!\n"	*
)	O
;	O
exit	function
(	O
1	int
)	O
;	O
}	O
This	*
->	O
rw	int
=	O
F_WRITE	int
;	O
j	int
=	O
i	int
=	O
0	int
;	O
while	O
(	O
i	int
<	O
1024	int
&&	O
j	int
<	O
len	int
)	O
{	O
if	O
(	O
buf	*
[	O
j	int
]	O
==	O
'\n'	O
)	O
{	O
buffer	*
[	O
i	int
++	O
]	O
=	O
'\r'	O
;	O
buffer	*
[	O
i	int
++	O
]	O
=	O
'\n'	O
;	O
j	int
++	O
;	O
continue	O
;	O
}	O
newchar	int
=	O
buf	*
[	O
j	int
++	O
]	O
;	O
buffer	*
[	O
i	int
++	O
]	O
=	O
newchar	int
;	O
}	O
This	*
->	O
unixpos	int
+=	O
j	int
;	O
ret	int
=	O
force_write	function
(	O
This	*
->	O
Next	*
,	O
buffer	*
,	O
(	O
mt_off_t	long
)	O
This	*
->	O
dospos	*
,	O
i	int
)	O
;	O
if	O
(	O
ret	int
>	O
0	int
)	O
This	*
->	O
dospos	int
+=	O
ret	int
;	O
if	O
(	O
ret	int
!=	O
(	O
signed	O
int	O
)	O
i	int
)	O
{	O
This	*
->	O
unixpos	int
=	O
-	O
1	int
;	O
return	O
-	O
1	int
;	O
}	O
return	O
j	int
;	O
}	O
static	O
int	O
free_filter	function
(	O
Stream_t	struct
*	O
Stream	*
)	O
{	O
DeclareThis	O
(	O
Filter_t	*
)	O
;	O
char	O
buffer	int
=	O
0x1a	int
;	O
if	O
(	O
This	*
->	O
rw	O
==	O
F_WRITE	int
)	O
return	O
force_write	function
(	O
This	*
->	O
Next	*
,	O
&	O
buffer	*
,	O
(	O
mt_off_t	long
)	O
This	*
->	O
dospos	*
,	O
1	int
)	O
;	O
else	O
return	O
0	int
;	O
}	O
static	O
Class_t	struct
FilterClass	struct
=	O
{	O
read_filter	*
,	O
write_filter	int
,	O
0	int
,	O
free_filter	function
,	O
0	int
,	O
get_data_pass_through	int
,	O
0	int
,	O
0	int
,	O
0	int
}	O
;	O
Stream_t	struct
*	O
open_filter	function
(	O
Stream_t	struct
*	O
Next	*
,	O
int	O
convertCharset	enum
UNUSEDP	O
)	O
{	O
Filter_t	struct
*	O
This	*
;	O
This	*
=	O
New	O
(	O
Filter_t	*
)	O
;	O
if	O
(	O
!	O
This	*
)	O
return	O
NULL	O
;	O
This	*
->	O
Class	*
=	O
&	O
FilterClass	O
;	O
This	*
->	O
dospos	int
=	O
This	*
->	O
unixpos	int
=	O
This	*
->	O
rw	int
=	O
0	int
;	O
This	*
->	O
Next	*
=	O
Next	*
;	O
This	*
->	O
refs	int
=	O
1	int
;	O
This	*
->	O
Buffer	*
=	O
0	int
;	O
return	O
(	O
Stream_t	struct
*	O
)	O
This	*
;	O
}	O
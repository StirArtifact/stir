typedef	O
struct	O
{	O
char	O
*	O
me	pointer
;	O
char	O
*	O
device	pointer
;	O
const	O
char	O
*	O
host	pointer
;	O
int	O
port	int
;	O
char	O
*	O
forward_host	pointer
;	O
int	O
forward_port	int
;	O
size_t	long
content_length	long
;	O
char	O
*	O
pid_filename	pointer
;	O
int	O
use_std	int
;	O
int	O
use_daemon	int
;	O
int	O
strict_content_length	int
;	O
int	O
keep_alive	int
;	O
int	O
max_connection_age	int
;	O
}	O
Arguments	struct
;	O
int	O
debug_level	int
=	O
0	int
;	O
FILE	struct
*	O
debug_file	pointer
=	O
NULL	O
;	O
static	O
void	O
usage	function
(	O
FILE	struct
*	O
f	pointer
,	O
const	O
char	O
*	O
me	pointer
)	O
{	O
fprintf	function
(	O
f	pointer
,	O
"Usage: %s [OPTION]... [PORT]\n"	pointer
"Listen for incoming httptunnel connections at PORT (default port is %d).\n"	pointer
"When a connection is made, I/O is redirected to the destination specified\n"	pointer
"by the --device, --forward-port or --stdin-stdout switch.\n"	pointer
"\n"	pointer
"  -c, --content-length BYTES     use HTTP PUT requests of BYTES size\n"	pointer
"                                 (k, M, and G postfixes recognized)\n"	pointer
"  -d, --device DEVICE            use DEVICE for input and output\n"	pointer
"  -F, --forward-port HOST:PORT   connect to PORT at HOST and use it for \n"	pointer
"                                 input and output\n"	pointer
"  -h, --help                     display this help and exit\n"	pointer
"  -k, --keep-alive SECONDS       send keepalive bytes every SECONDS seconds\n"	pointer
"                                 (default is %d)\n"	pointer
"  -M, --max-connection-age SEC   maximum time a connection will stay\n"	pointer
"                                 open is SEC seconds (default is %d)\n"	pointer
"  -s, --stdin-stdout             use stdin/stdout for communication\n"	pointer
"                                 (implies --no-daemon)\n"	pointer
"  -S, --strict-content-length    always write Content-Length bytes in requests\n"	pointer
"  -V, --version                  output version information and exit\n"	pointer
"  -w, --no-daemon                don't fork into the background\n"	pointer
"  -p, --pid-file LOCATION        write a PID file to LOCATION\n"	pointer
"\n"	pointer
"Report bugs to %s.\n"	pointer
,	O
me	pointer
,	O
DEFAULT_HOST_PORT	int
,	O
DEFAULT_KEEP_ALIVE	int
,	O
DEFAULT_MAX_CONNECTION_AGE	int
,	O
BUG_REPORT_EMAIL	pointer
)	O
;	O
}	O
static	O
void	O
parse_arguments	function
(	O
int	O
argc	int
,	O
char	O
*	O
*	O
argv	pointer
,	O
Arguments	struct
*	O
arg	pointer
)	O
{	O
int	O
c	int
;	O
arg	pointer
->	O
me	pointer
=	O
argv	pointer
[	O
0	int
]	O
;	O
arg	pointer
->	O
host	pointer
=	O
NULL	O
;	O
arg	pointer
->	O
port	int
=	O
DEFAULT_HOST_PORT	int
;	O
arg	pointer
->	O
device	pointer
=	O
NULL	O
;	O
arg	pointer
->	O
forward_host	pointer
=	O
NULL	O
;	O
arg	pointer
->	O
forward_port	int
=	O
-	O
1	int
;	O
arg	pointer
->	O
content_length	long
=	O
DEFAULT_CONTENT_LENGTH	O
;	O
arg	pointer
->	O
pid_filename	pointer
=	O
NULL	O
;	O
arg	pointer
->	O
use_std	int
=	O
FALSE	int
;	O
arg	pointer
->	O
use_daemon	int
=	O
TRUE	int
;	O
arg	pointer
->	O
strict_content_length	int
=	O
FALSE	int
;	O
arg	pointer
->	O
keep_alive	int
=	O
DEFAULT_KEEP_ALIVE	int
;	O
arg	pointer
->	O
max_connection_age	int
=	O
DEFAULT_CONNECTION_MAX_TIME	int
;	O
for	O
(	O
;	O
;	O
)	O
{	O
int	O
option_index	int
=	O
0	int
;	O
static	O
struct	O
option	struct
long_options	array
[	O
]	O
=	O
{	O
{	O
"help"	pointer
,	O
no_argument	int
,	O
0	int
,	O
'h'	O
}	O
,	O
{	O
"stdin-stdout"	pointer
,	O
no_argument	int
,	O
0	int
,	O
's'	O
}	O
,	O
{	O
"strict-content-length"	pointer
,	O
no_argument	int
,	O
0	int
,	O
'S'	O
}	O
,	O
{	O
"version"	pointer
,	O
no_argument	int
,	O
0	int
,	O
'V'	O
}	O
,	O
{	O
"no-daemon"	pointer
,	O
no_argument	int
,	O
0	int
,	O
'w'	O
}	O
,	O
{	O
"device"	pointer
,	O
required_argument	int
,	O
0	int
,	O
'd'	O
}	O
,	O
{	O
"pid-file"	pointer
,	O
required_argument	int
,	O
0	int
,	O
'p'	O
}	O
,	O
{	O
"keep-alive"	pointer
,	O
required_argument	int
,	O
0	int
,	O
'k'	O
}	O
,	O
{	O
"forward-port"	pointer
,	O
required_argument	int
,	O
0	int
,	O
'F'	O
}	O
,	O
{	O
"content-length"	pointer
,	O
required_argument	int
,	O
0	int
,	O
'c'	O
}	O
,	O
{	O
"max-connection-age"	pointer
,	O
required_argument	int
,	O
0	int
,	O
'M'	O
}	O
,	O
{	O
0	int
,	O
0	int
,	O
0	int
,	O
0	int
}	O
}	O
;	O
static	O
const	O
char	O
*	O
short_options	pointer
=	O
"c:d:F:hk:M:p:sSVw"	pointer
;	O
c	int
=	O
getopt_long	function
(	O
argc	int
,	O
argv	pointer
,	O
short_options	pointer
,	O
long_options	array
,	O
&	O
option_index	int
)	O
;	O
if	O
(	O
c	int
==	O
-	O
1	int
)	O
break	O
;	O
switch	O
(	O
c	int
)	O
{	O
case	O
0	int
:	O
fprintf	function
(	O
stderr	pointer
,	O
"option %s"	pointer
,	O
long_options	array
[	O
option_index	int
]	O
.	O
name	pointer
)	O
;	O
if	O
(	O
optarg	pointer
)	O
fprintf	function
(	O
stderr	pointer
,	O
" with arg %s"	pointer
,	O
optarg	pointer
)	O
;	O
fprintf	function
(	O
stderr	pointer
,	O
"\n"	pointer
)	O
;	O
break	O
;	O
case	O
'c'	O
:	O
arg	pointer
->	O
content_length	long
=	O
atoi_with_postfix	function
(	O
optarg	pointer
)	O
;	O
break	O
;	O
case	O
'd'	O
:	O
arg	pointer
->	O
device	pointer
=	O
optarg	pointer
;	O
break	O
;	O
case	O
'F'	O
:	O
name_and_port	function
(	O
optarg	pointer
,	O
&	O
arg	pointer
->	O
forward_host	pointer
,	O
&	O
arg	pointer
->	O
forward_port	int
)	O
;	O
if	O
(	O
arg	pointer
->	O
forward_port	int
==	O
-	O
1	int
)	O
{	O
fprintf	function
(	O
stderr	pointer
,	O
"%s: you must specify a port number.\n"	pointer
"%s: try '%s --help' for help.\n"	pointer
,	O
arg	pointer
->	O
me	pointer
,	O
arg	pointer
->	O
me	pointer
,	O
arg	pointer
->	O
me	pointer
)	O
;	O
exit	function
(	O
1	int
)	O
;	O
}	O
break	O
;	O
case	O
'h'	O
:	O
usage	function
(	O
stdout	pointer
,	O
arg	pointer
->	O
me	pointer
)	O
;	O
exit	function
(	O
0	int
)	O
;	O
case	O
'k'	O
:	O
arg	pointer
->	O
keep_alive	int
=	O
atoi	function
(	O
optarg	pointer
)	O
;	O
break	O
;	O
case	O
'M'	O
:	O
arg	pointer
->	O
max_connection_age	int
=	O
atoi	function
(	O
optarg	pointer
)	O
;	O
break	O
;	O
case	O
's'	O
:	O
arg	pointer
->	O
use_std	int
=	O
TRUE	int
;	O
arg	pointer
->	O
use_daemon	int
=	O
FALSE	int
;	O
break	O
;	O
case	O
'S'	O
:	O
arg	pointer
->	O
strict_content_length	int
=	O
TRUE	int
;	O
break	O
;	O
case	O
'V'	O
:	O
printf	function
(	O
"hts (%s) %s\n"	pointer
,	O
PACKAGE	pointer
,	O
VERSION	pointer
)	O
;	O
exit	function
(	O
0	int
)	O
;	O
case	O
'p'	O
:	O
arg	pointer
->	O
pid_filename	pointer
=	O
optarg	pointer
;	O
break	O
;	O
case	O
'w'	O
:	O
arg	pointer
->	O
use_daemon	int
=	O
FALSE	int
;	O
break	O
;	O
case	O
'?'	O
:	O
break	O
;	O
default	O
:	O
fprintf	function
(	O
stderr	pointer
,	O
"?? getopt returned character code 0%o ??\n"	pointer
,	O
c	int
)	O
;	O
}	O
}	O
if	O
(	O
argc	int
-	O
1	int
==	O
optind	int
)	O
{	O
char	O
*	O
colon	pointer
=	O
strchr	function
(	O
argv	pointer
[	O
optind	int
]	O
,	O
':'	O
)	O
;	O
if	O
(	O
colon	pointer
)	O
{	O
*	O
colon	pointer
=	O
'\0'	O
;	O
arg	pointer
->	O
host	pointer
=	O
argv	pointer
[	O
optind	int
]	O
;	O
arg	pointer
->	O
port	int
=	O
atoi	function
(	O
colon	pointer
+	O
1	int
)	O
;	O
}	O
else	O
arg	pointer
->	O
port	int
=	O
atoi	function
(	O
argv	pointer
[	O
optind	int
]	O
)	O
;	O
}	O
else	O
if	O
(	O
argc	int
-	O
1	int
>	O
optind	int
)	O
{	O
usage	function
(	O
stderr	pointer
,	O
arg	pointer
->	O
me	pointer
)	O
;	O
exit	function
(	O
1	int
)	O
;	O
}	O
if	O
(	O
arg	pointer
->	O
device	pointer
==	O
NULL	O
&&	O
arg	pointer
->	O
forward_port	int
==	O
-	O
1	int
&&	O
!	O
arg	pointer
->	O
use_std	int
)	O
{	O
fprintf	function
(	O
stderr	pointer
,	O
"%s: one of --device, --forward-port or --stdin-stdout must be used.\n"	pointer
"%s: try '%s -help' for help.\n"	pointer
,	O
arg	pointer
->	O
me	pointer
,	O
arg	pointer
->	O
me	pointer
,	O
arg	pointer
->	O
me	pointer
)	O
;	O
exit	function
(	O
1	int
)	O
;	O
}	O
if	O
(	O
(	O
arg	pointer
->	O
device	pointer
!=	O
NULL	O
&&	O
arg	pointer
->	O
forward_port	int
!=	O
-	O
1	int
)	O
||	O
(	O
arg	pointer
->	O
device	pointer
!=	O
NULL	O
&&	O
arg	pointer
->	O
use_std	int
)	O
||	O
(	O
arg	pointer
->	O
forward_port	int
!=	O
-	O
1	int
&&	O
arg	pointer
->	O
use_std	int
)	O
)	O
{	O
fprintf	function
(	O
stderr	pointer
,	O
"%s: only one of --device, --forward-port or --stdin-stdout can be used.\n"	pointer
"%s: try '%s --help' for help.\n"	pointer
,	O
arg	pointer
->	O
me	pointer
,	O
arg	pointer
->	O
me	pointer
,	O
arg	pointer
->	O
me	pointer
)	O
;	O
exit	function
(	O
1	int
)	O
;	O
}	O
if	O
(	O
debug_level	int
==	O
0	int
&&	O
debug_file	pointer
!=	O
NULL	O
)	O
{	O
fprintf	function
(	O
stderr	pointer
,	O
"%s: --logfile can't be used without debugging\n"	pointer
,	O
arg	pointer
->	O
me	pointer
)	O
;	O
exit	function
(	O
1	int
)	O
;	O
}	O
if	O
(	O
arg	pointer
->	O
port	int
==	O
-	O
1	int
||	O
(	O
(	O
arg	pointer
->	O
forward_host	pointer
==	O
NULL	O
)	O
!=	O
(	O
arg	pointer
->	O
forward_port	int
==	O
-	O
1	int
)	O
)	O
)	O
{	O
usage	function
(	O
stderr	pointer
,	O
arg	pointer
->	O
me	pointer
)	O
;	O
exit	function
(	O
1	int
)	O
;	O
}	O
}	O
int	O
main	function
(	O
int	O
argc	int
,	O
char	O
*	O
*	O
argv	pointer
)	O
{	O
int	O
closed	pointer
;	O
int	O
fd	int
=	O
-	O
1	int
;	O
Arguments	struct
arg	pointer
;	O
Tunnel	struct
*	O
tunnel	pointer
;	O
FILE	struct
*	O
pid_file	pointer
;	O
parse_arguments	function
(	O
argc	int
,	O
argv	pointer
,	O
&	O
arg	pointer
)	O
;	O
if	O
(	O
(	O
debug_level	int
==	O
0	int
||	O
debug_file	pointer
!=	O
NULL	O
)	O
&&	O
arg	pointer
.	O
use_daemon	int
)	O
daemon	function
(	O
0	int
,	O
1	int
)	O
;	O
openlog	function
(	O
"hts"	pointer
,	O
LOG_PID	int
,	O
LOG_DAEMON	O
)	O
;	O
log_notice	function
(	O
"hts (%s) %s started with arguments:"	pointer
,	O
PACKAGE	pointer
,	O
VERSION	pointer
)	O
;	O
log_notice	function
(	O
"  me = %s"	pointer
,	O
arg	pointer
.	O
me	pointer
)	O
;	O
log_notice	function
(	O
"  device = %s"	pointer
,	O
arg	pointer
.	O
device	pointer
?	O
arg	pointer
.	O
device	pointer
:	O
"(null)"	pointer
)	O
;	O
if	O
(	O
arg	pointer
.	O
host	pointer
)	O
log_notice	function
(	O
"  port = %s:%d"	pointer
,	O
arg	pointer
.	O
host	pointer
,	O
arg	pointer
.	O
port	int
)	O
;	O
else	O
log_notice	function
(	O
"  port = %d"	pointer
,	O
arg	pointer
.	O
port	int
)	O
;	O
log_notice	function
(	O
"  forward_port = %d"	pointer
,	O
arg	pointer
.	O
forward_port	int
)	O
;	O
log_notice	function
(	O
"  forward_host = %s"	pointer
,	O
arg	pointer
.	O
forward_host	pointer
?	O
arg	pointer
.	O
forward_host	pointer
:	O
"(null)"	pointer
)	O
;	O
log_notice	function
(	O
"  content_length = %d"	pointer
,	O
arg	pointer
.	O
content_length	long
)	O
;	O
log_notice	function
(	O
"  strict_content_length = %d"	pointer
,	O
arg	pointer
.	O
strict_content_length	int
)	O
;	O
log_notice	function
(	O
"  use_std = %d"	pointer
,	O
arg	pointer
.	O
use_std	int
)	O
;	O
log_notice	function
(	O
"  debug_level = %d"	pointer
,	O
debug_level	int
)	O
;	O
log_notice	function
(	O
"  pid_filename = %s"	pointer
,	O
arg	pointer
.	O
pid_filename	pointer
?	O
arg	pointer
.	O
pid_filename	pointer
:	O
"(null)"	pointer
)	O
;	O
tunnel	pointer
=	O
tunnel_new_server	function
(	O
arg	pointer
.	O
host	pointer
,	O
arg	pointer
.	O
port	int
,	O
arg	pointer
.	O
content_length	long
)	O
;	O
if	O
(	O
tunnel	pointer
==	O
NULL	O
)	O
{	O
log_error	function
(	O
"couldn't create tunnel"	pointer
,	O
argv	pointer
[	O
0	int
]	O
)	O
;	O
log_exit	function
(	O
1	int
)	O
;	O
}	O
if	O
(	O
tunnel_setopt	function
(	O
tunnel	pointer
,	O
"strict_content_length"	pointer
,	O
&	O
arg	pointer
.	O
strict_content_length	int
)	O
==	O
-	O
1	int
)	O
log_debug	function
(	O
"tunnel_setopt strict_content_length error: %s"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
if	O
(	O
tunnel_setopt	function
(	O
tunnel	pointer
,	O
"keep_alive"	pointer
,	O
&	O
arg	pointer
.	O
keep_alive	int
)	O
==	O
-	O
1	int
)	O
log_debug	function
(	O
"tunnel_setopt keep_alive error: %s"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
if	O
(	O
tunnel_setopt	function
(	O
tunnel	pointer
,	O
"max_connection_age"	pointer
,	O
&	O
arg	pointer
.	O
max_connection_age	int
)	O
==	O
-	O
1	int
)	O
log_debug	function
(	O
"tunnel_setopt max_connection_age error: %s"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
signal	function
(	O
SIGPIPE	int
,	O
SIG_IGN	O
)	O
;	O
if	O
(	O
arg	pointer
.	O
pid_filename	pointer
!=	O
NULL	O
)	O
{	O
pid_file	pointer
=	O
fopen	function
(	O
arg	pointer
.	O
pid_filename	pointer
,	O
"w+"	pointer
)	O
;	O
if	O
(	O
pid_file	pointer
==	O
NULL	O
)	O
{	O
fprintf	function
(	O
stderr	pointer
,	O
"Couldn't open pid file %s: %s\n"	pointer
,	O
arg	pointer
.	O
pid_filename	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
}	O
else	O
{	O
fprintf	function
(	O
pid_file	pointer
,	O
"%d\n"	pointer
,	O
(	O
int	O
)	O
getpid	function
(	O
)	O
)	O
;	O
if	O
(	O
fclose	function
(	O
pid_file	pointer
)	O
)	O
{	O
fprintf	function
(	O
stderr	pointer
,	O
"Error closing pid file: %s\n"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
}	O
}	O
}	O
for	O
(	O
;	O
;	O
)	O
{	O
time_t	long
last_tunnel_write	long
;	O
log_debug	function
(	O
"waiting for tunnel connection"	pointer
)	O
;	O
if	O
(	O
arg	pointer
.	O
device	pointer
!=	O
NULL	O
)	O
{	O
fd	int
=	O
open_device	function
(	O
arg	pointer
.	O
device	pointer
)	O
;	O
log_debug	function
(	O
"open_device (\"%s\") = %d"	pointer
,	O
arg	pointer
.	O
device	pointer
,	O
fd	int
)	O
;	O
if	O
(	O
fd	int
==	O
-	O
1	int
)	O
{	O
log_error	function
(	O
"couldn't open %s: %s"	pointer
,	O
arg	pointer
.	O
device	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
log_exit	function
(	O
1	int
)	O
;	O
}	O
if	O
(	O
fd	int
==	O
0	int
)	O
{	O
log_notice	function
(	O
"changing fd from %d to 3"	pointer
,	O
fd	int
)	O
;	O
if	O
(	O
dup2	function
(	O
fd	int
,	O
3	int
)	O
!=	O
3	int
)	O
{	O
log_error	function
(	O
"couldn't dup2(%d,3): %s"	pointer
,	O
fd	int
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
log_exit	function
(	O
1	int
)	O
;	O
}	O
}	O
}	O
else	O
if	O
(	O
arg	pointer
.	O
use_std	int
)	O
{	O
log_debug	function
(	O
"using stdin as fd"	pointer
)	O
;	O
fd	int
=	O
0	int
;	O
if	O
(	O
fcntl	function
(	O
fd	int
,	O
F_SETFL	int
,	O
O_NONBLOCK	int
)	O
==	O
-	O
1	int
)	O
{	O
log_error	function
(	O
"couldn't set stdin to non-blocking mode: %s"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
log_exit	function
(	O
1	int
)	O
;	O
}	O
}	O
if	O
(	O
tunnel_accept	function
(	O
tunnel	pointer
)	O
==	O
-	O
1	int
)	O
{	O
log_notice	function
(	O
"couldn't accept connection: %s"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
continue	O
;	O
}	O
if	O
(	O
arg	pointer
.	O
forward_port	int
!=	O
-	O
1	int
)	O
{	O
struct	O
sockaddr_in	struct
addr	struct
;	O
if	O
(	O
set_address	function
(	O
&	O
addr	struct
,	O
arg	pointer
.	O
forward_host	pointer
,	O
arg	pointer
.	O
forward_port	int
)	O
==	O
-	O
1	int
)	O
{	O
log_error	function
(	O
"couldn't forward port to %s:%d: %s\n"	pointer
,	O
arg	pointer
.	O
forward_host	pointer
,	O
arg	pointer
.	O
forward_port	int
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
log_exit	function
(	O
1	int
)	O
;	O
}	O
fd	int
=	O
do_connect	function
(	O
&	O
addr	struct
)	O
;	O
log_debug	function
(	O
"do_connect (\"%s:%d\") = %d"	pointer
,	O
arg	pointer
.	O
forward_host	pointer
,	O
arg	pointer
.	O
forward_port	int
,	O
fd	int
)	O
;	O
if	O
(	O
fd	int
==	O
-	O
1	int
)	O
{	O
log_error	function
(	O
"couldn't connect to %s:%d: %s\n"	pointer
,	O
arg	pointer
.	O
forward_host	pointer
,	O
arg	pointer
.	O
forward_port	int
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
log_exit	function
(	O
1	int
)	O
;	O
}	O
if	O
(	O
fd	int
==	O
0	int
)	O
{	O
log_notice	function
(	O
"changing fd from %d to 3"	pointer
,	O
fd	int
)	O
;	O
if	O
(	O
dup2	function
(	O
fd	int
,	O
3	int
)	O
!=	O
3	int
)	O
{	O
log_error	function
(	O
"couldn't dup2(%d,3): %s"	pointer
,	O
fd	int
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
log_exit	function
(	O
1	int
)	O
;	O
}	O
}	O
}	O
closed	pointer
=	O
FALSE	int
;	O
time	function
(	O
&	O
last_tunnel_write	long
)	O
;	O
while	O
(	O
!	O
closed	pointer
)	O
{	O
struct	O
pollfd	struct
pollfd	struct
[	O
2	int
]	O
;	O
int	O
timeout	int
;	O
time_t	long
t	long
;	O
int	O
n	long
;	O
pollfd	struct
[	O
0	int
]	O
.	O
fd	int
=	O
fd	int
;	O
pollfd	struct
[	O
0	int
]	O
.	O
events	short
=	O
POLLIN	int
;	O
pollfd	struct
[	O
1	int
]	O
.	O
fd	int
=	O
tunnel_pollin_fd	function
(	O
tunnel	pointer
)	O
;	O
pollfd	struct
[	O
1	int
]	O
.	O
events	short
=	O
POLLIN	int
;	O
time	function
(	O
&	O
t	long
)	O
;	O
timeout	int
=	O
1000	int
*	O
(	O
arg	pointer
.	O
keep_alive	int
-	O
(	O
t	long
-	O
last_tunnel_write	long
)	O
)	O
;	O
if	O
(	O
timeout	int
<	O
0	int
)	O
timeout	int
=	O
0	int
;	O
log_annoying	function
(	O
"poll () ..."	pointer
)	O
;	O
n	long
=	O
poll	function
(	O
pollfd	struct
,	O
2	int
,	O
timeout	int
)	O
;	O
log_annoying	function
(	O
"... = %d"	pointer
,	O
n	long
)	O
;	O
if	O
(	O
n	long
==	O
-	O
1	int
)	O
{	O
log_error	function
(	O
"poll error: %s\n"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
log_exit	function
(	O
1	int
)	O
;	O
}	O
else	O
if	O
(	O
n	long
==	O
0	int
)	O
{	O
log_verbose	function
(	O
"poll() timed out"	pointer
)	O
;	O
tunnel_padding	function
(	O
tunnel	pointer
,	O
1	int
)	O
;	O
time	function
(	O
&	O
last_tunnel_write	long
)	O
;	O
continue	O
;	O
}	O
log_annoying	function
(	O
"revents[0] = %x, revents[1] = %x, POLLIN = %x"	pointer
,	O
pollfd	struct
[	O
0	int
]	O
.	O
revents	short
,	O
pollfd	struct
[	O
1	int
]	O
.	O
revents	short
,	O
POLLIN	int
)	O
;	O
handle_input	function
(	O
"device or port"	pointer
,	O
tunnel	pointer
,	O
fd	int
,	O
pollfd	struct
[	O
0	int
]	O
.	O
revents	short
,	O
handle_device_input	function
,	O
&	O
closed	pointer
)	O
;	O
handle_input	function
(	O
"tunnel"	pointer
,	O
tunnel	pointer
,	O
fd	int
,	O
pollfd	struct
[	O
1	int
]	O
.	O
revents	short
,	O
handle_tunnel_input	function
,	O
&	O
closed	pointer
)	O
;	O
if	O
(	O
pollfd	struct
[	O
0	int
]	O
.	O
revents	short
&	O
POLLIN	int
)	O
time	function
(	O
&	O
last_tunnel_write	long
)	O
;	O
}	O
log_debug	function
(	O
"closing tunnel"	pointer
)	O
;	O
if	O
(	O
fd	int
!=	O
0	int
)	O
{	O
close	function
(	O
fd	int
)	O
;	O
}	O
tunnel_close	function
(	O
tunnel	pointer
)	O
;	O
log_notice	function
(	O
"disconnected from FIXME:hostname:port"	pointer
)	O
;	O
}	O
log_debug	function
(	O
"destroying tunnel"	pointer
)	O
;	O
tunnel_destroy	function
(	O
tunnel	pointer
)	O
;	O
log_exit	function
(	O
0	int
)	O
;	O
}	O

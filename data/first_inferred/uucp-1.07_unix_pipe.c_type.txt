const	O
char	O
pipe_rcsid	array
[	O
]	O
=	O
"$Id: pipe.c,v 1.10 2002/03/05 19:10:42 ian Rel $"	pointer
;	O
static	O
void	O
uspipe_free	function
P	O
(	O
(	O
struct	O
sconnection	struct
*	O
qconn	pointer
)	O
)	O
;	O
static	O
boolean	int
fspipe_open	function
P	O
(	O
(	O
struct	O
sconnection	struct
*	O
qconn	pointer
,	O
long	O
ibaud	long
,	O
boolean	int
fwait	int
,	O
boolean	int
fuser	int
)	O
)	O
;	O
static	O
boolean	int
fspipe_close	function
P	O
(	O
(	O
struct	O
sconnection	struct
*	O
qconn	pointer
,	O
pointer	pointer
puuconf	pointer
,	O
struct	O
uuconf_dialer	struct
*	O
qdialer	pointer
,	O
boolean	int
fsuccess	int
)	O
)	O
;	O
static	O
boolean	int
fspipe_dial	function
P	O
(	O
(	O
struct	O
sconnection	struct
*	O
qconn	pointer
,	O
pointer	pointer
puuconf	pointer
,	O
const	O
struct	O
uuconf_system	struct
*	O
qsys	pointer
,	O
const	O
char	O
*	O
zphone	pointer
,	O
struct	O
uuconf_dialer	struct
*	O
qdialer	pointer
,	O
enum	O
tdialerfound	enum
*	O
ptdialer	pointer
)	O
)	O
;	O
static	O
const	O
struct	O
sconncmds	struct
spipecmds	struct
=	O
{	O
uspipe_free	function
,	O
NULL	O
,	O
NULL	O
,	O
fspipe_open	function
,	O
fspipe_close	function
,	O
fspipe_dial	function
,	O
fsdouble_read	function
,	O
fsdouble_write	function
,	O
fsysdep_conn_io	function
,	O
NULL	O
,	O
NULL	O
,	O
NULL	O
,	O
fsdouble_chat	function
,	O
NULL	O
}	O
;	O
boolean	int
fsysdep_pipe_init	function
(	O
qconn	pointer
)	O
struct	O
sconnection	struct
*	O
qconn	pointer
;	O
{	O
struct	O
ssysdep_conn	struct
*	O
q	pointer
;	O
q	pointer
=	O
(	O
struct	O
ssysdep_conn	struct
*	O
)	O
xmalloc	function
(	O
sizeof	O
(	O
struct	O
ssysdep_conn	struct
)	O
)	O
;	O
q	pointer
->	O
o	int
=	O
-	O
1	int
;	O
q	pointer
->	O
ord	int
=	O
-	O
1	int
;	O
q	pointer
->	O
owr	int
=	O
-	O
1	int
;	O
q	pointer
->	O
zdevice	pointer
=	O
NULL	O
;	O
q	pointer
->	O
iflags	int
=	O
-	O
1	int
;	O
q	pointer
->	O
iwr_flags	int
=	O
-	O
1	int
;	O
q	pointer
->	O
fterminal	int
=	O
FALSE	O
;	O
q	pointer
->	O
ftli	int
=	O
FALSE	O
;	O
q	pointer
->	O
ibaud	long
=	O
0	int
;	O
q	pointer
->	O
ipid	int
=	O
-	O
1	int
;	O
qconn	pointer
->	O
psysdep	pointer
=	O
(	O
pointer	pointer
)	O
q	pointer
;	O
qconn	pointer
->	O
qcmds	pointer
=	O
&	O
spipecmds	struct
;	O
return	O
TRUE	O
;	O
}	O
static	O
void	O
uspipe_free	function
(	O
qconn	pointer
)	O
struct	O
sconnection	struct
*	O
qconn	pointer
;	O
{	O
xfree	function
(	O
qconn	pointer
->	O
psysdep	pointer
)	O
;	O
}	O
static	O
boolean	int
fspipe_open	function
(	O
qconn	pointer
,	O
ibaud	long
,	O
fwait	int
,	O
fuser	int
)	O
struct	O
sconnection	struct
*	O
qconn	pointer
ATTRIBUTE_UNUSED	O
;	O
long	O
ibaud	long
ATTRIBUTE_UNUSED	O
;	O
boolean	int
fwait	int
;	O
boolean	int
fuser	int
ATTRIBUTE_UNUSED	O
;	O
{	O
if	O
(	O
fwait	int
)	O
return	O
FALSE	O
;	O
return	O
TRUE	O
;	O
}	O
static	O
boolean	int
fspipe_close	function
(	O
qconn	pointer
,	O
puuconf	pointer
,	O
qdialer	pointer
,	O
fsuccess	int
)	O
struct	O
sconnection	struct
*	O
qconn	pointer
;	O
pointer	pointer
puuconf	pointer
ATTRIBUTE_UNUSED	O
;	O
struct	O
uuconf_dialer	struct
*	O
qdialer	pointer
ATTRIBUTE_UNUSED	O
;	O
boolean	int
fsuccess	int
ATTRIBUTE_UNUSED	O
;	O
{	O
struct	O
ssysdep_conn	struct
*	O
qsysdep	pointer
;	O
boolean	int
fret	int
;	O
qsysdep	pointer
=	O
(	O
struct	O
ssysdep_conn	struct
*	O
)	O
qconn	pointer
->	O
psysdep	pointer
;	O
fret	int
=	O
TRUE	O
;	O
if	O
(	O
qsysdep	pointer
->	O
ord	int
>=	O
0	int
&&	O
close	function
(	O
qsysdep	pointer
->	O
ord	int
)	O
<	O
0	int
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"fspipe_close: close read fd: %s"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
fret	int
=	O
FALSE	O
;	O
}	O
if	O
(	O
qsysdep	pointer
->	O
owr	int
!=	O
qsysdep	pointer
->	O
ord	int
&&	O
qsysdep	pointer
->	O
owr	int
>=	O
0	int
&&	O
close	function
(	O
qsysdep	pointer
->	O
owr	int
)	O
<	O
0	int
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"fspipe_close: close write fd: %s"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
fret	int
=	O
FALSE	O
;	O
}	O
qsysdep	pointer
->	O
ord	int
=	O
-	O
1	int
;	O
qsysdep	pointer
->	O
owr	int
=	O
-	O
1	int
;	O
if	O
(	O
qsysdep	pointer
->	O
ipid	int
>=	O
0	int
)	O
{	O
if	O
(	O
kill	function
(	O
qsysdep	pointer
->	O
ipid	int
,	O
SIGHUP	int
)	O
==	O
0	int
)	O
usysdep_sleep	function
(	O
2	int
)	O
;	O
if	O
(	O
kill	function
(	O
qsysdep	pointer
->	O
ipid	int
,	O
SIGPIPE	int
)	O
==	O
0	int
)	O
usysdep_sleep	function
(	O
2	int
)	O
;	O
if	O
(	O
kill	function
(	O
qsysdep	pointer
->	O
ipid	int
,	O
SIGKILL	int
)	O
<	O
0	int
&&	O
errno	O
==	O
EPERM	int
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"fspipe_close: Cannot kill child pid %lu: %s"	pointer
,	O
(	O
unsigned	O
long	O
)	O
qsysdep	pointer
->	O
ipid	int
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
fret	int
=	O
FALSE	O
;	O
}	O
else	O
(	O
void	O
)	O
ixswait	function
(	O
(	O
unsigned	O
long	O
)	O
qsysdep	pointer
->	O
ipid	int
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
)	O
;	O
}	O
qsysdep	pointer
->	O
ipid	int
=	O
-	O
1	int
;	O
return	O
fret	int
;	O
}	O
static	O
boolean	int
fspipe_dial	function
(	O
qconn	pointer
,	O
puuconf	pointer
,	O
qsys	pointer
,	O
zphone	pointer
,	O
qdialer	pointer
,	O
ptdialer	pointer
)	O
struct	O
sconnection	struct
*	O
qconn	pointer
;	O
pointer	pointer
puuconf	pointer
;	O
const	O
struct	O
uuconf_system	struct
*	O
qsys	pointer
ATTRIBUTE_UNUSED	O
;	O
const	O
char	O
*	O
zphone	pointer
ATTRIBUTE_UNUSED	O
;	O
struct	O
uuconf_dialer	struct
*	O
qdialer	pointer
;	O
enum	O
tdialerfound	enum
*	O
ptdialer	pointer
;	O
{	O
struct	O
ssysdep_conn	struct
*	O
q	pointer
;	O
int	O
aidescs	pointer
[	O
3	int
]	O
;	O
const	O
char	O
*	O
*	O
pzprog	pointer
;	O
q	pointer
=	O
(	O
struct	O
ssysdep_conn	struct
*	O
)	O
qconn	pointer
->	O
psysdep	pointer
;	O
*	O
ptdialer	pointer
=	O
DIALERFOUND_FALSE	int
;	O
pzprog	pointer
=	O
(	O
const	O
char	O
*	O
*	O
)	O
qconn	pointer
->	O
qport	pointer
->	O
uuconf_u	union
.	O
uuconf_spipe	struct
.	O
uuconf_pzcmd	pointer
;	O
if	O
(	O
pzprog	pointer
==	O
NULL	O
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"No command for pipe connection"	pointer
)	O
;	O
return	O
FALSE	O
;	O
}	O
aidescs	pointer
[	O
0	int
]	O
=	O
SPAWN_WRITE_PIPE	O
;	O
aidescs	pointer
[	O
1	int
]	O
=	O
SPAWN_READ_PIPE	O
;	O
aidescs	pointer
[	O
2	int
]	O
=	O
SPAWN_NULL	O
;	O
q	pointer
->	O
ipid	int
=	O
ixsspawn	function
(	O
pzprog	pointer
,	O
aidescs	pointer
,	O
TRUE	O
,	O
TRUE	O
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
FALSE	O
,	O
TRUE	O
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
)	O
;	O
if	O
(	O
q	pointer
->	O
ipid	int
<	O
0	int
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"ixsspawn (%s): %s"	pointer
,	O
pzprog	pointer
[	O
0	int
]	O
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
return	O
FALSE	O
;	O
}	O
q	pointer
->	O
owr	int
=	O
aidescs	pointer
[	O
0	int
]	O
;	O
q	pointer
->	O
ord	int
=	O
aidescs	pointer
[	O
1	int
]	O
;	O
q	pointer
->	O
o	int
=	O
q	pointer
->	O
ord	int
;	O
q	pointer
->	O
iflags	int
=	O
fcntl	function
(	O
q	pointer
->	O
ord	int
,	O
F_GETFL	int
,	O
0	int
)	O
;	O
q	pointer
->	O
iwr_flags	int
=	O
fcntl	function
(	O
q	pointer
->	O
owr	int
,	O
F_GETFL	int
,	O
0	int
)	O
;	O
if	O
(	O
q	pointer
->	O
iflags	int
<	O
0	int
||	O
q	pointer
->	O
iwr_flags	int
<	O
0	int
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"fspipe_dial: fcntl: %s"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
(	O
void	O
)	O
fspipe_close	function
(	O
qconn	pointer
,	O
puuconf	pointer
,	O
qdialer	pointer
,	O
FALSE	O
)	O
;	O
return	O
FALSE	O
;	O
}	O
return	O
TRUE	O
;	O
}	O

int	O
fasload	O
(	O
faslfile	O
)	O
object	O
faslfile	O
;	O
{	O
object	O
memory	O
,	O
data	O
,	O
tempfile	O
;	O
FILE	O
*	O
fp	O
;	O
char	O
filename	O
[	O
MAXPATHLEN	int
]	O
;	O
char	O
tempfilename	O
[	O
32	int
]	O
;	O
char	O
command	O
[	O
MAXPATHLEN	int
*	O
2	int
]	O
;	O
int	O
i	O
;	O
object	O
*	O
old_vs_base	O
=	O
vs_base	O
;	O
object	O
*	O
old_vs_top	O
=	O
vs_top	O
;	O
coerce_to_filename	O
(	O
faslfile	O
,	O
filename	O
)	O
;	O
faslfile	O
=	O
open_stream	O
(	O
faslfile	O
,	O
smm_input	O
,	O
Cnil	O
,	O
sKerror	O
)	O
;	O
vs_push	O
(	O
faslfile	O
)	O
;	O
fp	O
=	O
faslfile	O
->	O
sm	O
.	O
sm_fp	O
;	O
HEADER_SEEK	O
(	O
fp	O
)	O
;	O
memory	O
=	O
alloc_object	O
(	O
t_cfdata	O
)	O
;	O
memory	O
->	O
cfd	O
.	O
cfd_self	O
=	O
NULL	O
;	O
memory	O
->	O
cfd	O
.	O
cfd_start	O
=	O
NULL	O
;	O
memory	O
->	O
cfd	O
.	O
cfd_size	O
=	O
textsize	O
+	O
datasize	O
+	O
bsssize	O
;	O
vs_push	O
(	O
memory	O
)	O
;	O
if	O
(	O
file_len	O
(	O
fp	O
)	O
*	O
4	int
<	O
memory	O
->	O
cfd	O
.	O
cfd_size	O
)	O
FEerror	O
(	O
"Invalid object file stream: ~a"	*(char)
,	O
1	int
,	O
faslfile	O
)	O
;	O
memory	O
->	O
cfd	O
.	O
cfd_start	O
=	O
ALLOC_ALIGNED	O
(	O
alloc_contblock	O
,	O
memory	O
->	O
cfd	O
.	O
cfd_size	O
,	O
sizeof	O
(	O
double	O
)	O
)	O
;	O
data	O
=	O
read_fasl_vector	O
(	O
faslfile	O
)	O
;	O
vs_push	O
(	O
data	O
)	O
;	O
close_stream	O
(	O
faslfile	O
)	O
;	O
sprintf	O
(	O
tempfilename	O
,	O
"/tmp/fasltemp%d"	*(char)
,	O
getpid	O
(	O
)	O
)	O
;	O
AGAIN	O
:	O
if	O
(	O
system	O
(	O
command	O
)	O
!=	O
0	int
)	O
FEerror	O
(	O
"The linkage editor failed."	*(char)
,	O
0	int
)	O
;	O
tempfile	O
=	O
make_simple_string	O
(	O
tempfilename	O
)	O
;	O
vs_push	O
(	O
tempfile	O
)	O
;	O
tempfile	O
=	O
open_stream	O
(	O
tempfile	O
,	O
smm_input	O
,	O
Cnil	O
,	O
sKerror	O
)	O
;	O
vs_push	O
(	O
tempfile	O
)	O
;	O
fp	O
=	O
tempfile	O
->	O
sm	O
.	O
sm_fp	O
;	O
HEADER_SEEK	O
(	O
fp	O
)	O
;	O
if	O
(	O
fseek	O
(	O
fp	O
,	O
textstart	O
,	O
0	int
)	O
<	O
0	int
)	O
error	O
(	O
"file seek error"	*(char)
)	O
;	O
fread	O
(	O
memory	O
->	O
cfd	O
.	O
cfd_start	O
,	O
textsize	O
+	O
datasize	O
,	O
1	int
,	O
fp	O
)	O
;	O
close_stream	O
(	O
tempfile	O
)	O
;	O
unlink	O
(	O
tempfilename	O
)	O
;	O
call_init	O
(	O
0	int
,	O
memory	O
,	O
data	O
,	O
0	int
)	O
;	O
vs_base	O
=	O
old_vs_base	O
;	O
vs_top	O
=	O
old_vs_top	O
;	O
return	O
(	O
memory	O
->	O
cfd	O
.	O
cfd_size	O
)	O
;	O
}	O
void	O
gcl_init_unixfasl	()->(void)
(	O
void	O
)	O
{	O
}	O

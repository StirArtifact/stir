struct	O
sockaddr_in	struct(short,short,struct(int),array(char))
daemon_addr	struct(short,short,struct(int),array(char))
=	O
{	O
AF_INET	O
}	O
;	O
struct	O
sockaddr_in	struct(short,short,struct(int),array(char))
ctl_addr	struct(short,array(char))
=	O
{	O
AF_INET	O
}	O
;	O
struct	O
sockaddr_in	struct(short,short,struct(int),array(char))
my_addr	struct(short,short,struct(int),array(char))
=	O
{	O
AF_INET	O
}	O
;	O
struct	O
in_addr	struct(int)
my_machine_addr	struct(int)
;	O
struct	O
in_addr	struct(int)
his_machine_addr	struct(int)
;	O
unsigned	O
short	O
daemon_port	short
;	O
int	O
ctl_sockt	int
;	O
int	O
sockt	int
;	O
int	O
invitation_waiting	int
=	O
0	int
;	O
CTL_MSG	struct(char,char,char,char,int,struct(short,array(char)),struct(short,array(char)),int,array(char),array(char),array(char))
msg	struct(char,char,char,char,int,struct(short,array(char)),struct(short,array(char)),int,array(char),array(char),array(char))
;	O
int	O
open_sockt	()->(int)
(	O
void	O
)	O
{	O
socklen_t	int
length	int
;	O
my_addr	struct(short,short,struct(int),array(char))
.	O
sin_addr	struct(int)
=	O
my_machine_addr	struct(int)
;	O
my_addr	struct(short,short,struct(int),array(char))
.	O
sin_port	short
=	O
0	int
;	O
sockt	int
=	O
socket	(int,int,int)->(int)
(	O
AF_INET	O
,	O
SOCK_STREAM	int
,	O
0	int
)	O
;	O
if	O
(	O
sockt	int
<=	O
0	int
)	O
p_error	(*(char))->(int)
(	O
"Bad socket"	*(char)
)	O
;	O
if	O
(	O
bind	(int,union(*(struct(short,array(char))),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct)),int)->(int)
(	O
sockt	int
,	O
(	O
struct	O
sockaddr	struct(short,array(char))
*	O
)	O
&	O
my_addr	struct(short,short,struct(int),array(char))
,	O
sizeof	O
(	O
my_addr	struct(short,short,struct(int),array(char))
)	O
)	O
!=	O
0	int
)	O
p_error	(*(char))->(int)
(	O
"Binding local socket"	*(char)
)	O
;	O
length	int
=	O
sizeof	O
(	O
my_addr	struct(short,short,struct(int),array(char))
)	O
;	O
if	O
(	O
getsockname	(int,union(*(struct(short,array(char))),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct)),*(int))->(int)
(	O
sockt	int
,	O
(	O
struct	O
sockaddr	struct(short,array(char))
*	O
)	O
&	O
my_addr	struct(short,short,struct(int),array(char))
,	O
&	O
length	int
)	O
==	O
-	O
1	int
)	O
p_error	(*(char))->(int)
(	O
"Bad address for socket"	*(char)
)	O
;	O
return	O
0	int
;	O
}	O
int	O
open_ctl	()->(int)
(	O
void	O
)	O
{	O
socklen_t	int
length	int
;	O
ctl_addr	struct(short,array(char))
.	O
sin_port	short
=	O
0	int
;	O
ctl_addr	struct(short,array(char))
.	O
sin_addr	struct(int)
=	O
my_machine_addr	struct(int)
;	O
ctl_sockt	int
=	O
socket	(int,int,int)->(int)
(	O
AF_INET	O
,	O
SOCK_DGRAM	int
,	O
0	int
)	O
;	O
if	O
(	O
ctl_sockt	int
<=	O
0	int
)	O
p_error	(*(char))->(int)
(	O
"Bad socket"	*(char)
)	O
;	O
if	O
(	O
bind	(int,union(*(struct(short,array(char))),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct)),int)->(int)
(	O
ctl_sockt	int
,	O
(	O
struct	O
sockaddr	struct(short,array(char))
*	O
)	O
&	O
ctl_addr	struct(short,array(char))
,	O
sizeof	O
(	O
ctl_addr	struct(short,array(char))
)	O
)	O
!=	O
0	int
)	O
p_error	(*(char))->(int)
(	O
"Couldn't bind to control socket"	*(char)
)	O
;	O
length	int
=	O
sizeof	O
(	O
ctl_addr	struct(short,array(char))
)	O
;	O
if	O
(	O
getsockname	(int,union(*(struct(short,array(char))),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct),*(struct)),*(int))->(int)
(	O
ctl_sockt	int
,	O
(	O
struct	O
sockaddr	struct(short,array(char))
*	O
)	O
&	O
ctl_addr	struct(short,array(char))
,	O
&	O
length	int
)	O
==	O
-	O
1	int
)	O
p_error	(*(char))->(int)
(	O
"Bad address for ctl socket"	*(char)
)	O
;	O
return	O
0	int
;	O
}	O

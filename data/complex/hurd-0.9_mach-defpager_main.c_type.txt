mach_port_t	O
bootstrap_master_device_port	int
;	O
mach_port_t	O
bootstrap_master_host_port	int
;	O
extern	O
void	O
default_pager	()->(void)
(	O
)	O
;	O
extern	O
void	O
default_pager_initialize	()->(void)
(	O
)	O
;	O
extern	O
void	O
default_pager_setup	()->(void)
(	O
)	O
;	O
extern	O
mach_port_t	O
default_pager_exception_port	int
;	O
static	O
void	O
printf_init	(int)->(void)
(	O
device_t	O
master	int
)	O
{	O
mach_port_t	O
cons	O
;	O
kern_return_t	O
rc	O
;	O
rc	O
=	O
device_open	()->(int)
(	O
master	int
,	O
D_READ	O
|	O
D_WRITE	O
,	O
"console"	*(char)
,	O
&	O
cons	O
)	O
;	O
if	O
(	O
rc	O
)	O
error	()->(int)
(	O
2	int
,	O
rc	O
,	O
"cannot open kernel console device"	*(char)
)	O
;	O
stdin	O
=	O
mach_open_devstream	()->(int)
(	O
cons	O
,	O
"r"	*(char)
)	O
;	O
stdout	O
=	O
stderr	O
=	O
mach_open_devstream	()->(int)
(	O
cons	O
,	O
"w"	*(char)
)	O
;	O
mach_port_deallocate	()->(int)
(	O
mach_task_self	()->(int)
(	O
)	O
,	O
cons	O
)	O
;	O
setbuf	()->(int)
(	O
stdout	O
,	O
0	int
)	O
;	O
}	O
int	O
debug	int
;	O
static	O
void	O
nohandler	(int)->(void)
(	O
int	O
sig	int
)	O
{	O
}	O
int	O
main	(int,*(*(char)))->(int)
(	O
int	O
argc	int
,	O
char	O
*	O
*	O
argv	*(*(char))
)	O
{	O
const	O
task_t	O
my_task	int
=	O
mach_task_self	()->(int)
(	O
)	O
;	O
error_t	O
err	O
;	O
memory_object_t	O
defpager	O
;	O
err	O
=	O
get_privileged_ports	()->(int)
(	O
&	O
bootstrap_master_host_port	int
,	O
&	O
bootstrap_master_device_port	int
)	O
;	O
if	O
(	O
err	O
)	O
error	()->(int)
(	O
1	int
,	O
err	O
,	O
"cannot get privileged ports"	*(char)
)	O
;	O
defpager	O
=	O
MACH_PORT_NULL	O
;	O
err	O
=	O
vm_set_default_memory_manager	()->(int)
(	O
bootstrap_master_host_port	int
,	O
&	O
defpager	O
)	O
;	O
if	O
(	O
err	O
)	O
error	()->(int)
(	O
1	int
,	O
err	O
,	O
"cannot check current default memory manager"	*(char)
)	O
;	O
if	O
(	O
MACH_PORT_VALID	()->(int)
(	O
defpager	O
)	O
)	O
error	()->(int)
(	O
2	int
,	O
0	int
,	O
"Another default memory manager is already running"	*(char)
)	O
;	O
if	O
(	O
!	O
(	O
argc	int
==	O
2	int
&&	O
!	O
strcmp	O
(	O
argv	*(*(char))
[	O
1	int
]	O
,	O
"-d"	*(char)
)	O
)	O
)	O
{	O
sigset_t	O
set	O
;	O
signal	()->(int)
(	O
SIGUSR1	O
,	O
nohandler	(int)->(void)
)	O
;	O
signal	()->(int)
(	O
SIGCHLD	O
,	O
nohandler	(int)->(void)
)	O
;	O
sigemptyset	()->(int)
(	O
&	O
set	O
)	O
;	O
sigaddset	()->(int)
(	O
&	O
set	O
,	O
SIGUSR1	O
)	O
;	O
sigaddset	()->(int)
(	O
&	O
set	O
,	O
SIGCHLD	O
)	O
;	O
sigprocmask	()->(int)
(	O
SIG_SETMASK	O
,	O
&	O
set	O
,	O
NULL	O
)	O
;	O
switch	O
(	O
fork	()->(int)
(	O
)	O
)	O
{	O
case	O
-	O
1	int
:	O
error	()->(int)
(	O
1	int
,	O
errno	O
,	O
"cannot become daemon"	*(char)
)	O
;	O
case	O
0	int
:	O
setsid	()->(int)
(	O
)	O
;	O
chdir	()->(int)
(	O
"/"	*(char)
)	O
;	O
close	()->(int)
(	O
0	int
)	O
;	O
close	()->(int)
(	O
1	int
)	O
;	O
close	()->(int)
(	O
2	int
)	O
;	O
break	O
;	O
default	O
:	O
sigemptyset	()->(int)
(	O
&	O
set	O
)	O
;	O
sigsuspend	()->(int)
(	O
&	O
set	O
)	O
;	O
_exit	O
(	O
0	int
)	O
;	O
}	O
}	O
mach_port_t	O
proc	O
=	O
getproc	O
(	O
)	O
;	O
if	O
(	O
proc	O
==	O
MACH_PORT_NULL	O
)	O
error	()->(int)
(	O
3	int
,	O
err	O
,	O
"cannot get a handle to our process"	*(char)
)	O
;	O
err	O
=	O
proc_mark_important	()->(int)
(	O
proc	O
)	O
;	O
if	O
(	O
err	O
&&	O
err	O
!=	O
EPERM	O
&&	O
err	O
!=	O
EMIG_BAD_ID	O
)	O
error	()->(int)
(	O
3	int
,	O
err	O
,	O
"cannot mark us as important"	*(char)
)	O
;	O
mach_port_deallocate	()->(int)
(	O
mach_task_self	()->(int)
(	O
)	O
,	O
proc	O
)	O
;	O
printf_init	(int)->(void)
(	O
bootstrap_master_device_port	int
)	O
;	O
partition_init	()->(int)
(	O
)	O
;	O
(	O
void	O
)	O
mach_port_insert_right	()->(int)
(	O
my_task	int
,	O
default_pager_exception_port	int
,	O
default_pager_exception_port	int
,	O
MACH_MSG_TYPE_MAKE_SEND	O
)	O
;	O
if	O
(	O
!	O
debug	int
)	O
(	O
void	O
)	O
task_set_exception_port	()->(int)
(	O
my_task	int
,	O
default_pager_exception_port	int
)	O
;	O
default_pager_initialize	()->(void)
(	O
bootstrap_master_host_port	int
)	O
;	O
if	O
(	O
!	O
(	O
argc	int
==	O
2	int
&&	O
!	O
strcmp	O
(	O
argv	*(*(char))
[	O
1	int
]	O
,	O
"-d"	*(char)
)	O
)	O
)	O
kill	()->(int)
(	O
getppid	()->(int)
(	O
)	O
,	O
SIGUSR1	O
)	O
;	O
default_pager	()->(void)
(	O
)	O
;	O
return	O
-	O
1	int
;	O
}	O
void	O
panic	(*(char))->(void)
(	O
const	O
char	O
*	O
fmt	*(char)
,	O
...	O
)	O
{	O
va_list	O
ap	O
;	O
fprintf	()->(int)
(	O
stderr	O
,	O
"%s: panic: "	*(char)
,	O
program_invocation_name	O
)	O
;	O
va_start	O
(	O
ap	O
,	O
fmt	*(char)
)	O
;	O
vfprintf	()->(int)
(	O
stderr	O
,	O
fmt	*(char)
,	O
ap	O
)	O
;	O
va_end	O
(	O
ap	O
)	O
;	O
exit	O
(	O
3	int
)	O
;	O
}	O

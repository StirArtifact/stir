int	O
MHD_add_to_fd_set_	(int,*(struct(array(long))),*(int),int)->(int)
(	O
MHD_socket	int
fd	int
,	O
fd_set	struct(array(long))
*	O
set	*(struct(array(long)))
,	O
MHD_socket	int
*	O
max_fd	*(int)
,	O
unsigned	O
int	O
fd_setsize	int
)	O
{	O
if	O
(	O
(	O
NULL	O
==	O
set	*(struct(array(long)))
)	O
||	O
(	O
MHD_INVALID_SOCKET	O
==	O
fd	int
)	O
)	O
return	O
0	int
;	O
if	O
(	O
!	O
MHD_SCKT_FD_FITS_FDSET_SETSIZE_	O
(	O
fd	int
,	O
set	*(struct(array(long)))
,	O
fd_setsize	int
)	O
)	O
return	O
0	int
;	O
MHD_SCKT_ADD_FD_TO_FDSET_SETSIZE_	O
(	O
fd	int
,	O
set	*(struct(array(long)))
,	O
fd_setsize	int
)	O
;	O
if	O
(	O
(	O
NULL	O
!=	O
max_fd	*(int)
)	O
&&	O
(	O
(	O
fd	int
>	O
*	O
max_fd	*(int)
)	O
||	O
(	O
MHD_INVALID_SOCKET	O
==	O
*	O
max_fd	*(int)
)	O
)	O
)	O
*	O
max_fd	*(int)
=	O
fd	int
;	O
return	O
!	O
0	int
;	O
}	O
int	O
MHD_socket_nonblocking_	(int)->(int)
(	O
MHD_socket	int
sock	int
)	O
{	O
int	O
flags	int
;	O
flags	int
=	O
fcntl	(int,int)->(int)
(	O
sock	int
,	O
F_GETFL	int
)	O
;	O
if	O
(	O
-	O
1	int
==	O
flags	int
)	O
return	O
0	int
;	O
if	O
(	O
(	O
(	O
flags	int
|	O
O_NONBLOCK	int
)	O
!=	O
flags	int
)	O
&&	O
(	O
0	int
!=	O
fcntl	(int,int)->(int)
(	O
sock	int
,	O
F_SETFL	int
,	O
flags	int
|	O
O_NONBLOCK	int
)	O
)	O
)	O
return	O
0	int
;	O
return	O
!	O
0	int
;	O
}	O
int	O
MHD_socket_noninheritable_	(int)->(int)
(	O
MHD_socket	int
sock	int
)	O
{	O
int	O
flags	int
;	O
flags	int
=	O
fcntl	(int,int)->(int)
(	O
sock	int
,	O
F_GETFD	int
)	O
;	O
if	O
(	O
-	O
1	int
==	O
flags	int
)	O
return	O
0	int
;	O
if	O
(	O
(	O
(	O
flags	int
|	O
FD_CLOEXEC	int
)	O
!=	O
flags	int
)	O
&&	O
(	O
0	int
!=	O
fcntl	(int,int)->(int)
(	O
sock	int
,	O
F_SETFD	int
,	O
flags	int
|	O
FD_CLOEXEC	int
)	O
)	O
)	O
return	O
0	int
;	O
return	O
!	O
0	int
;	O
}	O
int	O
MHD_socket_set_nodelay_	(int,bool)->(int)
(	O
MHD_socket	int
sock	int
,	O
bool	bool
on	bool
)	O
{	O
{	O
const	O
MHD_SCKT_OPT_BOOL_	int
off_val	int
=	O
0	int
;	O
const	O
MHD_SCKT_OPT_BOOL_	int
on_val	int
=	O
1	int
;	O
return	O
setsockopt	(int,int,int,*(void),int)->(int)
(	O
sock	int
,	O
IPPROTO_TCP	int
,	O
TCP_NODELAY	int
,	O
(	O
const	O
void	O
*	O
)	O
(	O
on	bool
)	O
?	O
&	O
on_val	int
:	O
&	O
off_val	int
,	O
sizeof	O
(	O
on_val	int
)	O
)	O
;	O
}	O
}	O
int	O
MHD_socket_cork_	(int,bool)->(int)
(	O
MHD_socket	int
sock	int
,	O
bool	bool
on	bool
)	O
{	O
const	O
MHD_SCKT_OPT_BOOL_	int
off_val	int
=	O
0	int
;	O
const	O
MHD_SCKT_OPT_BOOL_	int
on_val	int
=	O
1	int
;	O
if	O
(	O
0	int
!=	O
setsockopt	(int,int,int,*(void),int)->(int)
(	O
sock	int
,	O
IPPROTO_TCP	int
,	O
MHD_TCP_CORK_NOPUSH	O
,	O
(	O
const	O
void	O
*	O
)	O
(	O
on	bool
?	O
&	O
on_val	int
:	O
&	O
off_val	int
)	O
,	O
sizeof	O
(	O
off_val	int
)	O
)	O
)	O
return	O
0	int
;	O
return	O
1	int
;	O
}	O
int	O
MHD_socket_buffering_reset_	(int)->(int)
(	O
MHD_socket	int
sock	int
)	O
{	O
int	O
res	int
=	O
!	O
MHD_socket_set_nodelay_	(int,bool)->(int)
(	O
sock	int
,	O
true	int
)	O
;	O
return	O
MHD_socket_cork_	(int,bool)->(int)
(	O
sock	int
,	O
false	int
)	O
&&	O
res	int
;	O
}	O
MHD_socket	int
MHD_socket_create_listen_	(int)->(int)
(	O
int	O
pf	int
)	O
{	O
MHD_socket	int
fd	int
;	O
int	O
cloexec_set	int
;	O
fd	int
=	O
socket	(int,int,int)->(int)
(	O
pf	int
,	O
SOCK_STREAM	int
|	O
SOCK_CLOEXEC	int
|	O
MAYBE_SOCK_NOSIGPIPE	int
,	O
0	int
)	O
;	O
cloexec_set	int
=	O
(	O
MAYBE_SOCK_CLOEXEC	O
!=	O
0	int
)	O
;	O
if	O
(	O
MHD_INVALID_SOCKET	O
==	O
fd	int
)	O
{	O
fd	int
=	O
socket	(int,int,int)->(int)
(	O
pf	int
,	O
SOCK_STREAM	int
,	O
0	int
)	O
;	O
cloexec_set	int
=	O
0	int
;	O
}	O
if	O
(	O
MHD_INVALID_SOCKET	O
==	O
fd	int
)	O
return	O
MHD_INVALID_SOCKET	O
;	O
if	O
(	O
!	O
cloexec_set	int
)	O
(	O
void	O
)	O
MHD_socket_noninheritable_	(int)->(int)
(	O
fd	int
)	O
;	O
return	O
fd	int
;	O
}	O

void	O
waitdaemon_timeout	(int)->(void)
(	O
int	O
signo	int
)	O
{	O
int	O
left	int
;	O
left	int
=	O
alarm	(int)->(int)
(	O
0	int
)	O
;	O
signal	(int,*((int)->(void)))->(*((int)->(void)))
(	O
SIGALRM	int
,	O
SIG_DFL	O
)	O
;	O
if	O
(	O
left	int
==	O
0	int
)	O
error	(int,int,*(char))->(void)
(	O
EXIT_FAILURE	int
,	O
0	int
,	O
"timed out waiting for child"	*(char)
)	O
;	O
}	O
int	O
waitdaemon	(int,int,int)->(int)
(	O
int	O
nochdir	int
,	O
int	O
noclose	int
,	O
int	O
maxwait	int
)	O
{	O
int	O
fd	int
;	O
pid_t	int
childpid	int
;	O
pid_t	int
ppid	int
;	O
ppid	int
=	O
getpid	()->(int)
(	O
)	O
;	O
switch	O
(	O
childpid	int
=	O
fork	()->(int)
(	O
)	O
)	O
{	O
case	O
-	O
1	int
:	O
return	O
(	O
-	O
1	int
)	O
;	O
case	O
0	int
:	O
break	O
;	O
default	O
:	O
if	O
(	O
maxwait	int
>	O
0	int
)	O
{	O
signal	(int,*((int)->(void)))->(*((int)->(void)))
(	O
SIGALRM	int
,	O
waitdaemon_timeout	(int)->(void)
)	O
;	O
alarm	(int)->(int)
(	O
maxwait	int
)	O
;	O
pause	()->(int)
(	O
)	O
;	O
}	O
_exit	(int)->(void)
(	O
0	int
)	O
;	O
}	O
if	O
(	O
setsid	()->(int)
(	O
)	O
==	O
-	O
1	int
)	O
return	O
-	O
1	int
;	O
signal	(int,*((int)->(void)))->(*((int)->(void)))
(	O
SIGHUP	int
,	O
SIG_IGN	O
)	O
;	O
switch	O
(	O
fork	()->(int)
(	O
)	O
)	O
{	O
case	O
0	int
:	O
break	O
;	O
case	O
-	O
1	int
:	O
return	O
-	O
1	int
;	O
default	O
:	O
_exit	(int)->(void)
(	O
0	int
)	O
;	O
}	O
if	O
(	O
!	O
nochdir	int
)	O
chdir	(*(char))->(int)
(	O
"/"	*(char)
)	O
;	O
if	O
(	O
!	O
noclose	int
)	O
{	O
int	O
i	int
;	O
long	O
fdlimit	long
=	O
-	O
1	int
;	O
fdlimit	long
=	O
getdtablesize	()->(int)
(	O
)	O
;	O
if	O
(	O
fdlimit	long
==	O
-	O
1	int
)	O
fdlimit	long
=	O
MAXFD	int
;	O
for	O
(	O
i	int
=	O
0	int
;	O
i	int
<	O
fdlimit	long
;	O
i	int
++	O
)	O
close	(int)->(int)
(	O
i	int
)	O
;	O
fd	int
=	O
open	(*(char),int)->(int)
(	O
PATH_DEVNULL	O
,	O
O_RDWR	int
,	O
0	int
)	O
;	O
if	O
(	O
fd	int
!=	O
-	O
1	int
)	O
{	O
dup2	(int,int)->(int)
(	O
fd	int
,	O
STDIN_FILENO	int
)	O
;	O
dup2	(int,int)->(int)
(	O
fd	int
,	O
STDOUT_FILENO	int
)	O
;	O
dup2	(int,int)->(int)
(	O
fd	int
,	O
STDERR_FILENO	int
)	O
;	O
if	O
(	O
fd	int
>	O
2	int
)	O
close	(int)->(int)
(	O
fd	int
)	O
;	O
}	O
}	O
return	O
ppid	int
;	O
}	O
int	O
daemon	(int,int)->(int)
(	O
int	O
nochdir	int
,	O
int	O
noclose	int
)	O
{	O
return	O
(	O
waitdaemon	(int,int,int)->(int)
(	O
nochdir	int
,	O
noclose	int
,	O
0	int
)	O
==	O
-	O
1	int
)	O
?	O
-	O
1	int
:	O
0	int
;	O
}	O

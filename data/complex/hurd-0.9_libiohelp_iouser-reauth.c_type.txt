error_t	O
iohelp_reauth	(*(*(struct(*(struct`),*(struct`),*(void)))),int,int,int,int)->(int)
(	O
struct	O
iouser	struct(*(struct),*(struct),*(void))
*	O
*	O
user	*(*(struct(*(struct),*(struct),*(void))))
,	O
auth_t	int
authserver	int
,	O
mach_port_t	O
rend_port	int
,	O
mach_port_t	O
newright	int
,	O
int	O
permit_failure	int
)	O
{	O
uid_t	O
gubuf	O
[	O
20	int
]	O
,	O
ggbuf	O
[	O
20	int
]	O
,	O
aubuf	O
[	O
20	int
]	O
,	O
agbuf	O
[	O
20	int
]	O
;	O
uid_t	O
*	O
gen_uids	O
,	O
*	O
gen_gids	O
,	O
*	O
aux_uids	O
,	O
*	O
aux_gids	O
;	O
size_t	O
genuidlen	O
,	O
gengidlen	O
,	O
auxuidlen	O
,	O
auxgidlen	O
;	O
error_t	O
err	O
;	O
struct	O
iouser	struct(*(struct),*(struct),*(void))
*	O
new	*(struct(*(struct),*(struct),*(void)))
;	O
*	O
user	*(*(struct(*(struct),*(struct),*(void))))
=	O
new	*(struct(*(struct),*(struct),*(void)))
=	O
malloc	O
(	O
sizeof	O
(	O
struct	O
iouser	struct(*(struct),*(struct),*(void))
)	O
)	O
;	O
if	O
(	O
!	O
new	*(struct(*(struct),*(struct),*(void)))
)	O
return	O
ENOMEM	O
;	O
new	*(struct(*(struct),*(struct),*(void)))
->	O
uids	*(struct)
=	O
make_idvec	()->(int)
(	O
)	O
;	O
new	*(struct(*(struct),*(struct),*(void)))
->	O
gids	*(struct)
=	O
make_idvec	()->(int)
(	O
)	O
;	O
if	O
(	O
!	O
new	*(struct(*(struct),*(struct),*(void)))
->	O
uids	*(struct)
||	O
!	O
new	*(struct(*(struct),*(struct),*(void)))
->	O
gids	*(struct)
)	O
{	O
if	O
(	O
new	*(struct(*(struct),*(struct),*(void)))
->	O
uids	*(struct)
)	O
idvec_free	()->(int)
(	O
new	*(struct(*(struct),*(struct),*(void)))
->	O
uids	*(struct)
)	O
;	O
if	O
(	O
new	*(struct(*(struct),*(struct),*(void)))
->	O
gids	*(struct)
)	O
idvec_free	()->(int)
(	O
new	*(struct(*(struct),*(struct),*(void)))
->	O
gids	*(struct)
)	O
;	O
free	()->(int)
(	O
new	*(struct(*(struct),*(struct),*(void)))
)	O
;	O
return	O
ENOMEM	O
;	O
}	O
genuidlen	O
=	O
gengidlen	O
=	O
auxuidlen	O
=	O
auxgidlen	O
=	O
20	int
;	O
gen_uids	O
=	O
gubuf	O
;	O
gen_gids	O
=	O
ggbuf	O
;	O
aux_uids	O
=	O
aubuf	O
;	O
aux_gids	O
=	O
agbuf	O
;	O
do	O
err	O
=	O
auth_server_authenticate	()->(int)
(	O
authserver	int
,	O
rend_port	int
,	O
MACH_MSG_TYPE_COPY_SEND	O
,	O
newright	int
,	O
MACH_MSG_TYPE_COPY_SEND	O
,	O
&	O
gen_uids	O
,	O
&	O
genuidlen	O
,	O
&	O
aux_uids	O
,	O
&	O
auxuidlen	O
,	O
&	O
gen_gids	O
,	O
&	O
gengidlen	O
,	O
&	O
aux_gids	O
,	O
&	O
auxgidlen	O
)	O
;	O
while	O
(	O
err	O
==	O
EINTR	O
)	O
;	O
if	O
(	O
err	O
)	O
{	O
if	O
(	O
permit_failure	int
)	O
genuidlen	O
=	O
gengidlen	O
=	O
0	int
;	O
else	O
goto	O
out	O
;	O
}	O
err	O
=	O
idvec_set_ids	()->(int)
(	O
new	*(struct(*(struct),*(struct),*(void)))
->	O
uids	*(struct)
,	O
gen_uids	O
,	O
genuidlen	O
)	O
;	O
if	O
(	O
!	O
err	O
)	O
err	O
=	O
idvec_set_ids	()->(int)
(	O
new	*(struct(*(struct),*(struct),*(void)))
->	O
gids	*(struct)
,	O
gen_gids	O
,	O
gengidlen	O
)	O
;	O
if	O
(	O
gubuf	O
!=	O
gen_uids	O
)	O
munmap	()->(int)
(	O
(	O
caddr_t	O
)	O
gen_uids	O
,	O
genuidlen	O
*	O
sizeof	O
(	O
uid_t	O
)	O
)	O
;	O
if	O
(	O
ggbuf	O
!=	O
gen_gids	O
)	O
munmap	()->(int)
(	O
(	O
caddr_t	O
)	O
gen_gids	O
,	O
gengidlen	O
*	O
sizeof	O
(	O
uid_t	O
)	O
)	O
;	O
if	O
(	O
aubuf	O
!=	O
aux_uids	O
)	O
munmap	()->(int)
(	O
(	O
caddr_t	O
)	O
aux_uids	O
,	O
auxuidlen	O
*	O
sizeof	O
(	O
uid_t	O
)	O
)	O
;	O
if	O
(	O
agbuf	O
!=	O
aux_gids	O
)	O
munmap	()->(int)
(	O
(	O
caddr_t	O
)	O
aux_gids	O
,	O
auxgidlen	O
*	O
sizeof	O
(	O
uid_t	O
)	O
)	O
;	O
if	O
(	O
err	O
)	O
{	O
out	O
:	O
idvec_free	()->(int)
(	O
new	*(struct(*(struct),*(struct),*(void)))
->	O
uids	*(struct)
)	O
;	O
idvec_free	()->(int)
(	O
new	*(struct(*(struct),*(struct),*(void)))
->	O
gids	*(struct)
)	O
;	O
free	()->(int)
(	O
new	*(struct(*(struct),*(struct),*(void)))
)	O
;	O
*	O
user	*(*(struct(*(struct),*(struct),*(void))))
=	O
0	int
;	O
return	O
err	O
;	O
}	O
*	O
user	*(*(struct(*(struct),*(struct),*(void))))
=	O
new	*(struct(*(struct),*(struct),*(void)))
;	O
return	O
0	int
;	O
}	O

static	O
int	O
fatal_signals	array
[	O
]	O
=	O
{	O
SIGINT	int
,	O
SIGTERM	int
,	O
SIGHUP	int
,	O
SIGPIPE	int
,	O
SIGXCPU	int
,	O
SIGXFSZ	int
,	O
0	int
}	O
;	O
static	O
void	O
init_fatal_signals	function
(	O
void	O
)	O
{	O
static	O
bool	bool
fatal_signals_initialized	bool
=	O
false	int
;	O
if	O
(	O
!	O
fatal_signals_initialized	bool
)	O
{	O
size_t	long
i	long
;	O
for	O
(	O
i	long
=	O
0	int
;	O
i	long
<	O
num_fatal_signals	O
;	O
i	long
++	O
)	O
{	O
struct	O
sigaction	struct
action	struct
;	O
if	O
(	O
sigaction	struct
(	O
fatal_signals	array
[	O
i	long
]	O
,	O
NULL	O
,	O
&	O
action	struct
)	O
>=	O
0	int
&&	O
get_handler	function
(	O
&	O
action	struct
)	O
==	O
SIG_IGN	O
)	O
fatal_signals	array
[	O
i	long
]	O
=	O
-	O
1	int
;	O
}	O
fatal_signals_initialized	bool
=	O
true	int
;	O
}	O
}	O
typedef	O
void	O
(	O
*	O
action_t	pointer
)	O
(	O
void	O
)	O
;	O
typedef	O
struct	O
{	O
volatile	O
action_t	pointer
action	struct
;	O
}	O
actions_entry_t	struct
;	O
static	O
actions_entry_t	struct
static_actions	array
[	O
32	int
]	O
;	O
static	O
actions_entry_t	struct
*	O
volatile	O
actions	pointer
=	O
static_actions	array
;	O
static	O
sig_atomic_t	int
volatile	O
actions_count	int
=	O
0	int
;	O
static	O
size_t	long
actions_allocated	long
=	O
SIZEOF	O
(	O
static_actions	array
)	O
;	O
static	O
struct	O
sigaction	struct
saved_sigactions	array
[	O
64	int
]	O
;	O
static	O
void	O
uninstall_handlers	function
(	O
void	O
)	O
{	O
size_t	long
i	long
;	O
for	O
(	O
i	long
=	O
0	int
;	O
i	long
<	O
num_fatal_signals	O
;	O
i	long
++	O
)	O
if	O
(	O
fatal_signals	array
[	O
i	long
]	O
>=	O
0	int
)	O
{	O
int	O
sig	int
=	O
fatal_signals	array
[	O
i	long
]	O
;	O
if	O
(	O
saved_sigactions	array
[	O
sig	int
]	O
.	O
sa_handler	pointer
==	O
SIG_IGN	O
)	O
saved_sigactions	array
[	O
sig	int
]	O
.	O
sa_handler	pointer
=	O
SIG_DFL	O
;	O
sigaction	struct
(	O
sig	int
,	O
&	O
saved_sigactions	array
[	O
sig	int
]	O
,	O
NULL	O
)	O
;	O
}	O
}	O
static	O
void	O
fatal_signal_handler	function
(	O
int	O
sig	int
)	O
{	O
for	O
(	O
;	O
;	O
)	O
{	O
action_t	pointer
action	struct
;	O
size_t	long
n	long
=	O
actions_count	int
;	O
if	O
(	O
n	long
==	O
0	int
)	O
break	O
;	O
n	long
--	O
;	O
actions_count	int
=	O
n	long
;	O
action	struct
=	O
actions	pointer
[	O
n	long
]	O
.	O
action	struct
;	O
action	struct
(	O
)	O
;	O
}	O
uninstall_handlers	function
(	O
)	O
;	O
raise	function
(	O
sig	int
)	O
;	O
}	O
static	O
void	O
install_handlers	function
(	O
void	O
)	O
{	O
size_t	long
i	long
;	O
struct	O
sigaction	struct
action	struct
;	O
action	struct
.	O
sa_handler	pointer
=	O
&	O
fatal_signal_handler	function
;	O
action	struct
.	O
sa_flags	int
=	O
SA_NODEFER	int
;	O
sigemptyset	function
(	O
&	O
action	struct
.	O
sa_mask	struct
)	O
;	O
for	O
(	O
i	long
=	O
0	int
;	O
i	long
<	O
num_fatal_signals	O
;	O
i	long
++	O
)	O
if	O
(	O
fatal_signals	array
[	O
i	long
]	O
>=	O
0	int
)	O
{	O
int	O
sig	int
=	O
fatal_signals	array
[	O
i	long
]	O
;	O
if	O
(	O
!	O
(	O
sig	int
<	O
sizeof	O
(	O
saved_sigactions	array
)	O
/	O
sizeof	O
(	O
saved_sigactions	array
[	O
0	int
]	O
)	O
)	O
)	O
abort	function
(	O
)	O
;	O
sigaction	struct
(	O
sig	int
,	O
&	O
action	struct
,	O
&	O
saved_sigactions	array
[	O
sig	int
]	O
)	O
;	O
}	O
}	O
void	O
at_fatal_signal	function
(	O
action_t	pointer
action	struct
)	O
{	O
static	O
bool	bool
cleanup_initialized	bool
=	O
false	int
;	O
if	O
(	O
!	O
cleanup_initialized	bool
)	O
{	O
init_fatal_signals	function
(	O
)	O
;	O
install_handlers	function
(	O
)	O
;	O
cleanup_initialized	bool
=	O
true	int
;	O
}	O
if	O
(	O
actions_count	int
==	O
actions_allocated	long
)	O
{	O
actions_entry_t	struct
*	O
old_actions	pointer
=	O
actions	pointer
;	O
size_t	long
old_actions_allocated	long
=	O
actions_allocated	long
;	O
size_t	long
new_actions_allocated	long
=	O
2	int
*	O
actions_allocated	long
;	O
actions_entry_t	struct
*	O
new_actions	pointer
=	O
XNMALLOC	O
(	O
new_actions_allocated	long
,	O
actions_entry_t	struct
)	O
;	O
size_t	long
k	long
;	O
for	O
(	O
k	long
=	O
0	int
;	O
k	long
<	O
old_actions_allocated	long
;	O
k	long
++	O
)	O
new_actions	pointer
[	O
k	long
]	O
=	O
old_actions	pointer
[	O
k	long
]	O
;	O
actions	pointer
=	O
new_actions	pointer
;	O
actions_allocated	long
=	O
new_actions_allocated	long
;	O
if	O
(	O
old_actions	pointer
!=	O
static_actions	array
)	O
free	function
(	O
old_actions	pointer
)	O
;	O
}	O
actions	pointer
[	O
actions_count	int
]	O
.	O
action	struct
=	O
action	struct
;	O
actions_count	int
++	O
;	O
}	O
static	O
sigset_t	struct
fatal_signal_set	struct
;	O
static	O
void	O
init_fatal_signal_set	function
(	O
void	O
)	O
{	O
static	O
bool	bool
fatal_signal_set_initialized	bool
=	O
false	int
;	O
if	O
(	O
!	O
fatal_signal_set_initialized	bool
)	O
{	O
size_t	long
i	long
;	O
init_fatal_signals	function
(	O
)	O
;	O
sigemptyset	function
(	O
&	O
fatal_signal_set	struct
)	O
;	O
for	O
(	O
i	long
=	O
0	int
;	O
i	long
<	O
num_fatal_signals	O
;	O
i	long
++	O
)	O
if	O
(	O
fatal_signals	array
[	O
i	long
]	O
>=	O
0	int
)	O
sigaddset	function
(	O
&	O
fatal_signal_set	struct
,	O
fatal_signals	array
[	O
i	long
]	O
)	O
;	O
fatal_signal_set_initialized	bool
=	O
true	int
;	O
}	O
}	O
void	O
block_fatal_signals	function
(	O
void	O
)	O
{	O
init_fatal_signal_set	function
(	O
)	O
;	O
sigprocmask	function
(	O
SIG_BLOCK	int
,	O
&	O
fatal_signal_set	struct
,	O
NULL	O
)	O
;	O
}	O
void	O
unblock_fatal_signals	function
(	O
void	O
)	O
{	O
init_fatal_signal_set	function
(	O
)	O
;	O
sigprocmask	function
(	O
SIG_UNBLOCK	int
,	O
&	O
fatal_signal_set	struct
,	O
NULL	O
)	O
;	O
}	O

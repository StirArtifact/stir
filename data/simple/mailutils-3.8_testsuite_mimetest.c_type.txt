void	O
message_display_parts	function
(	O
mu_message_t	pointer
msg	pointer
,	O
int	O
indent	int
)	O
;	O
const	O
char	O
*	O
from	pointer
;	O
const	O
char	O
*	O
subject	pointer
;	O
const	O
char	O
*	O
charset	pointer
;	O
int	O
print_attachments	int
;	O
int	O
indent_level	int
=	O
4	int
;	O
void	O
print_file	function
(	O
const	O
char	O
*	O
fname	pointer
,	O
int	O
indent	int
)	O
{	O
char	O
buf	pointer
[	O
128	int
]	O
;	O
FILE	struct
*	O
fp	pointer
=	O
fopen	function
(	O
fname	pointer
,	O
"r"	pointer
)	O
;	O
if	O
(	O
!	O
fp	pointer
)	O
{	O
fprintf	function
(	O
stderr	pointer
,	O
"can't open file %s: %s"	pointer
,	O
fname	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
return	O
;	O
}	O
while	O
(	O
fgets	function
(	O
buf	pointer
,	O
sizeof	O
buf	pointer
,	O
fp	pointer
)	O
)	O
printf	function
(	O
"%*.*s%s"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
,	O
buf	pointer
)	O
;	O
fclose	function
(	O
fp	pointer
)	O
;	O
unlink	function
(	O
fname	pointer
)	O
;	O
}	O
int	O
main	function
(	O
int	O
argc	long
,	O
char	O
*	O
*	O
argv	pointer
)	O
{	O
mu_mailbox_t	pointer
mbox	pointer
=	O
NULL	O
;	O
size_t	long
i	long
;	O
size_t	long
count	long
=	O
0	int
;	O
char	O
*	O
mailbox_name	pointer
;	O
int	O
debug	int
=	O
0	int
;	O
for	O
(	O
i	long
=	O
1	int
;	O
i	long
<	O
argc	long
;	O
i	long
++	O
)	O
{	O
if	O
(	O
strcmp	function
(	O
argv	pointer
[	O
i	long
]	O
,	O
"-d"	pointer
)	O
==	O
0	int
)	O
debug	int
=	O
1	int
;	O
else	O
if	O
(	O
strcmp	function
(	O
argv	pointer
[	O
i	long
]	O
,	O
"-p"	pointer
)	O
==	O
0	int
)	O
print_attachments	int
=	O
1	int
;	O
else	O
if	O
(	O
strcmp	function
(	O
argv	pointer
[	O
i	long
]	O
,	O
"-i"	pointer
)	O
==	O
0	int
)	O
{	O
if	O
(	O
++	O
i	long
==	O
argc	long
)	O
{	O
mu_error	function
(	O
"-i requires argument"	pointer
)	O
;	O
exit	function
(	O
1	int
)	O
;	O
}	O
indent_level	int
=	O
strtoul	function
(	O
argv	pointer
[	O
i	long
]	O
,	O
NULL	O
,	O
0	int
)	O
;	O
}	O
else	O
if	O
(	O
strcmp	function
(	O
argv	pointer
[	O
i	long
]	O
,	O
"-c"	pointer
)	O
==	O
0	int
)	O
{	O
if	O
(	O
++	O
i	long
==	O
argc	long
)	O
{	O
mu_error	function
(	O
"-c requires argument"	pointer
)	O
;	O
exit	function
(	O
1	int
)	O
;	O
}	O
charset	pointer
=	O
argv	pointer
[	O
i	long
]	O
;	O
}	O
else	O
break	O
;	O
}	O
mailbox_name	pointer
=	O
argv	pointer
[	O
i	long
]	O
;	O
mu_registrar_record	function
(	O
mu_imap_record	pointer
)	O
;	O
mu_registrar_record	function
(	O
mu_pop_record	pointer
)	O
;	O
mu_registrar_record	function
(	O
mu_mbox_record	pointer
)	O
;	O
mu_registrar_set_default_record	function
(	O
mu_mbox_record	pointer
)	O
;	O
MU_ASSERT	O
(	O
mu_mailbox_create_default	function
(	O
&	O
mbox	pointer
,	O
mailbox_name	pointer
)	O
)	O
;	O
if	O
(	O
debug	int
)	O
{	O
mu_debug_set_category_level	function
(	O
MU_DEBCAT_MAILBOX	int
,	O
MU_DEBUG_LEVEL_UPTO	O
(	O
MU_DEBUG_PROT	int
)	O
)	O
;	O
}	O
MU_ASSERT	O
(	O
mu_mailbox_open	function
(	O
mbox	pointer
,	O
MU_STREAM_READ	int
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_mailbox_messages_count	function
(	O
mbox	pointer
,	O
&	O
count	long
)	O
)	O
;	O
for	O
(	O
i	long
=	O
1	int
;	O
i	long
<=	O
count	long
;	O
++	O
i	long
)	O
{	O
mu_message_t	pointer
msg	pointer
;	O
mu_header_t	pointer
hdr	pointer
;	O
size_t	long
nparts	pointer
;	O
size_t	long
msize	long
,	O
nlines	long
;	O
MU_ASSERT	O
(	O
mu_mailbox_get_message	function
(	O
mbox	pointer
,	O
i	long
,	O
&	O
msg	pointer
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_message_size	function
(	O
msg	pointer
,	O
&	O
msize	long
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_message_lines	function
(	O
msg	pointer
,	O
&	O
nlines	long
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_message_get_header	function
(	O
msg	pointer
,	O
&	O
hdr	pointer
)	O
)	O
;	O
if	O
(	O
mu_header_sget_value	O
(	O
hdr	pointer
,	O
MU_HEADER_FROM	pointer
,	O
&	O
from	pointer
)	O
)	O
from	pointer
=	O
""	pointer
;	O
if	O
(	O
mu_header_sget_value	O
(	O
hdr	pointer
,	O
MU_HEADER_SUBJECT	pointer
,	O
&	O
subject	pointer
)	O
)	O
subject	pointer
=	O
""	pointer
;	O
printf	function
(	O
"Message:%lu\n"	pointer
,	O
(	O
unsigned	O
long	O
)	O
i	long
)	O
;	O
printf	function
(	O
"From:%s\n"	pointer
,	O
from	pointer
)	O
;	O
printf	function
(	O
"Subject:%s\n"	pointer
,	O
subject	pointer
)	O
;	O
MU_ASSERT	O
(	O
mu_message_get_num_parts	function
(	O
msg	pointer
,	O
&	O
nparts	pointer
)	O
)	O
;	O
printf	function
(	O
"Number of parts in message:%lu\n"	pointer
,	O
(	O
unsigned	O
long	O
)	O
nparts	pointer
)	O
;	O
printf	function
(	O
"Total message size:%lu/%lu\n"	pointer
,	O
(	O
unsigned	O
long	O
)	O
msize	long
,	O
(	O
unsigned	O
long	O
)	O
nlines	long
)	O
;	O
message_display_parts	function
(	O
msg	pointer
,	O
0	int
)	O
;	O
}	O
mu_mailbox_close	function
(	O
mbox	pointer
)	O
;	O
mu_mailbox_destroy	function
(	O
&	O
mbox	pointer
)	O
;	O
return	O
0	int
;	O
}	O
char	O
buf	pointer
[	O
2048	int
]	O
;	O
static	O
void	O
print_message_part_sizes	function
(	O
mu_message_t	pointer
part	long
,	O
int	O
indent	int
)	O
{	O
mu_body_t	pointer
body	pointer
;	O
mu_header_t	pointer
hdr	pointer
;	O
size_t	long
msize	long
,	O
mlines	long
,	O
hsize	long
,	O
hlines	long
,	O
bsize	long
,	O
blines	long
;	O
MU_ASSERT	O
(	O
mu_message_size	function
(	O
part	long
,	O
&	O
msize	long
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_message_lines	function
(	O
part	long
,	O
&	O
mlines	long
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_message_get_header	function
(	O
part	long
,	O
&	O
hdr	pointer
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_header_size	function
(	O
hdr	pointer
,	O
&	O
hsize	long
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_header_lines	function
(	O
hdr	pointer
,	O
&	O
hlines	long
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_message_get_body	function
(	O
part	long
,	O
&	O
body	pointer
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_body_size	function
(	O
body	pointer
,	O
&	O
bsize	long
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_body_lines	function
(	O
body	pointer
,	O
&	O
blines	long
)	O
)	O
;	O
printf	function
(	O
"%*.*sMessage part size:%lu/%lu: %lu/%lu, %lu/%lu\n"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
,	O
(	O
unsigned	O
long	O
)	O
msize	long
,	O
(	O
unsigned	O
long	O
)	O
mlines	long
,	O
(	O
unsigned	O
long	O
)	O
hsize	long
,	O
(	O
unsigned	O
long	O
)	O
hlines	long
,	O
(	O
unsigned	O
long	O
)	O
bsize	long
,	O
(	O
unsigned	O
long	O
)	O
blines	long
)	O
;	O
}	O
void	O
message_display_parts	function
(	O
mu_message_t	pointer
msg	pointer
,	O
int	O
indent	int
)	O
{	O
int	O
ret	pointer
,	O
j	int
;	O
size_t	long
nparts	pointer
;	O
mu_message_t	pointer
part	long
;	O
mu_header_t	pointer
hdr	pointer
;	O
mu_stream_t	pointer
str	pointer
;	O
mu_body_t	pointer
body	pointer
;	O
int	O
ismulti	int
;	O
size_t	long
nbytes	long
;	O
if	O
(	O
(	O
ret	pointer
=	O
mu_message_get_num_parts	function
(	O
msg	pointer
,	O
&	O
nparts	pointer
)	O
)	O
!=	O
0	int
)	O
{	O
fprintf	function
(	O
stderr	pointer
,	O
"mu_message_get_num_parts - %s\n"	pointer
,	O
mu_strerror	function
(	O
ret	pointer
)	O
)	O
;	O
exit	function
(	O
2	int
)	O
;	O
}	O
for	O
(	O
j	int
=	O
1	int
;	O
j	int
<=	O
nparts	pointer
;	O
j	int
++	O
)	O
{	O
int	O
status	int
;	O
const	O
char	O
*	O
hvalue	pointer
;	O
char	O
*	O
type	int
=	O
NULL	O
;	O
const	O
char	O
*	O
encoding	pointer
=	O
""	pointer
;	O
MU_ASSERT	O
(	O
mu_message_get_part	function
(	O
msg	pointer
,	O
j	int
,	O
&	O
part	long
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_message_get_header	function
(	O
part	long
,	O
&	O
hdr	pointer
)	O
)	O
;	O
status	int
=	O
mu_header_sget_value	O
(	O
hdr	pointer
,	O
MU_HEADER_CONTENT_TYPE	pointer
,	O
&	O
hvalue	pointer
)	O
;	O
if	O
(	O
status	int
==	O
MU_ERR_NOENT	O
)	O
;	O
else	O
if	O
(	O
status	int
!=	O
0	int
)	O
mu_error	function
(	O
"Cannot get header value: %s"	pointer
,	O
mu_strerror	function
(	O
status	int
)	O
)	O
;	O
else	O
{	O
status	int
=	O
mu_mimehdr_aget_disp	function
(	O
hvalue	pointer
,	O
&	O
type	int
)	O
;	O
if	O
(	O
status	int
)	O
mu_error	function
(	O
"Cannot extract content type field: %s"	pointer
,	O
mu_strerror	function
(	O
status	int
)	O
)	O
;	O
}	O
printf	function
(	O
"%*.*sType of part %d:%s\n"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
,	O
j	int
,	O
mu_prstr	function
(	O
type	int
)	O
)	O
;	O
print_message_part_sizes	function
(	O
part	long
,	O
indent	int
)	O
;	O
if	O
(	O
mu_header_sget_value	O
(	O
hdr	pointer
,	O
MU_HEADER_CONTENT_TRANSFER_ENCODING	pointer
,	O
&	O
encoding	pointer
)	O
)	O
encoding	pointer
=	O
""	pointer
;	O
ismulti	int
=	O
0	int
;	O
if	O
(	O
(	O
type	int
&&	O
mu_c_strcasecmp	function
(	O
type	int
,	O
"message/rfc822"	pointer
)	O
==	O
0	int
)	O
||	O
(	O
mu_message_is_multipart	function
(	O
part	long
,	O
&	O
ismulti	int
)	O
==	O
0	int
&&	O
ismulti	int
)	O
)	O
{	O
if	O
(	O
!	O
ismulti	int
)	O
MU_ASSERT	O
(	O
mu_message_unencapsulate	function
(	O
part	long
,	O
&	O
part	long
,	O
NULL	O
)	O
)	O
;	O
MU_ASSERT	O
(	O
mu_message_get_header	function
(	O
part	long
,	O
&	O
hdr	pointer
)	O
)	O
;	O
if	O
(	O
mu_header_sget_value	O
(	O
hdr	pointer
,	O
MU_HEADER_FROM	pointer
,	O
&	O
from	pointer
)	O
)	O
from	pointer
=	O
""	pointer
;	O
if	O
(	O
mu_header_sget_value	O
(	O
hdr	pointer
,	O
MU_HEADER_SUBJECT	pointer
,	O
&	O
subject	pointer
)	O
)	O
subject	pointer
=	O
""	pointer
;	O
printf	function
(	O
"%*.*sEncapsulated message:\n"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
)	O
;	O
printf	function
(	O
"%*.*sFrom:%s\n"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
,	O
from	pointer
)	O
;	O
printf	function
(	O
"%*.*sSubject:%s\n"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
,	O
subject	pointer
)	O
;	O
printf	function
(	O
"%*.*sBegin\n"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
)	O
;	O
message_display_parts	function
(	O
part	long
,	O
indent	int
+	O
indent_level	int
)	O
;	O
mu_message_destroy	function
(	O
&	O
part	long
,	O
NULL	O
)	O
;	O
}	O
else	O
if	O
(	O
!	O
type	int
||	O
(	O
mu_c_strcasecmp	function
(	O
type	int
,	O
"text/plain"	pointer
)	O
==	O
0	int
)	O
||	O
(	O
mu_c_strcasecmp	function
(	O
type	int
,	O
"text/html"	pointer
)	O
)	O
==	O
0	int
)	O
{	O
printf	function
(	O
"%*.*sText Message\n"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
)	O
;	O
printf	function
(	O
"%*.*sBegin\n"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
)	O
;	O
mu_message_get_body	function
(	O
part	long
,	O
&	O
body	pointer
)	O
;	O
mu_body_get_streamref	function
(	O
body	pointer
,	O
&	O
str	pointer
)	O
;	O
mu_filter_create	function
(	O
&	O
str	pointer
,	O
str	pointer
,	O
encoding	pointer
,	O
MU_FILTER_DECODE	int
,	O
MU_STREAM_READ	int
)	O
;	O
while	O
(	O
mu_stream_readline	function
(	O
str	pointer
,	O
buf	pointer
,	O
sizeof	O
(	O
buf	pointer
)	O
,	O
&	O
nbytes	long
)	O
==	O
0	int
&&	O
nbytes	long
)	O
{	O
printf	function
(	O
"%*.*s%s"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
,	O
buf	pointer
)	O
;	O
}	O
mu_stream_destroy	function
(	O
&	O
str	pointer
)	O
;	O
}	O
else	O
{	O
char	O
*	O
fname	pointer
=	O
NULL	O
;	O
mu_message_aget_decoded_attachment_name	function
(	O
part	long
,	O
charset	pointer
,	O
&	O
fname	pointer
,	O
NULL	O
)	O
;	O
if	O
(	O
fname	pointer
==	O
NULL	O
)	O
fname	pointer
=	O
mu_tempname	function
(	O
NULL	O
)	O
;	O
printf	function
(	O
"%*.*sAttachment - saving [%s]\n"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
,	O
fname	pointer
)	O
;	O
printf	function
(	O
"%*.*sBegin\n"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
)	O
;	O
if	O
(	O
charset	pointer
)	O
{	O
mu_mime_io_buffer_t	pointer
info	pointer
;	O
mu_mime_io_buffer_create	function
(	O
&	O
info	pointer
)	O
;	O
mu_mime_io_buffer_set_charset	function
(	O
info	pointer
,	O
charset	pointer
)	O
;	O
MU_ASSERT	O
(	O
mu_message_save_attachment	function
(	O
part	long
,	O
NULL	O
,	O
info	pointer
)	O
)	O
;	O
mu_mime_io_buffer_destroy	function
(	O
&	O
info	pointer
)	O
;	O
}	O
else	O
MU_ASSERT	O
(	O
mu_message_save_attachment	function
(	O
part	long
,	O
fname	pointer
,	O
NULL	O
)	O
)	O
;	O
if	O
(	O
print_attachments	int
)	O
print_file	function
(	O
fname	pointer
,	O
indent	int
)	O
;	O
free	function
(	O
fname	pointer
)	O
;	O
}	O
printf	function
(	O
"\n%*.*sEnd\n"	pointer
,	O
indent	int
,	O
indent	int
,	O
""	pointer
)	O
;	O
free	function
(	O
type	int
)	O
;	O
}	O
}	O

public	O
int	O
errmsgs	int
;	O
public	O
int	O
need_clr	int
;	O
public	O
int	O
final_attr	int
;	O
public	O
int	O
at_prompt	int
;	O
extern	O
int	O
sigs	int
;	O
extern	O
int	O
sc_width	int
;	O
extern	O
int	O
so_s_width	int
,	O
so_e_width	int
;	O
extern	O
int	O
screen_trashed	int
;	O
extern	O
int	O
any_display	int
;	O
extern	O
int	O
is_tty	int
;	O
extern	O
int	O
oldbot	int
;	O
public	O
void	O
put_line	function
(	O
)	O
{	O
int	O
c	int
;	O
int	O
i	int
;	O
int	O
a	int
;	O
if	O
(	O
ABORT_SIGS	O
(	O
)	O
)	O
{	O
screen_trashed	int
=	O
1	int
;	O
return	O
;	O
}	O
final_attr	int
=	O
AT_NORMAL	O
;	O
for	O
(	O
i	int
=	O
0	int
;	O
(	O
c	int
=	O
gline	function
(	O
i	int
,	O
&	O
a	int
)	O
)	O
!=	O
'\0'	O
;	O
i	int
++	O
)	O
{	O
at_switch	function
(	O
a	int
)	O
;	O
final_attr	int
=	O
a	int
;	O
if	O
(	O
c	int
==	O
'\b'	O
)	O
putbs	function
(	O
)	O
;	O
else	O
putchr	function
(	O
c	int
)	O
;	O
}	O
at_exit	function
(	O
)	O
;	O
}	O
static	O
char	O
obuf	array
[	O
OUTBUF_SIZE	int
]	O
;	O
static	O
char	O
*	O
ob	pointer
=	O
obuf	array
;	O
public	O
void	O
flush	function
(	O
)	O
{	O
int	O
n	int
;	O
int	O
fd	int
;	O
n	int
=	O
(	O
int	O
)	O
(	O
ob	pointer
-	O
obuf	array
)	O
;	O
if	O
(	O
n	int
==	O
0	int
)	O
return	O
;	O
fd	int
=	O
(	O
any_display	int
)	O
?	O
1	int
:	O
2	int
;	O
if	O
(	O
write	function
(	O
fd	int
,	O
obuf	array
,	O
n	int
)	O
!=	O
n	int
)	O
screen_trashed	int
=	O
1	int
;	O
ob	pointer
=	O
obuf	array
;	O
}	O
public	O
int	O
putchr	function
(	O
c	int
)	O
int	O
c	int
;	O
{	O
if	O
(	O
need_clr	int
)	O
{	O
need_clr	int
=	O
0	int
;	O
clear_bot	function
(	O
)	O
;	O
}	O
if	O
(	O
ob	pointer
>=	O
&	O
obuf	array
[	O
sizeof	O
(	O
obuf	array
)	O
-	O
1	int
]	O
)	O
flush	function
(	O
)	O
;	O
*	O
ob	pointer
++	O
=	O
c	int
;	O
at_prompt	int
=	O
0	int
;	O
return	O
(	O
c	int
)	O
;	O
}	O
public	O
void	O
putstr	function
(	O
s	pointer
)	O
constant	O
char	O
*	O
s	pointer
;	O
{	O
while	O
(	O
*	O
s	pointer
!=	O
'\0'	O
)	O
putchr	function
(	O
*	O
s	pointer
++	O
)	O
;	O
}	O
TYPE_TO_A_FUNC	O
(	O
postoa	function
,	O
POSITION	long
)	O
TYPE_TO_A_FUNC	O
(	O
linenumtoa	function
,	O
LINENUM	long
)	O
TYPE_TO_A_FUNC	O
(	O
inttoa	function
,	O
int	O
)	O
static	O
int	O
iprint_int	function
(	O
num	long
)	O
int	O
num	long
;	O
{	O
char	O
buf	pointer
[	O
INT_STRLEN_BOUND	O
(	O
num	long
)	O
]	O
;	O
inttoa	function
(	O
num	long
,	O
buf	pointer
)	O
;	O
putstr	function
(	O
buf	pointer
)	O
;	O
return	O
(	O
(	O
int	O
)	O
strlen	function
(	O
buf	pointer
)	O
)	O
;	O
}	O
static	O
int	O
iprint_linenum	function
(	O
num	long
)	O
LINENUM	long
num	long
;	O
{	O
char	O
buf	pointer
[	O
INT_STRLEN_BOUND	O
(	O
num	long
)	O
]	O
;	O
linenumtoa	function
(	O
num	long
,	O
buf	pointer
)	O
;	O
putstr	function
(	O
buf	pointer
)	O
;	O
return	O
(	O
(	O
int	O
)	O
strlen	function
(	O
buf	pointer
)	O
)	O
;	O
}	O
static	O
int	O
less_printf	function
(	O
fmt	pointer
,	O
parg	union
)	O
char	O
*	O
fmt	pointer
;	O
PARG	union
*	O
parg	union
;	O
{	O
char	O
*	O
s	pointer
;	O
int	O
col	int
;	O
col	int
=	O
0	int
;	O
while	O
(	O
*	O
fmt	pointer
!=	O
'\0'	O
)	O
{	O
if	O
(	O
*	O
fmt	pointer
!=	O
'%'	O
)	O
{	O
putchr	function
(	O
*	O
fmt	pointer
++	O
)	O
;	O
col	int
++	O
;	O
}	O
else	O
{	O
++	O
fmt	pointer
;	O
switch	O
(	O
*	O
fmt	pointer
++	O
)	O
{	O
case	O
's'	O
:	O
s	pointer
=	O
parg	union
->	O
p_string	pointer
;	O
parg	union
++	O
;	O
while	O
(	O
*	O
s	pointer
!=	O
'\0'	O
)	O
{	O
putchr	function
(	O
*	O
s	pointer
++	O
)	O
;	O
col	int
++	O
;	O
}	O
break	O
;	O
case	O
'd'	O
:	O
col	int
+=	O
iprint_int	function
(	O
parg	union
->	O
p_int	int
)	O
;	O
parg	union
++	O
;	O
break	O
;	O
case	O
'n'	O
:	O
col	int
+=	O
iprint_linenum	function
(	O
parg	union
->	O
p_linenum	long
)	O
;	O
parg	union
++	O
;	O
break	O
;	O
case	O
'%'	O
:	O
putchr	function
(	O
'%'	O
)	O
;	O
break	O
;	O
}	O
}	O
}	O
return	O
(	O
col	int
)	O
;	O
}	O
public	O
void	O
get_return	function
(	O
)	O
{	O
int	O
c	int
;	O
c	int
=	O
getchr	function
(	O
)	O
;	O
if	O
(	O
c	int
!=	O
'\n'	O
&&	O
c	int
!=	O
'\r'	O
&&	O
c	int
!=	O
' '	O
&&	O
c	int
!=	O
READ_INTR	O
)	O
ungetcc	function
(	O
c	int
)	O
;	O
}	O
public	O
void	O
error	function
(	O
fmt	pointer
,	O
parg	union
)	O
char	O
*	O
fmt	pointer
;	O
PARG	union
*	O
parg	union
;	O
{	O
int	O
col	int
=	O
0	int
;	O
static	O
char	O
return_to_continue	array
[	O
]	O
=	O
"  (press RETURN)"	pointer
;	O
errmsgs	int
++	O
;	O
if	O
(	O
any_display	int
&&	O
is_tty	int
)	O
{	O
if	O
(	O
!	O
oldbot	int
)	O
squish_check	function
(	O
)	O
;	O
at_exit	function
(	O
)	O
;	O
clear_bot	function
(	O
)	O
;	O
at_enter	function
(	O
AT_STANDOUT	O
)	O
;	O
col	int
+=	O
so_s_width	int
;	O
}	O
col	int
+=	O
less_printf	function
(	O
fmt	pointer
,	O
parg	union
)	O
;	O
if	O
(	O
!	O
(	O
any_display	int
&&	O
is_tty	int
)	O
)	O
{	O
putchr	function
(	O
'\n'	O
)	O
;	O
return	O
;	O
}	O
putstr	function
(	O
return_to_continue	array
)	O
;	O
at_exit	function
(	O
)	O
;	O
col	int
+=	O
sizeof	O
(	O
return_to_continue	array
)	O
+	O
so_e_width	int
;	O
get_return	function
(	O
)	O
;	O
lower_left	function
(	O
)	O
;	O
clear_eol	function
(	O
)	O
;	O
if	O
(	O
col	int
>=	O
sc_width	int
)	O
screen_trashed	int
=	O
1	int
;	O
flush	function
(	O
)	O
;	O
}	O
static	O
char	O
intr_to_abort	array
[	O
]	O
=	O
"... (interrupt to abort)"	pointer
;	O
public	O
void	O
ierror	function
(	O
fmt	pointer
,	O
parg	union
)	O
char	O
*	O
fmt	pointer
;	O
PARG	union
*	O
parg	union
;	O
{	O
at_exit	function
(	O
)	O
;	O
clear_bot	function
(	O
)	O
;	O
at_enter	function
(	O
AT_STANDOUT	O
)	O
;	O
(	O
void	O
)	O
less_printf	function
(	O
fmt	pointer
,	O
parg	union
)	O
;	O
putstr	function
(	O
intr_to_abort	array
)	O
;	O
at_exit	function
(	O
)	O
;	O
flush	function
(	O
)	O
;	O
need_clr	int
=	O
1	int
;	O
}	O
public	O
int	O
query	function
(	O
fmt	pointer
,	O
parg	union
)	O
char	O
*	O
fmt	pointer
;	O
PARG	union
*	O
parg	union
;	O
{	O
int	O
c	int
;	O
int	O
col	int
=	O
0	int
;	O
if	O
(	O
any_display	int
&&	O
is_tty	int
)	O
clear_bot	function
(	O
)	O
;	O
(	O
void	O
)	O
less_printf	function
(	O
fmt	pointer
,	O
parg	union
)	O
;	O
c	int
=	O
getchr	function
(	O
)	O
;	O
if	O
(	O
!	O
(	O
any_display	int
&&	O
is_tty	int
)	O
)	O
{	O
putchr	function
(	O
'\n'	O
)	O
;	O
return	O
(	O
c	int
)	O
;	O
}	O
lower_left	function
(	O
)	O
;	O
if	O
(	O
col	int
>=	O
sc_width	int
)	O
screen_trashed	int
=	O
1	int
;	O
flush	function
(	O
)	O
;	O
return	O
(	O
c	int
)	O
;	O
}	O

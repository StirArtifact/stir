void	O
snmp_read	function
(	O
)	O
;	O
int	O
snmp_query	function
(	O
struct	O
snmp_session	struct
*	O
sess	pointer
,	O
struct	O
snmp_pdu	struct
*	O
pdu	pointer
)	O
{	O
if	O
(	O
snmp_send	function
(	O
sess	pointer
,	O
pdu	pointer
)	O
)	O
return	O
-	O
1	int
;	O
snmp_poll	function
(	O
sess	pointer
)	O
;	O
return	O
0	int
;	O
}	O
void	O
snmp_poll	function
(	O
struct	O
snmp_session	struct
*	O
sess	pointer
)	O
{	O
int	O
rc	int
;	O
int	O
numfds	int
;	O
fd_set	struct
fdset	pointer
;	O
struct	O
timeval	struct
timeout	int
;	O
while	O
(	O
numfds	int
=	O
snmp_fdset	function
(	O
sess	pointer
,	O
&	O
fdset	pointer
)	O
)	O
{	O
timeout	int
.	O
tv_usec	long
=	O
0	int
;	O
timeout	int
.	O
tv_sec	long
=	O
1	int
;	O
rc	int
=	O
select	function
(	O
numfds	int
,	O
&	O
fdset	pointer
,	O
NULL	O
,	O
NULL	O
,	O
&	O
timeout	int
)	O
;	O
if	O
(	O
rc	int
<	O
0	int
)	O
{	O
if	O
(	O
errno	O
==	O
EINTR	int
)	O
continue	O
;	O
break	O
;	O
}	O
else	O
if	O
(	O
rc	int
==	O
0	int
)	O
{	O
snmp_timeout	function
(	O
sess	pointer
)	O
;	O
}	O
else	O
{	O
snmp_read	function
(	O
sess	pointer
,	O
&	O
fdset	pointer
)	O
;	O
}	O
}	O
}	O
void	O
snmp_timeout	function
(	O
struct	O
snmp_session	struct
*	O
sess	pointer
)	O
{	O
struct	O
snmp_session	struct
*	O
sp	pointer
;	O
struct	O
snmp_request	struct
*	O
req	pointer
,	O
*	O
preq	pointer
;	O
struct	O
timeval	struct
now	struct
;	O
gettimeofday	function
(	O
&	O
now	struct
,	O
(	O
struct	O
timezone	struct
*	O
)	O
0	int
)	O
;	O
for	O
(	O
sp	pointer
=	O
sess	pointer
;	O
sp	pointer
;	O
sp	pointer
=	O
sp	pointer
->	O
next	pointer
)	O
{	O
if	O
(	O
sp	pointer
->	O
sd	int
<	O
0	int
)	O
continue	O
;	O
preq	pointer
=	O
NULL	O
;	O
req	pointer
=	O
sp	pointer
->	O
request_list	pointer
;	O
while	O
(	O
req	pointer
)	O
{	O
if	O
(	O
timercmp	O
(	O
&	O
req	pointer
->	O
expire	struct
,	O
&	O
now	struct
,	O
<	O
)	O
)	O
{	O
if	O
(	O
req	pointer
->	O
retries	int
>	O
sp	pointer
->	O
retries	int
)	O
{	O
sp	pointer
->	O
converse	pointer
(	O
SNMP_CONV_TIMEOUT	int
,	O
sp	pointer
,	O
req	pointer
->	O
pdu	pointer
,	O
sp	pointer
->	O
app_closure	pointer
)	O
;	O
if	O
(	O
preq	pointer
)	O
{	O
preq	pointer
->	O
next	pointer
=	O
req	pointer
->	O
next	pointer
;	O
snmp_request_free	function
(	O
req	pointer
)	O
;	O
req	pointer
=	O
preq	pointer
->	O
next	pointer
;	O
}	O
else	O
{	O
sp	pointer
->	O
request_list	pointer
=	O
req	pointer
->	O
next	pointer
;	O
snmp_request_free	function
(	O
req	pointer
)	O
;	O
req	pointer
=	O
sp	pointer
->	O
request_list	pointer
;	O
}	O
continue	O
;	O
}	O
else	O
{	O
req	pointer
->	O
retries	int
++	O
;	O
req	pointer
->	O
timeout	int
<<=	O
1	int
;	O
snmp_request_xmit	function
(	O
sp	pointer
,	O
req	pointer
)	O
;	O
}	O
}	O
preq	pointer
=	O
req	pointer
;	O
req	pointer
=	O
req	pointer
->	O
next	pointer
;	O
}	O
}	O
}	O
void	O
snmp_read	function
(	O
struct	O
snmp_session	struct
*	O
sess	pointer
,	O
fd_set	struct
*	O
fdset	pointer
)	O
{	O
struct	O
snmp_session	struct
*	O
sp	pointer
;	O
struct	O
snmp_request	struct
*	O
req	pointer
,	O
*	O
prev	pointer
;	O
struct	O
snmp_pdu	struct
*	O
pdu	pointer
;	O
u_char	char
packet	pointer
[	O
SNMP_PACKET_LENGTH	int
]	O
;	O
struct	O
sockaddr_in	struct
sin	struct
;	O
int	O
salen	int
;	O
int	O
length	pointer
;	O
char	O
comm	pointer
[	O
128	int
]	O
;	O
int	O
comm_len	pointer
;	O
for	O
(	O
sp	pointer
=	O
sess	pointer
;	O
sp	pointer
;	O
sp	pointer
=	O
sp	pointer
->	O
next	pointer
)	O
{	O
if	O
(	O
sp	pointer
->	O
sd	int
<	O
0	int
||	O
!	O
FD_ISSET	O
(	O
sp	pointer
->	O
sd	int
,	O
fdset	pointer
)	O
)	O
continue	O
;	O
salen	int
=	O
sizeof	O
(	O
sin	struct
)	O
;	O
length	pointer
=	O
recvfrom	function
(	O
sp	pointer
->	O
sd	int
,	O
(	O
char	O
*	O
)	O
packet	pointer
,	O
sizeof	O
(	O
packet	pointer
)	O
,	O
0	int
,	O
(	O
struct	O
sockaddr	struct
*	O
)	O
&	O
sin	struct
,	O
&	O
salen	int
)	O
;	O
if	O
(	O
length	pointer
==	O
-	O
1	int
)	O
{	O
perror	function
(	O
"recvfrom"	pointer
)	O
;	O
continue	O
;	O
}	O
pdu	pointer
=	O
snmp_pdu_create	function
(	O
0	int
)	O
;	O
if	O
(	O
!	O
pdu	pointer
)	O
{	O
continue	O
;	O
}	O
pdu	pointer
->	O
peer_sin	struct
=	O
sin	struct
;	O
pdu	pointer
->	O
req_id	int
=	O
0	int
;	O
comm_len	pointer
=	O
sizeof	O
(	O
comm	pointer
)	O
-	O
1	int
;	O
if	O
(	O
snmp_decode_request	function
(	O
sp	pointer
,	O
pdu	pointer
,	O
packet	pointer
,	O
length	pointer
,	O
comm	pointer
,	O
&	O
comm_len	pointer
)	O
)	O
{	O
snmp_pdu_free	function
(	O
pdu	pointer
)	O
;	O
continue	O
;	O
}	O
if	O
(	O
pdu	pointer
->	O
type	pointer
==	O
SNMP_PDU_RESPONSE	O
)	O
{	O
if	O
(	O
strcmp	function
(	O
sp	pointer
->	O
community	struct
.	O
str	pointer
,	O
comm	pointer
)	O
)	O
{	O
if	O
(	O
sp	pointer
->	O
converse	pointer
(	O
SNMP_CONV_COMMUNITY_MISMATCH	int
,	O
sp	pointer
,	O
pdu	pointer
,	O
sp	pointer
->	O
app_closure	pointer
)	O
)	O
{	O
snmp_pdu_free	function
(	O
pdu	pointer
)	O
;	O
continue	O
;	O
}	O
}	O
}	O
else	O
{	O
char	O
*	O
p	pointer
=	O
snmp_alloc	function
(	O
comm_len	pointer
+	O
1	int
)	O
;	O
if	O
(	O
!	O
p	pointer
)	O
{	O
SNMP_SET_ERRNO	O
(	O
E_SNMP_NOMEM	int
)	O
;	O
snmp_pdu_free	function
(	O
pdu	pointer
)	O
;	O
continue	O
;	O
}	O
strcpy	function
(	O
sp	pointer
->	O
community	struct
.	O
str	pointer
,	O
comm	pointer
)	O
;	O
if	O
(	O
sp	pointer
->	O
community	struct
.	O
str	pointer
)	O
snmp_free	function
(	O
sp	pointer
->	O
community	struct
.	O
str	pointer
)	O
;	O
sp	pointer
->	O
community	struct
.	O
str	pointer
=	O
p	pointer
;	O
sp	pointer
->	O
community	struct
.	O
len	int
=	O
comm_len	pointer
;	O
}	O
switch	O
(	O
pdu	pointer
->	O
type	pointer
)	O
{	O
case	O
SNMP_PDU_RESPONSE	O
:	O
prev	pointer
=	O
NULL	O
;	O
for	O
(	O
req	pointer
=	O
sp	pointer
->	O
request_list	pointer
;	O
req	pointer
&&	O
req	pointer
->	O
pdu	pointer
->	O
req_id	int
!=	O
pdu	pointer
->	O
req_id	int
;	O
req	pointer
=	O
req	pointer
->	O
next	pointer
)	O
prev	pointer
=	O
req	pointer
;	O
if	O
(	O
!	O
req	pointer
)	O
{	O
snmp_pdu_free	function
(	O
pdu	pointer
)	O
;	O
continue	O
;	O
}	O
if	O
(	O
sp	pointer
->	O
converse	pointer
(	O
SNMP_CONV_RECV_MSG	int
,	O
sp	pointer
,	O
pdu	pointer
,	O
sp	pointer
->	O
app_closure	pointer
)	O
)	O
{	O
if	O
(	O
!	O
prev	pointer
)	O
sp	pointer
->	O
request_list	pointer
=	O
req	pointer
->	O
next	pointer
;	O
else	O
prev	pointer
->	O
next	pointer
=	O
req	pointer
->	O
next	pointer
;	O
snmp_request_free	function
(	O
req	pointer
)	O
;	O
}	O
break	O
;	O
case	O
SNMP_PDU_GET	O
:	O
case	O
SNMP_PDU_GETNEXT	O
:	O
case	O
SNMP_PDU_SET	O
:	O
sp	pointer
->	O
converse	pointer
(	O
SNMP_CONV_RECV_MSG	int
,	O
sp	pointer
,	O
pdu	pointer
,	O
sp	pointer
->	O
app_closure	pointer
)	O
;	O
break	O
;	O
default	O
:	O
;	O
}	O
snmp_pdu_free	function
(	O
pdu	pointer
)	O
;	O
}	O
}	O

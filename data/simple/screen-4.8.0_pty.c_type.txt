extern	O
int	O
eff_uid	int
;	O
static	O
char	O
PtyName	array
[	O
32	int
]	O
,	O
TtyName	array
[	O
32	int
]	O
;	O
static	O
void	O
initmaster	function
__P	O
(	O
(	O
int	O
)	O
)	O
;	O
int	O
pty_preopen	int
=	O
0	int
;	O
static	O
void	O
initmaster	function
(	O
f	int
)	O
int	O
f	int
;	O
{	O
tcflush	function
(	O
f	int
,	O
TCIOFLUSH	int
)	O
;	O
}	O
void	O
InitPTY	function
(	O
f	int
)	O
int	O
f	int
;	O
{	O
if	O
(	O
f	int
<	O
0	int
)	O
return	O
;	O
}	O
int	O
OpenPTY	function
(	O
ttyn	pointer
)	O
char	O
*	O
*	O
ttyn	pointer
;	O
{	O
register	O
int	O
f	int
;	O
char	O
*	O
m	union
,	O
*	O
ptsname	function
(	O
)	O
;	O
int	O
unlockpt	function
__P	O
(	O
(	O
int	O
)	O
)	O
,	O
grantpt	function
__P	O
(	O
(	O
int	O
)	O
)	O
;	O
int	O
getpt	function
__P	O
(	O
(	O
void	O
)	O
)	O
;	O
sigret_t	void
(	O
*	O
sigcld	pointer
)	O
__P	O
(	O
SIGPROTOARG	O
)	O
;	O
strcpy	function
(	O
PtyName	array
,	O
"/dev/ptmx"	pointer
)	O
;	O
if	O
(	O
(	O
f	int
=	O
getpt	function
(	O
)	O
)	O
==	O
-	O
1	int
)	O
return	O
-	O
1	int
;	O
sigcld	pointer
=	O
signal	function
(	O
SIGCHLD	int
,	O
SIG_DFL	O
)	O
;	O
if	O
(	O
(	O
m	union
=	O
ptsname	function
(	O
f	int
)	O
)	O
==	O
NULL	O
||	O
grantpt	function
(	O
f	int
)	O
||	O
unlockpt	function
(	O
f	int
)	O
)	O
{	O
signal	function
(	O
SIGCHLD	int
,	O
sigcld	pointer
)	O
;	O
close	pointer
(	O
f	int
)	O
;	O
return	O
-	O
1	int
;	O
}	O
signal	function
(	O
SIGCHLD	int
,	O
sigcld	pointer
)	O
;	O
if	O
(	O
strlen	function
(	O
m	union
)	O
<	O
sizeof	O
(	O
TtyName	array
)	O
)	O
strcpy	function
(	O
TtyName	array
,	O
m	union
)	O
;	O
else	O
{	O
close	pointer
(	O
f	int
)	O
;	O
return	O
-	O
1	int
;	O
}	O
initmaster	function
(	O
f	int
)	O
;	O
*	O
ttyn	pointer
=	O
TtyName	array
;	O
return	O
f	int
;	O
}	O
char	O
*	O
GetPtsPathOrSymlink	function
(	O
int	O
fd	int
)	O
{	O
int	O
ret	int
;	O
char	O
*	O
tty_name	pointer
;	O
static	O
char	O
tty_symlink	array
[	O
MAX_PTS_SYMLINK	O
]	O
;	O
errno	O
=	O
0	int
;	O
tty_name	pointer
=	O
ttyname	function
(	O
fd	int
)	O
;	O
if	O
(	O
!	O
tty_name	pointer
&&	O
errno	O
==	O
ENODEV	int
)	O
{	O
ret	int
=	O
snprintf	function
(	O
tty_symlink	array
,	O
MAX_PTS_SYMLINK	O
,	O
"/proc/self/fd/%d"	pointer
,	O
fd	int
)	O
;	O
if	O
(	O
ret	int
<	O
0	int
||	O
ret	int
>=	O
MAX_PTS_SYMLINK	O
)	O
return	O
NULL	O
;	O
errno	O
=	O
ENODEV	int
;	O
return	O
tty_symlink	array
;	O
}	O
return	O
tty_name	pointer
;	O
}	O

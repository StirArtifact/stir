error_t	int
trivfs_create_control	function
(	O
mach_port_t	O
underlying	int
,	O
struct	O
port_class	O
*	O
control_class	pointer
,	O
struct	O
port_bucket	O
*	O
control_bucket	pointer
,	O
struct	O
port_class	O
*	O
protid_class	pointer
,	O
struct	O
port_bucket	O
*	O
protid_bucket	pointer
,	O
struct	O
trivfs_control	struct
*	O
*	O
control	pointer
)	O
{	O
error_t	int
err	int
;	O
err	int
=	O
trivfs_add_control_port_class	function
(	O
&	O
control_class	pointer
)	O
;	O
if	O
(	O
!	O
err	int
)	O
err	int
=	O
trivfs_add_protid_port_class	function
(	O
&	O
protid_class	pointer
)	O
;	O
else	O
protid_class	pointer
=	O
0	int
;	O
if	O
(	O
!	O
err	int
)	O
err	int
=	O
trivfs_add_port_bucket	function
(	O
&	O
control_bucket	pointer
)	O
;	O
else	O
control_bucket	pointer
=	O
0	int
;	O
if	O
(	O
!	O
err	int
)	O
{	O
if	O
(	O
!	O
protid_bucket	pointer
)	O
protid_bucket	pointer
=	O
control_bucket	pointer
;	O
err	int
=	O
trivfs_add_port_bucket	function
(	O
&	O
protid_bucket	pointer
)	O
;	O
}	O
else	O
protid_bucket	pointer
=	O
0	int
;	O
if	O
(	O
!	O
err	int
)	O
err	int
=	O
ports_create_port	function
(	O
control_class	pointer
,	O
control_bucket	pointer
,	O
sizeof	O
(	O
struct	O
trivfs_control	struct
)	O
,	O
control	pointer
)	O
;	O
if	O
(	O
!	O
err	int
)	O
{	O
(	O
*	O
control	pointer
)	O
->	O
underlying	int
=	O
underlying	int
;	O
(	O
*	O
control	pointer
)	O
->	O
protid_class	pointer
=	O
protid_class	pointer
;	O
(	O
*	O
control	pointer
)	O
->	O
protid_bucket	pointer
=	O
protid_bucket	pointer
;	O
err	int
=	O
mach_port_allocate	function
(	O
mach_task_self	function
(	O
)	O
,	O
MACH_PORT_RIGHT_RECEIVE	O
,	O
&	O
(	O
*	O
control	pointer
)	O
->	O
filesys_id	int
)	O
;	O
if	O
(	O
err	int
)	O
{	O
ports_port_deref	function
(	O
*	O
control	pointer
)	O
;	O
goto	O
out	O
;	O
}	O
err	int
=	O
mach_port_allocate	function
(	O
mach_task_self	function
(	O
)	O
,	O
MACH_PORT_RIGHT_RECEIVE	O
,	O
&	O
(	O
*	O
control	pointer
)	O
->	O
file_id	int
)	O
;	O
if	O
(	O
err	int
)	O
{	O
mach_port_destroy	function
(	O
mach_task_self	function
(	O
)	O
,	O
(	O
*	O
control	pointer
)	O
->	O
filesys_id	int
)	O
;	O
ports_port_deref	function
(	O
*	O
control	pointer
)	O
;	O
goto	O
out	O
;	O
}	O
(	O
*	O
control	pointer
)	O
->	O
hook	pointer
=	O
0	int
;	O
}	O
out	O
:	O
if	O
(	O
err	int
)	O
{	O
trivfs_remove_control_port_class	function
(	O
control_class	pointer
)	O
;	O
trivfs_remove_protid_port_class	function
(	O
protid_class	pointer
)	O
;	O
trivfs_remove_port_bucket	function
(	O
control_bucket	pointer
)	O
;	O
trivfs_remove_port_bucket	function
(	O
protid_bucket	pointer
)	O
;	O
}	O
return	O
err	int
;	O
}	O

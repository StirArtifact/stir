static	O
void	O
set_copypass_perms	function
(	O
int	O
fd	int
,	O
const	O
char	O
*	O
name	pointer
,	O
struct	O
stat	struct
*	O
st	pointer
)	O
{	O
struct	O
cpio_file_stat	struct
header	pointer
;	O
header	pointer
.	O
c_name	pointer
=	O
(	O
char	O
*	O
)	O
name	pointer
;	O
stat_to_cpio	function
(	O
&	O
header	pointer
,	O
st	pointer
)	O
;	O
set_perms	function
(	O
fd	int
,	O
&	O
header	pointer
)	O
;	O
}	O
void	O
process_copy_pass	function
(	O
)	O
{	O
dynamic_string	struct
input_name	struct
;	O
dynamic_string	struct
output_name	struct
;	O
size_t	long
dirname_len	long
;	O
int	O
res	int
;	O
char	O
*	O
slash	pointer
;	O
struct	O
stat	struct
in_file_stat	struct
;	O
struct	O
stat	struct
out_file_stat	struct
;	O
int	O
in_file_des	int
;	O
int	O
out_file_des	int
;	O
int	O
existing_dir	int
;	O
newdir_umask	int
=	O
umask	function
(	O
0	int
)	O
;	O
ds_init	function
(	O
&	O
input_name	struct
,	O
128	int
)	O
;	O
dirname_len	long
=	O
strlen	function
(	O
directory_name	pointer
)	O
;	O
if	O
(	O
change_directory_option	pointer
&&	O
!	O
ISSLASH	O
(	O
directory_name	pointer
[	O
0	int
]	O
)	O
)	O
{	O
char	O
*	O
pwd	pointer
=	O
xgetcwd	function
(	O
)	O
;	O
dirname_len	long
+=	O
strlen	function
(	O
pwd	pointer
)	O
+	O
1	int
;	O
ds_init	function
(	O
&	O
output_name	struct
,	O
dirname_len	long
+	O
2	int
)	O
;	O
strcpy	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
pwd	pointer
)	O
;	O
strcat	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
"/"	pointer
)	O
;	O
strcat	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
directory_name	pointer
)	O
;	O
}	O
else	O
{	O
ds_init	function
(	O
&	O
output_name	struct
,	O
dirname_len	long
+	O
2	int
)	O
;	O
strcpy	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
directory_name	pointer
)	O
;	O
}	O
output_name	struct
.	O
ds_string	pointer
[	O
dirname_len	long
]	O
=	O
'/'	O
;	O
output_is_seekable	char
=	O
true	int
;	O
change_dir	function
(	O
)	O
;	O
while	O
(	O
ds_fgetstr	function
(	O
stdin	pointer
,	O
&	O
input_name	struct
,	O
name_end	char
)	O
!=	O
NULL	O
)	O
{	O
int	O
link_res	int
=	O
-	O
1	int
;	O
if	O
(	O
input_name	struct
.	O
ds_string	pointer
[	O
0	int
]	O
==	O
'\0'	O
)	O
{	O
error	function
(	O
0	int
,	O
0	int
,	O
_	O
(	O
"blank line ignored"	pointer
)	O
)	O
;	O
continue	O
;	O
}	O
if	O
(	O
input_name	struct
.	O
ds_string	pointer
[	O
0	int
]	O
==	O
'.'	O
&&	O
(	O
input_name	struct
.	O
ds_string	pointer
[	O
1	int
]	O
==	O
'\0'	O
||	O
(	O
input_name	struct
.	O
ds_string	pointer
[	O
1	int
]	O
==	O
'/'	O
&&	O
input_name	struct
.	O
ds_string	pointer
[	O
2	int
]	O
==	O
'\0'	O
)	O
)	O
)	O
continue	O
;	O
if	O
(	O
(	O
*	O
xstat	pointer
)	O
(	O
input_name	struct
.	O
ds_string	pointer
,	O
&	O
in_file_stat	struct
)	O
<	O
0	int
)	O
{	O
stat_error	function
(	O
input_name	struct
.	O
ds_string	pointer
)	O
;	O
continue	O
;	O
}	O
for	O
(	O
slash	pointer
=	O
input_name	struct
.	O
ds_string	pointer
;	O
*	O
slash	pointer
==	O
'/'	O
;	O
++	O
slash	pointer
)	O
;	O
ds_resize	function
(	O
&	O
output_name	struct
,	O
dirname_len	long
+	O
strlen	function
(	O
slash	pointer
)	O
+	O
2	int
)	O
;	O
strcpy	function
(	O
output_name	struct
.	O
ds_string	pointer
+	O
dirname_len	long
+	O
1	int
,	O
slash	pointer
)	O
;	O
existing_dir	int
=	O
false	int
;	O
if	O
(	O
lstat	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
&	O
out_file_stat	struct
)	O
==	O
0	int
)	O
{	O
if	O
(	O
S_ISDIR	O
(	O
out_file_stat	struct
.	O
st_mode	int
)	O
&&	O
S_ISDIR	O
(	O
in_file_stat	struct
.	O
st_mode	int
)	O
)	O
{	O
existing_dir	int
=	O
true	int
;	O
}	O
else	O
if	O
(	O
!	O
unconditional_flag	int
&&	O
in_file_stat	struct
.	O
st_mtime	O
<=	O
out_file_stat	struct
.	O
st_mtime	O
)	O
{	O
error	function
(	O
0	int
,	O
0	int
,	O
_	O
(	O
"%s not created: newer or same age version exists"	pointer
)	O
,	O
output_name	struct
.	O
ds_string	pointer
)	O
;	O
continue	O
;	O
}	O
else	O
if	O
(	O
S_ISDIR	O
(	O
out_file_stat	struct
.	O
st_mode	int
)	O
?	O
rmdir	function
(	O
output_name	struct
.	O
ds_string	pointer
)	O
:	O
unlink	function
(	O
output_name	struct
.	O
ds_string	pointer
)	O
)	O
{	O
error	function
(	O
0	int
,	O
errno	O
,	O
_	O
(	O
"cannot remove current %s"	pointer
)	O
,	O
output_name	struct
.	O
ds_string	pointer
)	O
;	O
continue	O
;	O
}	O
}	O
if	O
(	O
S_ISREG	O
(	O
in_file_stat	struct
.	O
st_mode	int
)	O
)	O
{	O
if	O
(	O
link_flag	int
)	O
link_res	int
=	O
link_to_name	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
input_name	struct
.	O
ds_string	pointer
)	O
;	O
if	O
(	O
(	O
link_res	int
<	O
0	int
)	O
&&	O
(	O
in_file_stat	struct
.	O
st_nlink	long
>	O
1	int
)	O
)	O
link_res	int
=	O
link_to_maj_min_ino	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
major	O
(	O
in_file_stat	struct
.	O
st_dev	long
)	O
,	O
minor	O
(	O
in_file_stat	struct
.	O
st_dev	long
)	O
,	O
in_file_stat	struct
.	O
st_ino	long
)	O
;	O
if	O
(	O
link_res	int
<	O
0	int
)	O
{	O
in_file_des	int
=	O
open	function
(	O
input_name	struct
.	O
ds_string	pointer
,	O
O_RDONLY	int
|	O
O_BINARY	int
,	O
0	int
)	O
;	O
if	O
(	O
in_file_des	int
<	O
0	int
)	O
{	O
open_error	function
(	O
input_name	struct
.	O
ds_string	pointer
)	O
;	O
continue	O
;	O
}	O
out_file_des	int
=	O
open	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
O_CREAT	int
|	O
O_WRONLY	int
|	O
O_BINARY	int
,	O
0600	int
)	O
;	O
if	O
(	O
out_file_des	int
<	O
0	int
&&	O
create_dir_flag	int
)	O
{	O
create_all_directories	function
(	O
output_name	struct
.	O
ds_string	pointer
)	O
;	O
out_file_des	int
=	O
open	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
O_CREAT	int
|	O
O_WRONLY	int
|	O
O_BINARY	int
,	O
0600	int
)	O
;	O
}	O
if	O
(	O
out_file_des	int
<	O
0	int
)	O
{	O
open_error	function
(	O
output_name	struct
.	O
ds_string	pointer
)	O
;	O
close	function
(	O
in_file_des	int
)	O
;	O
continue	O
;	O
}	O
copy_files_disk_to_disk	function
(	O
in_file_des	int
,	O
out_file_des	int
,	O
in_file_stat	struct
.	O
st_size	long
,	O
input_name	struct
.	O
ds_string	pointer
)	O
;	O
disk_empty_output_buffer	function
(	O
out_file_des	int
,	O
true	int
)	O
;	O
set_copypass_perms	function
(	O
out_file_des	int
,	O
output_name	struct
.	O
ds_string	pointer
,	O
&	O
in_file_stat	struct
)	O
;	O
if	O
(	O
reset_time_flag	int
)	O
{	O
set_file_times	function
(	O
in_file_des	int
,	O
input_name	struct
.	O
ds_string	pointer
,	O
in_file_stat	struct
.	O
st_atime	O
,	O
in_file_stat	struct
.	O
st_mtime	O
)	O
;	O
set_file_times	function
(	O
out_file_des	int
,	O
output_name	struct
.	O
ds_string	pointer
,	O
in_file_stat	struct
.	O
st_atime	O
,	O
in_file_stat	struct
.	O
st_mtime	O
)	O
;	O
}	O
if	O
(	O
close	function
(	O
in_file_des	int
)	O
<	O
0	int
)	O
close_error	function
(	O
input_name	struct
.	O
ds_string	pointer
)	O
;	O
if	O
(	O
close	function
(	O
out_file_des	int
)	O
<	O
0	int
)	O
close_error	function
(	O
output_name	struct
.	O
ds_string	pointer
)	O
;	O
warn_if_file_changed	function
(	O
input_name	struct
.	O
ds_string	pointer
,	O
in_file_stat	struct
.	O
st_size	long
,	O
in_file_stat	struct
.	O
st_mtime	O
)	O
;	O
}	O
}	O
else	O
if	O
(	O
S_ISDIR	O
(	O
in_file_stat	struct
.	O
st_mode	int
)	O
)	O
{	O
struct	O
cpio_file_stat	struct
file_stat	pointer
;	O
stat_to_cpio	function
(	O
&	O
file_stat	pointer
,	O
&	O
in_file_stat	struct
)	O
;	O
file_stat	pointer
.	O
c_name	pointer
=	O
output_name	struct
.	O
ds_string	pointer
;	O
cpio_create_dir	function
(	O
&	O
file_stat	pointer
,	O
existing_dir	int
)	O
;	O
}	O
else	O
if	O
(	O
S_ISCHR	O
(	O
in_file_stat	struct
.	O
st_mode	int
)	O
||	O
S_ISBLK	O
(	O
in_file_stat	struct
.	O
st_mode	int
)	O
||	O
S_ISFIFO	O
(	O
in_file_stat	struct
.	O
st_mode	int
)	O
||	O
S_ISSOCK	O
(	O
in_file_stat	struct
.	O
st_mode	int
)	O
||	O
0	int
)	O
{	O
if	O
(	O
link_flag	int
)	O
link_res	int
=	O
link_to_name	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
input_name	struct
.	O
ds_string	pointer
)	O
;	O
if	O
(	O
(	O
link_res	int
<	O
0	int
)	O
&&	O
(	O
in_file_stat	struct
.	O
st_nlink	long
>	O
1	int
)	O
)	O
link_res	int
=	O
link_to_maj_min_ino	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
major	O
(	O
in_file_stat	struct
.	O
st_dev	long
)	O
,	O
minor	O
(	O
in_file_stat	struct
.	O
st_dev	long
)	O
,	O
in_file_stat	struct
.	O
st_ino	long
)	O
;	O
if	O
(	O
link_res	int
<	O
0	int
)	O
{	O
res	int
=	O
mknod	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
in_file_stat	struct
.	O
st_mode	int
,	O
in_file_stat	struct
.	O
st_rdev	long
)	O
;	O
if	O
(	O
res	int
<	O
0	int
&&	O
create_dir_flag	int
)	O
{	O
create_all_directories	function
(	O
output_name	struct
.	O
ds_string	pointer
)	O
;	O
res	int
=	O
mknod	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
in_file_stat	struct
.	O
st_mode	int
,	O
in_file_stat	struct
.	O
st_rdev	long
)	O
;	O
}	O
if	O
(	O
res	int
<	O
0	int
)	O
{	O
mknod_error	function
(	O
output_name	struct
.	O
ds_string	pointer
)	O
;	O
continue	O
;	O
}	O
set_copypass_perms	function
(	O
-	O
1	int
,	O
output_name	struct
.	O
ds_string	pointer
,	O
&	O
in_file_stat	struct
)	O
;	O
}	O
}	O
else	O
if	O
(	O
S_ISLNK	O
(	O
in_file_stat	struct
.	O
st_mode	int
)	O
)	O
{	O
char	O
*	O
link_name	pointer
;	O
int	O
link_size	int
;	O
link_name	pointer
=	O
(	O
char	O
*	O
)	O
xmalloc	function
(	O
(	O
unsigned	O
int	O
)	O
in_file_stat	struct
.	O
st_size	long
+	O
1	int
)	O
;	O
link_size	int
=	O
readlink	function
(	O
input_name	struct
.	O
ds_string	pointer
,	O
link_name	pointer
,	O
in_file_stat	struct
.	O
st_size	long
)	O
;	O
if	O
(	O
link_size	int
<	O
0	int
)	O
{	O
readlink_error	function
(	O
input_name	struct
.	O
ds_string	pointer
)	O
;	O
free	function
(	O
link_name	pointer
)	O
;	O
continue	O
;	O
}	O
link_name	pointer
[	O
link_size	int
]	O
=	O
'\0'	O
;	O
res	int
=	O
UMASKED_SYMLINK	O
(	O
link_name	pointer
,	O
output_name	struct
.	O
ds_string	pointer
,	O
in_file_stat	struct
.	O
st_mode	int
)	O
;	O
if	O
(	O
res	int
<	O
0	int
&&	O
create_dir_flag	int
)	O
{	O
create_all_directories	function
(	O
output_name	struct
.	O
ds_string	pointer
)	O
;	O
res	int
=	O
UMASKED_SYMLINK	O
(	O
link_name	pointer
,	O
output_name	struct
.	O
ds_string	pointer
,	O
in_file_stat	struct
.	O
st_mode	int
)	O
;	O
}	O
if	O
(	O
res	int
<	O
0	int
)	O
{	O
symlink_error	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
link_name	pointer
)	O
;	O
free	function
(	O
link_name	pointer
)	O
;	O
continue	O
;	O
}	O
if	O
(	O
!	O
no_chown_flag	int
)	O
{	O
uid_t	int
uid	int
=	O
set_owner_flag	int
?	O
set_owner	int
:	O
in_file_stat	struct
.	O
st_uid	int
;	O
gid_t	int
gid	int
=	O
set_group_flag	int
?	O
set_group	int
:	O
in_file_stat	struct
.	O
st_gid	int
;	O
if	O
(	O
(	O
lchown	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
uid	int
,	O
gid	int
)	O
<	O
0	int
)	O
&&	O
errno	O
!=	O
EPERM	int
)	O
chown_error_details	function
(	O
output_name	struct
.	O
ds_string	pointer
,	O
uid	int
,	O
gid	int
)	O
;	O
}	O
free	function
(	O
link_name	pointer
)	O
;	O
}	O
else	O
{	O
error	function
(	O
0	int
,	O
0	int
,	O
_	O
(	O
"%s: unknown file type"	pointer
)	O
,	O
input_name	struct
.	O
ds_string	pointer
)	O
;	O
}	O
if	O
(	O
verbose_flag	int
)	O
fprintf	function
(	O
stderr	pointer
,	O
"%s\n"	pointer
,	O
output_name	struct
.	O
ds_string	pointer
)	O
;	O
if	O
(	O
dot_flag	int
)	O
fputc	function
(	O
'.'	O
,	O
stderr	pointer
)	O
;	O
}	O
if	O
(	O
dot_flag	int
)	O
fputc	function
(	O
'\n'	O
,	O
stderr	pointer
)	O
;	O
apply_delayed_set_stat	function
(	O
)	O
;	O
if	O
(	O
!	O
quiet_flag	int
)	O
{	O
size_t	long
blocks	long
=	O
(	O
output_bytes	long
+	O
io_block_size	int
-	O
1	int
)	O
/	O
io_block_size	int
;	O
fprintf	function
(	O
stderr	pointer
,	O
ngettext	function
(	O
"%lu block\n"	pointer
,	O
"%lu blocks\n"	pointer
,	O
(	O
unsigned	O
long	O
)	O
blocks	long
)	O
,	O
(	O
unsigned	O
long	O
)	O
blocks	long
)	O
;	O
}	O
}	O
int	O
link_to_maj_min_ino	function
(	O
char	O
*	O
file_name	pointer
,	O
int	O
st_dev_maj	int
,	O
int	O
st_dev_min	int
,	O
ino_t	long
st_ino	long
)	O
{	O
int	O
link_res	int
;	O
char	O
*	O
link_name	pointer
;	O
link_res	int
=	O
-	O
1	int
;	O
link_name	pointer
=	O
find_inode_file	function
(	O
st_ino	long
,	O
st_dev_maj	int
,	O
st_dev_min	int
)	O
;	O
if	O
(	O
link_name	pointer
==	O
NULL	O
)	O
add_inode	function
(	O
st_ino	long
,	O
file_name	pointer
,	O
st_dev_maj	int
,	O
st_dev_min	int
)	O
;	O
else	O
link_res	int
=	O
link_to_name	function
(	O
file_name	pointer
,	O
link_name	pointer
)	O
;	O
return	O
link_res	int
;	O
}	O
int	O
link_to_name	function
(	O
char	O
const	O
*	O
link_name	pointer
,	O
char	O
const	O
*	O
link_target	bool
)	O
{	O
int	O
res	int
=	O
link	function
(	O
link_target	bool
,	O
link_name	pointer
)	O
;	O
if	O
(	O
res	int
<	O
0	int
&&	O
create_dir_flag	int
)	O
{	O
create_all_directories	function
(	O
link_name	pointer
)	O
;	O
res	int
=	O
link	function
(	O
link_target	bool
,	O
link_name	pointer
)	O
;	O
}	O
if	O
(	O
res	int
==	O
0	int
)	O
{	O
if	O
(	O
verbose_flag	int
)	O
error	function
(	O
0	int
,	O
0	int
,	O
_	O
(	O
"%s linked to %s"	pointer
)	O
,	O
link_target	bool
,	O
link_name	pointer
)	O
;	O
}	O
else	O
if	O
(	O
link_flag	int
)	O
{	O
error	function
(	O
0	int
,	O
errno	O
,	O
_	O
(	O
"cannot link %s to %s"	pointer
)	O
,	O
link_target	bool
,	O
link_name	pointer
)	O
;	O
}	O
return	O
res	int
;	O
}	O

int	O
mu_rename_file	function
(	O
const	O
char	O
*	O
oldpath	pointer
,	O
const	O
char	O
*	O
newpath	pointer
,	O
int	O
flags	int
)	O
{	O
int	O
rc	int
;	O
struct	O
stat	struct
st	pointer
;	O
if	O
(	O
access	function
(	O
oldpath	pointer
,	O
F_OK	int
)	O
)	O
return	O
errno	O
;	O
if	O
(	O
stat	struct
(	O
newpath	pointer
,	O
&	O
st	pointer
)	O
==	O
0	int
)	O
{	O
if	O
(	O
flags	int
&	O
MU_COPY_OVERWRITE	int
)	O
{	O
if	O
(	O
S_ISDIR	O
(	O
st	pointer
.	O
st_mode	int
)	O
)	O
{	O
if	O
(	O
mu_remove_file	function
(	O
newpath	pointer
)	O
)	O
return	O
MU_ERR_REMOVE_DEST	O
;	O
}	O
}	O
else	O
return	O
EEXIST	int
;	O
}	O
if	O
(	O
rename	function
(	O
oldpath	pointer
,	O
newpath	pointer
)	O
==	O
0	int
)	O
return	O
0	int
;	O
if	O
(	O
errno	O
==	O
EXDEV	int
)	O
{	O
mu_debug	O
(	O
MU_DEBCAT_STREAM	int
,	O
MU_DEBUG_ERROR	int
,	O
(	O
_	O
(	O
"cannot rename %s to %s: %s"	pointer
)	O
,	O
oldpath	pointer
,	O
newpath	pointer
,	O
mu_strerror	function
(	O
errno	O
)	O
)	O
)	O
;	O
mu_debug	O
(	O
MU_DEBCAT_STREAM	int
,	O
MU_DEBUG_TRACE1	int
,	O
(	O
_	O
(	O
"attempting copy"	pointer
)	O
)	O
)	O
;	O
rc	int
=	O
mu_copy_file	function
(	O
oldpath	pointer
,	O
newpath	pointer
,	O
flags	int
|	O
MU_COPY_MODE	int
|	O
MU_COPY_OWNER	int
)	O
;	O
if	O
(	O
rc	int
==	O
0	int
)	O
{	O
rc	int
=	O
mu_remove_file	function
(	O
oldpath	pointer
)	O
;	O
if	O
(	O
rc	int
)	O
{	O
mu_debug	O
(	O
MU_DEBCAT_STREAM	int
,	O
MU_DEBUG_ERROR	int
,	O
(	O
_	O
(	O
"copied %s to %s, but failed to remove the source: %s"	pointer
)	O
,	O
oldpath	pointer
,	O
newpath	pointer
,	O
mu_strerror	function
(	O
rc	int
)	O
)	O
)	O
;	O
rc	int
=	O
MU_ERR_REMOVE_SOURCE	O
;	O
}	O
}	O
}	O
else	O
rc	int
=	O
errno	O
;	O
return	O
rc	int
;	O
}	O

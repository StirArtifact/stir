static	O
int	O
fork2	function
(	O
void	O
)	O
;	O
static	O
char	O
*	O
normalize_path	function
(	O
char	O
*	O
path	pointer
,	O
const	O
char	O
*	O
delim	pointer
)	O
;	O
char	O
*	O
ttymsg	function
(	O
struct	O
iovec	struct
*	O
iov	pointer
,	O
int	O
iovcnt	int
,	O
char	O
*	O
line	pointer
,	O
int	O
tmout	int
)	O
{	O
static	O
char	O
errbuf	array
[	O
MAX_ERRBUF	int
]	O
;	O
char	O
*	O
device	pointer
;	O
register	O
int	O
cnt	int
,	O
fd	int
,	O
left	int
,	O
wret	int
;	O
struct	O
iovec	struct
localiov	array
[	O
6	int
]	O
;	O
int	O
forked	int
=	O
0	int
;	O
if	O
(	O
iovcnt	int
>	O
(	O
int	O
)	O
(	O
sizeof	O
(	O
localiov	array
)	O
/	O
sizeof	O
(	O
localiov	array
[	O
0	int
]	O
)	O
)	O
)	O
return	O
(	O
char	O
*	O
)	O
(	O
"too many iov's (change code in wall/ttymsg.c)"	pointer
)	O
;	O
device	pointer
=	O
malloc	function
(	O
sizeof	O
PATH_TTY_PFX	O
-	O
1	int
+	O
strlen	function
(	O
line	pointer
)	O
+	O
1	int
)	O
;	O
if	O
(	O
!	O
device	pointer
)	O
{	O
snprintf	function
(	O
errbuf	array
,	O
sizeof	O
errbuf	array
,	O
"Not enough memory for tty device name"	pointer
)	O
;	O
return	O
errbuf	array
;	O
}	O
strcpy	function
(	O
device	pointer
,	O
PATH_TTY_PFX	O
)	O
;	O
strcat	function
(	O
device	pointer
,	O
line	pointer
)	O
;	O
normalize_path	function
(	O
device	pointer
,	O
"/"	pointer
)	O
;	O
if	O
(	O
strncmp	function
(	O
device	pointer
,	O
PATH_TTY_PFX	O
,	O
strlen	function
(	O
PATH_TTY_PFX	O
)	O
)	O
)	O
{	O
snprintf	function
(	O
errbuf	array
,	O
sizeof	O
(	O
errbuf	array
)	O
,	O
"bad line name: %s"	pointer
,	O
line	pointer
)	O
;	O
return	O
(	O
errbuf	array
)	O
;	O
}	O
fd	int
=	O
open	function
(	O
device	pointer
,	O
O_WRONLY	int
|	O
O_NONBLOCK	int
,	O
0	int
)	O
;	O
if	O
(	O
fd	int
<	O
0	int
)	O
{	O
if	O
(	O
errno	O
==	O
EBUSY	int
||	O
errno	O
==	O
EACCES	int
)	O
return	O
(	O
NULL	O
)	O
;	O
snprintf	function
(	O
errbuf	array
,	O
sizeof	O
(	O
errbuf	array
)	O
,	O
"%s: %s"	pointer
,	O
device	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
free	function
(	O
device	pointer
)	O
;	O
return	O
errbuf	array
;	O
}	O
for	O
(	O
cnt	int
=	O
left	int
=	O
0	int
;	O
cnt	int
<	O
iovcnt	int
;	O
++	O
cnt	int
)	O
left	int
+=	O
iov	pointer
[	O
cnt	int
]	O
.	O
iov_len	long
;	O
for	O
(	O
;	O
;	O
)	O
{	O
wret	int
=	O
writev	function
(	O
fd	int
,	O
iov	pointer
,	O
iovcnt	int
)	O
;	O
if	O
(	O
wret	int
>=	O
left	int
)	O
break	O
;	O
if	O
(	O
wret	int
>=	O
0	int
)	O
{	O
left	int
-=	O
wret	int
;	O
if	O
(	O
iov	pointer
!=	O
localiov	array
)	O
{	O
memcpy	function
(	O
localiov	array
,	O
iov	pointer
,	O
iovcnt	int
*	O
sizeof	O
(	O
struct	O
iovec	struct
)	O
)	O
;	O
iov	pointer
=	O
localiov	array
;	O
}	O
for	O
(	O
cnt	int
=	O
0	int
;	O
wret	int
>=	O
(	O
int	O
)	O
iov	pointer
->	O
iov_len	long
;	O
++	O
cnt	int
)	O
{	O
wret	int
-=	O
iov	pointer
->	O
iov_len	long
;	O
++	O
iov	pointer
;	O
--	O
iovcnt	int
;	O
}	O
if	O
(	O
wret	int
)	O
{	O
iov	pointer
->	O
iov_base	pointer
=	O
(	O
char	O
*	O
)	O
iov	pointer
->	O
iov_base	pointer
+	O
wret	int
;	O
iov	pointer
->	O
iov_len	long
-=	O
wret	int
;	O
}	O
continue	O
;	O
}	O
if	O
(	O
errno	O
==	O
EWOULDBLOCK	O
)	O
{	O
int	O
cpid	int
,	O
off	int
=	O
0	int
;	O
if	O
(	O
forked	int
)	O
{	O
close	function
(	O
fd	int
)	O
;	O
_exit	function
(	O
1	int
)	O
;	O
}	O
cpid	int
=	O
fork2	function
(	O
)	O
;	O
if	O
(	O
cpid	int
<	O
0	int
)	O
{	O
snprintf	function
(	O
errbuf	array
,	O
sizeof	O
(	O
errbuf	array
)	O
,	O
"fork: %s"	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
close	function
(	O
fd	int
)	O
;	O
free	function
(	O
device	pointer
)	O
;	O
return	O
(	O
errbuf	array
)	O
;	O
}	O
if	O
(	O
cpid	int
)	O
{	O
close	function
(	O
fd	int
)	O
;	O
free	function
(	O
device	pointer
)	O
;	O
return	O
(	O
NULL	O
)	O
;	O
}	O
forked	int
++	O
;	O
signal	function
(	O
SIGALRM	int
,	O
SIG_DFL	O
)	O
;	O
signal	function
(	O
SIGTERM	int
,	O
SIG_DFL	O
)	O
;	O
{	O
sigset_t	struct
empty	struct
;	O
sigemptyset	function
(	O
&	O
empty	struct
)	O
;	O
sigprocmask	function
(	O
SIG_SETMASK	int
,	O
&	O
empty	struct
,	O
0	int
)	O
;	O
}	O
alarm	function
(	O
(	O
u_int	int
)	O
tmout	int
)	O
;	O
fcntl	function
(	O
fd	int
,	O
O_NONBLOCK	int
,	O
&	O
off	int
)	O
;	O
continue	O
;	O
}	O
if	O
(	O
errno	O
==	O
ENODEV	int
||	O
errno	O
==	O
EIO	int
)	O
break	O
;	O
close	function
(	O
fd	int
)	O
;	O
if	O
(	O
forked	int
)	O
_exit	function
(	O
1	int
)	O
;	O
snprintf	function
(	O
errbuf	array
,	O
sizeof	O
(	O
errbuf	array
)	O
,	O
"%s: %s"	pointer
,	O
device	pointer
,	O
strerror	function
(	O
errno	O
)	O
)	O
;	O
free	function
(	O
device	pointer
)	O
;	O
return	O
(	O
errbuf	array
)	O
;	O
}	O
free	function
(	O
device	pointer
)	O
;	O
close	function
(	O
fd	int
)	O
;	O
if	O
(	O
forked	int
)	O
_exit	function
(	O
0	int
)	O
;	O
return	O
(	O
NULL	O
)	O
;	O
}	O
static	O
int	O
fork2	function
(	O
void	O
)	O
{	O
pid_t	int
pid	int
;	O
int	O
status	int
;	O
if	O
(	O
!	O
(	O
pid	int
=	O
fork	function
(	O
)	O
)	O
)	O
{	O
switch	O
(	O
fork	function
(	O
)	O
)	O
{	O
case	O
0	int
:	O
return	O
0	int
;	O
case	O
-	O
1	int
:	O
_exit	function
(	O
errno	O
)	O
;	O
default	O
:	O
_exit	function
(	O
0	int
)	O
;	O
}	O
}	O
if	O
(	O
pid	int
<	O
0	int
||	O
waitpid	function
(	O
pid	int
,	O
&	O
status	int
,	O
0	int
)	O
<	O
0	int
)	O
return	O
-	O
1	int
;	O
if	O
(	O
WIFEXITED	O
(	O
status	int
)	O
)	O
if	O
(	O
WEXITSTATUS	O
(	O
status	int
)	O
==	O
0	int
)	O
return	O
1	int
;	O
else	O
errno	O
=	O
WEXITSTATUS	O
(	O
status	int
)	O
;	O
else	O
errno	O
=	O
EINTR	int
;	O
return	O
-	O
1	int
;	O
}	O
char	O
*	O
normalize_path	function
(	O
char	O
*	O
path	pointer
,	O
const	O
char	O
*	O
delim	pointer
)	O
{	O
int	O
len	int
;	O
char	O
*	O
p	pointer
;	O
if	O
(	O
!	O
path	pointer
)	O
return	O
path	pointer
;	O
len	int
=	O
strlen	function
(	O
path	pointer
)	O
;	O
if	O
(	O
len	int
==	O
0	int
)	O
return	O
path	pointer
;	O
if	O
(	O
len	int
&&	O
path	pointer
[	O
len	int
-	O
1	int
]	O
==	O
delim	pointer
[	O
0	int
]	O
)	O
path	pointer
[	O
len	int
-	O
1	int
]	O
=	O
0	int
;	O
for	O
(	O
p	pointer
=	O
strchr	function
(	O
path	pointer
,	O
'.'	O
)	O
;	O
p	pointer
;	O
p	pointer
=	O
strchr	function
(	O
p	pointer
,	O
'.'	O
)	O
)	O
{	O
if	O
(	O
p	pointer
>	O
path	pointer
&&	O
p	pointer
[	O
-	O
1	int
]	O
==	O
delim	pointer
[	O
0	int
]	O
)	O
{	O
if	O
(	O
p	pointer
[	O
1	int
]	O
==	O
'.'	O
&&	O
(	O
p	pointer
[	O
2	int
]	O
==	O
0	int
||	O
p	pointer
[	O
2	int
]	O
==	O
delim	pointer
[	O
0	int
]	O
)	O
)	O
{	O
char	O
*	O
q	pointer
,	O
*	O
s	pointer
;	O
for	O
(	O
q	pointer
=	O
p	pointer
-	O
2	int
;	O
*	O
q	pointer
!=	O
delim	pointer
[	O
0	int
]	O
&&	O
q	pointer
>=	O
path	pointer
;	O
q	pointer
--	O
)	O
;	O
if	O
(	O
q	pointer
<	O
path	pointer
)	O
break	O
;	O
s	pointer
=	O
p	pointer
+	O
2	int
;	O
p	pointer
=	O
q	pointer
;	O
while	O
(	O
(	O
*	O
q	pointer
++	O
=	O
*	O
s	pointer
++	O
)	O
)	O
;	O
continue	O
;	O
}	O
}	O
p	pointer
++	O
;	O
}	O
if	O
(	O
path	pointer
[	O
0	int
]	O
==	O
0	int
)	O
{	O
path	pointer
[	O
0	int
]	O
=	O
delim	pointer
[	O
0	int
]	O
;	O
path	pointer
[	O
1	int
]	O
=	O
0	int
;	O
}	O
return	O
path	pointer
;	O
}	O

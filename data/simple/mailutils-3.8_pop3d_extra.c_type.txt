mu_stream_t	pointer
iostream	pointer
;	O
void	O
pop3d_parse_command	function
(	O
char	O
*	O
cmd	enum
,	O
char	O
*	O
*	O
pcmd	pointer
,	O
char	O
*	O
*	O
parg	pointer
)	O
{	O
char	O
*	O
p	pointer
;	O
cmd	enum
=	O
mu_str_skip_class	function
(	O
cmd	enum
,	O
MU_CTYPE_BLANK	int
)	O
;	O
*	O
pcmd	pointer
=	O
cmd	enum
;	O
p	pointer
=	O
mu_str_skip_class_comp	function
(	O
cmd	enum
,	O
MU_CTYPE_SPACE	int
)	O
;	O
*	O
p	pointer
++	O
=	O
0	int
;	O
if	O
(	O
*	O
p	pointer
)	O
{	O
*	O
parg	pointer
=	O
p	pointer
;	O
mu_rtrim_class	function
(	O
p	pointer
,	O
MU_CTYPE_SPACE	int
)	O
;	O
}	O
else	O
*	O
parg	pointer
=	O
""	pointer
;	O
}	O
int	O
pop3d_abquit	function
(	O
int	O
reason	int
)	O
{	O
int	O
code	int
;	O
if	O
(	O
state	pointer
!=	O
AUTHORIZATION	int
)	O
{	O
mu_mailbox_flush	function
(	O
mbox	pointer
,	O
0	int
)	O
;	O
mu_mailbox_close	function
(	O
mbox	pointer
)	O
;	O
manlock_unlock	function
(	O
mbox	pointer
)	O
;	O
mu_mailbox_destroy	function
(	O
&	O
mbox	pointer
)	O
;	O
}	O
switch	O
(	O
reason	int
)	O
{	O
case	O
ERR_NO_MEM	int
:	O
code	int
=	O
EX_SOFTWARE	int
;	O
pop3d_outf	function
(	O
"-ERR %s\n"	pointer
,	O
pop3d_error_string	function
(	O
reason	int
)	O
)	O
;	O
mu_diag_output	function
(	O
MU_DIAG_ERROR	O
,	O
_	O
(	O
"not enough memory"	pointer
)	O
)	O
;	O
break	O
;	O
case	O
ERR_SIGNAL	int
:	O
code	int
=	O
EX_SOFTWARE	int
;	O
mu_diag_output	function
(	O
MU_DIAG_ERROR	O
,	O
_	O
(	O
"quitting on signal"	pointer
)	O
)	O
;	O
break	O
;	O
case	O
ERR_TERMINATE	int
:	O
code	int
=	O
EX_OK	int
;	O
mu_diag_output	function
(	O
MU_DIAG_NOTICE	O
,	O
_	O
(	O
"terminating on request"	pointer
)	O
)	O
;	O
break	O
;	O
case	O
ERR_TIMEOUT	int
:	O
code	int
=	O
EX_TEMPFAIL	int
;	O
pop3d_outf	function
(	O
"-ERR %s\n"	pointer
,	O
pop3d_error_string	function
(	O
reason	int
)	O
)	O
;	O
if	O
(	O
state	pointer
==	O
TRANSACTION	int
)	O
mu_diag_output	function
(	O
MU_DIAG_INFO	O
,	O
_	O
(	O
"session timed out for user: %s"	pointer
)	O
,	O
username	pointer
)	O
;	O
else	O
mu_diag_output	function
(	O
MU_DIAG_INFO	O
,	O
_	O
(	O
"session timed out for no user"	pointer
)	O
)	O
;	O
break	O
;	O
case	O
ERR_NO_IFILE	int
:	O
code	int
=	O
EX_NOINPUT	int
;	O
mu_diag_output	function
(	O
MU_DIAG_INFO	O
,	O
_	O
(	O
"no input stream"	pointer
)	O
)	O
;	O
break	O
;	O
case	O
ERR_NO_OFILE	int
:	O
code	int
=	O
EX_IOERR	int
;	O
mu_diag_output	function
(	O
MU_DIAG_INFO	O
,	O
_	O
(	O
"no socket to send to"	pointer
)	O
)	O
;	O
break	O
;	O
case	O
ERR_FILE	int
:	O
code	int
=	O
EX_IOERR	int
;	O
break	O
;	O
case	O
ERR_PROTO	int
:	O
code	int
=	O
EX_PROTOCOL	int
;	O
mu_diag_output	function
(	O
MU_DIAG_INFO	O
,	O
_	O
(	O
"remote protocol error"	pointer
)	O
)	O
;	O
break	O
;	O
case	O
ERR_IO	int
:	O
code	int
=	O
EX_IOERR	int
;	O
mu_diag_output	function
(	O
MU_DIAG_INFO	O
,	O
_	O
(	O
"I/O error"	pointer
)	O
)	O
;	O
break	O
;	O
case	O
ERR_MBOX_SYNC	int
:	O
code	int
=	O
EX_OSERR	int
;	O
mu_diag_output	function
(	O
MU_DIAG_ERROR	O
,	O
_	O
(	O
"mailbox was updated by other party: %s"	pointer
)	O
,	O
username	pointer
)	O
;	O
pop3d_outf	function
(	O
"-ERR [OUT-SYNC] Mailbox updated by other party or corrupt\n"	pointer
)	O
;	O
break	O
;	O
default	O
:	O
code	int
=	O
EX_SOFTWARE	int
;	O
pop3d_outf	function
(	O
"-ERR Quitting: %s\n"	pointer
,	O
pop3d_error_string	function
(	O
reason	int
)	O
)	O
;	O
mu_diag_output	function
(	O
MU_DIAG_ERROR	O
,	O
_	O
(	O
"quitting (numeric reason %d)"	pointer
)	O
,	O
reason	int
)	O
;	O
break	O
;	O
}	O
closelog	function
(	O
)	O
;	O
exit	function
(	O
code	int
)	O
;	O
}	O
static	O
void	O
log_cipher	function
(	O
mu_stream_t	pointer
stream	pointer
)	O
{	O
mu_property_t	pointer
prop	pointer
;	O
int	O
rc	int
=	O
mu_stream_ioctl	function
(	O
stream	pointer
,	O
MU_IOCTL_TLSSTREAM	int
,	O
MU_IOCTL_TLS_GET_CIPHER_INFO	int
,	O
&	O
prop	pointer
)	O
;	O
if	O
(	O
rc	int
)	O
{	O
mu_diag_output	function
(	O
MU_DIAG_INFO	O
,	O
_	O
(	O
"TLS established"	pointer
)	O
)	O
;	O
mu_diag_output	function
(	O
MU_DIAG_ERROR	O
,	O
_	O
(	O
"can't get TLS details: %s"	pointer
)	O
,	O
mu_strerror	function
(	O
rc	int
)	O
)	O
;	O
}	O
else	O
{	O
char	O
const	O
*	O
cipher	pointer
,	O
*	O
mac	pointer
,	O
*	O
proto	pointer
;	O
if	O
(	O
mu_property_sget_value	function
(	O
prop	pointer
,	O
"cipher"	pointer
,	O
&	O
cipher	pointer
)	O
)	O
cipher	pointer
=	O
"UNKNOWN"	pointer
;	O
if	O
(	O
mu_property_sget_value	function
(	O
prop	pointer
,	O
"mac"	pointer
,	O
&	O
mac	pointer
)	O
)	O
mac	pointer
=	O
"UNKNOWN"	pointer
;	O
if	O
(	O
mu_property_sget_value	function
(	O
prop	pointer
,	O
"protocol"	pointer
,	O
&	O
proto	pointer
)	O
)	O
proto	pointer
=	O
"UNKNOWN"	pointer
;	O
mu_diag_output	function
(	O
MU_DIAG_INFO	O
,	O
_	O
(	O
"TLS established using %s-%s (%s)"	pointer
)	O
,	O
cipher	pointer
,	O
mac	pointer
,	O
proto	pointer
)	O
;	O
mu_property_destroy	function
(	O
&	O
prop	pointer
)	O
;	O
}	O
}	O
void	O
pop3d_setio	function
(	O
int	O
ifd	int
,	O
int	O
ofd	int
,	O
struct	O
mu_tls_config	struct
*	O
tls_conf	pointer
)	O
{	O
mu_stream_t	pointer
str	pointer
,	O
istream	pointer
,	O
ostream	pointer
;	O
if	O
(	O
ifd	int
==	O
-	O
1	int
)	O
pop3d_abquit	function
(	O
ERR_NO_IFILE	int
)	O
;	O
if	O
(	O
ofd	int
==	O
-	O
1	int
)	O
pop3d_abquit	function
(	O
ERR_NO_OFILE	int
)	O
;	O
if	O
(	O
mu_stdio_stream_create	function
(	O
&	O
istream	pointer
,	O
ifd	int
,	O
MU_STREAM_READ	int
)	O
)	O
pop3d_abquit	function
(	O
ERR_NO_IFILE	int
)	O
;	O
mu_stream_set_buffer	function
(	O
istream	pointer
,	O
mu_buffer_line	int
,	O
0	int
)	O
;	O
if	O
(	O
mu_stdio_stream_create	function
(	O
&	O
ostream	pointer
,	O
ofd	int
,	O
MU_STREAM_WRITE	int
)	O
)	O
pop3d_abquit	function
(	O
ERR_NO_OFILE	int
)	O
;	O
if	O
(	O
tls_conf	pointer
)	O
{	O
int	O
rc	int
=	O
mu_tls_stream_create	function
(	O
&	O
str	pointer
,	O
istream	pointer
,	O
ostream	pointer
,	O
tls_conf	pointer
,	O
MU_TLS_SERVER	int
,	O
0	int
)	O
;	O
if	O
(	O
rc	int
)	O
{	O
mu_stream_unref	function
(	O
istream	pointer
)	O
;	O
mu_stream_unref	function
(	O
ostream	pointer
)	O
;	O
mu_error	function
(	O
_	O
(	O
"failed to create TLS stream: %s"	pointer
)	O
,	O
mu_strerror	function
(	O
rc	int
)	O
)	O
;	O
pop3d_abquit	function
(	O
ERR_FILE	int
)	O
;	O
}	O
log_cipher	function
(	O
str	pointer
)	O
;	O
}	O
else	O
if	O
(	O
mu_iostream_create	function
(	O
&	O
str	pointer
,	O
istream	pointer
,	O
ostream	pointer
)	O
)	O
pop3d_abquit	function
(	O
ERR_FILE	int
)	O
;	O
if	O
(	O
mu_filter_create	function
(	O
&	O
iostream	pointer
,	O
str	pointer
,	O
"CRLF"	pointer
,	O
MU_FILTER_ENCODE	int
,	O
MU_STREAM_WRITE	int
|	O
MU_STREAM_RDTHRU	int
)	O
)	O
pop3d_abquit	function
(	O
ERR_NO_IFILE	int
)	O
;	O
mu_stream_set_buffer	function
(	O
iostream	pointer
,	O
mu_buffer_line	int
,	O
0	int
)	O
;	O
if	O
(	O
pop3d_transcript	int
)	O
{	O
int	O
rc	int
;	O
mu_stream_t	pointer
dstr	pointer
,	O
xstr	pointer
;	O
rc	int
=	O
mu_dbgstream_create	function
(	O
&	O
dstr	pointer
,	O
MU_DIAG_DEBUG	O
)	O
;	O
if	O
(	O
rc	int
)	O
mu_error	function
(	O
_	O
(	O
"cannot create debug stream; transcript disabled: %s"	pointer
)	O
,	O
mu_strerror	function
(	O
rc	int
)	O
)	O
;	O
else	O
{	O
rc	int
=	O
mu_xscript_stream_create	function
(	O
&	O
xstr	pointer
,	O
iostream	pointer
,	O
dstr	pointer
,	O
NULL	O
)	O
;	O
mu_stream_unref	function
(	O
dstr	pointer
)	O
;	O
if	O
(	O
rc	int
)	O
mu_error	function
(	O
_	O
(	O
"cannot create transcript stream: %s"	pointer
)	O
,	O
mu_strerror	function
(	O
rc	int
)	O
)	O
;	O
else	O
{	O
mu_stream_unref	function
(	O
iostream	pointer
)	O
;	O
iostream	pointer
=	O
xstr	pointer
;	O
}	O
}	O
}	O
}	O
int	O
pop3d_init_tls_server	function
(	O
struct	O
mu_tls_config	struct
*	O
tls_conf	pointer
)	O
{	O
mu_stream_t	pointer
tlsstream	pointer
,	O
stream	pointer
[	O
2	int
]	O
;	O
int	O
rc	int
;	O
rc	int
=	O
mu_stream_ioctl	function
(	O
iostream	pointer
,	O
MU_IOCTL_SUBSTREAM	int
,	O
MU_IOCTL_OP_GET	int
,	O
stream	pointer
)	O
;	O
if	O
(	O
rc	int
)	O
{	O
mu_error	function
(	O
_	O
(	O
"%s failed: %s"	pointer
)	O
,	O
"MU_IOCTL_GET_STREAM"	pointer
,	O
mu_stream_strerror	function
(	O
iostream	pointer
,	O
rc	int
)	O
)	O
;	O
return	O
1	int
;	O
}	O
rc	int
=	O
mu_tls_stream_create	function
(	O
&	O
tlsstream	pointer
,	O
stream	pointer
[	O
0	int
]	O
,	O
stream	pointer
[	O
1	int
]	O
,	O
tls_conf	pointer
,	O
MU_TLS_SERVER	int
,	O
0	int
)	O
;	O
mu_stream_unref	function
(	O
stream	pointer
[	O
0	int
]	O
)	O
;	O
mu_stream_unref	function
(	O
stream	pointer
[	O
1	int
]	O
)	O
;	O
if	O
(	O
rc	int
)	O
return	O
1	int
;	O
log_cipher	function
(	O
tlsstream	pointer
)	O
;	O
stream	pointer
[	O
0	int
]	O
=	O
stream	pointer
[	O
1	int
]	O
=	O
tlsstream	pointer
;	O
rc	int
=	O
mu_stream_ioctl	function
(	O
iostream	pointer
,	O
MU_IOCTL_SUBSTREAM	int
,	O
MU_IOCTL_OP_SET	int
,	O
stream	pointer
)	O
;	O
mu_stream_unref	function
(	O
stream	pointer
[	O
0	int
]	O
)	O
;	O
mu_stream_unref	function
(	O
stream	pointer
[	O
1	int
]	O
)	O
;	O
if	O
(	O
rc	int
)	O
{	O
mu_error	function
(	O
_	O
(	O
"%s failed: %s"	pointer
)	O
,	O
"MU_IOCTL_SET_STREAM"	pointer
,	O
mu_stream_strerror	function
(	O
iostream	pointer
,	O
rc	int
)	O
)	O
;	O
pop3d_abquit	function
(	O
ERR_IO	int
)	O
;	O
}	O
return	O
0	int
;	O
}	O
void	O
pop3d_bye	function
(	O
)	O
{	O
mu_stream_close	function
(	O
iostream	pointer
)	O
;	O
mu_stream_destroy	function
(	O
&	O
iostream	pointer
)	O
;	O
}	O
void	O
pop3d_flush_output	function
(	O
)	O
{	O
mu_stream_flush	function
(	O
iostream	pointer
)	O
;	O
}	O
int	O
pop3d_is_master	function
(	O
)	O
{	O
return	O
iostream	pointer
==	O
NULL	O
;	O
}	O
void	O
pop3d_outf	function
(	O
const	O
char	O
*	O
fmt	pointer
,	O
...	O
)	O
{	O
va_list	array
ap	array
;	O
int	O
rc	int
;	O
va_start	O
(	O
ap	array
,	O
fmt	pointer
)	O
;	O
rc	int
=	O
mu_stream_vprintf	function
(	O
iostream	pointer
,	O
fmt	pointer
,	O
ap	array
)	O
;	O
va_end	O
(	O
ap	array
)	O
;	O
if	O
(	O
rc	int
)	O
{	O
mu_diag_output	function
(	O
MU_DIAG_ERROR	O
,	O
_	O
(	O
"Write failed: %s"	pointer
)	O
,	O
mu_stream_strerror	function
(	O
iostream	pointer
,	O
rc	int
)	O
)	O
;	O
pop3d_abquit	function
(	O
ERR_IO	int
)	O
;	O
}	O
}	O
char	O
*	O
pop3d_readline	function
(	O
char	O
*	O
buffer	pointer
,	O
size_t	long
size	long
)	O
{	O
int	O
rc	int
;	O
size_t	long
nbytes	long
;	O
alarm	function
(	O
idle_timeout	int
)	O
;	O
rc	int
=	O
mu_stream_readline	function
(	O
iostream	pointer
,	O
buffer	pointer
,	O
size	long
,	O
&	O
nbytes	long
)	O
;	O
alarm	function
(	O
0	int
)	O
;	O
if	O
(	O
rc	int
)	O
{	O
mu_diag_output	function
(	O
MU_DIAG_ERROR	O
,	O
_	O
(	O
"Read failed: %s"	pointer
)	O
,	O
mu_stream_strerror	function
(	O
iostream	pointer
,	O
rc	int
)	O
)	O
;	O
pop3d_abquit	function
(	O
ERR_IO	int
)	O
;	O
}	O
else	O
if	O
(	O
nbytes	long
==	O
0	int
)	O
{	O
if	O
(	O
state	pointer
==	O
AUTHORIZATION	int
)	O
exit	function
(	O
EX_OK	int
)	O
;	O
mu_diag_output	function
(	O
MU_DIAG_ERROR	O
,	O
_	O
(	O
"Unexpected eof on input"	pointer
)	O
)	O
;	O
pop3d_abquit	function
(	O
ERR_PROTO	int
)	O
;	O
}	O
return	O
buffer	pointer
;	O
}	O
void	O
pop3d_mark_deleted	function
(	O
mu_attribute_t	pointer
attr	pointer
)	O
{	O
mu_attribute_set_userflag	function
(	O
attr	pointer
,	O
POP3_ATTRIBUTE_DELE	int
)	O
;	O
}	O
int	O
pop3d_is_deleted	function
(	O
mu_attribute_t	pointer
attr	pointer
)	O
{	O
return	O
mu_attribute_is_deleted	function
(	O
attr	pointer
)	O
||	O
mu_attribute_is_userflag	function
(	O
attr	pointer
,	O
POP3_ATTRIBUTE_DELE	int
)	O
;	O
}	O
void	O
pop3d_unset_deleted	function
(	O
mu_attribute_t	pointer
attr	pointer
)	O
{	O
if	O
(	O
mu_attribute_is_userflag	function
(	O
attr	pointer
,	O
POP3_ATTRIBUTE_DELE	int
)	O
)	O
mu_attribute_unset_userflag	function
(	O
attr	pointer
,	O
POP3_ATTRIBUTE_DELE	int
)	O
;	O
}	O
void	O
pop3d_undelete_all	function
(	O
)	O
{	O
size_t	long
i	long
;	O
size_t	long
total	array
=	O
0	int
;	O
mu_mailbox_messages_count	function
(	O
mbox	pointer
,	O
&	O
total	array
)	O
;	O
for	O
(	O
i	long
=	O
1	int
;	O
i	long
<=	O
total	array
;	O
i	long
++	O
)	O
{	O
mu_message_t	pointer
msg	pointer
=	O
NULL	O
;	O
mu_attribute_t	pointer
attr	pointer
=	O
NULL	O
;	O
mu_mailbox_get_message	function
(	O
mbox	pointer
,	O
i	long
,	O
&	O
msg	pointer
)	O
;	O
mu_message_get_attribute	function
(	O
msg	pointer
,	O
&	O
attr	pointer
)	O
;	O
mu_attribute_unset_deleted	function
(	O
attr	pointer
)	O
;	O
}	O
}	O
int	O
set_xscript_level	function
(	O
int	O
xlev	int
)	O
{	O
if	O
(	O
pop3d_transcript	int
)	O
{	O
if	O
(	O
xlev	int
!=	O
MU_XSCRIPT_NORMAL	int
)	O
{	O
if	O
(	O
mu_debug_level_p	function
(	O
MU_DEBCAT_REMOTE	int
,	O
xlev	int
==	O
MU_XSCRIPT_SECURE	int
?	O
MU_DEBUG_TRACE6	int
:	O
MU_DEBUG_TRACE7	int
)	O
)	O
return	O
MU_XSCRIPT_NORMAL	int
;	O
}	O
if	O
(	O
mu_stream_ioctl	function
(	O
iostream	pointer
,	O
MU_IOCTL_XSCRIPTSTREAM	int
,	O
MU_IOCTL_XSCRIPTSTREAM_LEVEL	int
,	O
&	O
xlev	int
)	O
==	O
0	int
)	O
return	O
xlev	int
;	O
}	O
return	O
0	int
;	O
}	O

void	O
pdImagePNG	function
(	O
im	pointer
,	O
fd	pointer
)	O
pdImagePtr	pointer
im	pointer
;	O
FILE	struct
*	O
fd	pointer
;	O
{	O
png_structp	O
png_ptr	O
;	O
png_infop	O
info_ptr	O
;	O
png_uint_32	O
width	O
,	O
height	O
;	O
int	O
bit_depth	int
;	O
struct	O
png_color_struct	O
*	O
palette	pointer
;	O
int	O
ci	int
;	O
png_bytep	O
*	O
row_pointers	O
;	O
png_ptr	O
=	O
png_create_write_struct	function
(	O
PNG_LIBPNG_VER_STRING	O
,	O
NULL	O
,	O
NULL	O
,	O
NULL	O
)	O
;	O
if	O
(	O
!	O
png_ptr	O
)	O
return	O
;	O
info_ptr	O
=	O
png_create_info_struct	function
(	O
png_ptr	O
)	O
;	O
if	O
(	O
!	O
info_ptr	O
)	O
{	O
png_destroy_write_struct	function
(	O
&	O
png_ptr	O
,	O
(	O
png_infopp	O
)	O
NULL	O
)	O
;	O
return	O
;	O
}	O
if	O
(	O
setjmp	function
(	O
png_ptr	O
->	O
jmpbuf	O
)	O
)	O
{	O
png_destroy_write_struct	function
(	O
&	O
png_ptr	O
,	O
&	O
info_ptr	O
)	O
;	O
return	O
;	O
}	O
png_data_freer	function
(	O
png_ptr	O
,	O
info_ptr	O
,	O
PNG_DESTROY_WILL_FREE_DATA	O
,	O
-	O
1	int
)	O
;	O
png_init_io	function
(	O
png_ptr	O
,	O
fd	pointer
)	O
;	O
png_set_filter	function
(	O
png_ptr	O
,	O
0	int
,	O
PNG_FILTER_NONE	O
|	O
PNG_FILTER_SUB	O
|	O
PNG_FILTER_PAETH	O
)	O
;	O
png_set_compression_level	function
(	O
png_ptr	O
,	O
Z_BEST_COMPRESSION	O
)	O
;	O
png_set_compression_mem_level	function
(	O
png_ptr	O
,	O
8	int
)	O
;	O
png_set_compression_strategy	function
(	O
png_ptr	O
,	O
Z_DEFAULT_STRATEGY	O
)	O
;	O
png_set_compression_window_bits	function
(	O
png_ptr	O
,	O
15	int
)	O
;	O
png_set_compression_method	function
(	O
png_ptr	O
,	O
8	int
)	O
;	O
png_set_compression_buffer_size	function
(	O
png_ptr	O
,	O
8192	int
)	O
;	O
width	O
=	O
(	O
png_uint_32	O
)	O
im	pointer
->	O
sx	int
;	O
height	O
=	O
(	O
png_uint_32	O
)	O
im	pointer
->	O
sy	int
;	O
bit_depth	int
=	O
8	int
;	O
png_set_IHDR	function
(	O
png_ptr	O
,	O
info_ptr	O
,	O
width	O
,	O
height	O
,	O
bit_depth	int
,	O
PNG_COLOR_TYPE_PALETTE	O
,	O
PNG_INTERLACE_NONE	O
,	O
PNG_COMPRESSION_TYPE_DEFAULT	O
,	O
PNG_FILTER_TYPE_DEFAULT	O
)	O
;	O
palette	pointer
=	O
png_malloc	function
(	O
png_ptr	O
,	O
PDNCOL	int
*	O
sizeof	O
(	O
png_color	O
)	O
)	O
;	O
for	O
(	O
ci	int
=	O
0	int
;	O
ci	int
<	O
PDNCOL	int
;	O
ci	int
++	O
)	O
{	O
palette	pointer
[	O
ci	int
]	O
.	O
red	array
=	O
(	O
png_byte	O
)	O
im	pointer
->	O
red	array
[	O
ci	int
]	O
;	O
palette	pointer
[	O
ci	int
]	O
.	O
green	array
=	O
(	O
png_byte	O
)	O
im	pointer
->	O
green	array
[	O
ci	int
]	O
;	O
palette	pointer
[	O
ci	int
]	O
.	O
blue	array
=	O
(	O
png_byte	O
)	O
im	pointer
->	O
blue	array
[	O
ci	int
]	O
;	O
}	O
png_set_PLTE	function
(	O
png_ptr	O
,	O
info_ptr	O
,	O
palette	pointer
,	O
PDNCOL	int
)	O
;	O
png_write_info	function
(	O
png_ptr	O
,	O
info_ptr	O
)	O
;	O
png_set_packing	function
(	O
png_ptr	O
)	O
;	O
row_pointers	O
=	O
im	pointer
->	O
pixels	pointer
;	O
png_write_image	function
(	O
png_ptr	O
,	O
row_pointers	O
)	O
;	O
png_write_end	function
(	O
png_ptr	O
,	O
info_ptr	O
)	O
;	O
png_destroy_write_struct	function
(	O
&	O
png_ptr	O
,	O
&	O
info_ptr	O
)	O
;	O
png_free_data	function
(	O
png_ptr	O
,	O
info_ptr	O
,	O
PNG_FREE_ALL	O
,	O
-	O
1	int
)	O
;	O
return	O
;	O
}	O

kern_return_t	O
diskfs_S_dir_notice_changes	function
(	O
struct	O
protid	O
*	O
cred	pointer
,	O
mach_port_t	O
notify	int
)	O
{	O
error_t	O
err	O
;	O
struct	O
modreq	O
*	O
req	pointer
;	O
struct	O
node	O
*	O
np	pointer
;	O
if	O
(	O
!	O
cred	pointer
)	O
return	O
EOPNOTSUPP	O
;	O
np	pointer
=	O
cred	pointer
->	O
po	O
->	O
np	pointer
;	O
pthread_mutex_lock	function
(	O
&	O
np	pointer
->	O
lock	O
)	O
;	O
if	O
(	O
!	O
S_ISDIR	function
(	O
np	pointer
->	O
dn_stat	O
.	O
st_mode	O
)	O
)	O
{	O
pthread_mutex_unlock	function
(	O
&	O
np	pointer
->	O
lock	O
)	O
;	O
return	O
ENOTDIR	O
;	O
}	O
err	O
=	O
dir_changed	function
(	O
notify	int
,	O
np	pointer
->	O
dirmod_tick	O
,	O
DIR_CHANGED_NULL	O
,	O
""	pointer
)	O
;	O
if	O
(	O
err	O
)	O
{	O
pthread_mutex_unlock	function
(	O
&	O
np	pointer
->	O
lock	O
)	O
;	O
return	O
err	O
;	O
}	O
req	pointer
=	O
malloc	O
(	O
sizeof	O
(	O
struct	O
modreq	O
)	O
)	O
;	O
if	O
(	O
!	O
req	pointer
)	O
{	O
pthread_mutex_unlock	function
(	O
&	O
np	pointer
->	O
lock	O
)	O
;	O
return	O
ENOMEM	O
;	O
}	O
req	pointer
->	O
port	O
=	O
notify	int
;	O
req	pointer
->	O
next	O
=	O
np	pointer
->	O
dirmod_reqs	O
;	O
np	pointer
->	O
dirmod_reqs	O
=	O
req	pointer
;	O
pthread_mutex_unlock	function
(	O
&	O
np	pointer
->	O
lock	O
)	O
;	O
return	O
0	int
;	O
}	O
void	O
diskfs_notice_dirchange	function
(	O
struct	O
node	O
*	O
dp	pointer
,	O
enum	O
dir_changed_type	O
type	enum
,	O
const	O
char	O
*	O
name	pointer
)	O
{	O
error_t	O
err	O
;	O
struct	O
modreq	O
*	O
*	O
preq	pointer
;	O
dp	pointer
->	O
dirmod_tick	O
++	O
;	O
preq	pointer
=	O
&	O
dp	pointer
->	O
dirmod_reqs	O
;	O
while	O
(	O
*	O
preq	pointer
)	O
{	O
struct	O
modreq	O
*	O
req	pointer
=	O
*	O
preq	pointer
;	O
err	O
=	O
dir_changed	function
(	O
req	pointer
->	O
port	O
,	O
dp	pointer
->	O
dirmod_tick	O
,	O
type	enum
,	O
(	O
char	O
*	O
)	O
name	pointer
)	O
;	O
if	O
(	O
err	O
&&	O
err	O
!=	O
MACH_SEND_TIMED_OUT	O
)	O
{	O
*	O
preq	pointer
=	O
req	pointer
->	O
next	O
;	O
mach_port_deallocate	function
(	O
mach_task_self	function
(	O
)	O
,	O
req	pointer
->	O
port	O
)	O
;	O
free	function
(	O
req	pointer
)	O
;	O
}	O
else	O
preq	pointer
=	O
&	O
req	pointer
->	O
next	O
;	O
}	O
}	O

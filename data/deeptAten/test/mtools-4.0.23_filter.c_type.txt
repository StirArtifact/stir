typedef	O
struct	O
Filter_t	O
{	O
Class_t	O
*	O
Class	pointer
;	O
int	O
refs	int
;	O
Stream_t	O
*	O
Next	pointer
;	O
Stream_t	O
*	O
Buffer	pointer
;	O
int	O
dospos	int
;	O
int	O
unixpos	int
;	O
int	O
mode	int
;	O
int	O
rw	int
;	O
int	O
lastchar	int
;	O
}	O
Filter_t	O
;	O
static	O
int	O
read_filter	function
(	O
Stream_t	O
*	O
Stream	pointer
,	O
char	O
*	O
buf	pointer
,	O
mt_off_t	O
iwhere	O
,	O
size_t	O
len	O
)	O
{	O
DeclareThis	O
(	O
Filter_t	O
)	O
;	O
int	O
i	int
,	O
j	int
,	O
ret	int
;	O
unsigned	O
char	O
newchar	O
;	O
off_t	O
where	O
=	O
truncBytes32	int
(	O
iwhere	pointer
)	O
;	O
if	O
(	O
where	int
!=	O
This	O
->	O
unixpos	int
)	O
{	O
fprintf	O
(	O
stderr	pointer
,	O
"Bad offset\n"	pointer
)	O
;	O
exit	O
(	O
1	int
)	O
;	O
}	O
if	O
(	O
This	O
->	O
rw	int
==	O
F_WRITE	int
)	O
{	O
fprintf	O
(	O
stderr	pointer
,	O
"Change of transfer direction!\n"	pointer
)	O
;	O
exit	O
(	O
1	int
)	O
;	O
}	O
This	O
->	O
rw	pointer
=	O
F_READ	int
;	O
ret	O
=	O
READS	int
(	O
This	pointer
->	O
Next	pointer
,	O
buf	int
,	O
(	int
mt_off_t	O
)	O
This	O
->	O
dospos	int
,	O
len	int
)	O
;	O
if	O
(	O
ret	int
<	O
0	int
)	O
return	O
ret	int
;	O
j	int
=	O
0	int
;	O
for	int
(	O
i	int
=	O
0	int
;	O
i	int
<	O
ret	int
;	O
i	int
++	O
)	O
{	O
if	O
(	O
buf	int
[	O
i	int
]	O
==	O
'\r'	O
)	O
continue	O
;	O
if	int
(	O
buf	int
[	O
i	int
]	O
==	O
0x1a	O
)	O
break	O
;	O
newchar	O
=	O
buf	int
[	O
i	int
]	O
;	O
This	pointer
->	O
lastchar	int
=	O
buf	int
[	O
j	int
++	O
]	O
=	O
newchar	pointer
;	O
}	pointer
This	O
->	O
dospos	pointer
+=	O
i	int
;	O
This	O
->	O
unixpos	int
+=	O
j	int
;	O
return	int
j	int
;	O
}	O
static	O
int	O
write_filter	function
(	O
Stream_t	O
*	O
Stream	pointer
,	O
char	O
*	O
buf	pointer
,	O
mt_off_t	O
iwhere	O
,	O
size_t	O
len	long
)	O
{	O
DeclareThis	O
(	O
Filter_t	O
)	O
;	O
unsigned	O
int	O
i	int
,	O
j	int
;	O
int	O
ret	int
;	O
char	O
buffer	O
[	O
1025	int
]	O
;	O
unsigned	O
char	O
newchar	O
;	O
off_t	O
where	O
=	O
truncBytes32	int
(	O
iwhere	long
)	O
;	O
if	O
(	O
This	int
->	O
unixpos	int
==	O
-	int
1	int
)	O
return	O
-	O
1	int
;	O
if	O
(	O
where	O
!=	O
This	O
->	O
unixpos	int
)	O
{	O
fprintf	O
(	O
stderr	pointer
,	O
"Bad offset\n"	pointer
)	O
;	O
exit	O
(	O
1	int
)	O
;	O
}	O
if	O
(	O
This	O
->	O
rw	int
==	O
F_READ	int
)	O
{	O
fprintf	O
(	O
stderr	pointer
,	O
"Change of transfer direction!\n"	pointer
)	O
;	O
exit	O
(	O
1	int
)	O
;	O
}	O
This	O
->	O
rw	pointer
=	O
F_WRITE	int
;	O
j	O
=	O
i	int
=	O
0	int
;	O
while	int
(	O
i	int
<	O
1024	int
&&	O
j	int
<	O
len	int
)	O
{	O
if	O
(	O
buf	int
[	O
j	int
]	O
==	O
'\n'	O
)	O
{	O
buffer	pointer
[	O
i	int
++	O
]	O
=	O
'\r'	pointer
;	O
buffer	pointer
[	O
i	int
++	O
]	O
=	O
'\n'	pointer
;	O
j	pointer
++	O
;	O
continue	O
;	O
}	O
newchar	O
=	O
buf	function
[	O
j	int
++	O
]	O
;	O
buffer	O
[	O
i	int
++	O
]	O
=	O
newchar	pointer
;	O
}	pointer
This	O
->	O
unixpos	pointer
+=	O
j	int
;	O
ret	O
=	O
force_write	int
(	O
This	int
->	O
Next	int
,	O
buffer	int
,	O
(	pointer
mt_off_t	O
)	O
This	O
->	O
dospos	int
,	O
i	int
)	O
;	O
if	O
(	O
ret	int
>	O
0	int
)	O
This	int
->	O
dospos	int
+=	O
ret	int
;	O
if	int
(	O
ret	int
!=	O
(	int
signed	int
int	O
)	int
i	O
)	O
{	O
This	O
->	O
unixpos	int
=	O
-	int
1	int
;	O
return	O
-	int
1	int
;	O
}	O
return	O
j	O
;	O
}	O
static	O
int	O
free_filter	function
(	O
Stream_t	O
*	O
Stream	pointer
)	O
{	O
DeclareThis	O
(	O
Filter_t	O
)	O
;	O
char	O
buffer	O
=	O
0x1a	O
;	O
if	O
(	O
This	O
->	O
rw	int
==	O
F_WRITE	int
)	O
return	O
force_write	int
(	O
This	int
->	O
Next	int
,	O
&	int
buffer	pointer
,	O
(	O
mt_off_t	O
)	O
This	O
->	O
dospos	int
,	O
1	int
)	O
;	O
else	O
return	O
0	int
;	O
}	O
static	O
Class_t	O
FilterClass	O
=	O
{	O
read_filter	O
,	O
write_filter	int
,	O
0	int
,	O
free_filter	int
,	O
0	int
,	O
get_data_pass_through	int
,	O
0	int
,	O
0	int
,	O
0	int
}	O
;	O
Stream_t	O
*	O
open_filter	O
(	O
Stream_t	pointer
*	O
Next	pointer
,	O
int	int
convertCharset	int
UNUSEDP	O
)	O
{	O
Filter_t	O
*	O
This	pointer
;	O
This	O
=	O
New	int
(	O
Filter_t	pointer
)	O
;	O
if	O
(	O
!	int
This	O
)	O
return	O
NULL	int
;	O
This	O
->	O
Class	int
=	O
&	int
FilterClass	pointer
;	O
This	O
->	O
dospos	int
=	O
This	int
->	O
unixpos	int
=	O
This	int
->	O
rw	int
=	O
0	int
;	O
This	int
->	O
Next	int
=	O
Next	int
;	O
This	pointer
->	O
refs	int
=	O
1	int
;	O
This	pointer
->	O
Buffer	int
=	O
0	int
;	O
return	int
(	int
Stream_t	O
*	O
)	O
This	function
;	O
}	O
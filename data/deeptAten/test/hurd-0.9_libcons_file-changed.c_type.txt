kern_return_t	O
cons_S_file_changed	function
(	O
cons_notify_t	pointer
notify	struct
,	O
natural_t	O
tickno	int
,	O
file_changed_type_t	O
change	int
,	O
off_t	O
start	int
,	O
off_t	O
end	int
)	O
{	O
error_t	int
err	int
=	O
0	int
;	O
vcons_t	pointer
vcons	pointer
=	O
(	O
vcons_t	pointer
)	O
notify	struct
;	O
if	O
(	O
!	O
notify	struct
||	O
notify	struct
->	O
cons	pointer
)	O
return	O
EOPNOTSUPP	int
;	O
pthread_mutex_lock	function
(	O
&	O
vcons	pointer
->	O
lock	union
)	O
;	O
switch	O
(	O
change	int
)	O
{	O
case	O
FILE_CHANGED_NULL	O
:	O
cons_vcons_refresh	function
(	O
vcons	pointer
)	O
;	O
break	O
;	O
case	O
FILE_CHANGED_WRITE	O
:	O
while	O
(	O
vcons	pointer
->	O
state	struct
.	O
changes	struct
.	O
written	int
<	O
vcons	pointer
->	O
display	pointer
->	O
changes	struct
.	O
written	int
)	O
{	O
cons_change_t	O
change	int
;	O
if	O
(	O
vcons	pointer
->	O
display	pointer
->	O
changes	struct
.	O
written	int
-	O
vcons	pointer
->	O
state	struct
.	O
changes	struct
.	O
written	int
>	O
vcons	pointer
->	O
cons	pointer
->	O
slack	int
)	O
{	O
cons_vcons_refresh	function
(	O
vcons	pointer
)	O
;	O
continue	O
;	O
}	O
change	int
=	O
vcons	pointer
->	O
state	struct
.	O
changes	struct
.	O
buffer	pointer
[	O
vcons	pointer
->	O
state	struct
.	O
changes	struct
.	O
written	int
%	O
vcons	pointer
->	O
state	struct
.	O
changes	struct
.	O
length	int
]	O
;	O
if	O
(	O
vcons	pointer
->	O
display	pointer
->	O
changes	struct
.	O
written	int
-	O
vcons	pointer
->	O
state	struct
.	O
changes	struct
.	O
written	int
>	O
vcons	pointer
->	O
state	struct
.	O
changes	struct
.	O
length	int
-	O
1	int
)	O
{	O
cons_vcons_refresh	function
(	O
vcons	pointer
)	O
;	O
continue	O
;	O
}	O
vcons	pointer
->	O
state	struct
.	O
changes	struct
.	O
written	int
++	O
;	O
if	O
(	O
change	int
.	O
what	O
.	O
not_matrix	O
)	O
{	O
if	O
(	O
change	int
.	O
what	O
.	O
cursor_pos	O
)	O
{	O
uint32_t	O
old_row	O
=	O
vcons	pointer
->	O
state	struct
.	O
cursor	struct
.	O
row	int
;	O
uint32_t	O
height	int
=	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
height	int
;	O
uint32_t	O
row	int
;	O
vcons	pointer
->	O
state	struct
.	O
cursor	struct
.	O
col	int
=	O
vcons	pointer
->	O
display	pointer
->	O
cursor	struct
.	O
col	int
;	O
row	int
=	O
vcons	pointer
->	O
state	struct
.	O
cursor	struct
.	O
row	int
=	O
vcons	pointer
->	O
display	pointer
->	O
cursor	struct
.	O
row	int
;	O
if	O
(	O
row	int
+	O
vcons	pointer
->	O
scrolling	int
<	O
height	int
)	O
{	O
cons_vcons_set_cursor_pos	function
(	O
vcons	pointer
,	O
vcons	pointer
->	O
state	struct
.	O
cursor	struct
.	O
col	int
,	O
row	int
+	O
vcons	pointer
->	O
scrolling	int
)	O
;	O
if	O
(	O
old_row	O
+	O
vcons	pointer
->	O
scrolling	int
>=	O
height	int
)	O
cons_vcons_set_cursor_status	function
(	O
vcons	pointer
,	O
vcons	pointer
->	O
state	struct
.	O
cursor	struct
.	O
status	int
)	O
;	O
}	O
else	O
if	O
(	O
old_row	O
+	O
vcons	pointer
->	O
scrolling	int
<	O
height	int
)	O
cons_vcons_set_cursor_status	function
(	O
vcons	pointer
,	O
CONS_CURSOR_INVISIBLE	O
)	O
;	O
_cons_vcons_console_event	function
(	O
vcons	pointer
,	O
CONS_EVT_OUTPUT	O
)	O
;	O
cons_vcons_update	function
(	O
vcons	pointer
)	O
;	O
}	O
if	O
(	O
change	int
.	O
what	O
.	O
cursor_status	O
)	O
{	O
vcons	pointer
->	O
state	struct
.	O
cursor	struct
.	O
status	int
=	O
vcons	pointer
->	O
display	pointer
->	O
cursor	struct
.	O
status	int
;	O
cons_vcons_set_cursor_status	function
(	O
vcons	pointer
,	O
vcons	pointer
->	O
state	struct
.	O
cursor	struct
.	O
status	int
)	O
;	O
cons_vcons_update	function
(	O
vcons	pointer
)	O
;	O
}	O
if	O
(	O
change	int
.	O
what	O
.	O
screen_cur_line	O
)	O
{	O
uint32_t	O
new_cur_line	O
;	O
new_cur_line	O
=	O
vcons	pointer
->	O
display	pointer
->	O
screen	struct
.	O
cur_line	int
;	O
if	O
(	O
new_cur_line	O
!=	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
cur_line	int
)	O
{	O
off_t	O
size	long
=	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
*	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
lines	int
;	O
off_t	O
vis_start	O
;	O
uint32_t	O
scrolling	int
;	O
off_t	O
start	int
;	O
off_t	O
end	int
;	O
if	O
(	O
new_cur_line	O
>	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
cur_line	int
)	O
scrolling	int
=	O
new_cur_line	O
-	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
cur_line	int
;	O
else	O
scrolling	int
=	O
UINT32_MAX	O
-	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
cur_line	int
+	O
1	int
+	O
new_cur_line	O
;	O
if	O
(	O
vcons	pointer
->	O
scrolling	int
)	O
{	O
if	O
(	O
_cons_jump_down_on_output	O
)	O
_cons_vcons_scrollback	function
(	O
vcons	pointer
,	O
CONS_SCROLL_ABSOLUTE_LINE	int
,	O
0	int
)	O
;	O
else	O
{	O
if	O
(	O
vcons	pointer
->	O
scrolling	int
+	O
scrolling	int
<=	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
scr_lines	int
)	O
{	O
vcons	pointer
->	O
scrolling	int
+=	O
scrolling	int
;	O
scrolling	int
=	O
0	int
;	O
}	O
else	O
{	O
scrolling	int
-=	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
scr_lines	int
-	O
vcons	pointer
->	O
scrolling	int
;	O
vcons	pointer
->	O
scrolling	int
=	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
scr_lines	int
;	O
}	O
}	O
}	O
if	O
(	O
scrolling	int
)	O
{	O
uint32_t	O
cur_disp_line	O
;	O
if	O
(	O
new_cur_line	O
>=	O
vcons	pointer
->	O
scrolling	int
)	O
cur_disp_line	O
=	O
new_cur_line	O
-	O
vcons	pointer
->	O
scrolling	int
;	O
else	O
cur_disp_line	O
=	O
(	O
UINT32_MAX	O
-	O
(	O
vcons	pointer
->	O
scrolling	int
-	O
new_cur_line	O
)	O
)	O
+	O
1	int
;	O
if	O
(	O
scrolling	int
>	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
height	int
)	O
scrolling	int
=	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
height	int
;	O
if	O
(	O
scrolling	int
<	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
height	int
)	O
cons_vcons_scroll	function
(	O
vcons	pointer
,	O
scrolling	int
)	O
;	O
else	O
cons_vcons_clear	function
(	O
vcons	pointer
,	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
*	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
height	int
,	O
0	int
,	O
0	int
)	O
;	O
vis_start	O
=	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
*	O
(	O
cur_disp_line	O
%	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
lines	int
)	O
;	O
start	int
=	O
(	O
(	O
(	O
cur_disp_line	O
%	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
lines	int
)	O
+	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
height	int
-	O
scrolling	int
)	O
*	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
)	O
%	O
size	long
;	O
end	int
=	O
start	int
+	O
scrolling	int
*	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
-	O
1	int
;	O
cons_vcons_write	function
(	O
vcons	pointer
,	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
matrix	pointer
+	O
start	int
,	O
end	int
<	O
size	long
?	O
end	int
-	O
start	int
+	O
1	int
:	O
size	long
-	O
start	int
,	O
0	int
,	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
height	int
-	O
scrolling	int
)	O
;	O
if	O
(	O
end	int
>=	O
size	long
)	O
cons_vcons_write	function
(	O
vcons	pointer
,	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
matrix	pointer
,	O
end	int
-	O
size	long
+	O
1	int
,	O
0	int
,	O
(	O
size	long
-	O
vis_start	O
)	O
/	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
)	O
;	O
_cons_vcons_console_event	function
(	O
vcons	pointer
,	O
CONS_EVT_OUTPUT	O
)	O
;	O
cons_vcons_update	function
(	O
vcons	pointer
)	O
;	O
}	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
cur_line	int
=	O
new_cur_line	O
;	O
}	O
}	O
if	O
(	O
change	int
.	O
what	O
.	O
screen_scr_lines	O
)	O
{	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
scr_lines	int
=	O
vcons	pointer
->	O
display	pointer
->	O
screen	struct
.	O
scr_lines	int
;	O
if	O
(	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
scr_lines	int
<	O
vcons	pointer
->	O
scrolling	int
)	O
assert	O
(	O
!	O
"Implement shrinking scrollback buffer! XXX"	pointer
)	O
;	O
}	O
if	O
(	O
change	int
.	O
what	O
.	O
bell_audible	O
)	O
{	O
while	O
(	O
vcons	pointer
->	O
state	struct
.	O
bell	struct
.	O
audible	int
<	O
vcons	pointer
->	O
display	pointer
->	O
bell	struct
.	O
audible	int
)	O
{	O
if	O
(	O
_cons_audible_bell	O
==	O
BELL_AUDIBLE	O
)	O
cons_vcons_beep	function
(	O
vcons	pointer
)	O
;	O
else	O
if	O
(	O
_cons_audible_bell	O
==	O
BELL_VISUAL	O
)	O
cons_vcons_flash	function
(	O
vcons	pointer
)	O
;	O
vcons	pointer
->	O
state	struct
.	O
bell	struct
.	O
audible	int
++	O
;	O
}	O
}	O
if	O
(	O
change	int
.	O
what	O
.	O
bell_visible	O
)	O
{	O
while	O
(	O
vcons	pointer
->	O
state	struct
.	O
bell	struct
.	O
visible	int
<	O
vcons	pointer
->	O
display	pointer
->	O
bell	struct
.	O
visible	int
)	O
{	O
if	O
(	O
_cons_visual_bell	O
==	O
BELL_VISUAL	O
)	O
cons_vcons_flash	function
(	O
vcons	pointer
)	O
;	O
else	O
if	O
(	O
_cons_visual_bell	O
==	O
BELL_AUDIBLE	O
)	O
cons_vcons_beep	function
(	O
vcons	pointer
)	O
;	O
vcons	pointer
->	O
state	struct
.	O
bell	struct
.	O
visible	int
++	O
;	O
}	O
}	O
if	O
(	O
change	int
.	O
what	O
.	O
flags	int
)	O
{	O
uint32_t	O
flags	int
=	O
vcons	pointer
->	O
display	pointer
->	O
flags	int
;	O
if	O
(	O
(	O
flags	int
&	O
CONS_FLAGS_SCROLL_LOCK	O
)	O
!=	O
(	O
vcons	pointer
->	O
state	struct
.	O
flags	int
&	O
CONS_FLAGS_SCROLL_LOCK	O
)	O
)	O
cons_vcons_set_scroll_lock	function
(	O
vcons	pointer
,	O
flags	int
&	O
CONS_FLAGS_SCROLL_LOCK	O
)	O
;	O
vcons	pointer
->	O
state	struct
.	O
flags	int
=	O
flags	int
;	O
}	O
}	O
else	O
{	O
off_t	O
size	long
=	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
*	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
lines	int
;	O
off_t	O
rotate	O
;	O
off_t	O
vis_end	O
=	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
height	int
*	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
-	O
1	int
;	O
off_t	O
end2	O
=	O
-	O
1	int
;	O
off_t	O
start_rel	O
=	O
0	int
;	O
off_t	O
start	int
=	O
change	int
.	O
matrix	pointer
.	O
start	int
;	O
off_t	O
end	int
=	O
change	int
.	O
matrix	pointer
.	O
end	int
;	O
if	O
(	O
vcons	pointer
->	O
scrolling	int
&&	O
_cons_jump_down_on_output	O
)	O
_cons_vcons_scrollback	function
(	O
vcons	pointer
,	O
CONS_SCROLL_ABSOLUTE_LINE	int
,	O
0	int
)	O
;	O
if	O
(	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
cur_line	int
>=	O
vcons	pointer
->	O
scrolling	int
)	O
rotate	O
=	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
cur_line	int
-	O
vcons	pointer
->	O
scrolling	int
;	O
else	O
rotate	O
=	O
(	O
UINT32_MAX	O
-	O
(	O
vcons	pointer
->	O
scrolling	int
-	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
cur_line	int
)	O
)	O
+	O
1	int
;	O
rotate	O
=	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
*	O
(	O
rotate	O
%	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
lines	int
)	O
;	O
start	int
-=	O
rotate	O
;	O
if	O
(	O
start	int
<	O
0	int
)	O
start	int
+=	O
size	long
;	O
end	int
-=	O
rotate	O
;	O
if	O
(	O
end	int
<	O
0	int
)	O
end	int
+=	O
size	long
;	O
if	O
(	O
start	int
>	O
vis_end	O
)	O
{	O
if	O
(	O
end	int
<	O
start	int
)	O
{	O
start	int
=	O
0	int
;	O
if	O
(	O
vis_end	O
<	O
end	int
)	O
end	int
=	O
vis_end	O
;	O
}	O
else	O
start	int
=	O
-	O
1	int
;	O
}	O
else	O
{	O
if	O
(	O
end	int
>=	O
start	int
)	O
{	O
if	O
(	O
end	int
>	O
vis_end	O
)	O
end	int
=	O
vis_end	O
;	O
}	O
else	O
{	O
end2	O
=	O
end	int
;	O
end	int
=	O
vis_end	O
;	O
}	O
}	O
if	O
(	O
start	int
!=	O
-	O
1	int
)	O
{	O
start_rel	O
=	O
start	int
;	O
start	int
+=	O
rotate	O
;	O
if	O
(	O
start	int
>=	O
size	long
)	O
start	int
-=	O
size	long
;	O
end	int
+=	O
rotate	O
;	O
if	O
(	O
end	int
>=	O
size	long
)	O
end	int
-=	O
size	long
;	O
if	O
(	O
start	int
>	O
end	int
)	O
end	int
+=	O
size	long
;	O
}	O
if	O
(	O
end2	O
!=	O
-	O
1	int
)	O
end2	O
+=	O
rotate	O
;	O
if	O
(	O
start	int
!=	O
-	O
1	int
)	O
{	O
cons_vcons_clear	function
(	O
vcons	pointer
,	O
end	int
-	O
start	int
+	O
1	int
,	O
start_rel	O
%	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
,	O
start_rel	O
/	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
)	O
;	O
cons_vcons_write	function
(	O
vcons	pointer
,	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
matrix	pointer
+	O
start	int
,	O
end	int
<	O
size	long
?	O
end	int
-	O
start	int
+	O
1	int
:	O
size	long
-	O
start	int
,	O
start_rel	O
%	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
,	O
start_rel	O
/	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
)	O
;	O
if	O
(	O
end	int
>=	O
size	long
)	O
cons_vcons_write	function
(	O
vcons	pointer
,	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
matrix	pointer
,	O
end	int
-	O
size	long
+	O
1	int
,	O
(	O
size	long
-	O
rotate	O
)	O
%	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
,	O
(	O
size	long
-	O
rotate	O
)	O
/	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
)	O
;	O
if	O
(	O
end2	O
!=	O
-	O
1	int
)	O
{	O
cons_vcons_clear	function
(	O
vcons	pointer
,	O
end2	O
-	O
rotate	O
+	O
1	int
,	O
0	int
,	O
0	int
)	O
;	O
cons_vcons_write	function
(	O
vcons	pointer
,	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
matrix	pointer
+	O
rotate	O
,	O
end2	O
<	O
size	long
?	O
end2	O
-	O
rotate	O
+	O
1	int
:	O
size	long
-	O
rotate	O
,	O
0	int
,	O
0	int
)	O
;	O
if	O
(	O
end2	O
>=	O
size	long
)	O
cons_vcons_write	function
(	O
vcons	pointer
,	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
matrix	pointer
,	O
end2	O
-	O
size	long
+	O
1	int
,	O
(	O
size	long
-	O
rotate	O
)	O
%	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
,	O
(	O
size	long
-	O
rotate	O
)	O
/	O
vcons	pointer
->	O
state	struct
.	O
screen	struct
.	O
width	int
)	O
;	O
}	O
_cons_vcons_console_event	function
(	O
vcons	pointer
,	O
CONS_EVT_OUTPUT	O
)	O
;	O
cons_vcons_update	function
(	O
vcons	pointer
)	O
;	O
}	O
}	O
}	O
break	O
;	O
case	O
FILE_CHANGED_EXTEND	O
:	O
case	O
FILE_CHANGED_TRUNCATE	O
:	O
case	O
FILE_CHANGED_META	O
:	O
default	O
:	O
err	int
=	O
EINVAL	int
;	O
}	O
;	O
pthread_mutex_unlock	function
(	O
&	O
vcons	pointer
->	O
lock	union
)	O
;	O
return	O
err	int
;	O
}	O

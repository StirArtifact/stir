void	O
recfmt_parse_args	function
(	O
int	O
argc	int
,	O
char	O
*	O
*	pointer
argv	pointer
)	O
;	O
bool	O
recfmt_process_data	int
(	O
rec_db_t	O
db	pointer
)	O
;	O
void	O
recfmt_process_db	function
(	O
rec_db_t	O
db	pointer
,	O
char	O
*	O
template	pointer
)	O
;	O
char	O
*	O
recfmt_apply_template	pointer
(	O
rec_record_t	O
record	O
,	O
char	O
*	O
template	pointer
)	O
;	O
char	O
*	O
recfmt_get_subst	pointer
(	O
rec_record_t	O
record	O
,	O
char	O
*	O
str	pointer
)	O
;	O
char	O
*	O
recfmt_template	pointer
=	O
NULL	O
;	O
enum	O
{	O
COMMON_ARGS	O
,	O
FILE_ARG	O
}	O
;	O
static	O
const	O
struct	O
option	struct
GNU_longOptions	O
[	O
]	O
=	O
{	O
COMMON_LONG_ARGS	O
,	O
{	O
"file"	O
,	O
required_argument	pointer
,	O
NULL	O
,	O
FILE_ARG	O
}	O
,	O
{	O
NULL	O
,	O
0	O
,	O
NULL	int
,	O
0	O
}	O
}	O
;	O
void	O
recutl_print_help	function
(	O
void	O
)	O
{	O
printf	O
(	O
_	pointer
(	O
"Usage: recfmt [OPTION]... [TEMPLATE]\n"	pointer
)	O
)	O
;	O
fputs	O
(	O
_	pointer
(	O
"Apply a template to records read from standard input.\n"	pointer
)	O
,	O
stdout	pointer
)	O
;	O
puts	O
(	O
""	pointer
)	O
;	O
fputs	O
(	O
_	pointer
(	O
"  -f, --file=FILENAME                 read the template to apply from a file.\n"	pointer
)	O
,	O
stdout	pointer
)	O
;	O
recutl_print_help_common	O
(	O
)	O
;	O
puts	O
(	O
""	pointer
)	O
;	O
recutl_print_help_footer	O
(	O
)	O
;	O
}	O
void	O
recfmt_parse_args	function
(	O
int	O
argc	O
,	O
char	O
*	O
*	pointer
argv	pointer
)	O
{	O
char	O
c	O
;	O
int	O
ret	int
;	O
while	O
(	O
(	O
ret	O
=	O
getopt_long	int
(	O
argc	pointer
,	O
argv	pointer
,	O
"f:"	pointer
,	O
GNU_longOptions	int
,	O
NULL	O
)	O
)	O
!=	O
-	int
1	int
)	O
{	O
c	O
=	O
ret	function
;	O
switch	O
(	O
c	O
)	O
{	O
COMMON_ARGS_CASES	O
case	O
FILE_ARG	O
:	O
case	O
'f'	O
:	O
{	O
recfmt_template	O
=	O
recutl_read_file	O
(	O
optarg	pointer
)	O
;	O
if	O
(	O
!	O
recfmt_template	O
)	O
{	O
recutl_fatal	function
(	O
_	O
(	O
"can't open file %s for reading.\n"	pointer
)	O
,	O
optarg	pointer
)	O
;	O
}	O
break	O
;	O
}	O
default	O
:	O
{	O
exit	O
(	O
EXIT_FAILURE	int
)	O
;	O
}	O
}	O
}	O
if	O
(	O
optind	O
<	O
argc	int
)	O
{	O
if	O
(	O
recfmt_template	int
)	O
{	O
recutl_fatal	O
(	O
_	O
(	O
"don't specify a template in the command line and -f at the same time.\n"	pointer
)	O
)	O
;	O
}	O
if	O
(	O
(	pointer
argc	O
-	O
optind	int
)	O
!=	O
1	O
)	O
{	O
recutl_print_help	O
(	O
)	O
;	O
exit	O
(	O
EXIT_FAILURE	int
)	O
;	O
}	O
recfmt_template	O
=	O
xstrdup	function
(	O
argv	pointer
[	O
optind	int
++	O
]	O
)	O
;	O
}	O
}	O
char	O
*	O
recfmt_get_subst	function
(	O
rec_record_t	O
record	O
,	O
char	O
*	O
str	pointer
)	O
{	O
char	O
*	O
res	pointer
;	O
rec_sex_t	O
sex	O
;	O
sex	O
=	O
rec_sex_new	function
(	O
false	O
)	O
;	O
if	O
(	O
!	pointer
rec_sex_compile	pointer
(	O
sex	pointer
,	O
str	pointer
)	O
)	O
{	O
recutl_fatal	O
(	O
_	O
(	O
"invalid expression in a template slot.\n"	pointer
)	O
)	O
;	O
}	O
res	O
=	O
rec_sex_eval_str	function
(	O
sex	pointer
,	O
record	pointer
)	O
;	O
if	O
(	O
!	pointer
res	pointer
)	O
{	O
recutl_fatal	function
(	O
_	O
(	O
"error evaluating expression in a template slot.\n"	pointer
)	O
)	O
;	O
}	O
rec_sex_destroy	O
(	O
sex	O
)	O
;	O
return	O
res	int
;	O
}	O
char	O
*	O
recfmt_apply_template	function
(	O
rec_record_t	O
record	O
,	O
char	O
*	O
template	pointer
)	O
{	O
rec_buf_t	O
result_buf	pointer
;	O
char	O
*	O
result	pointer
;	O
char	O
*	O
tmp	pointer
;	O
size_t	O
tmp_size	long
;	O
size_t	O
result_size	long
;	O
char	O
*	O
p	pointer
;	O
regex_t	O
regexp	O
;	O
regmatch_t	O
matches	O
;	O
char	O
*	O
subst_str	pointer
;	O
if	O
(	O
regcomp	O
(	O
&	pointer
regexp	pointer
,	O
"\\{\\{"	O
"[^}]*"	O
"\\}\\}"	O
,	O
REG_EXTENDED	pointer
)	O
!=	O
0	O
)	O
{	O
recutl_fatal	O
(	O
_	O
(	O
"recfmt_apply_template: error compiling regexp. Please report this.\n"	pointer
)	O
)	O
;	O
}	O
result_buf	O
=	O
rec_buf_new	function
(	O
&	pointer
result	pointer
,	O
&	O
result_size	pointer
)	O
;	O
p	O
=	O
template	function
;	O
while	O
(	O
*	O
p	pointer
&&	O
(	O
regexec	O
(	O
&	pointer
regexp	pointer
,	O
p	O
,	O
1	O
,	O
&	O
matches	pointer
,	O
0	O
)	O
==	O
0	int
)	O
&&	O
(	O
matches	O
.	O
rm_so	pointer
!=	O
-	O
1	int
)	O
)	O
{	O
if	O
(	O
matches	pointer
.	O
rm_so	pointer
>	O
0	int
)	O
{	O
tmp	O
=	O
xmalloc	int
(	O
matches	O
.	O
rm_so	pointer
+	O
1	int
)	O
;	O
memcpy	O
(	O
tmp	pointer
,	O
p	pointer
,	O
matches	pointer
.	O
rm_so	pointer
)	O
;	O
tmp	O
[	O
matches	int
.	O
rm_so	int
]	O
=	O
'\0'	pointer
;	O
rec_buf_puts	pointer
(	O
tmp	pointer
,	O
result_buf	int
)	O
;	O
free	O
(	O
tmp	pointer
)	O
;	O
}	O
tmp_size	O
=	O
matches	function
.	O
rm_eo	pointer
-	O
matches	int
.	O
rm_so	pointer
-	O
4	int
;	O
tmp	O
=	O
xmalloc	int
(	O
tmp_size	O
+	O
1	int
)	O
;	O
memcpy	O
(	O
tmp	pointer
,	O
p	pointer
+	O
matches	int
.	O
rm_so	pointer
+	O
2	int
,	O
tmp_size	pointer
)	O
;	O
tmp	O
[	O
tmp_size	int
]	O
=	O
'\0'	O
;	O
p	pointer
=	O
p	O
+	O
matches	int
.	O
rm_eo	pointer
;	O
subst_str	O
=	O
recfmt_get_subst	pointer
(	O
record	pointer
,	O
tmp	pointer
)	O
;	O
if	O
(	O
subst_str	pointer
)	O
{	O
rec_buf_puts	O
(	O
subst_str	pointer
,	O
result_buf	pointer
)	O
;	O
free	O
(	O
subst_str	pointer
)	O
;	O
}	O
free	O
(	O
tmp	pointer
)	O
;	O
}	O
if	O
(	O
*	pointer
p	pointer
)	O
{	O
rec_buf_puts	O
(	O
p	pointer
,	O
result_buf	pointer
)	O
;	O
}	O
rec_buf_close	O
(	O
result_buf	pointer
)	O
;	O
return	O
result	int
;	O
}	O
void	O
recfmt_process_db	function
(	O
rec_db_t	O
db	pointer
,	O
char	O
*	O
template	pointer
)	O
{	O
size_t	O
n_rset	long
;	O
rec_rset_t	O
rset	O
;	O
rec_record_t	O
record	pointer
;	O
char	O
*	O
result	pointer
;	O
rec_mset_iterator_t	O
iter	O
;	O
for	O
(	O
n_rset	long
=	O
0	pointer
;	O
n_rset	pointer
<	O
rec_db_size	O
(	O
db	pointer
)	O
;	O
n_rset	O
++	O
)	O
{	O
rset	O
=	O
rec_db_get_rset	function
(	O
db	pointer
,	O
n_rset	pointer
)	O
;	O
iter	O
=	O
rec_mset_iterator	O
(	O
rec_rset_mset	pointer
(	O
rset	pointer
)	O
)	O
;	O
while	O
(	O
rec_mset_iterator_next	O
(	O
&	pointer
iter	pointer
,	O
MSET_RECORD	O
,	O
(	O
const	O
void	O
*	O
*	O
)	O
&	O
record	pointer
,	O
NULL	O
)	O
)	O
{	O
result	O
=	O
recfmt_apply_template	function
(	O
record	pointer
,	O
template	pointer
)	O
;	O
if	O
(	O
result	pointer
&&	O
(	O
*	O
result	pointer
!=	O
'\0'	O
)	O
)	O
{	O
printf	O
(	O
"%s"	pointer
,	O
result	pointer
)	O
;	O
free	O
(	O
result	pointer
)	O
;	O
}	O
}	O
rec_mset_iterator_free	O
(	O
&	O
iter	pointer
)	O
;	O
}	O
}	O
int	O
main	function
(	O
int	O
argc	int
,	O
char	O
*	O
argv	pointer
[	O
]	int
)	O
{	O
rec_db_t	O
db	pointer
;	O
recutl_init	O
(	O
"recfmt"	pointer
)	O
;	O
recfmt_parse_args	O
(	O
argc	pointer
,	O
argv	pointer
)	O
;	O
db	O
=	O
recutl_read_db_from_file	function
(	O
NULL	pointer
)	O
;	O
if	O
(	O
db	pointer
&&	O
recfmt_template	pointer
)	O
{	O
recfmt_process_db	O
(	O
db	pointer
,	O
recfmt_template	pointer
)	O
;	O
}	O
return	O
EXIT_SUCCESS	O
;	O
}	O
static	O
object	O
rando	O
(	O
object	O
x	O
,	O
object	O
rs	O
)	O
{	O
enum	O
type	O
tx	O
;	O
object	O
base	int
,	O
out	O
,	O
z	O
;	O
fixnum	O
fbase	O
;	O
double	O
d	array
;	O
tx	O
=	O
type_of	int
(	O
x	int
)	O
;	O
if	O
(	O
number_compare	int
(	O
x	pointer
,	O
small_fixnum	pointer
(	O
0	pointer
)	O
)	O
!=	O
1	O
)	O
FEwrong_type_argument	O
(	O
TSpositive_number	O
,	O
x	int
)	O
;	O
if	O
(	O
tx	int
==	O
t_bignum	O
)	O
{	O
out	O
=	O
new_bignum	O
(	O
)	pointer
;	O
base	O
=	O
x	O
;	O
fbase	O
=	O
-	O
1	int
;	O
}	O
else	O
{	O
out	O
=	O
big_fixnum1	O
;	O
fbase	O
=	O
tx	O
==	O
t_fixnum	O
?	O
fix	int
(	O
x	int
)	O
:	O
MOST_POSITIVE_FIX	O
;	O
mpz_set_si	O
(	O
MP	O
(	O
big_fixnum2	int
)	O
,	O
fbase	O
)	O
;	O
base	O
=	O
big_fixnum2	O
;	O
}	O
mpz_urandomm	O
(	O
MP	O
(	O
out	int
)	O
,	O
&	O
rs	pointer
->	O
rnd	struct
.	O
rnd_state	int
,	O
MP	O
(	O
base	int
)	O
)	O
;	O
switch	O
(	O
tx	int
)	O
{	O
case	O
t_fixnum	O
:	O
return	O
make_fixnum	O
(	O
mpz_get_si	O
(	O
MP	pointer
(	O
out	int
)	O
)	O
)	O
;	O
case	O
t_bignum	O
:	O
return	O
normalize_big	O
(	O
out	O
)	O
;	O
case	O
t_shortfloat	O
:	O
case	O
t_longfloat	O
:	O
d	O
=	O
mpz_get_d	O
(	O
MP	O
(	O
out	int
)	O
)	O
;	O
d	O
/=	O
(	O
double	O
)	O
fbase	O
;	O
z	O
=	O
alloc_object	int
(	O
tx	pointer
)	O
;	O
if	O
(	O
tx	int
==	O
t_shortfloat	O
)	O
sf	O
(	O
z	pointer
)	O
=	O
sf	int
(	O
x	pointer
)	O
*	O
d	pointer
;	O
else	O
lf	O
(	O
z	int
)	O
=	O
lf	int
(	O
x	int
)	O
*	O
d	O
;	O
return	O
z	int
;	O
default	O
:	O
FEerror	O
(	O
"~S is not an integer nor a floating-point number."	pointer
,	O
1	int
,	O
x	int
)	O
;	O
return	O
(	int
Cnil	O
)	O
;	O
}	O
}	O
void	O
reinit_gmp	function
(	O
)	O
{	O
}	O
void	O
init_gmp_rnd_state	function
(	O
__gmp_randstate_struct	O
*	O
x	pointer
)	O
{	O
static	O
int	O
n	function
;	O
bzero	O
(	O
x	O
,	O
sizeof	O
(	O
*	O
x	pointer
)	O
)	O
;	O
gmp_randinit_default	O
(	O
x	O
)	O
;	O
}	O
static	O
object	O
make_random_state	function
(	O
object	O
rs	O
)	O
{	O
object	O
z	int
;	O
if	O
(	O
rs	O
==	O
Cnil	O
)	O
rs	O
=	O
symbol_value	O
(	O
Vrandom_state	pointer
)	O
;	O
if	O
(	O
rs	int
!=	O
Ct	O
&&	O
type_of	int
(	O
rs	int
)	O
!=	O
t_random	O
)	O
{	O
FEwrong_type_argument	O
(	O
sLrandom_state	O
,	O
rs	int
)	O
;	O
return	O
(	int
Cnil	O
)	O
;	O
}	O
z	O
=	O
alloc_object	function
(	O
t_random	pointer
)	O
;	O
init_gmp_rnd_state	O
(	O
&	O
z	struct
->	O
rnd	pointer
.	O
rnd_state	int
)	O
;	O
if	O
(	O
rs	int
==	O
Ct	O
)	O
gmp_randseed_ui	O
(	O
&	pointer
z	pointer
->	O
rnd	pointer
.	O
rnd_state	int
,	O
RS_DEF_INIT	pointer
)	O
;	O
else	O
memcpy	O
(	O
z	pointer
->	O
rnd	pointer
.	O
rnd_state	pointer
.	O
_mp_seed	pointer
->	O
_mp_d	pointer
,	O
rs	pointer
->	O
rnd	pointer
.	O
rnd_state	int
.	O
_mp_seed	pointer
->	O
_mp_d	pointer
,	O
rs	pointer
->	O
rnd	pointer
.	O
rnd_state	int
.	O
_mp_seed	pointer
->	O
_mp_alloc	pointer
*	O
sizeof	O
(	O
*	O
z	pointer
->	O
rnd	pointer
.	O
rnd_state	int
.	O
_mp_seed	pointer
->	O
_mp_d	pointer
)	O
)	O
;	O
return	O
(	int
z	O
)	O
;	O
}	O
LFD	O
(	O
Lrandom	int
)	O
(	O
void	O
)	O
{	function
int	function
j	int
;	O
object	O
x	int
;	O
j	O
=	O
vs_top	O
-	O
vs_base	int
;	O
if	O
(	O
j	O
==	O
1	int
)	O
vs_push	O
(	O
symbol_value	O
(	O
Vrandom_state	pointer
)	O
)	O
;	O
check_arg	O
(	O
2	int
)	O
;	O
check_type_random_state	O
(	O
&	O
vs_base	struct
[	O
1	int
]	O
)	O
;	O
x	O
=	O
rando	O
(	O
vs_base	O
[	O
0	int
]	O
,	O
vs_base	O
[	O
1	int
]	O
)	O
;	O
vs_top	O
=	O
vs_base	function
;	O
vs_push	O
(	O
x	O
)	O
;	O
}	O
LFD	O
(	O
Lmake_random_state	int
)	O
(	O
void	O
)	O
{	O
int	function
j	int
;	O
object	O
x	int
;	O
j	O
=	O
vs_top	O
-	O
vs_base	int
;	O
if	O
(	O
j	O
==	O
0	int
)	O
vs_push	O
(	O
Cnil	O
)	O
;	O
check_arg	O
(	O
1	int
)	O
;	O
x	O
=	O
make_random_state	O
(	O
vs_head	O
)	O
;	O
vs_top	O
=	O
vs_base	function
;	O
vs_push	O
(	O
x	O
)	O
;	O
}	O
LFD	O
(	O
Lrandom_state_p	int
)	O
(	O
void	O
)	O
{	O
check_arg	function
(	O
1	int
)	O
;	O
if	O
(	O
type_of	int
(	O
vs_pop	int
)	O
==	O
t_random	int
)	O
vs_push	O
(	O
Ct	O
)	O
;	O
else	O
vs_push	O
(	O
Cnil	O
)	O
;	O
}	O
void	O
gcl_init_num_rand	function
(	O
void	O
)	O
{	O
Vrandom_state	O
=	O
make_special	int
(	O
"*RANDOM-STATE*"	O
,	O
make_random_state	int
(	O
Ct	pointer
)	O
)	O
;	O
make_function	O
(	O
"RANDOM"	pointer
,	O
Lrandom	pointer
)	O
;	O
make_function	O
(	O
"MAKE-RANDOM-STATE"	pointer
,	O
Lmake_random_state	pointer
)	O
;	O
make_function	O
(	O
"RANDOM-STATE-P"	pointer
,	O
Lrandom_state_p	pointer
)	O
;	O
}	O
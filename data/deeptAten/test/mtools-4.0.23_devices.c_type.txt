static	O
int	O
compare_geom	function
(	O
struct	O
device	struct
*	O
dev	pointer
,	O
struct	O
device	struct
*	O
orig_dev	pointer
)	O
{	O
if	O
(	O
IS_MFORMAT_ONLY	O
(	O
orig_dev	pointer
)	O
)	O
return	O
0	int
;	O
if	O
(	O
!	O
orig_dev	pointer
||	O
!	O
orig_dev	pointer
->	O
tracks	int
||	O
!	O
dev	pointer
||	O
!	O
dev	pointer
->	O
tracks	int
)	O
return	O
0	int
;	O
return	O
(	O
orig_dev	pointer
->	O
tracks	int
!=	O
dev	pointer
->	O
tracks	int
||	O
orig_dev	pointer
->	O
heads	short
!=	O
dev	pointer
->	O
heads	short
||	O
orig_dev	pointer
->	O
sectors	short
!=	O
dev	pointer
->	O
sectors	short
)	O
;	O
}	O
static	O
const	O
char	O
*	O
error_msg	array
[	O
22	int
]	O
=	O
{	O
"Missing Data Address Mark"	pointer
,	O
"Bad cylinder"	pointer
,	O
"Scan not satisfied"	pointer
,	O
"Scan equal hit"	pointer
,	O
"Wrong cylinder"	pointer
,	O
"CRC error in data field"	pointer
,	O
"Control Mark = deleted"	pointer
,	O
0	int
,	O
"Missing Address Mark"	pointer
,	O
"Write Protect"	pointer
,	O
"No Data - unreadable"	pointer
,	O
0	int
,	O
"OverRun"	pointer
,	O
"CRC error in data or address"	pointer
,	O
0	int
,	O
"End Of Cylinder"	pointer
,	O
0	int
,	O
0	int
,	O
0	int
,	O
"Not ready"	pointer
,	O
"Equipment check error"	pointer
,	O
"Seek end"	pointer
}	O
;	O
static	O
__inline__	O
void	O
print_message	function
(	O
RawRequest_t	struct
*	O
raw_cmd	pointer
,	O
const	O
char	O
*	O
message	pointer
)	O
{	O
int	O
i	int
,	O
code	int
;	O
if	O
(	O
!	O
message	pointer
)	O
return	O
;	O
fprintf	function
(	O
stderr	pointer
,	O
"   "	pointer
)	O
;	O
for	O
(	O
i	int
=	O
0	int
;	O
i	int
<	O
raw_cmd	pointer
->	O
cmd_count	char
;	O
i	int
++	O
)	O
fprintf	function
(	O
stderr	pointer
,	O
"%2.2x "	pointer
,	O
(	O
int	O
)	O
raw_cmd	pointer
->	O
cmd	array
[	O
i	int
]	O
)	O
;	O
fprintf	function
(	O
stderr	pointer
,	O
"\n"	pointer
)	O
;	O
for	O
(	O
i	int
=	O
0	int
;	O
i	int
<	O
raw_cmd	pointer
->	O
reply_count	char
;	O
i	int
++	O
)	O
fprintf	function
(	O
stderr	pointer
,	O
"%2.2x "	pointer
,	O
(	O
int	O
)	O
raw_cmd	pointer
->	O
reply	array
[	O
i	int
]	O
)	O
;	O
fprintf	function
(	O
stderr	pointer
,	O
"\n"	pointer
)	O
;	O
code	int
=	O
(	O
raw_cmd	pointer
->	O
reply	array
[	O
0	int
]	O
<<	O
16	int
)	O
+	O
(	O
raw_cmd	pointer
->	O
reply	array
[	O
1	int
]	O
<<	O
8	int
)	O
+	O
raw_cmd	pointer
->	O
reply	array
[	O
2	int
]	O
;	O
for	O
(	O
i	int
=	O
0	int
;	O
i	int
<	O
22	int
;	O
i	int
++	O
)	O
{	O
if	O
(	O
(	O
code	int
&	O
(	O
1	int
<<	O
i	int
)	O
)	O
&&	O
error_msg	array
[	O
i	int
]	O
)	O
fprintf	function
(	O
stderr	pointer
,	O
"%s\n"	pointer
,	O
error_msg	array
[	O
i	int
]	O
)	O
;	O
}	O
}	O
int	O
send_one_cmd	function
(	O
int	O
fd	int
,	O
RawRequest_t	struct
*	O
raw_cmd	pointer
,	O
const	O
char	O
*	O
message	pointer
)	O
{	O
if	O
(	O
ioctl	function
(	O
fd	int
,	O
FDRAWCMD	O
,	O
raw_cmd	pointer
)	O
>=	O
0	int
)	O
{	O
if	O
(	O
raw_cmd	pointer
->	O
reply_count	char
<	O
7	int
)	O
{	O
fprintf	function
(	O
stderr	pointer
,	O
"Short reply from FDC\n"	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
return	O
0	int
;	O
}	O
switch	O
(	O
errno	O
)	O
{	O
case	O
EBUSY	int
:	O
fprintf	function
(	O
stderr	pointer
,	O
"FDC busy, sleeping for a second\n"	pointer
)	O
;	O
sleep	function
(	O
1	int
)	O
;	O
return	O
1	int
;	O
case	O
EIO	int
:	O
fprintf	function
(	O
stderr	pointer
,	O
"resetting controller\n"	pointer
)	O
;	O
if	O
(	O
ioctl	function
(	O
fd	int
,	O
FDRESET	O
,	O
2	int
)	O
<	O
0	int
)	O
{	O
perror	function
(	O
"reset"	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
return	O
1	int
;	O
default	O
:	O
perror	function
(	O
message	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
}	O
int	O
analyze_one_reply	function
(	O
RawRequest_t	struct
*	O
raw_cmd	pointer
,	O
int	O
*	O
bytes	array
,	O
int	O
do_print	int
)	O
{	O
if	O
(	O
raw_cmd	pointer
->	O
reply_count	char
==	O
7	int
)	O
{	O
int	O
end	int
;	O
if	O
(	O
raw_cmd	pointer
->	O
reply	array
[	O
3	int
]	O
!=	O
raw_cmd	pointer
->	O
cmd	array
[	O
2	int
]	O
)	O
{	O
end	int
=	O
raw_cmd	pointer
->	O
cmd	array
[	O
6	int
]	O
+	O
1	int
;	O
}	O
else	O
{	O
end	int
=	O
raw_cmd	pointer
->	O
reply	array
[	O
5	int
]	O
;	O
}	O
*	O
bytes	array
=	O
end	int
-	O
raw_cmd	pointer
->	O
cmd	array
[	O
4	int
]	O
;	O
*	O
bytes	array
=	O
*	O
bytes	array
<<	O
(	O
7	int
+	O
raw_cmd	pointer
->	O
cmd	array
[	O
5	int
]	O
)	O
;	O
}	O
else	O
*	O
bytes	array
=	O
0	int
;	O
switch	O
(	O
raw_cmd	pointer
->	O
reply	array
[	O
0	int
]	O
&	O
0xc0	int
)	O
{	O
case	O
0x40	int
:	O
if	O
(	O
(	O
raw_cmd	pointer
->	O
reply	array
[	O
0	int
]	O
&	O
0x38	int
)	O
==	O
0	int
&&	O
(	O
raw_cmd	pointer
->	O
reply	array
[	O
1	int
]	O
)	O
==	O
0x80	int
&&	O
(	O
raw_cmd	pointer
->	O
reply	array
[	O
2	int
]	O
)	O
==	O
0	int
)	O
{	O
*	O
bytes	array
+=	O
1	int
<<	O
(	O
7	int
+	O
raw_cmd	pointer
->	O
cmd	array
[	O
5	int
]	O
)	O
;	O
break	O
;	O
}	O
if	O
(	O
raw_cmd	pointer
->	O
reply	array
[	O
1	int
]	O
&	O
ST1_WP	int
)	O
{	O
*	O
bytes	array
=	O
0	int
;	O
fprintf	function
(	O
stderr	pointer
,	O
"This disk is write protected\n"	pointer
)	O
;	O
return	O
-	O
1	int
;	O
}	O
if	O
(	O
!	O
*	O
bytes	array
&&	O
do_print	int
)	O
print_message	function
(	O
raw_cmd	pointer
,	O
""	pointer
)	O
;	O
return	O
-	O
1	int
;	O
case	O
0x80	int
:	O
*	O
bytes	array
=	O
0	int
;	O
fprintf	function
(	O
stderr	pointer
,	O
"invalid command given\n"	pointer
)	O
;	O
return	O
-	O
1	int
;	O
case	O
0xc0	int
:	O
*	O
bytes	array
=	O
0	int
;	O
fprintf	function
(	O
stderr	pointer
,	O
"abnormal termination caused by polling\n"	pointer
)	O
;	O
return	O
-	O
1	int
;	O
default	O
:	O
break	O
;	O
}	O
if	O
(	O
raw_cmd	pointer
->	O
flags	char
&	O
FD_RAW_MORE	int
)	O
return	O
1	int
;	O
return	O
0	int
;	O
}	O
struct	O
device	struct
devices	pointer
[	O
]	O
=	O
{	O
{	O
"/dev/fd0"	pointer
,	O
'A'	O
,	O
0	int
,	O
0	int
,	O
80	int
,	O
2	int
,	O
18	int
,	O
0	int
,	O
MDEF_ARG	O
,	O
0	int
,	O
0	int
}	O
,	O
{	O
"/dev/fd1"	pointer
,	O
'B'	O
,	O
0	int
,	O
0	int
,	O
0	int
,	O
0	int
,	O
0	int
,	O
0	int
,	O
FDEF_ARG	O
,	O
0	int
,	O
0	int
}	O
,	O
{	O
"/dev/sdb4"	pointer
,	O
'J'	O
,	O
GENHD	O
,	O
0	int
,	O
0	int
}	O
,	O
{	O
"/dev/sdb4"	pointer
,	O
'Z'	O
,	O
GENHD	O
,	O
0	int
,	O
0	int
}	O
,	O
REMOTE	O
}	O
;	O
static	O
__inline__	O
void	O
set_2m	function
(	O
struct	O
floppy_struct	struct
*	O
floppy	pointer
,	O
int	O
value	int
)	O
{	O
if	O
(	O
value	int
&	O
0x7f	int
)	O
value	int
=	O
FD_2M	int
;	O
else	O
value	int
=	O
0	int
;	O
floppy	pointer
->	O
rate	int
=	O
(	O
floppy	pointer
->	O
rate	int
&	O
~	O
FD_2M	int
)	O
|	O
value	int
;	O
}	O
static	O
__inline__	O
void	O
set_ssize	function
(	O
struct	O
floppy_struct	struct
*	O
floppy	pointer
,	O
int	O
value	int
)	O
{	O
value	int
=	O
(	O
(	O
(	O
value	int
&	O
7	int
)	O
+	O
6	int
)	O
%	O
8	int
)	O
<<	O
3	int
;	O
floppy	pointer
->	O
rate	int
=	O
(	O
floppy	pointer
->	O
rate	int
&	O
~	O
0x38	int
)	O
|	O
value	int
;	O
}	O
static	O
__inline__	O
int	O
set_parameters	function
(	O
int	O
fd	int
,	O
struct	O
floppy_struct	struct
*	O
floppy	pointer
,	O
struct	O
MT_STAT	O
*	O
buf	pointer
)	O
{	O
if	O
(	O
(	O
MINOR	O
(	O
buf	pointer
->	O
st_rdev	long
)	O
&	O
0x7f	int
)	O
>	O
3	int
)	O
return	O
1	int
;	O
return	O
ioctl	function
(	O
fd	int
,	O
FDSETPRM	O
,	O
floppy	pointer
)	O
;	O
}	O
static	O
__inline__	O
int	O
get_parameters	function
(	O
int	O
fd	int
,	O
struct	O
floppy_struct	struct
*	O
floppy	pointer
)	O
{	O
return	O
ioctl	function
(	O
fd	int
,	O
FDGETPRM	O
,	O
floppy	pointer
)	O
;	O
}	O
int	O
init_geom	function
(	O
int	O
fd	int
,	O
struct	O
device	struct
*	O
dev	pointer
,	O
struct	O
device	struct
*	O
orig_dev	pointer
,	O
struct	O
MT_STAT	O
*	O
statbuf	pointer
)	O
{	O
struct	O
generic_floppy_struct	O
floppy	pointer
;	O
int	O
change	int
;	O
if	O
(	O
!	O
(	O
(	O
S_ISBLK	O
(	O
statbuf	pointer
->	O
st_mode	int
)	O
&&	O
major	O
(	O
statbuf	pointer
->	O
st_rdev	long
)	O
==	O
BLOCK_MAJOR	int
)	O
)	O
)	O
return	O
compare_geom	function
(	O
dev	pointer
,	O
orig_dev	pointer
)	O
;	O
if	O
(	O
get_parameters	function
(	O
fd	int
,	O
&	O
floppy	pointer
)	O
)	O
return	O
1	int
;	O
change	int
=	O
0	int
;	O
if	O
(	O
compare	function
(	O
dev	pointer
->	O
sectors	short
,	O
SECTORS	O
(	O
floppy	pointer
)	O
)	O
)	O
{	O
SECTORS	O
(	O
floppy	pointer
)	O
=	O
dev	pointer
->	O
sectors	short
;	O
change	int
=	O
1	int
;	O
}	O
else	O
dev	pointer
->	O
sectors	short
=	O
SECTORS	O
(	O
floppy	pointer
)	O
;	O
if	O
(	O
compare	function
(	O
dev	pointer
->	O
heads	short
,	O
HEADS	O
(	O
floppy	pointer
)	O
)	O
)	O
{	O
HEADS	O
(	O
floppy	pointer
)	O
=	O
dev	pointer
->	O
heads	short
;	O
change	int
=	O
1	int
;	O
}	O
else	O
dev	pointer
->	O
heads	short
=	O
HEADS	O
(	O
floppy	pointer
)	O
;	O
if	O
(	O
compare	function
(	O
dev	pointer
->	O
tracks	int
,	O
TRACKS	O
(	O
floppy	pointer
)	O
)	O
)	O
{	O
TRACKS	O
(	O
floppy	pointer
)	O
=	O
dev	pointer
->	O
tracks	int
;	O
change	int
=	O
1	int
;	O
}	O
else	O
dev	pointer
->	O
tracks	int
=	O
TRACKS	O
(	O
floppy	pointer
)	O
;	O
if	O
(	O
compare	function
(	O
dev	pointer
->	O
use_2m	int
,	O
USE_2M	O
(	O
floppy	pointer
)	O
)	O
)	O
{	O
SET_2M	O
(	O
&	O
floppy	pointer
,	O
dev	pointer
->	O
use_2m	int
)	O
;	O
change	int
=	O
1	int
;	O
}	O
else	O
dev	pointer
->	O
use_2m	int
=	O
USE_2M	O
(	O
floppy	pointer
)	O
;	O
if	O
(	O
!	O
(	O
dev	pointer
->	O
ssize	char
&	O
0x80	int
)	O
)	O
dev	pointer
->	O
ssize	char
=	O
0	int
;	O
if	O
(	O
compare	function
(	O
dev	pointer
->	O
ssize	char
,	O
SSIZE	O
(	O
floppy	pointer
)	O
+	O
128	int
)	O
)	O
{	O
SET_SSIZE	O
(	O
&	O
floppy	pointer
,	O
dev	pointer
->	O
ssize	char
)	O
;	O
change	int
=	O
1	int
;	O
}	O
else	O
dev	pointer
->	O
ssize	char
=	O
SSIZE	O
(	O
floppy	pointer
)	O
;	O
if	O
(	O
!	O
change	int
)	O
return	O
0	int
;	O
SECTORS_PER_DISK	O
(	O
floppy	pointer
)	O
=	O
dev	pointer
->	O
sectors	short
*	O
dev	pointer
->	O
heads	short
*	O
dev	pointer
->	O
tracks	int
;	O
if	O
(	O
dev	pointer
->	O
tracks	int
>	O
41	int
)	O
STRETCH	O
(	O
floppy	pointer
)	O
=	O
0	int
;	O
else	O
STRETCH	O
(	O
floppy	pointer
)	O
=	O
1	int
;	O
return	O
set_parameters	function
(	O
fd	int
,	O
&	O
floppy	pointer
,	O
statbuf	pointer
)	O
;	O
}	O
const	O
unsigned	O
int	O
nr_const_devices	int
=	O
sizeof	O
(	O
const_devices	array
)	O
/	O
sizeof	O
(	O
*	O
const_devices	array
)	O
;	O

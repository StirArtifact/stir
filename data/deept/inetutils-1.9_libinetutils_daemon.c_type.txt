void	O
waitdaemon_timeout	function
(	O
int	O
signo	int
)	O
{	O
int	O
left	int
;	O
left	int
=	O
alarm	function
(	O
0	int
)	O
;	O
signal	function
(	O
SIGALRM	int
,	O
SIG_DFL	O
)	O
;	O
if	O
(	O
left	int
==	O
0	int
)	O
error	function
(	O
EXIT_FAILURE	int
,	O
0	int
,	O
"timed out waiting for child"	pointer
)	O
;	O
}	O
int	O
waitdaemon	function
(	O
int	O
nochdir	int
,	O
int	O
noclose	int
,	O
int	O
maxwait	int
)	O
{	O
int	O
fd	int
;	O
pid_t	int
childpid	int
;	O
pid_t	int
ppid	int
;	O
ppid	int
=	O
getpid	function
(	O
)	O
;	O
switch	O
(	O
childpid	int
=	O
fork	function
(	O
)	O
)	O
{	O
case	O
-	O
1	int
:	O
return	O
(	O
-	O
1	int
)	O
;	O
case	O
0	int
:	O
break	O
;	O
default	O
:	O
if	O
(	O
maxwait	int
>	O
0	int
)	O
{	O
signal	function
(	O
SIGALRM	int
,	O
waitdaemon_timeout	function
)	O
;	O
alarm	function
(	O
maxwait	int
)	O
;	O
pause	function
(	O
)	O
;	O
}	O
_exit	function
(	O
0	int
)	O
;	O
}	O
if	O
(	O
setsid	function
(	O
)	O
==	O
-	O
1	int
)	O
return	O
-	O
1	int
;	O
signal	function
(	O
SIGHUP	int
,	O
SIG_IGN	O
)	O
;	O
switch	O
(	O
fork	function
(	O
)	O
)	O
{	O
case	O
0	int
:	O
break	O
;	O
case	O
-	O
1	int
:	O
return	O
-	O
1	int
;	O
default	O
:	O
_exit	function
(	O
0	int
)	O
;	O
}	O
if	O
(	O
!	O
nochdir	int
)	O
chdir	function
(	O
"/"	pointer
)	O
;	O
if	O
(	O
!	O
noclose	int
)	O
{	O
int	O
i	int
;	O
long	O
fdlimit	long
=	O
-	O
1	int
;	O
fdlimit	long
=	O
getdtablesize	function
(	O
)	O
;	O
if	O
(	O
fdlimit	long
==	O
-	O
1	int
)	O
fdlimit	long
=	O
MAXFD	int
;	O
for	O
(	O
i	int
=	O
0	int
;	O
i	int
<	O
fdlimit	long
;	O
i	int
++	O
)	O
close	function
(	O
i	int
)	O
;	O
fd	int
=	O
open	function
(	O
PATH_DEVNULL	O
,	O
O_RDWR	int
,	O
0	int
)	O
;	O
if	O
(	O
fd	int
!=	O
-	O
1	int
)	O
{	O
dup2	function
(	O
fd	int
,	O
STDIN_FILENO	int
)	O
;	O
dup2	function
(	O
fd	int
,	O
STDOUT_FILENO	int
)	O
;	O
dup2	function
(	O
fd	int
,	O
STDERR_FILENO	int
)	O
;	O
if	O
(	O
fd	int
>	O
2	int
)	O
close	function
(	O
fd	int
)	O
;	O
}	O
}	O
return	O
ppid	int
;	O
}	O
int	O
daemon	function
(	O
int	O
nochdir	int
,	O
int	O
noclose	int
)	O
{	O
return	O
(	O
waitdaemon	function
(	O
nochdir	int
,	O
noclose	int
,	O
0	int
)	O
==	O
-	O
1	int
)	O
?	O
-	O
1	int
:	O
0	int
;	O
}	O

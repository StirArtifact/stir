int	O
__osip_ict_init	function
(	O
osip_ict_t	struct
*	O
*	O
ict	pointer
,	O
osip_t	struct
*	O
osip	struct
,	O
osip_message_t	struct
*	O
invite	pointer
)	O
{	O
osip_route_t	struct
*	O
route	pointer
;	O
int	O
i	int
;	O
OSIP_TRACE	O
(	O
osip_trace	function
(	O
__FILE__	O
,	O
__LINE__	O
,	O
OSIP_INFO2	O
,	O
NULL	O
,	O
"allocating ICT context\n"	pointer
)	O
)	O
;	O
*	O
ict	pointer
=	O
(	O
osip_ict_t	struct
*	O
)	O
osip_malloc	O
(	O
sizeof	O
(	O
osip_ict_t	struct
)	O
)	O
;	O
if	O
(	O
*	O
ict	pointer
==	O
NULL	O
)	O
return	O
OSIP_NOMEM	O
;	O
memset	function
(	O
*	O
ict	pointer
,	O
0	int
,	O
sizeof	O
(	O
osip_ict_t	struct
)	O
)	O
;	O
{	O
osip_via_t	struct
*	O
via	pointer
;	O
char	O
*	O
proto	pointer
;	O
i	int
=	O
osip_message_get_via	function
(	O
invite	pointer
,	O
0	int
,	O
&	O
via	pointer
)	O
;	O
if	O
(	O
i	int
<	O
0	int
)	O
{	O
osip_free	O
(	O
*	O
ict	pointer
)	O
;	O
return	O
i	int
;	O
}	O
proto	pointer
=	O
via_get_protocol	function
(	O
via	pointer
)	O
;	O
if	O
(	O
proto	pointer
==	O
NULL	O
)	O
{	O
osip_free	O
(	O
*	O
ict	pointer
)	O
;	O
return	O
OSIP_SYNTAXERROR	O
;	O
}	O
if	O
(	O
osip_strcasecmp	function
(	O
proto	pointer
,	O
"TCP"	pointer
)	O
!=	O
0	int
&&	O
osip_strcasecmp	function
(	O
proto	pointer
,	O
"TLS"	pointer
)	O
!=	O
0	int
&&	O
osip_strcasecmp	function
(	O
proto	pointer
,	O
"SCTP"	pointer
)	O
!=	O
0	int
)	O
{	O
(	O
*	O
ict	pointer
)	O
->	O
timer_a_length	int
=	O
DEFAULT_T1	int
;	O
if	O
(	O
64	int
*	O
DEFAULT_T1	int
<	O
32000	int
)	O
(	O
*	O
ict	pointer
)	O
->	O
timer_d_length	int
=	O
32000	int
;	O
else	O
(	O
*	O
ict	pointer
)	O
->	O
timer_d_length	int
=	O
64	int
*	O
DEFAULT_T1	int
;	O
osip_gettimeofday	function
(	O
&	O
(	O
*	O
ict	pointer
)	O
->	O
timer_a_start	struct
,	O
NULL	O
)	O
;	O
add_gettimeofday	function
(	O
&	O
(	O
*	O
ict	pointer
)	O
->	O
timer_a_start	struct
,	O
(	O
*	O
ict	pointer
)	O
->	O
timer_a_length	int
)	O
;	O
(	O
*	O
ict	pointer
)	O
->	O
timer_d_start	struct
.	O
tv_sec	long
=	O
-	O
1	int
;	O
}	O
else	O
{	O
(	O
*	O
ict	pointer
)	O
->	O
timer_a_length	int
=	O
DEFAULT_T1	int
;	O
(	O
*	O
ict	pointer
)	O
->	O
timer_d_length	int
=	O
0	int
;	O
osip_gettimeofday	function
(	O
&	O
(	O
*	O
ict	pointer
)	O
->	O
timer_a_start	struct
,	O
NULL	O
)	O
;	O
add_gettimeofday	function
(	O
&	O
(	O
*	O
ict	pointer
)	O
->	O
timer_a_start	struct
,	O
(	O
*	O
ict	pointer
)	O
->	O
timer_a_length	int
)	O
;	O
(	O
*	O
ict	pointer
)	O
->	O
timer_d_start	struct
.	O
tv_sec	long
=	O
-	O
1	int
;	O
}	O
}	O
osip_message_get_route	function
(	O
invite	pointer
,	O
0	int
,	O
&	O
route	pointer
)	O
;	O
if	O
(	O
route	pointer
!=	O
NULL	O
&&	O
route	pointer
->	O
url	pointer
!=	O
NULL	O
)	O
{	O
osip_uri_param_t	struct
*	O
lr_param	pointer
;	O
osip_uri_uparam_get_byname	O
(	O
route	pointer
->	O
url	pointer
,	O
"lr"	pointer
,	O
&	O
lr_param	pointer
)	O
;	O
if	O
(	O
lr_param	pointer
==	O
NULL	O
)	O
{	O
route	pointer
=	O
NULL	O
;	O
}	O
}	O
if	O
(	O
route	pointer
!=	O
NULL	O
&&	O
route	pointer
->	O
url	pointer
!=	O
NULL	O
)	O
{	O
int	O
port	pointer
=	O
5060	int
;	O
if	O
(	O
route	pointer
->	O
url	pointer
->	O
port	pointer
!=	O
NULL	O
)	O
port	pointer
=	O
osip_atoi	function
(	O
route	pointer
->	O
url	pointer
->	O
port	pointer
)	O
;	O
osip_ict_set_destination	function
(	O
(	O
*	O
ict	pointer
)	O
,	O
osip_strdup	function
(	O
route	pointer
->	O
url	pointer
->	O
host	pointer
)	O
,	O
port	pointer
)	O
;	O
}	O
else	O
{	O
int	O
port	pointer
=	O
5060	int
;	O
osip_uri_param_t	struct
*	O
maddr_param	pointer
=	O
NULL	O
;	O
osip_uri_param_t	struct
*	O
obr_param	pointer
=	O
NULL	O
;	O
osip_uri_param_t	struct
*	O
obp_param	pointer
=	O
NULL	O
;	O
port	pointer
=	O
5060	int
;	O
if	O
(	O
invite	pointer
->	O
req_uri	pointer
->	O
port	pointer
!=	O
NULL	O
)	O
port	pointer
=	O
osip_atoi	function
(	O
invite	pointer
->	O
req_uri	pointer
->	O
port	pointer
)	O
;	O
osip_uri_uparam_get_byname	O
(	O
invite	pointer
->	O
req_uri	pointer
,	O
"x-obr"	pointer
,	O
&	O
obr_param	pointer
)	O
;	O
osip_uri_uparam_get_byname	O
(	O
invite	pointer
->	O
req_uri	pointer
,	O
"x-obp"	pointer
,	O
&	O
obp_param	pointer
)	O
;	O
osip_uri_uparam_get_byname	O
(	O
invite	pointer
->	O
req_uri	pointer
,	O
"maddr"	pointer
,	O
&	O
maddr_param	pointer
)	O
;	O
if	O
(	O
maddr_param	pointer
!=	O
NULL	O
&&	O
maddr_param	pointer
->	O
gvalue	pointer
!=	O
NULL	O
)	O
osip_ict_set_destination	function
(	O
(	O
*	O
ict	pointer
)	O
,	O
osip_strdup	function
(	O
maddr_param	pointer
->	O
gvalue	pointer
)	O
,	O
port	pointer
)	O
;	O
else	O
if	O
(	O
obr_param	pointer
!=	O
NULL	O
&&	O
obr_param	pointer
->	O
gvalue	pointer
!=	O
NULL	O
&&	O
obp_param	pointer
!=	O
NULL	O
&&	O
obp_param	pointer
->	O
gvalue	pointer
!=	O
NULL	O
)	O
osip_ict_set_destination	function
(	O
(	O
*	O
ict	pointer
)	O
,	O
osip_strdup	function
(	O
obr_param	pointer
->	O
gvalue	pointer
)	O
,	O
osip_atoi	function
(	O
obp_param	pointer
->	O
gvalue	pointer
)	O
)	O
;	O
else	O
osip_ict_set_destination	function
(	O
(	O
*	O
ict	pointer
)	O
,	O
osip_strdup	function
(	O
invite	pointer
->	O
req_uri	pointer
->	O
host	pointer
)	O
,	O
port	pointer
)	O
;	O
}	O
(	O
*	O
ict	pointer
)	O
->	O
timer_b_length	int
=	O
64	int
*	O
DEFAULT_T1	int
;	O
osip_gettimeofday	function
(	O
&	O
(	O
*	O
ict	pointer
)	O
->	O
timer_b_start	struct
,	O
NULL	O
)	O
;	O
add_gettimeofday	function
(	O
&	O
(	O
*	O
ict	pointer
)	O
->	O
timer_b_start	struct
,	O
(	O
*	O
ict	pointer
)	O
->	O
timer_b_length	int
)	O
;	O
return	O
OSIP_SUCCESS	int
;	O
}	O
int	O
__osip_ict_free	function
(	O
osip_ict_t	struct
*	O
ict	pointer
)	O
{	O
if	O
(	O
ict	pointer
==	O
NULL	O
)	O
return	O
OSIP_SUCCESS	int
;	O
OSIP_TRACE	O
(	O
osip_trace	function
(	O
__FILE__	O
,	O
__LINE__	O
,	O
OSIP_INFO2	O
,	O
NULL	O
,	O
"free ict resource\n"	pointer
)	O
)	O
;	O
osip_free	O
(	O
ict	pointer
->	O
destination	pointer
)	O
;	O
osip_free	O
(	O
ict	pointer
)	O
;	O
return	O
OSIP_SUCCESS	int
;	O
}	O
int	O
osip_ict_set_destination	function
(	O
osip_ict_t	struct
*	O
ict	pointer
,	O
char	O
*	O
destination	pointer
,	O
int	O
port	pointer
)	O
{	O
if	O
(	O
ict	pointer
==	O
NULL	O
)	O
return	O
OSIP_BADPARAMETER	O
;	O
if	O
(	O
ict	pointer
->	O
destination	pointer
!=	O
NULL	O
)	O
osip_free	O
(	O
ict	pointer
->	O
destination	pointer
)	O
;	O
ict	pointer
->	O
destination	pointer
=	O
destination	pointer
;	O
ict	pointer
->	O
port	pointer
=	O
port	pointer
;	O
return	O
OSIP_SUCCESS	int
;	O
}	O
osip_event_t	struct
*	O
__osip_ict_need_timer_a_event	function
(	O
osip_ict_t	struct
*	O
ict	pointer
,	O
state_t	enum
state	pointer
,	O
int	O
transactionid	int
)	O
{	O
return	O
__osip_transaction_need_timer_x_event	function
(	O
ict	pointer
,	O
&	O
ict	pointer
->	O
timer_a_start	struct
,	O
state	pointer
==	O
ICT_CALLING	int
,	O
transactionid	int
,	O
TIMEOUT_A	int
)	O
;	O
}	O
osip_event_t	struct
*	O
__osip_ict_need_timer_b_event	function
(	O
osip_ict_t	struct
*	O
ict	pointer
,	O
state_t	enum
state	pointer
,	O
int	O
transactionid	int
)	O
{	O
return	O
__osip_transaction_need_timer_x_event	function
(	O
ict	pointer
,	O
&	O
ict	pointer
->	O
timer_b_start	struct
,	O
state	pointer
==	O
ICT_CALLING	int
,	O
transactionid	int
,	O
TIMEOUT_B	int
)	O
;	O
}	O
osip_event_t	struct
*	O
__osip_ict_need_timer_d_event	function
(	O
osip_ict_t	struct
*	O
ict	pointer
,	O
state_t	enum
state	pointer
,	O
int	O
transactionid	int
)	O
{	O
return	O
__osip_transaction_need_timer_x_event	function
(	O
ict	pointer
,	O
&	O
ict	pointer
->	O
timer_d_start	struct
,	O
state	pointer
==	O
ICT_COMPLETED	int
,	O
transactionid	int
,	O
TIMEOUT_D	int
)	O
;	O
}	O

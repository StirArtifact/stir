HANDLE	long
CalculateVarHandle	function
(	O
PVMMAPSTRCT	pointer
pvm	pointer
,	O
PSTR	pointer
sz	pointer
)	O
;	O
static	O
PVMMAPSTRCT	pointer
vpvmGlo	pointer
;	O
typedef	O
struct	O
tagINPUTFUNCTIONMAP	struct
{	O
PSTR	pointer
szName	pointer
;	O
int	O
iIFNType	int
;	O
}	O
IFM	struct
,	O
*	O
PIFM	pointer
;	O
IFM	struct
vrgifmMap	array
[	O
]	O
=	O
{	O
{	O
"PerDose"	pointer
,	O
IFN_PERDOSE	int
}	O
,	O
{	O
"PerRate"	pointer
,	O
IFN_PERRATE	int
}	O
,	O
{	O
"PerExp"	pointer
,	O
IFN_PEREXP	int
}	O
,	O
{	O
"NDoses"	pointer
,	O
IFN_NDOSES	int
}	O
,	O
{	O
""	pointer
,	O
IFN_NULL	int
}	O
}	O
;	O
int	O
GetFnType	function
(	O
PSTR	pointer
szName	pointer
)	O
{	O
PIFM	pointer
pifm	pointer
=	O
&	O
vrgifmMap	array
[	O
0	int
]	O
;	O
while	O
(	O
*	O
pifm	pointer
->	O
szName	pointer
&&	O
MyStrcmp	function
(	O
szName	pointer
,	O
pifm	pointer
->	O
szName	pointer
)	O
)	O
pifm	pointer
++	O
;	O
return	O
(	O
pifm	pointer
->	O
iIFNType	int
)	O
;	O
}	O
void	O
InitIFN	function
(	O
PIFN	pointer
pifn	pointer
)	O
{	O
pifn	pointer
->	O
dTStartPeriod	double
=	O
0.0	int
;	O
pifn	pointer
->	O
bOn	int
=	O
FALSE	int
;	O
pifn	pointer
->	O
dMag	double
=	O
0.0	int
;	O
pifn	pointer
->	O
dTper	double
=	O
0.0	int
;	O
pifn	pointer
->	O
dT0	double
=	O
0.0	int
;	O
pifn	pointer
->	O
dTexp	double
=	O
0.0	int
;	O
pifn	pointer
->	O
dDecay	double
=	O
0.0	int
;	O
pifn	pointer
->	O
dVal	double
=	O
0.0	int
;	O
pifn	pointer
->	O
nDoses	int
=	O
0	int
;	O
pifn	pointer
->	O
hMag	long
=	O
0	int
;	O
pifn	pointer
->	O
hTper	long
=	O
0	int
;	O
pifn	pointer
->	O
hT0	long
=	O
0	int
;	O
pifn	pointer
->	O
hTexp	long
=	O
0	int
;	O
pifn	pointer
->	O
hDecay	long
=	O
0	int
;	O
pifn	pointer
->	O
nDoses	int
=	O
pifn	pointer
->	O
iDoseCur	int
=	O
0	int
;	O
pifn	pointer
->	O
rgT0s	pointer
=	O
pifn	pointer
->	O
rgTexps	pointer
=	O
pifn	pointer
->	O
rgMags	pointer
=	O
NULL	O
;	O
}	O
BOOL	int
DefDepParm	function
(	O
PSTR	pointer
szLex	pointer
,	O
PDOUBLE	pointer
pdValue	pointer
,	O
HANDLE	long
*	O
phvar	pointer
)	O
{	O
BOOL	int
bReturn	int
=	O
TRUE	int
;	O
if	O
(	O
IsIdentifier	O
(	O
szLex	pointer
)	O
)	O
{	O
if	O
(	O
!	O
(	O
*	O
phvar	pointer
=	O
(	O
HANDLE	long
)	O
GetParmHandle	O
(	O
szLex	pointer
)	O
)	O
)	O
{	O
bReturn	int
=	O
FALSE	int
;	O
ReportError	function
(	O
NULL	O
,	O
RE_UNDEFINED	O
,	O
szLex	pointer
,	O
NULL	O
)	O
;	O
}	O
}	O
else	O
*	O
pdValue	pointer
=	O
atof	function
(	O
szLex	pointer
)	O
;	O
return	O
(	O
bReturn	int
)	O
;	O
}	O
BOOL	int
GetInputArgs	function
(	O
PINPUTBUF	pointer
pibIn	pointer
,	O
PIFN	pointer
pifn	pointer
)	O
{	O
PSTRLEX	array
rgszLex	array
[	O
4	int
]	O
;	O
int	O
rgiTypes	array
[	O
4	int
]	O
,	O
i	int
;	O
long	O
rgiLowerB	array
[	O
4	int
]	O
,	O
rgiUpperB	array
[	O
4	int
]	O
;	O
BOOL	int
bReturn	int
=	O
FALSE	int
;	O
for	O
(	O
i	int
=	O
0	int
;	O
i	int
<	O
4	int
;	O
i	int
++	O
)	O
rgiTypes	array
[	O
i	int
]	O
=	O
LX_INTEGER	int
|	O
LX_FLOAT	int
|	O
LX_IDENTIFIER	int
;	O
if	O
(	O
GetFuncArgs	function
(	O
pibIn	pointer
,	O
4	int
,	O
rgiTypes	array
,	O
rgszLex	array
[	O
0	int
]	O
,	O
rgiLowerB	array
,	O
rgiUpperB	array
)	O
)	O
{	O
for	O
(	O
i	int
=	O
0	int
;	O
i	int
<	O
4	int
;	O
i	int
++	O
)	O
if	O
(	O
(	O
rgiLowerB	array
[	O
i	int
]	O
!=	O
-	O
1	int
)	O
||	O
(	O
rgiUpperB	array
[	O
i	int
]	O
!=	O
-	O
1	int
)	O
)	O
ReportError	function
(	O
pibIn	pointer
,	O
RE_BADCONTEXT	O
|	O
RE_FATAL	int
,	O
"array bounds"	pointer
,	O
"Arrays cannot be used as input function parameters"	pointer
)	O
;	O
bReturn	int
=	O
TRUE	int
;	O
bReturn	int
&=	O
DefDepParm	function
(	O
rgszLex	array
[	O
0	int
]	O
,	O
&	O
pifn	pointer
->	O
dMag	double
,	O
&	O
pifn	pointer
->	O
hMag	long
)	O
;	O
bReturn	int
&=	O
DefDepParm	function
(	O
rgszLex	array
[	O
1	int
]	O
,	O
&	O
pifn	pointer
->	O
dTper	double
,	O
&	O
pifn	pointer
->	O
hTper	long
)	O
;	O
bReturn	int
&=	O
DefDepParm	function
(	O
rgszLex	array
[	O
2	int
]	O
,	O
&	O
pifn	pointer
->	O
dT0	double
,	O
&	O
pifn	pointer
->	O
hT0	long
)	O
;	O
if	O
(	O
pifn	pointer
->	O
iType	int
==	O
IFN_PEREXP	int
)	O
bReturn	int
&=	O
DefDepParm	function
(	O
rgszLex	array
[	O
3	int
]	O
,	O
&	O
pifn	pointer
->	O
dDecay	double
,	O
&	O
pifn	pointer
->	O
hDecay	long
)	O
;	O
else	O
bReturn	int
&=	O
DefDepParm	function
(	O
rgszLex	array
[	O
3	int
]	O
,	O
&	O
pifn	pointer
->	O
dTexp	double
,	O
&	O
pifn	pointer
->	O
hTexp	long
)	O
;	O
if	O
(	O
!	O
bReturn	int
)	O
ReportError	function
(	O
pibIn	pointer
,	O
RE_EXPECTED	int
,	O
"input-spec"	pointer
,	O
NULL	O
)	O
;	O
}	O
return	O
(	O
bReturn	int
)	O
;	O
}	O
BOOL	int
GetNNumbers	function
(	O
PINPUTBUF	pointer
pibIn	pointer
,	O
PSTR	pointer
szLex	pointer
,	O
int	O
nNumbers	int
,	O
PDOUBLE	pointer
rgd	pointer
)	O
{	O
BOOL	int
bErr	int
=	O
FALSE	int
;	O
int	O
i	int
;	O
for	O
(	O
i	int
=	O
0	int
;	O
i	int
<	O
nNumbers	int
&&	O
!	O
bErr	int
;	O
i	int
++	O
)	O
{	O
if	O
(	O
i	int
)	O
GetOptPunct	function
(	O
pibIn	pointer
,	O
szLex	pointer
,	O
','	O
)	O
;	O
if	O
(	O
!	O
(	O
bErr	int
=	O
ENextLex	function
(	O
pibIn	pointer
,	O
szLex	pointer
,	O
LX_NUMBER	O
)	O
)	O
)	O
rgd	pointer
[	O
i	int
]	O
=	O
atof	function
(	O
szLex	pointer
)	O
;	O
}	O
return	O
bErr	int
;	O
}	O
BOOL	int
GetNDoses	function
(	O
PINPUTBUF	pointer
pibIn	pointer
,	O
PSTR	pointer
szLex	pointer
,	O
PIFN	pointer
pifn	pointer
)	O
{	O
BOOL	int
bErr	int
=	O
FALSE	int
;	O
if	O
(	O
(	O
bErr	int
=	O
EGetPunct	function
(	O
pibIn	pointer
,	O
szLex	pointer
,	O
CH_LPAREN	O
)	O
)	O
)	O
goto	O
Exit_GetNDoses	O
;	O
if	O
(	O
(	O
bErr	int
=	O
ENextLex	function
(	O
pibIn	pointer
,	O
szLex	pointer
,	O
LX_INTEGER	int
)	O
)	O
)	O
goto	O
Exit_GetNDoses	O
;	O
pifn	pointer
->	O
nDoses	int
=	O
atoi	function
(	O
szLex	pointer
)	O
;	O
if	O
(	O
(	O
bErr	int
=	O
(	O
pifn	pointer
->	O
nDoses	int
<=	O
0	int
)	O
)	O
)	O
{	O
ReportError	function
(	O
pibIn	pointer
,	O
RE_LEXEXPECTED	int
,	O
"positive-integer"	pointer
,	O
szLex	pointer
)	O
;	O
goto	O
Exit_GetNDoses	O
;	O
}	O
if	O
(	O
!	O
(	O
pifn	pointer
->	O
rgT0s	pointer
=	O
(	O
PDOUBLE	pointer
)	O
malloc	function
(	O
pifn	pointer
->	O
nDoses	int
*	O
sizeof	O
(	O
double	O
)	O
)	O
)	O
||	O
!	O
(	O
pifn	pointer
->	O
rgTexps	pointer
=	O
(	O
PDOUBLE	pointer
)	O
malloc	function
(	O
pifn	pointer
->	O
nDoses	int
*	O
sizeof	O
(	O
double	O
)	O
)	O
)	O
||	O
!	O
(	O
pifn	pointer
->	O
rgMags	pointer
=	O
(	O
PDOUBLE	pointer
)	O
malloc	function
(	O
pifn	pointer
->	O
nDoses	int
*	O
sizeof	O
(	O
double	O
)	O
)	O
)	O
)	O
ReportError	function
(	O
pibIn	pointer
,	O
RE_OUTOFMEM	int
|	O
RE_FATAL	int
,	O
"GetNDoses"	pointer
,	O
NULL	O
)	O
;	O
GetOptPunct	function
(	O
pibIn	pointer
,	O
szLex	pointer
,	O
','	O
)	O
;	O
bErr	int
=	O
GetNNumbers	function
(	O
pibIn	pointer
,	O
szLex	pointer
,	O
pifn	pointer
->	O
nDoses	int
,	O
pifn	pointer
->	O
rgMags	pointer
)	O
;	O
GetOptPunct	function
(	O
pibIn	pointer
,	O
szLex	pointer
,	O
','	O
)	O
;	O
if	O
(	O
!	O
bErr	int
)	O
bErr	int
=	O
GetNNumbers	function
(	O
pibIn	pointer
,	O
szLex	pointer
,	O
pifn	pointer
->	O
nDoses	int
,	O
pifn	pointer
->	O
rgT0s	pointer
)	O
;	O
GetOptPunct	function
(	O
pibIn	pointer
,	O
szLex	pointer
,	O
','	O
)	O
;	O
if	O
(	O
!	O
bErr	int
)	O
bErr	int
=	O
GetNNumbers	function
(	O
pibIn	pointer
,	O
szLex	pointer
,	O
pifn	pointer
->	O
nDoses	int
,	O
pifn	pointer
->	O
rgTexps	pointer
)	O
;	O
if	O
(	O
!	O
bErr	int
)	O
bErr	int
=	O
EGetPunct	function
(	O
pibIn	pointer
,	O
szLex	pointer
,	O
CH_RPAREN	O
)	O
;	O
Exit_GetNDoses	O
:	O
if	O
(	O
bErr	int
)	O
fprintf	function
(	O
stderr	pointer
,	O
"Syntax: GetNDoses (nDoses, <n Magnitudes>, "	pointer
"<n T0's>, <n Texposure's>)\n"	pointer
)	O
;	O
return	O
(	O
!	O
bErr	int
)	O
;	O
}	O
BOOL	int
GetInputFn	function
(	O
PINPUTBUF	pointer
pibIn	pointer
,	O
PSTR	pointer
sz	pointer
,	O
PIFN	pointer
pifn	pointer
)	O
{	O
INPUTBUF	struct
ibDummy	struct
;	O
PINPUTBUF	pointer
pibDum	pointer
=	O
&	O
ibDummy	struct
;	O
PSTRLEX	array
szLex	pointer
;	O
int	O
iType	int
;	O
BOOL	int
bReturn	int
=	O
FALSE	int
;	O
if	O
(	O
!	O
pibIn	pointer
||	O
!	O
pifn	pointer
)	O
return	O
(	O
FALSE	int
)	O
;	O
{	O
PINPUTINFO	pointer
pinfo	pointer
=	O
(	O
PINPUTINFO	pointer
)	O
pibIn	pointer
->	O
pInfo	pointer
;	O
vpvmGlo	pointer
=	O
pinfo	pointer
->	O
pvmGloVars	pointer
;	O
}	O
if	O
(	O
sz	pointer
)	O
MakeStringBuffer	function
(	O
pibIn	pointer
,	O
pibDum	pointer
,	O
sz	pointer
)	O
;	O
else	O
pibDum	pointer
=	O
pibIn	pointer
;	O
NextLex	function
(	O
pibDum	pointer
,	O
szLex	pointer
,	O
&	O
iType	int
)	O
;	O
switch	O
(	O
iType	int
)	O
{	O
default	O
:	O
case	O
LX_NULL	int
:	O
case	O
LX_PUNCT	int
:	O
ReportError	function
(	O
pibIn	pointer
,	O
RE_LEXEXPECTED	int
,	O
"input-spec"	pointer
,	O
NULL	O
)	O
;	O
break	O
;	O
case	O
LX_FLOAT	int
:	O
case	O
LX_INTEGER	int
:	O
case	O
LX_IDENTIFIER	int
:	O
InitIFN	function
(	O
pifn	pointer
)	O
;	O
if	O
(	O
iType	int
==	O
LX_IDENTIFIER	int
)	O
{	O
pifn	pointer
->	O
iType	int
=	O
GetFnType	function
(	O
szLex	pointer
)	O
;	O
switch	O
(	O
pifn	pointer
->	O
iType	int
)	O
{	O
case	O
IFN_NDOSES	int
:	O
bReturn	int
=	O
GetNDoses	function
(	O
pibDum	pointer
,	O
szLex	pointer
,	O
pifn	pointer
)	O
;	O
break	O
;	O
default	O
:	O
pifn	pointer
->	O
iType	int
=	O
IFN_NULL	int
;	O
ReportError	function
(	O
pibIn	pointer
,	O
RE_LEXEXPECTED	int
,	O
"input-spec"	pointer
,	O
szLex	pointer
)	O
;	O
break	O
;	O
case	O
IFN_PERDOSE	int
:	O
case	O
IFN_PERRATE	int
:	O
case	O
IFN_PEREXP	int
:	O
bReturn	int
=	O
GetInputArgs	function
(	O
pibDum	pointer
,	O
pifn	pointer
)	O
;	O
break	O
;	O
}	O
}	O
else	O
{	O
pifn	pointer
->	O
iType	int
=	O
IFN_CONSTANT	int
;	O
pifn	pointer
->	O
dMag	double
=	O
pifn	pointer
->	O
dVal	double
=	O
atof	function
(	O
szLex	pointer
)	O
;	O
pifn	pointer
->	O
bOn	int
=	O
TRUE	int
;	O
bReturn	int
=	O
TRUE	int
;	O
}	O
break	O
;	O
}	O
return	O
(	O
bReturn	int
)	O
;	O
}	O

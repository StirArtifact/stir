const	O
char	O
xcmd_rcsid	array
[	O
]	O
=	O
"$Id: xcmd.c,v 1.24 2002/03/05 19:10:42 ian Rel $"	pointer
;	O
static	O
boolean	int
flocal_xcmd_request	function
P	O
(	O
(	O
struct	O
stransfer	struct
*	O
qtrans	pointer
,	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
)	O
)	O
;	O
static	O
boolean	int
flocal_xcmd_await_reply	function
P	O
(	O
(	O
struct	O
stransfer	struct
*	O
qtrans	pointer
,	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
,	O
const	O
char	O
*	O
zdata	pointer
,	O
size_t	long
cdata	long
)	O
)	O
;	O
static	O
boolean	int
fremote_xcmd_reply	function
P	O
(	O
(	O
struct	O
stransfer	struct
*	O
qtrans	pointer
,	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
)	O
)	O
;	O
boolean	int
flocal_xcmd_init	function
(	O
qdaemon	pointer
,	O
qcmd	pointer
)	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
struct	O
scmd	struct
*	O
qcmd	pointer
;	O
{	O
struct	O
stransfer	struct
*	O
qtrans	pointer
;	O
qtrans	pointer
=	O
qtransalc	function
(	O
qcmd	pointer
)	O
;	O
qtrans	pointer
->	O
psendfn	pointer
=	O
flocal_xcmd_request	function
;	O
return	O
fqueue_local	function
(	O
qdaemon	pointer
,	O
qtrans	pointer
)	O
;	O
}	O
static	O
boolean	int
flocal_xcmd_request	function
(	O
qtrans	pointer
,	O
qdaemon	pointer
)	O
struct	O
stransfer	struct
*	O
qtrans	pointer
;	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
{	O
boolean	int
fquote	int
;	O
const	O
struct	O
scmd	struct
*	O
qcmd	pointer
;	O
struct	O
scmd	struct
squoted	struct
;	O
size_t	long
clen	long
;	O
char	O
*	O
zsend	pointer
;	O
boolean	int
fret	int
;	O
ulog	function
(	O
LOG_NORMAL	int
,	O
"Requesting work: %s to %s"	pointer
,	O
qtrans	pointer
->	O
s	struct
.	O
zfrom	pointer
,	O
qtrans	pointer
->	O
s	struct
.	O
zto	pointer
)	O
;	O
qtrans	pointer
->	O
fcmd	int
=	O
TRUE	O
;	O
qtrans	pointer
->	O
precfn	pointer
=	O
flocal_xcmd_await_reply	function
;	O
fquote	int
=	O
fcmd_needs_quotes	function
(	O
&	O
qtrans	pointer
->	O
s	struct
)	O
;	O
if	O
(	O
!	O
fquote	int
)	O
qcmd	pointer
=	O
&	O
qtrans	pointer
->	O
s	struct
;	O
else	O
{	O
if	O
(	O
(	O
qdaemon	pointer
->	O
ifeatures	int
&	O
FEATURE_QUOTES	O
)	O
==	O
0	int
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"%s: remote system does not support required quoting"	pointer
,	O
qtrans	pointer
->	O
s	struct
.	O
zfrom	pointer
)	O
;	O
(	O
void	O
)	O
fmail_transfer	function
(	O
FALSE	O
,	O
qtrans	pointer
->	O
s	struct
.	O
zuser	pointer
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
"remote system does not support required quoting"	pointer
,	O
qtrans	pointer
->	O
s	struct
.	O
zfrom	pointer
,	O
qdaemon	pointer
->	O
qsys	pointer
->	O
uuconf_zname	pointer
,	O
qtrans	pointer
->	O
s	struct
.	O
zto	pointer
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
)	O
;	O
(	O
void	O
)	O
fsysdep_did_work	function
(	O
qtrans	pointer
->	O
s	struct
.	O
pseq	pointer
)	O
;	O
utransfree	function
(	O
qtrans	pointer
)	O
;	O
return	O
TRUE	O
;	O
}	O
uquote_cmd	function
(	O
&	O
qtrans	pointer
->	O
s	struct
,	O
&	O
squoted	struct
)	O
;	O
qcmd	pointer
=	O
&	O
squoted	struct
;	O
}	O
if	O
(	O
!	O
fqueue_receive	function
(	O
qdaemon	pointer
,	O
qtrans	pointer
)	O
)	O
return	O
FALSE	O
;	O
clen	long
=	O
(	O
strlen	function
(	O
qcmd	pointer
->	O
zfrom	pointer
)	O
+	O
strlen	function
(	O
qcmd	pointer
->	O
zto	pointer
)	O
+	O
strlen	function
(	O
qcmd	pointer
->	O
zuser	pointer
)	O
+	O
strlen	function
(	O
qcmd	pointer
->	O
zoptions	pointer
)	O
+	O
7	int
)	O
;	O
zsend	pointer
=	O
zbufalc	function
(	O
clen	long
)	O
;	O
sprintf	function
(	O
zsend	pointer
,	O
"X %s %s %s -%s"	pointer
,	O
qcmd	pointer
->	O
zfrom	pointer
,	O
qcmd	pointer
->	O
zto	pointer
,	O
qcmd	pointer
->	O
zuser	pointer
,	O
qcmd	pointer
->	O
zoptions	pointer
)	O
;	O
fret	int
=	O
(	O
*	O
qdaemon	pointer
->	O
qproto	pointer
->	O
pfsendcmd	pointer
)	O
(	O
qdaemon	pointer
,	O
zsend	pointer
,	O
qtrans	pointer
->	O
ilocal	int
,	O
qtrans	pointer
->	O
iremote	int
)	O
;	O
ubuffree	function
(	O
zsend	pointer
)	O
;	O
if	O
(	O
fquote	int
)	O
ufree_quoted_cmd	function
(	O
&	O
squoted	struct
)	O
;	O
return	O
fret	int
;	O
}	O
static	O
boolean	int
flocal_xcmd_await_reply	function
(	O
qtrans	pointer
,	O
qdaemon	pointer
,	O
zdata	pointer
,	O
cdata	long
)	O
struct	O
stransfer	struct
*	O
qtrans	pointer
;	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
const	O
char	O
*	O
zdata	pointer
;	O
size_t	long
cdata	long
ATTRIBUTE_UNUSED	O
;	O
{	O
qtrans	pointer
->	O
precfn	pointer
=	O
NULL	O
;	O
if	O
(	O
zdata	pointer
[	O
0	int
]	O
!=	O
'X'	O
||	O
(	O
zdata	pointer
[	O
1	int
]	O
!=	O
'Y'	O
&&	O
zdata	pointer
[	O
1	int
]	O
!=	O
'N'	O
)	O
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"Bad response to work request"	pointer
)	O
;	O
utransfree	function
(	O
qtrans	pointer
)	O
;	O
return	O
FALSE	O
;	O
}	O
if	O
(	O
zdata	pointer
[	O
1	int
]	O
==	O
'N'	O
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"%s: work request denied"	pointer
,	O
qtrans	pointer
->	O
s	struct
.	O
zfrom	pointer
)	O
;	O
(	O
void	O
)	O
fmail_transfer	function
(	O
FALSE	O
,	O
qtrans	pointer
->	O
s	struct
.	O
zuser	pointer
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
"work request denied"	pointer
,	O
qtrans	pointer
->	O
s	struct
.	O
zfrom	pointer
,	O
qdaemon	pointer
->	O
qsys	pointer
->	O
uuconf_zname	pointer
,	O
qtrans	pointer
->	O
s	struct
.	O
zto	pointer
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
)	O
;	O
}	O
(	O
void	O
)	O
fsysdep_did_work	function
(	O
qtrans	pointer
->	O
s	struct
.	O
pseq	pointer
)	O
;	O
utransfree	function
(	O
qtrans	pointer
)	O
;	O
return	O
TRUE	O
;	O
}	O
boolean	int
fremote_xcmd_init	function
(	O
qdaemon	pointer
,	O
qcmd	pointer
,	O
iremote	int
)	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
struct	O
scmd	struct
*	O
qcmd	pointer
;	O
int	O
iremote	int
;	O
{	O
const	O
struct	O
uuconf_system	struct
*	O
qsys	pointer
;	O
const	O
char	O
*	O
zexclam	pointer
;	O
const	O
struct	O
uuconf_system	struct
*	O
qdestsys	pointer
;	O
struct	O
uuconf_system	struct
sdestsys	struct
;	O
char	O
*	O
zdestfile	pointer
;	O
boolean	int
fmkdirs	int
;	O
struct	O
stransfer	struct
*	O
qtrans	pointer
;	O
char	O
*	O
zuser	pointer
;	O
char	O
aboptions	array
[	O
5	int
]	O
;	O
char	O
*	O
zfrom	pointer
;	O
boolean	int
fret	int
;	O
char	O
*	O
zfile	pointer
;	O
ulog	function
(	O
LOG_NORMAL	int
,	O
"Work requested: %s to %s"	pointer
,	O
qcmd	pointer
->	O
zfrom	pointer
,	O
qcmd	pointer
->	O
zto	pointer
)	O
;	O
qsys	pointer
=	O
qdaemon	pointer
->	O
qsys	pointer
;	O
zexclam	pointer
=	O
strchr	function
(	O
qcmd	pointer
->	O
zto	pointer
,	O
'!'	O
)	O
;	O
if	O
(	O
zexclam	pointer
==	O
NULL	O
||	O
zexclam	pointer
==	O
qcmd	pointer
->	O
zto	pointer
||	O
strncmp	function
(	O
qdaemon	pointer
->	O
zlocalname	pointer
,	O
qcmd	pointer
->	O
zto	pointer
,	O
(	O
size_t	long
)	O
(	O
zexclam	pointer
-	O
qcmd	pointer
->	O
zto	pointer
)	O
)	O
==	O
0	int
)	O
{	O
const	O
char	O
*	O
zconst	pointer
;	O
qdestsys	pointer
=	O
NULL	O
;	O
if	O
(	O
zexclam	pointer
==	O
NULL	O
)	O
zconst	pointer
=	O
qcmd	pointer
->	O
zto	pointer
;	O
else	O
zconst	pointer
=	O
zexclam	pointer
+	O
1	int
;	O
zdestfile	pointer
=	O
zsysdep_local_file	function
(	O
zconst	pointer
,	O
qsys	pointer
->	O
uuconf_zpubdir	pointer
,	O
(	O
boolean	int
*	O
)	O
NULL	O
)	O
;	O
if	O
(	O
zdestfile	pointer
==	O
NULL	O
)	O
return	O
FALSE	O
;	O
zuser	pointer
=	O
NULL	O
;	O
fmkdirs	int
=	O
strchr	function
(	O
qcmd	pointer
->	O
zoptions	pointer
,	O
'f'	O
)	O
!=	O
NULL	O
;	O
}	O
else	O
{	O
size_t	long
clen	long
;	O
char	O
*	O
zcopy	pointer
;	O
int	O
iuuconf	int
;	O
char	O
*	O
zoptions	pointer
;	O
clen	long
=	O
zexclam	pointer
-	O
qcmd	pointer
->	O
zto	pointer
;	O
zcopy	pointer
=	O
zbufalc	function
(	O
clen	long
+	O
1	int
)	O
;	O
memcpy	function
(	O
zcopy	pointer
,	O
qcmd	pointer
->	O
zto	pointer
,	O
clen	long
)	O
;	O
zcopy	pointer
[	O
clen	long
]	O
=	O
'\0'	O
;	O
iuuconf	int
=	O
uuconf_system_info	function
(	O
qdaemon	pointer
->	O
puuconf	pointer
,	O
zcopy	pointer
,	O
&	O
sdestsys	struct
)	O
;	O
if	O
(	O
iuuconf	int
==	O
UUCONF_NOT_FOUND	O
)	O
{	O
if	O
(	O
!	O
funknown_system	function
(	O
qdaemon	pointer
->	O
puuconf	pointer
,	O
zcopy	pointer
,	O
&	O
sdestsys	struct
)	O
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"%s: System not found"	pointer
,	O
zcopy	pointer
)	O
;	O
ubuffree	function
(	O
zcopy	pointer
)	O
;	O
qtrans	pointer
=	O
qtransalc	function
(	O
qcmd	pointer
)	O
;	O
qtrans	pointer
->	O
psendfn	pointer
=	O
fremote_xcmd_reply	function
;	O
qtrans	pointer
->	O
pinfo	pointer
=	O
(	O
pointer	pointer
)	O
"XN"	pointer
;	O
qtrans	pointer
->	O
iremote	int
=	O
iremote	int
;	O
return	O
fqueue_remote	function
(	O
qdaemon	pointer
,	O
qtrans	pointer
)	O
;	O
}	O
}	O
else	O
if	O
(	O
iuuconf	int
!=	O
UUCONF_SUCCESS	O
)	O
{	O
ulog_uuconf	function
(	O
LOG_ERROR	int
,	O
qdaemon	pointer
->	O
puuconf	pointer
,	O
iuuconf	int
)	O
;	O
ubuffree	function
(	O
zcopy	pointer
)	O
;	O
return	O
FALSE	O
;	O
}	O
ubuffree	function
(	O
zcopy	pointer
)	O
;	O
qdestsys	pointer
=	O
&	O
sdestsys	struct
;	O
zdestfile	pointer
=	O
zbufcpy	function
(	O
zexclam	pointer
+	O
1	int
)	O
;	O
zuser	pointer
=	O
zbufalc	function
(	O
strlen	function
(	O
qdestsys	pointer
->	O
uuconf_zname	pointer
)	O
+	O
strlen	function
(	O
qcmd	pointer
->	O
zuser	pointer
)	O
+	O
sizeof	O
"!"	pointer
)	O
;	O
sprintf	function
(	O
zuser	pointer
,	O
"%s!%s"	pointer
,	O
qdestsys	pointer
->	O
uuconf_zname	pointer
,	O
qcmd	pointer
->	O
zuser	pointer
)	O
;	O
zoptions	pointer
=	O
aboptions	array
;	O
*	O
zoptions	pointer
++	O
=	O
'C'	O
;	O
if	O
(	O
strchr	function
(	O
qcmd	pointer
->	O
zoptions	pointer
,	O
'd'	O
)	O
!=	O
NULL	O
)	O
*	O
zoptions	pointer
++	O
=	O
'd'	O
;	O
if	O
(	O
strchr	function
(	O
qcmd	pointer
->	O
zoptions	pointer
,	O
'm'	O
)	O
!=	O
NULL	O
)	O
*	O
zoptions	pointer
++	O
=	O
'm'	O
;	O
*	O
zoptions	pointer
=	O
'\0'	O
;	O
fmkdirs	int
=	O
TRUE	O
;	O
}	O
qtrans	pointer
=	O
qtransalc	function
(	O
qcmd	pointer
)	O
;	O
qtrans	pointer
->	O
psendfn	pointer
=	O
fremote_xcmd_reply	function
;	O
qtrans	pointer
->	O
pinfo	pointer
=	O
(	O
pointer	pointer
)	O
"XY"	pointer
;	O
qtrans	pointer
->	O
iremote	int
=	O
iremote	int
;	O
if	O
(	O
!	O
fqueue_remote	function
(	O
qdaemon	pointer
,	O
qtrans	pointer
)	O
)	O
{	O
ubuffree	function
(	O
zdestfile	pointer
)	O
;	O
ubuffree	function
(	O
zuser	pointer
)	O
;	O
return	O
FALSE	O
;	O
}	O
zfrom	pointer
=	O
zsysdep_local_file	function
(	O
qcmd	pointer
->	O
zfrom	pointer
,	O
qsys	pointer
->	O
uuconf_zpubdir	pointer
,	O
(	O
boolean	int
*	O
)	O
NULL	O
)	O
;	O
if	O
(	O
zfrom	pointer
==	O
NULL	O
)	O
{	O
ubuffree	function
(	O
zdestfile	pointer
)	O
;	O
ubuffree	function
(	O
zuser	pointer
)	O
;	O
return	O
FALSE	O
;	O
}	O
if	O
(	O
!	O
fsysdep_wildcard_start	function
(	O
zfrom	pointer
)	O
)	O
{	O
ubuffree	function
(	O
zfrom	pointer
)	O
;	O
ubuffree	function
(	O
zdestfile	pointer
)	O
;	O
ubuffree	function
(	O
zuser	pointer
)	O
;	O
return	O
FALSE	O
;	O
}	O
fret	int
=	O
TRUE	O
;	O
while	O
(	O
(	O
zfile	pointer
=	O
zsysdep_wildcard	function
(	O
zfrom	pointer
)	O
)	O
!=	O
NULL	O
)	O
{	O
char	O
*	O
zto	pointer
;	O
char	O
abtname	array
[	O
CFILE_NAME_LEN	O
]	O
;	O
if	O
(	O
!	O
fsysdep_file_exists	function
(	O
zfile	pointer
)	O
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"%s: no such file"	pointer
,	O
zfile	pointer
)	O
;	O
continue	O
;	O
}	O
if	O
(	O
!	O
fin_directory_list	function
(	O
zfile	pointer
,	O
qsys	pointer
->	O
uuconf_pzremote_send	pointer
,	O
qsys	pointer
->	O
uuconf_zpubdir	pointer
,	O
TRUE	O
,	O
TRUE	O
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
)	O
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"%s: not permitted to send"	pointer
,	O
zfile	pointer
)	O
;	O
break	O
;	O
}	O
if	O
(	O
qdestsys	pointer
!=	O
NULL	O
)	O
{	O
zto	pointer
=	O
zsysdep_data_file_name	function
(	O
qdestsys	pointer
,	O
qdaemon	pointer
->	O
zlocalname	pointer
,	O
BDEFAULT_UUCP_GRADE	O
,	O
FALSE	O
,	O
abtname	array
,	O
(	O
char	O
*	O
)	O
NULL	O
,	O
(	O
char	O
*	O
)	O
NULL	O
)	O
;	O
if	O
(	O
zto	pointer
==	O
NULL	O
)	O
{	O
fret	int
=	O
FALSE	O
;	O
break	O
;	O
}	O
}	O
else	O
{	O
zto	pointer
=	O
zsysdep_add_base	function
(	O
zdestfile	pointer
,	O
zfile	pointer
)	O
;	O
if	O
(	O
zto	pointer
==	O
NULL	O
)	O
{	O
fret	int
=	O
FALSE	O
;	O
break	O
;	O
}	O
if	O
(	O
!	O
fin_directory_list	function
(	O
zto	pointer
,	O
qsys	pointer
->	O
uuconf_pzremote_receive	pointer
,	O
qsys	pointer
->	O
uuconf_zpubdir	pointer
,	O
TRUE	O
,	O
FALSE	O
,	O
(	O
const	O
char	O
*	O
)	O
NULL	O
)	O
)	O
{	O
ulog	function
(	O
LOG_ERROR	int
,	O
"%s: not permitted to receive"	pointer
,	O
zto	pointer
)	O
;	O
ubuffree	function
(	O
zto	pointer
)	O
;	O
break	O
;	O
}	O
}	O
if	O
(	O
!	O
fcopy_file	function
(	O
zfile	pointer
,	O
zto	pointer
,	O
qdestsys	pointer
==	O
NULL	O
,	O
fmkdirs	int
,	O
FALSE	O
)	O
)	O
{	O
ubuffree	function
(	O
zto	pointer
)	O
;	O
break	O
;	O
}	O
ubuffree	function
(	O
zto	pointer
)	O
;	O
if	O
(	O
qdestsys	pointer
!=	O
NULL	O
)	O
{	O
struct	O
scmd	struct
ssend	struct
;	O
char	O
*	O
zjobid	pointer
;	O
ssend	struct
.	O
bcmd	char
=	O
'S'	O
;	O
ssend	struct
.	O
bgrade	char
=	O
BDEFAULT_UUCP_GRADE	O
;	O
ssend	struct
.	O
pseq	pointer
=	O
NULL	O
;	O
ssend	struct
.	O
zfrom	pointer
=	O
zfile	pointer
;	O
ssend	struct
.	O
zto	pointer
=	O
zdestfile	pointer
;	O
ssend	struct
.	O
zuser	pointer
=	O
zuser	pointer
;	O
ssend	struct
.	O
zoptions	pointer
=	O
aboptions	array
;	O
ssend	struct
.	O
ztemp	pointer
=	O
abtname	array
;	O
ssend	struct
.	O
imode	int
=	O
ixsysdep_file_mode	function
(	O
zfile	pointer
)	O
;	O
ssend	struct
.	O
znotify	pointer
=	O
""	pointer
;	O
ssend	struct
.	O
cbytes	long
=	O
-	O
1	int
;	O
ssend	struct
.	O
zcmd	pointer
=	O
NULL	O
;	O
ssend	struct
.	O
ipos	long
=	O
0	int
;	O
zjobid	pointer
=	O
zsysdep_spool_commands	function
(	O
qdestsys	pointer
,	O
BDEFAULT_UUCP_GRADE	O
,	O
1	int
,	O
&	O
ssend	struct
,	O
(	O
boolean	int
*	O
)	O
NULL	O
)	O
;	O
if	O
(	O
zjobid	pointer
==	O
NULL	O
)	O
break	O
;	O
ubuffree	function
(	O
zjobid	pointer
)	O
;	O
}	O
ubuffree	function
(	O
zfile	pointer
)	O
;	O
}	O
if	O
(	O
zfile	pointer
!=	O
NULL	O
)	O
ubuffree	function
(	O
zfile	pointer
)	O
;	O
(	O
void	O
)	O
fsysdep_wildcard_end	function
(	O
)	O
;	O
ubuffree	function
(	O
zdestfile	pointer
)	O
;	O
if	O
(	O
qdestsys	pointer
!=	O
NULL	O
)	O
(	O
void	O
)	O
uuconf_system_free	function
(	O
qdaemon	pointer
->	O
puuconf	pointer
,	O
&	O
sdestsys	struct
)	O
;	O
ubuffree	function
(	O
zfrom	pointer
)	O
;	O
ubuffree	function
(	O
zuser	pointer
)	O
;	O
return	O
fret	int
;	O
}	O
static	O
boolean	int
fremote_xcmd_reply	function
(	O
qtrans	pointer
,	O
qdaemon	pointer
)	O
struct	O
stransfer	struct
*	O
qtrans	pointer
;	O
struct	O
sdaemon	struct
*	O
qdaemon	pointer
;	O
{	O
boolean	int
fret	int
;	O
fret	int
=	O
(	O
*	O
qdaemon	pointer
->	O
qproto	pointer
->	O
pfsendcmd	pointer
)	O
(	O
qdaemon	pointer
,	O
(	O
const	O
char	O
*	O
)	O
qtrans	pointer
->	O
pinfo	pointer
,	O
qtrans	pointer
->	O
ilocal	int
,	O
qtrans	pointer
->	O
iremote	int
)	O
;	O
utransfree	function
(	O
qtrans	pointer
)	O
;	O
return	O
fret	int
;	O
}	O
